<script>
// Dados de exemplo para demonstração
        const horariosManha = ['07:00-08:00', '08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', '12:00-13:00'];
        const horariosTarde = ['13:00-14:00', '14:00-15:00', '15:00-16:00', '16:00-17:00', '17:00-18:00', '18:00-19:00'];
        const horariosNoite = ['19:00-20:00', '20:00-21:00', '21:00-22:00', '22:00-23:00', '23:00-00:00', '00:00-01:00', '01:00-02:00', '02:00-03:00', '03:00-04:00', '04:00-05:00', '05:00-06:00', '06:00-07:00'];

        const LOGS_DEMONSTRACAO = [
            {
                id: 'LOG-20240210-0810',
                timestamp: '2024-02-10T08:10:24-03:00',
                usuario: 'Ana Lima',
                matricula: '12567',
                perfil: 'Administrador',
                acao: 'Atualização de agenda',
                tipoAcao: 'atualizacao',
                resultado: 'sucesso',
                origem: 'web',
                ip: '10.10.12.5',
                detalhes: 'Atualizou o turno da sala 203 para procedimento de ortopedia.',
                observacoes: 'Ajuste solicitado pelo coordenador clínico para acomodar caso urgente.',
                alerta: false,
                revisado: true,
                revisadoPor: 'Carlos Mendes',
                revisadoEm: '2024-02-10T09:05:00-03:00',
                payload: {
                    sala: '203',
                    turno: 'manhã',
                    statusAnterior: 'Livre',
                    statusAtual: 'Ocupado',
                    especialidade: 'Ortopedia'
                }
            },
            {
                id: 'LOG-20240210-0915',
                timestamp: '2024-02-10T09:15:42-03:00',
                usuario: 'João Tavares',
                matricula: '98321',
                perfil: 'Gestor',
                acao: 'Bloqueio de sala',
                tipoAcao: 'administrativo',
                resultado: 'alerta',
                origem: 'web',
                ip: '10.10.14.2',
                detalhes: 'Bloqueou a sala 105 por manutenção emergencial.',
                observacoes: 'Manutenção preventiva do equipamento de anestesia. Encaminhado para engenharia clínica.',
                alerta: true,
                alertaMotivo: 'Bloqueio emergencial registrado.',
                revisado: false,
                payload: {
                    sala: '105',
                    bloqueio: 'Emergencial',
                    previsaoRetorno: '2024-02-10T15:00:00-03:00'
                }
            },
            {
                id: 'LOG-20240209-2312',
                timestamp: '2024-02-09T23:12:07-03:00',
                usuario: 'API Externa',
                matricula: 'api-service',
                perfil: 'Integração',
                acao: 'Sincronização automática',
                tipoAcao: 'rotina',
                resultado: 'sucesso',
                origem: 'rotina',
                ip: '172.16.10.3',
                detalhes: 'Rotina de sincronização com planilha mestre executada com sucesso.',
                observacoes: 'Atualização completa em 320ms.',
                alerta: false,
                revisado: true,
                revisadoPor: 'Sistema',
                revisadoEm: '2024-02-09T23:12:40-03:00',
                payload: {
                    registrosSincronizados: 128,
                    inconsistencias: 0
                }
            },
            {
                id: 'LOG-20240210-0628',
                timestamp: '2024-02-10T06:28:11-03:00',
                usuario: 'Marina Costa',
                matricula: '77321',
                perfil: 'Analista',
                acao: 'Exportação de relatório',
                tipoAcao: 'exportacao',
                resultado: 'sucesso',
                origem: 'web',
                ip: '10.10.9.8',
                detalhes: 'Exportou relatório consolidado do turno da noite (CSV).',
                observacoes: 'Arquivo encaminhado para o comitê de produtividade.',
                alerta: false,
                revisado: false,
                payload: {
                    turno: 'Noite',
                    formato: 'CSV',
                    linhas: 78
                }
            },
            {
                id: 'LOG-20240209-1844',
                timestamp: '2024-02-09T18:44:09-03:00',
                usuario: 'Paulo Vilar',
                matricula: '66111',
                perfil: 'Administrador',
                acao: 'Cancelamento de agendamento',
                tipoAcao: 'cancelamento',
                resultado: 'erro',
                origem: 'mobile',
                ip: '177.201.32.88',
                detalhes: 'Falha ao cancelar agendamento da sala 302 - conflito de horário.',
                observacoes: 'Usuário recebeu orientação para tentar novamente após sincronização.',
                alerta: true,
                alertaMotivo: 'Cancelamento crítico não concluído.',
                revisado: false,
                payload: {
                    sala: '302',
                    profissional: 'Dr. Henrique Souza',
                    motivoErro: 'Horário indisponível após atualização paralela'
                }
            },
            {
                id: 'LOG-20240210-1033',
                timestamp: '2024-02-10T10:33:58-03:00',
                usuario: 'Carla Moraes',
                matricula: '55219',
                perfil: 'Gestor',
                acao: 'Cadastro de usuário',
                tipoAcao: 'criacao',
                resultado: 'sucesso',
                origem: 'web',
                ip: '10.10.21.4',
                detalhes: 'Cadastrou novo colaborador com perfil de analista de agenda.',
                observacoes: 'Perfil temporário válido até 30/03/2024.',
                alerta: false,
                revisado: true,
                revisadoPor: 'Ana Lima',
                revisadoEm: '2024-02-10T11:00:00-03:00',
                payload: {
                    novoUsuario: 'Fernanda Lessa',
                    perfil: 'Analista',
                    expiracao: '2024-03-30'
                }
            },
            {
                id: 'LOG-20240208-2138',
                timestamp: '2024-02-08T21:38:44-03:00',
                usuario: 'Rafael Campos',
                matricula: '44192',
                perfil: 'Administrador',
                acao: 'Login do usuário',
                tipoAcao: 'login',
                resultado: 'sucesso',
                origem: 'web',
                ip: '187.55.21.102',
                detalhes: 'Login autenticado via MFA.',
                observacoes: 'Sessão ativa por 2h.',
                alerta: false,
                revisado: true,
                revisadoPor: 'Sistema',
                revisadoEm: '2024-02-08T21:39:00-03:00',
                payload: {
                    metodoAutenticacao: 'MFA',
                    dispositivo: 'Notebook corporativo'
                }
            },
            {
                id: 'LOG-20240210-1122',
                timestamp: '2024-02-10T11:22:05-03:00',
                usuario: 'Monitoramento Automático',
                matricula: 'watcher',
                perfil: 'Integração',
                acao: 'Regra de alerta disparada',
                tipoAcao: 'rotina',
                resultado: 'alerta',
                origem: 'rotina',
                ip: '172.16.10.12',
                detalhes: 'Detectado volume atípico de cancelamentos em 30 minutos.',
                observacoes: 'Alertar equipe de governança para validação.',
                alerta: true,
                alertaMotivo: 'Mais de 5 cancelamentos em 30 minutos.',
                revisado: false,
                payload: {
                    cancelamentosDetectados: 7,
                    intervaloMinutos: 30,
                    salasAfetadas: ['201', '203', '210']
                }
            },
            {
                id: 'LOG-20240207-1542',
                timestamp: '2024-02-07T15:42:33-03:00',
                usuario: 'Equipe TI',
                matricula: 'support',
                perfil: 'Suporte',
                acao: 'Reprocessamento de fila',
                tipoAcao: 'administrativo',
                resultado: 'sucesso',
                origem: 'api',
                ip: '10.10.55.7',
                detalhes: 'Reprocessou fila de notificações para salas bloqueadas.',
                observacoes: 'Fila limpa após tentativa manual.',
                alerta: false,
                revisado: true,
                revisadoPor: 'Paulo Vilar',
                revisadoEm: '2024-02-07T16:10:00-03:00',
                payload: {
                    notificacoesReenviadas: 12,
                    erros: 0
                }
            }
        ];

        const ALERTAS_LOGS_DEMONSTRACAO = [
            {
                titulo: 'Cancelamentos em sequência',
                descricao: 'Dispara quando ocorrem 5 cancelamentos em 30 minutos.',
                ultimaVerificacao: '2024-02-10T11:22:05-03:00'
            },
            {
                titulo: 'Bloqueios emergenciais',
                descricao: 'Notifica sempre que uma sala é bloqueada com motivo emergencial.',
                ultimaVerificacao: '2024-02-10T09:15:42-03:00'
            },
            {
                titulo: 'Falhas de integração',
                descricao: 'Alerta quando rotinas automáticas retornam erro consecutivo.',
                ultimaVerificacao: '2024-02-09T23:12:07-03:00'
            }
        ];

        const criarEstadoFiltrosContexto = () => ({
            turnos: [],
            status: [],
            ilhas: [],
            salas: [],
            especialidades: [],
            categorias: [],
            profissionais: []
        });

        const FILTRO_CHAVES = {
            turno: 'turnos',
            status: 'status',
            ilha: 'ilhas',
            sala: 'salas',
            especialidade: 'especialidades',
            categoria: 'categorias',
            profissional: 'profissionais'
        };

        const FILTRO_ID_MAP = {
            turnos: 'turno',
            status: 'status',
            ilhas: 'ilha',
            salas: 'sala',
            especialidades: 'especialidade',
            categorias: 'categoria',
            profissionais: 'profissional'
        };

        const stores = {
            ui: {
                dataAtual: new Date(),
                turnoAtual: 'manha',
                visualizacaoSimplificada: true,
                temaAtual: 'light'
            },
            auth: {
                userRole: null
            },
            dados: {
                salas: [],
                agendamentos: [],
                dadosMestres: {
                    especialidades: [],
                    categorias: [],
                    ilhas: []
                }
            },
            filtros: {
                principais: {
                    especialidade: [],
                    categoria: [],
                    status: ['ocupado'],
                    ilha: []
                },
                dashboard: criarEstadoFiltrosContexto()
            },
            planejamento: {
                turno: 'manha',
                linhas: [],
                filtroNome: '',
                filtroEspecialidade: '',
                selecionados: new Set()
            },
            agendamento: {
                editarId: null
            },
            dashboard: {
                diasEspecificos: [],
                intervaloDias: { inicio: '', fim: '' },
                dados: null,
                comparacaoAtiva: false,
                comparativoConfig: null,
                comparativoDados: null,
                comparativoInfo: null,
                mesesSelecionados: [],
                semanaMesesSelecionados: [],
                semanasSelecionadas: [],
                anosSelecionados: [],
                resumoAtual: null
            },
            salaMes: {
                periodo: {
                    tipo: 'mes',
                    meses: [],
                    semanaMeses: [],
                    semanas: [],
                    diaModo: 'hoje',
                    diaUnico: '',
                    intervalo: { inicio: '', fim: '' }
                }
            },
            medicos: {
                resumo: [],
                acompanhamento: {
                    busca: '',
                    especialidade: 'todas',
                    frequencia: 'todos',
                    ordenacao: 'atrasos',
                    periodo: {
                        tipo: 'dia',
                        dia: new Date().toISOString().split('T')[0],
                        semana: '',
                        mes: '',
                        ano: '',
                        inicio: '',
                        fim: ''
                    }
                }
            },
            relatorios: {
                comparacaoAtiva: false,
                comparativoConfig: null,
                comparativoDados: null,
                comparativoInfo: null,
                resumoAtual: null
            },
            gestaoCadastros: {
                carregando: false,
                carregado: false,
                erro: null,
                tabAtiva: 'especialidades',
                dados: {
                    especialidades: [],
                    categorias: [],
                    ilhas: [],
                    salas: [],
                    estatisticas: {
                        totalEspecialidades: 0,
                        totalCategorias: 0,
                        totalIlhas: 0,
                        totalSalas: 0,
                        ilhasSemSala: 0,
                        salasSemIlha: 0
                    },
                    timestamp: null
                },
                selecao: {
                    especialidadeId: null,
                    categoriaId: null,
                    ilhaId: null,
                    salaId: null,
                    salasSelecionadas: new Set()
                },
                historico: {
                    carregando: false,
                    registros: [],
                    erro: null,
                    filtros: {
                        busca: '',
                        entidade: '',
                        acao: '',
                        usuario: '',
                        inicio: '',
                        fim: ''
                    }
                },
                feedback: null,
                ultimaAtualizacao: null,
                eventosRegistrados: false
            },
            logs: {
                registros: [],
                filtros: {
                    busca: '',
                    dataInicio: '',
                    dataFim: '',
                    usuario: '',
                    acao: [],
                    status: [],
                    origem: [],
                    apenasAlertas: false
                },
                filtroRapido: 'todos',
                filtrosSalvos: [],
                selecionadoId: null,
                alertasConfigurados: [],
                eventosConfigurados: false,
                ultimaSincronizacao: null,
                carregado: false,
                carregando: false
            },
            cache: {
                dadosPorDia: new Map(),
                prefetchEmAndamento: new Set(),
                salaMes: new Map(),
                salaMesTimer: null,
                salaMesRequestAtual: null,
                salaMesLoadingPendencias: 0,
                salaMesFiltrosPendentes: false
            }
        };

        const estado = {};
        let contextoRegistroRapido = null;
        let planejamentoEdicaoFila = null;
        let gestaoConfirmacaoCallback = null;
        let gestaoConfirmacaoContexto = null;
        const drawerController = {
            register: () => () => {},
            unregister: () => {},
            open: () => {},
            close: () => {},
            toggle: () => {},
            closeAll: () => {},
            isAnyOpen: () => false,
            syncBackdrop: () => {}
        };
        const estadoMapeamento = {
            dataAtual: ['ui', 'dataAtual'],
            turnoAtual: ['ui', 'turnoAtual'],
            visualizacaoSimplificada: ['ui', 'visualizacaoSimplificada'],
            temaAtual: ['ui', 'temaAtual'],
            userRole: ['auth', 'userRole'],
            salas: ['dados', 'salas'],
            agendamentos: ['dados', 'agendamentos'],
            dadosMestres: ['dados', 'dadosMestres'],
            filtros: ['filtros', 'principais'],
            filtrosDashboard: ['filtros', 'dashboard'],
            planejamentoTurno: ['planejamento', 'turno'],
            planejamentoLinhas: ['planejamento', 'linhas'],
            planejamentoFiltroNome: ['planejamento', 'filtroNome'],
            planejamentoFiltroEspecialidade: ['planejamento', 'filtroEspecialidade'],
            planejamentoSelecionados: ['planejamento', 'selecionados'],
            agendamentoEditarId: ['agendamento', 'editarId'],
            dashboardDiasEspecificos: ['dashboard', 'diasEspecificos'],
            dashboardIntervaloDias: ['dashboard', 'intervaloDias'],
            dashboardDados: ['dashboard', 'dados'],
            dashboardComparacaoAtiva: ['dashboard', 'comparacaoAtiva'],
            dashboardComparativoConfig: ['dashboard', 'comparativoConfig'],
            dashboardComparativoDados: ['dashboard', 'comparativoDados'],
            dashboardComparativoInfo: ['dashboard', 'comparativoInfo'],
            dashboardMesesSelecionados: ['dashboard', 'mesesSelecionados'],
            dashboardSemanaMesesSelecionados: ['dashboard', 'semanaMesesSelecionados'],
            dashboardSemanasSelecionadas: ['dashboard', 'semanasSelecionadas'],
            dashboardAnosSelecionados: ['dashboard', 'anosSelecionados'],
            dashboardResumoAtual: ['dashboard', 'resumoAtual'],
            salaMesPeriodo: ['salaMes', 'periodo'],
            medicosResumo: ['medicos', 'resumo'],
            acompanhamentoMedicos: ['medicos', 'acompanhamento'],
            relatorioComparacaoAtiva: ['relatorios', 'comparacaoAtiva'],
            relatorioComparativoConfig: ['relatorios', 'comparativoConfig'],
            relatorioComparativoDados: ['relatorios', 'comparativoDados'],
            relatorioComparativoInfo: ['relatorios', 'comparativoInfo'],
            relatorioResumoAtual: ['relatorios', 'resumoAtual'],
            gestaoCadastrosDados: ['gestaoCadastros', 'dados'],
            gestaoCadastrosCarregando: ['gestaoCadastros', 'carregando'],
            gestaoCadastrosTabAtiva: ['gestaoCadastros', 'tabAtiva'],
            gestaoCadastrosFeedback: ['gestaoCadastros', 'feedback'],
            gestaoCadastrosHistorico: ['gestaoCadastros', 'historico'],
            gestaoCadastrosSelecao: ['gestaoCadastros', 'selecao'],
            gestaoCadastrosUltimaAtualizacao: ['gestaoCadastros', 'ultimaAtualizacao'],
            gestaoCadastrosErro: ['gestaoCadastros', 'erro'],
            gestaoCadastrosCarregado: ['gestaoCadastros', 'carregado']
        };

        Object.keys(estadoMapeamento).forEach(chave => {
            const [grupo, propriedade] = estadoMapeamento[chave];
            Object.defineProperty(estado, chave, {
                get() {
                    return stores[grupo][propriedade];
                },
                set(valor) {
                    stores[grupo][propriedade] = valor;
                }
            });
        });

        const cacheDadosPorDia = stores.cache.dadosPorDia;
        const prefetchDiasEmAndamento = stores.cache.prefetchEmAndamento;
        const cacheSalaMes = stores.cache.salaMes;

        let salaMesAtualizacaoTimer = stores.cache.salaMesTimer;
        let salaMesRequestAtual = stores.cache.salaMesRequestAtual;
        let salaMesLoadingPendencias = stores.cache.salaMesLoadingPendencias;
        let salaMesFiltrosPendentes = stores.cache.salaMesFiltrosPendentes;

        function sincronizarEstadoSalaMes() {
            stores.cache.salaMesTimer = salaMesAtualizacaoTimer;
            stores.cache.salaMesRequestAtual = salaMesRequestAtual;
            stores.cache.salaMesLoadingPendencias = salaMesLoadingPendencias;
            stores.cache.salaMesFiltrosPendentes = salaMesFiltrosPendentes;
        }

        // Cache local para dados por dia visando carregamentos mais ágeis
        const CACHE_DADOS_DIA_TTL_MS = 2 * 60 * 1000; // 2 minutos
        const CACHE_SALA_MES_TTL_MS = 5 * 60 * 1000; // 5 minutos

        const domCache = {
            login: {},
            main: {},
            usuario: {},
            forgot: {},
            gestaoCadastros: {}
        };

        const normalizer = {
            removerAcentos(texto) {
                return String(texto || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            },
            escapeHtml(texto) {
                if (texto === null || texto === undefined) return '';
                return String(texto)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            },
            texto(valor) {
                if (valor === null || valor === undefined) return '';
                return this.removerAcentos(valor).trim().toLowerCase();
            },
            turno(valor) {
                const turno = this.texto(valor);
                if (turno.includes('manha')) return 'manha';
                if (turno.includes('tarde')) return 'tarde';
                if (turno.includes('noite')) return 'noite';
                if (turno.includes('integral') || turno.includes('todos')) return 'todos';
                return turno;
            },
            status(valor) {
                const status = this.texto(valor);
                if (!status) return 'livre';
                if (status.includes('ocup')) return 'ocupado';
                if (status.includes('agend') || status.includes('confir') || status.includes('atend') || status.includes('presen') || status.includes('compare')) {
                    return 'ocupado';
                }
                if (status.includes('reser')) return 'reservado';
                if (status.includes('bloq')) return 'bloqueado';
                if (status.includes('indisp')) return 'bloqueado';
                if (status.includes('livre')) return 'livre';
                return status || 'livre';
            }
        };

        const removerAcentos = normalizer.removerAcentos.bind(normalizer);

        function escapeHtml(texto) {
            return normalizer.escapeHtml(texto);
        }

        function normalizarTexto(valor) {
            return normalizer.texto(valor);
        }

        function normalizarTurno(valor) {
            return normalizer.turno(valor);
        }

        function normalizarStatus(valor) {
            return normalizer.status(valor);
        }

        function normalizarChaveCadastroLocal(valor) {
            if (valor === null || valor === undefined) {
                return '';
            }
            return removerAcentos(String(valor))
                .toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();
        }

        const formatadorDataHora = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        const formatadorData = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short' });

        function formatarDataHoraLocal(isoString) {
            if (!isoString) return '--';
            const data = new Date(isoString);
            if (Number.isNaN(data.getTime())) return '--';
            return formatadorDataHora.format(data);
        }

        function formatarDataLocal(isoString) {
            if (!isoString) return '--';
            const data = new Date(isoString);
            if (Number.isNaN(data.getTime())) return '--';
            return formatadorData.format(data);
        }

        function obterDomLogin() {
            const cache = domCache.login;
            if (cache.inicializado) return cache;

            cache.container = document.getElementById('login-container');
            cache.form = cache.container?.querySelector('.login-form') || null;
            cache.matricula = document.getElementById('login-matricula');
            cache.senha = document.getElementById('login-senha');
            cache.botao = document.getElementById('btn-login');
            cache.alerta = document.getElementById('login-alert');
            cache.mensagem = document.getElementById('login-message');
            cache.botaoLogout = document.getElementById('btn-logout');
            cache.botaoForgot = document.getElementById('btn-forgot');
            cache.botaoCadastrarUsuario = document.getElementById('btn-cadastrar-usuario');
            cache.inicializado = true;
            return cache;
        }

        function obterDomMain() {
            const cache = domCache.main;
            if (cache.inicializado) return cache;
            cache.container = document.getElementById('main-container');
            cache.inicializado = true;
            return cache;
        }

        function obterDomForgot() {
            const cache = domCache.forgot;
            if (cache.inicializado) return cache;
            cache.modal = document.getElementById('forgot-modal');
            cache.form = document.getElementById('form-forgot');
            cache.matricula = document.getElementById('forgot-matricula');
            cache.alerta = document.getElementById('forgot-alert');
            cache.mensagem = document.getElementById('forgot-message');
            cache.inicializado = true;
            return cache;
        }

        function obterDomUsuario() {
            const cache = domCache.usuario;
            if (cache.inicializado) return cache;
            cache.modal = document.getElementById('usuario-modal');
            cache.form = document.getElementById('form-usuario');
            cache.nome = document.getElementById('usuario-nome');
            cache.matricula = document.getElementById('usuario-matricula');
            cache.setor = document.getElementById('usuario-setor');
            cache.senha = document.getElementById('usuario-senha');
            cache.role = document.getElementById('usuario-role');
            cache.alerta = document.getElementById('usuario-alert');
            cache.mensagem = document.getElementById('usuario-message');
            cache.inicializado = true;
            return cache;
        }

        function executarGoogleScript({ funcao, parametros = [], onSuccess, onFailure, tentativas = 0, contexto = null, mensagemErroPadrao = 'Falha na comunicação com o serviço.' }) {
            const runner = typeof google !== 'undefined' && google?.script?.run ? google.script.run : null;
            if (!runner || typeof runner[funcao] !== 'function') {
                console.warn(`[AppsScript] Função ${funcao} indisponível.`);
                if (typeof onFailure === 'function') {
                    onFailure(new Error('Google Apps Script indisponível.'));
                }
                return;
            }

            const executarChamada = restantes => {
                let exec = runner;
                if (typeof onSuccess === 'function') {
                    exec = exec.withSuccessHandler(resultado => {
                        if (contexto && typeof contexto.onFinally === 'function') {
                            contexto.onFinally();
                        }
                        onSuccess(resultado);
                    });
                }
                exec = exec.withFailureHandler(erro => {
                    console.error(`[AppsScript] Erro ao executar ${funcao}:`, erro);
                    if (restantes > 0) {
                        executarChamada(restantes - 1);
                        return;
                    }
                    if (contexto && typeof contexto.onFinally === 'function') {
                        contexto.onFinally();
                    }
                    if (typeof onFailure === 'function') {
                        onFailure(erro instanceof Error ? erro : new Error(mensagemErroPadrao));
                    }
                });

                try {
                    exec[funcao](...parametros);
                } catch (erro) {
                    console.error(`[AppsScript] Exceção ao chamar ${funcao}:`, erro);
                    if (restantes > 0) {
                        executarChamada(restantes - 1);
                    } else if (typeof onFailure === 'function') {
                        onFailure(erro instanceof Error ? erro : new Error(mensagemErroPadrao));
                    }
                }
            };

            executarChamada(Number(tentativas) || 0);
        }

        function obterInfoCacheDia(diaIso) {
            const registro = cacheDadosPorDia.get(diaIso);
            if (!registro) return null;
            const expirado = Date.now() - registro.timestamp > CACHE_DADOS_DIA_TTL_MS;
            return { ...registro, expirado };
        }

        function salvarCacheDia(diaIso, dados) {
            if (!diaIso) return;
            cacheDadosPorDia.set(diaIso, {
                dados,
                timestamp: Date.now()
            });

            const LIMITE_CACHE_DIAS = 10;
            if (cacheDadosPorDia.size > LIMITE_CACHE_DIAS) {
                const chaves = Array.from(cacheDadosPorDia.keys());
                while (cacheDadosPorDia.size > LIMITE_CACHE_DIAS) {
                    const chaveRemover = chaves.shift();
                    if (chaveRemover && chaveRemover !== diaIso) {
                        cacheDadosPorDia.delete(chaveRemover);
                    }
                }
            }
        }

        function obterCacheSalaMes(chave) {
            if (!chave) return null;
            const registro = cacheSalaMes.get(chave);
            if (!registro) return null;
            const expirado = Date.now() - registro.timestamp > CACHE_SALA_MES_TTL_MS;
            if (expirado) {
                cacheSalaMes.delete(chave);
                return null;
            }
            return registro.dados;
        }

        function salvarCacheSalaMes(chave, dados) {
            if (!chave) return;
            cacheSalaMes.set(chave, { dados, timestamp: Date.now() });
            if (cacheSalaMes.size > 20) {
                const maisAntiga = [...cacheSalaMes.entries()].sort((a, b) => a[1].timestamp - b[1].timestamp)[0];
                if (maisAntiga) {
                    cacheSalaMes.delete(maisAntiga[0]);
                }
            }
        }

        const percentagePlugin = {
            id: 'percentagePlugin',
            afterDatasetsDraw(chart, args, opts) {
                const pluginOptions = chart.options?.plugins?.percentagePlugin;
                if (!pluginOptions || pluginOptions.enabled === false) {
                    return;
                }

                const datasetIndex = Number.isInteger(pluginOptions.datasetIndex)
                    ? pluginOptions.datasetIndex
                    : 0;
                const dataset = chart.data?.datasets?.[datasetIndex];
                if (!dataset) return;

                const dados = Array.isArray(dataset.data) ? dataset.data : [];
                const total = dados.reduce((acumulado, valor) => {
                    const numero = Number(valor);
                    if (!Number.isFinite(numero) || numero <= 0) return acumulado;
                    return acumulado + numero;
                }, 0);
                if (!total) return;

                const fontFamily = pluginOptions.fontFamily || (Chart.defaults?.font?.family) || 'Inter, sans-serif';
                const fontWeight = pluginOptions.fontWeight || '600';
                const fontSize = pluginOptions.fontSize || 12;
                const minPercentage = pluginOptions.minPercentage ?? 0;
                const decimals = pluginOptions.decimals ?? 1;
                const color = pluginOptions.color || '#ffffff';
                const offsetX = pluginOptions.offsetX ?? 18;
                const offsetY = pluginOptions.offsetY ?? 12;

                const meta = chart.getDatasetMeta(datasetIndex);
                const ctx = chart.ctx;
                const tipo = chart.config?.type;
                const indexAxis = chart.options?.indexAxis || 'x';

                meta.data.forEach((elemento, indice) => {
                    if (!elemento) return;
                    const bruto = Number(dados[indice]);
                    if (!Number.isFinite(bruto) || bruto <= 0) return;
                    const percentual = (bruto / total) * 100;
                    if (percentual < minPercentage) return;

                    const texto = `${percentual.toFixed(decimals)}%`;
                    const posicao = elemento.tooltipPosition(true);
                    let x = posicao.x;
                    let y = posicao.y;

                    ctx.save();
                    ctx.fillStyle = color;
                    ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
                    ctx.textBaseline = 'middle';
                    ctx.textAlign = 'center';

                    if (tipo === 'bar') {
                        if (indexAxis === 'y') {
                            x = posicao.x + offsetX;
                            ctx.textAlign = 'left';
                        } else {
                            y = posicao.y - offsetY;
                            ctx.textBaseline = 'bottom';
                        }
                    }

                    ctx.fillText(texto, x, y);
                    ctx.restore();
                });
            }
        };

        let percentagePluginRegistrado = false;

        function registrarPluginPercentual() {
            if (percentagePluginRegistrado) return;
            if (typeof Chart === 'undefined' || typeof Chart.register !== 'function') return;
            Chart.register(percentagePlugin);
            percentagePluginRegistrado = true;
        }

        function prefetchDiasAdjacentes(diaIso) {
            const base = new Date(`${diaIso}T00:00:00`);
            if (Number.isNaN(base.getTime())) return;

            [-1, 1].forEach(offset => {
                const alvo = new Date(base);
                alvo.setDate(alvo.getDate() + offset);
                const alvoIso = alvo.toISOString().split('T')[0];

                const infoCache = obterInfoCacheDia(alvoIso);
                if (infoCache && !infoCache.expirado) {
                    return;
                }

                if (prefetchDiasEmAndamento.has(alvoIso)) {
                    return;
                }

                prefetchDiasEmAndamento.add(alvoIso);

                executarGoogleScript({
                    funcao: 'getDadosCompletos',
                    parametros: [alvoIso],
                    tentativas: 1,
                    onSuccess(dados) {
                        prefetchDiasEmAndamento.delete(alvoIso);
                        if (dados && !dados.error) {
                            salvarCacheDia(alvoIso, dados);
                        }
                    },
                    onFailure() {
                        prefetchDiasEmAndamento.delete(alvoIso);
                    }
                });
            });
        }

        const ordenarAlphaNumerico = (a, b) => {
            const valorA = String(a ?? '').trim();
            const valorB = String(b ?? '').trim();
            const numA = parseFloat(valorA);
            const numB = parseFloat(valorB);
            const ehNumA = valorA !== '' && !Number.isNaN(numA);
            const ehNumB = valorB !== '' && !Number.isNaN(numB);
            if (ehNumA && ehNumB) {
                return numA - numB;
            }
            return valorA.localeCompare(valorB, 'pt-BR', { numeric: true, sensitivity: 'base' });
        };

        function statusBloqueiaAgendamento(status) {
            const normalizado = normalizarStatus(status);
            return ['ocupado', 'reservado', 'bloqueado', 'manutencao'].includes(normalizado);
        }

        function statusParaClasseVisual(status) {
            const normalizado = normalizarStatus(status);
            if (normalizado === 'manutencao') return 'bloqueado';
            if (['ocupado', 'reservado', 'bloqueado'].includes(normalizado)) return normalizado;
            return 'livre';
        }

        function formatarTurnoLabel(turno) {
            const normalizado = normalizarTurno(turno);
            switch (normalizado) {
                case 'manha':
                    return 'Manhã';
                case 'tarde':
                    return 'Tarde';
                case 'noite':
                    return 'Noite';
                case 'todos':
                    return 'Todos os turnos';
                default:
                    return turno || '';
            }
        }

        function formatarStatusLabel(status) {
            const normalizado = normalizarStatus(status);
            const mapa = {
                ocupado: 'Ocupado',
                livre: 'Livre',
                reservado: 'Reservado',
                bloqueado: 'Bloqueado',
                manutencao: 'Em manutenção',
                cancelado: 'Cancelado'
            };
            return mapa[normalizado] || (status ? status : '-');
        }

        function obterStatusVariant(status) {
            const normalizado = normalizarStatus(status);
            switch (normalizado) {
                case 'livre':
                    return 'sucesso';
                case 'ocupado':
                case 'reservado':
                    return 'info';
                case 'bloqueado':
                case 'manutencao':
                    return 'alerta';
                case 'cancelado':
                    return 'perigo';
                default:
                    return 'neutro';
            }
        }

        const THEME_CONFIG = {
            light: {
                id: 'light',
                label: 'Tema claro',
                toggleIcon: 'fas fa-sun'
            },
            dark: {
                id: 'dark',
                label: 'Tema escuro',
                toggleIcon: 'fas fa-moon'
            },
            rose: {
                id: 'rose',
                label: 'Tema rosé',
                toggleIcon: 'fas fa-seedling'
            }
        };
        const THEME_IDS = Object.keys(THEME_CONFIG);

        function obterTemaPreferido() {
            const salvo = localStorage.getItem('themePreference');
            if (THEME_IDS.includes(salvo)) {
                return salvo;
            }
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            return 'light';
        }

        function aplicarTema(tema) {
            const normalizado = THEME_IDS.includes(tema) ? tema : 'light';
            estado.temaAtual = normalizado;

            const body = document.body;
            const isLightVariant = normalizado === 'light' || normalizado === 'rose';
            body.dataset.theme = normalizado;
            body.classList.toggle('light-theme', isLightVariant);
            body.classList.toggle('theme-light', normalizado === 'light');
            body.classList.toggle('theme-dark', normalizado === 'dark');
            body.classList.toggle('theme-rose', normalizado === 'rose');

            const toggle = document.getElementById('theme-menu-toggle');
            if (toggle) {
                const icone = toggle.querySelector('i');
                if (icone) {
                    icone.className = THEME_CONFIG[normalizado].toggleIcon;
                }
                toggle.setAttribute('aria-label', `Selecionar tema (atual: ${THEME_CONFIG[normalizado].label})`);
                toggle.setAttribute('title', THEME_CONFIG[normalizado].label);
            }

            const menu = document.getElementById('theme-menu');
            if (menu) {
                menu.querySelectorAll('[data-theme]').forEach(option => {
                    const ativo = option.dataset.theme === normalizado;
                    option.classList.toggle('is-active', ativo);
                    option.setAttribute('aria-checked', ativo ? 'true' : 'false');
                });
            }

            const logoImg = document.getElementById('app-logo');
            if (logoImg) {
                const { lightSrc, darkSrc } = logoImg.dataset;
                if (normalizado === 'dark' && darkSrc) {
                    logoImg.src = darkSrc;
                } else if (lightSrc) {
                    logoImg.src = lightSrc;
                }
            }

            localStorage.setItem('themePreference', normalizado);

            if (estado.dashboardDados) {
                renderCharts(estado.dashboardDados, estado.dashboardComparativoDados, estado.dashboardComparativoInfo);
            }
        }

        function inicializarTema() {
            const preferido = obterTemaPreferido();
            aplicarTema(preferido);

            const toggle = document.getElementById('theme-menu-toggle');
            const menu = document.getElementById('theme-menu');
            if (!toggle || !menu) return;

            const options = Array.from(menu.querySelectorAll('[data-theme]'));
            menu.setAttribute('aria-hidden', 'true');
            const closeMenu = () => {
                if (!menu.classList.contains('is-open')) return;
                menu.classList.remove('is-open');
                menu.setAttribute('hidden', '');
                menu.setAttribute('aria-hidden', 'true');
                toggle.setAttribute('aria-expanded', 'false');
            };
            const openMenu = () => {
                if (menu.classList.contains('is-open')) return;
                menu.classList.add('is-open');
                menu.removeAttribute('hidden');
                menu.setAttribute('aria-hidden', 'false');
                toggle.setAttribute('aria-expanded', 'true');
                const ativo = menu.querySelector('.theme-option.is-active');
                if (ativo) {
                    ativo.focus({ preventScroll: true });
                }
            };

            toggle.addEventListener('click', event => {
                event.preventDefault();
                event.stopPropagation();
                if (menu.classList.contains('is-open')) {
                    closeMenu();
                } else {
                    openMenu();
                }
            });

            options.forEach(option => {
                option.addEventListener('click', event => {
                    event.preventDefault();
                    const temaSelecionado = option.dataset.theme;
                    aplicarTema(temaSelecionado);
                    closeMenu();
                    toggle.focus({ preventScroll: true });
                });
            });

            menu.addEventListener('focusout', event => {
                if (!menu.classList.contains('is-open')) return;
                const proximo = event.relatedTarget || document.activeElement;
                if (!proximo || (!menu.contains(proximo) && !toggle.contains(proximo))) {
                    closeMenu();
                }
            });

            document.addEventListener('click', event => {
                if (!menu.classList.contains('is-open')) return;
                if (menu.contains(event.target) || toggle.contains(event.target)) return;
                closeMenu();
            });

            document.addEventListener('keydown', event => {
                if (event.key === 'Escape' && menu.classList.contains('is-open')) {
                    closeMenu();
                    toggle.focus({ preventScroll: true });
                }
            });
        }

        function inicializarAnimacaoBotoes() {
            document.addEventListener('click', event => {
                const button = event.target.closest('button');
                if (!button || button.dataset.skipBusy === 'true') {
                    return;
                }
                if (button.classList.contains('is-processing')) {
                    return;
                }

                button.classList.add('is-processing');

                const deveMostrarSpinner = button.classList.contains('btn') || button.classList.contains('icon-button');
                if (deveMostrarSpinner && !button.querySelector('.button-spinner')) {
                    const spinner = document.createElement('span');
                    spinner.className = 'button-spinner';
                    spinner.setAttribute('aria-hidden', 'true');
                    button.appendChild(spinner);
                }

                setTimeout(() => {
                    if (button.dataset.keepBusy === 'true') return;
                    button.classList.remove('is-processing');
                }, 650);
            }, true);
        }

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', function() {
            inicializarTema();
            configurarLogin();
            inicializarAnimacaoBotoes();
            inicializarData();
            setupResponsiveShell();
            configurarEventListeners();
            carregarDadosMestres();
            carregarDados();
        });

        function configurarLogin() {
            const loginDom = obterDomLogin();
            const mainDom = obterDomMain();
            const forgotDom = obterDomForgot();
            const usuarioDom = obterDomUsuario();

            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');
            if (token && role) {
                estado.userRole = role;
                if (loginDom.container) loginDom.container.style.display = 'none';
                if (mainDom.container) mainDom.container.style.display = 'block';
                toggleAdminFeatures(role === 'admin');
            } else {
                if (loginDom.container) loginDom.container.style.display = 'flex';
                if (mainDom.container) mainDom.container.style.display = 'none';
            }

            if (!loginDom.eventosConfigurados) {
                loginDom.botao?.addEventListener('click', realizarLogin);
                loginDom.botaoLogout?.addEventListener('click', realizarLogout);
                loginDom.botaoForgot?.addEventListener('click', abrirModalForgot);
                forgotDom.form?.addEventListener('submit', e => {
                    e.preventDefault();
                    solicitarResetSenha();
                });
                loginDom.botaoCadastrarUsuario?.addEventListener('click', abrirModalUsuario);
                usuarioDom.form?.addEventListener('submit', e => {
                    e.preventDefault();
                    cadastrarUsuario();
                });
                loginDom.eventosConfigurados = true;
            }
        }

        function toggleAdminFeatures(isAdmin) {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? 'flex' : 'none';
            });
            aplicarRestricoesLogs();
        }

        function realizarLogin() {
            const loginDom = obterDomLogin();
            const mainDom = obterDomMain();
            const matricula = loginDom.matricula?.value?.trim();
            const senha = loginDom.senha?.value || '';

            if (!matricula || !senha) {
                mostrarLoginAlerta('Preencha todos os campos.');
                return;
            }

            const btnLogin = loginDom.botao;
            const loginForm = loginDom.form;

            const finalizarLoginAnimacao = estadoFinal => {
                if (btnLogin) {
                    delete btnLogin.dataset.keepBusy;
                    btnLogin.classList.remove('is-processing', 'login-button-animating', 'login-button-error');
                    if (estadoFinal === 'erro') {
                        btnLogin.classList.add('login-button-error');
                        setTimeout(() => btnLogin.classList.remove('login-button-error'), 700);
                    }
                    btnLogin.blur();
                }
                if (loginForm) {
                    loginForm.classList.remove('login-form-processing');
                }
            };

            if (btnLogin) {
                btnLogin.dataset.keepBusy = 'true';
                btnLogin.classList.add('login-button-animating');
            }

            if (loginForm) {
                loginForm.classList.add('login-form-processing');
            }

            executarGoogleScript({
                funcao: 'login',
                parametros: [matricula, senha],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        finalizarLoginAnimacao('ok');
                        localStorage.setItem('authToken', result.token);
                        localStorage.setItem('userRole', result.role);
                        estado.userRole = result.role;
                        if (loginDom.container) loginDom.container.style.display = 'none';
                        if (mainDom.container) mainDom.container.style.display = 'block';
                        toggleAdminFeatures(result.role === 'admin');
                    } else {
                        finalizarLoginAnimacao('erro');
                        mostrarLoginAlerta(result?.message || 'Credenciais inválidas.');
                    }
                },
                onFailure() {
                    finalizarLoginAnimacao('erro');
                    mostrarLoginAlerta('Erro ao fazer login.');
                }
            });
        }

        function realizarLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            estado.userRole = null;
            const loginDom = obterDomLogin();
            const mainDom = obterDomMain();
            if (mainDom.container) mainDom.container.style.display = 'none';
            if (loginDom.container) loginDom.container.style.display = 'flex';
            aplicarRestricoesLogs();
        }

        function mostrarLoginAlerta(mensagem) {
            const loginDom = obterDomLogin();
            if (!loginDom.alerta || !loginDom.mensagem) return;
            loginDom.mensagem.textContent = mensagem;
            loginDom.alerta.style.display = 'block';
            setTimeout(() => {
                loginDom.alerta.style.display = 'none';
            }, 5000);
        }

        function abrirModalForgot() {
            const forgotDom = obterDomForgot();
            if (forgotDom.modal) {
                forgotDom.modal.style.display = 'flex';
            }
        }

        function solicitarResetSenha() {
            const forgotDom = obterDomForgot();
            const matricula = forgotDom.matricula?.value?.trim();
            if (!matricula) {
                alert('Informe a matrícula.');
                return;
            }

            executarGoogleScript({
                funcao: 'forgotPassword',
                parametros: [matricula],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        if (forgotDom.mensagem) {
                            forgotDom.mensagem.textContent = 'Solicitação enviada ao administrador.';
                        }
                        if (forgotDom.alerta) {
                            forgotDom.alerta.style.display = 'block';
                        }
                        setTimeout(() => {
                            if (forgotDom.modal) {
                                forgotDom.modal.style.display = 'none';
                            }
                        }, 3000);
                    } else {
                        alert(result?.message || 'Não foi possível registrar a solicitação.');
                    }
                },
                onFailure() {
                    alert('Erro ao enviar solicitação.');
                }
            });
        }

        function abrirModalUsuario() {
            const usuarioDom = obterDomUsuario();
            if (usuarioDom.modal) {
                usuarioDom.modal.style.display = 'flex';
            }
        }

        function cadastrarUsuario() {
            const usuarioDom = obterDomUsuario();
            const nome = usuarioDom.nome?.value?.trim();
            const matricula = usuarioDom.matricula?.value?.trim();
            const setor = usuarioDom.setor?.value?.trim();
            const senha = usuarioDom.senha?.value || '';
            const role = usuarioDom.role?.value || '';

            if (!nome || !matricula || !setor || !senha || !role) {
                mostrarUsuarioAlerta('Preencha todos os campos.');
                return;
            }

            executarGoogleScript({
                funcao: 'cadastrarUsuario',
                parametros: [{ nome, matricula, setor, senha, role }],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        alert('Usuário cadastrado com sucesso!');
                        if (usuarioDom.modal) usuarioDom.modal.style.display = 'none';
                        usuarioDom.form?.reset();
                    } else {
                        mostrarUsuarioAlerta(result?.message || 'Não foi possível cadastrar o usuário.');
                    }
                },
                onFailure() {
                    mostrarUsuarioAlerta('Erro ao cadastrar usuário.');
                }
            });
        }

        function mostrarUsuarioAlerta(mensagem) {
            const usuarioDom = obterDomUsuario();
            if (!usuarioDom.alerta || !usuarioDom.mensagem) return;
            usuarioDom.mensagem.textContent = mensagem;
            usuarioDom.alerta.style.display = 'block';
            setTimeout(() => {
                usuarioDom.alerta.style.display = 'none';
            }, 5000);
        }

        function inicializarData() {
            const dataElement = document.getElementById('current-date');
            const datePicker = document.getElementById('current-date-picker');
            if (!dataElement) return;

            const atualizarVisualData = () => {
                dataElement.textContent = formatarData(estado.dataAtual);
                if (datePicker) {
                    const iso = estado.dataAtual.toISOString().split('T')[0];
                    datePicker.value = iso;
                }
            };

            const definirDataAtual = novaData => {
                estado.dataAtual = novaData;
                if (estado.acompanhamentoMedicos?.periodo?.tipo === 'dia') {
                    estado.acompanhamentoMedicos.periodo.dia = novaData.toISOString().split('T')[0];
                }
                atualizarVisualData();
                carregarDados();
            };

            const ehFinalDeSemana = data => {
                if (!(data instanceof Date)) return false;
                const dia = data.getDay();
                return dia === 0 || dia === 6;
            };

            const calcularDiaUtil = (referencia, direcao) => {
                const novaData = new Date(referencia.getTime());
                novaData.setDate(novaData.getDate() + direcao);
                while (ehFinalDeSemana(novaData)) {
                    novaData.setDate(novaData.getDate() + direcao);
                }
                return novaData;
            };

            atualizarVisualData();

            const prevBtn = document.getElementById('prev-date');
            const nextBtn = document.getElementById('next-date');

            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    const novaData = calcularDiaUtil(estado.dataAtual, -1);
                    definirDataAtual(novaData);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    const novaData = calcularDiaUtil(estado.dataAtual, 1);
                    definirDataAtual(novaData);
                });
            }

            if (datePicker) {
                datePicker.addEventListener('change', () => {
                    if (!datePicker.value) return;
                    const novaData = new Date(`${datePicker.value}T00:00:00`);
                    if (!isNaN(novaData.getTime())) {
                        definirDataAtual(novaData);
                    }
                });
            }
        }

        function formatarData(data) {
            if (!(data instanceof Date) || Number.isNaN(data.getTime())) {
                return '';
            }
            const texto = data.toLocaleDateString('pt-BR', { weekday: 'long' });
            return texto.charAt(0).toUpperCase() + texto.slice(1);
        }

        function normalizarDataISO(valor) {
            if (!valor && valor !== 0) return null;
            if (valor instanceof Date) {
                return Number.isNaN(valor.getTime()) ? null : valor.toISOString().split('T')[0];
            }
            if (typeof valor === 'number') {
                const dataNumero = new Date(valor);
                return Number.isNaN(dataNumero.getTime()) ? null : dataNumero.toISOString().split('T')[0];
            }
            const texto = String(valor).trim();
            if (!texto) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(texto)) return texto;
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(texto)) {
                const [dia, mes, ano] = texto.split('/');
                return `${ano.padStart(4, '0')}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
            }
            const data = new Date(texto);
            if (Number.isNaN(data.getTime())) return null;
            return data.toISOString().split('T')[0];
        }

        function obterInicioSemanaISO(ano, semana) {
            const simples = new Date(Date.UTC(ano, 0, 1 + (semana - 1) * 7));
            const diaSemana = simples.getUTCDay() || 7;
            if (diaSemana <= 4) {
                simples.setUTCDate(simples.getUTCDate() - (diaSemana - 1));
            } else {
                simples.setUTCDate(simples.getUTCDate() + (8 - diaSemana));
            }
            return simples;
        }

        function obterIntervaloAgendamento(ag) {
            const inicio = normalizarDataISO(ag?.dataInicio || ag?.data);
            const fim = normalizarDataISO(ag?.dataFim || ag?.data);
            if (inicio && fim) {
                return inicio <= fim ? { inicio, fim } : { inicio: fim, fim: inicio };
            }
            const unico = inicio || fim;
            return { inicio: unico, fim: unico };
        }

        function calcularPeriodoMedicos(config = {}) {
            const tipo = config.tipo || 'dia';
            const hoje = estado.dataAtual instanceof Date ? estado.dataAtual : new Date();
            const dataHoje = normalizarDataISO(hoje) || new Date().toISOString().split('T')[0];

            if (tipo === 'intervalo') {
                let inicio = normalizarDataISO(config.inicio) || dataHoje;
                let fim = normalizarDataISO(config.fim) || inicio;
                if (inicio > fim) [inicio, fim] = [fim, inicio];
                return { inicio, fim, tipo };
            }

            if (tipo === 'mes') {
                const valor = (config.mes || dataHoje.slice(0, 7)).trim();
                if (/^\d{4}-\d{2}$/.test(valor)) {
                    const [anoStr, mesStr] = valor.split('-');
                    const ano = Number(anoStr);
                    const mes = Number(mesStr) - 1;
                    const inicio = new Date(Date.UTC(ano, mes, 1));
                    const fim = new Date(Date.UTC(ano, mes + 1, 0));
                    return { inicio: normalizarDataISO(inicio), fim: normalizarDataISO(fim), tipo };
                }
            }

            if (tipo === 'semana') {
                const valor = (config.semana || '').trim();
                const padraoSemana = /^\d{4}-W(\d{2})$/;
                const anoAtual = dataHoje.slice(0, 4);
                const semanaValor = padraoSemana.test(valor) ? valor : `${anoAtual}-W${obterSemanaISO(hoje)}`;
                const [, semanaStr] = semanaValor.match(/^(\d{4})-W(\d{2})$/) || [];
                const ano = Number(semanaValor.slice(0, 4));
                const semanaNumero = Number(semanaStr || obterSemanaISO(hoje));
                const inicioData = obterInicioSemanaISO(ano, semanaNumero);
                const fimData = new Date(inicioData);
                fimData.setUTCDate(fimData.getUTCDate() + 6);
                return {
                    inicio: normalizarDataISO(inicioData),
                    fim: normalizarDataISO(fimData),
                    tipo,
                    semana: `${ano}-W${String(semanaNumero).padStart(2, '0')}`
                };
            }

            if (tipo === 'ano') {
                const ano = (config.ano || dataHoje.slice(0, 4)).padStart(4, '0');
                return {
                    inicio: `${ano}-01-01`,
                    fim: `${ano}-12-31`,
                    tipo,
                    ano
                };
            }

            const dia = normalizarDataISO(config.dia) || dataHoje;
            return { inicio: dia, fim: dia, tipo: 'dia' };
        }

        function obterSemanaISO(data) {
            const alvo = new Date(Date.UTC(data.getFullYear(), data.getMonth(), data.getDate()));
            const diaSemana = (alvo.getUTCDay() + 6) % 7;
            alvo.setUTCDate(alvo.getUTCDate() - diaSemana + 3);
            const primeiraQuinta = new Date(Date.UTC(alvo.getUTCFullYear(), 0, 4));
            const diff = alvo - primeiraQuinta;
            const semana = 1 + Math.round(diff / (7 * 24 * 3600 * 1000));
            return String(semana).padStart(2, '0');
        }

        function filtrarAgendamentosPorPeriodoMedicos(lista) {
            const periodoConfig = estado.acompanhamentoMedicos?.periodo || {};
            const periodo = calcularPeriodoMedicos(periodoConfig);
            if (!periodo.inicio || !periodo.fim) {
                return Array.isArray(lista) ? [...lista] : [];
            }
            if (estado.acompanhamentoMedicos?.periodo) {
                if (periodo.semana) {
                    estado.acompanhamentoMedicos.periodo.semana = periodo.semana;
                }
                if (periodo.ano) {
                    estado.acompanhamentoMedicos.periodo.ano = periodo.ano;
                }
            }
            const inicioFiltro = periodo.inicio;
            const fimFiltro = periodo.fim;
            const resultado = [];
            (lista || []).forEach(ag => {
                const intervalo = obterIntervaloAgendamento(ag);
                const inicio = intervalo.inicio || intervalo.fim;
                const fim = intervalo.fim || intervalo.inicio;
                if (!inicio && !fim) {
                    resultado.push(ag);
                    return;
                }
                const inicioComparar = inicio || fimFiltro;
                const fimComparar = fim || inicioFiltro;
                if (inicioComparar <= fimFiltro && fimComparar >= inicioFiltro) {
                    resultado.push(ag);
                }
            });
            return resultado;
        }

        function atualizarMedicosPeriodoAnos() {
            const selectAno = document.getElementById('medicos-periodo-ano');
            if (!selectAno) return;
            const anos = new Set();
            (estado.agendamentos || []).forEach(ag => {
                const intervalo = obterIntervaloAgendamento(ag);
                [intervalo.inicio, intervalo.fim].forEach(dataISO => {
                    if (typeof dataISO === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dataISO)) {
                        anos.add(dataISO.slice(0, 4));
                    }
                });
            });
            if (!anos.size) {
                anos.add(new Date().getFullYear().toString());
            }
            const valores = Array.from(anos).sort();
            const periodo = estado.acompanhamentoMedicos?.periodo || {};
            const atual = periodo.ano && valores.includes(periodo.ano)
                ? periodo.ano
                : valores[valores.length - 1];
            selectAno.innerHTML = valores.map(ano => `<option value="${ano}">${ano}</option>`).join('');
            selectAno.value = atual;
            estado.acompanhamentoMedicos.periodo.ano = atual;
        }

        function atualizarMedicosPeriodoUI() {
            const periodoSelect = document.getElementById('medicos-periodo');
            const tipoAtual = periodoSelect ? periodoSelect.value : 'dia';
            document.querySelectorAll('.medicos-periodo-detalhes').forEach(container => {
                const tipo = container.getAttribute('data-periodo');
                if (tipo === tipoAtual) {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
            });
        }

        let isLoading = false;
        let pendingReload = false;

        function togglePlanejamentoLoading(visivel) {
            const loader = document.getElementById('planejamento-loading');
            if (!loader) return;
            if (visivel) {
                loader.classList.add('active');
                loader.setAttribute('aria-hidden', 'false');
            } else {
                loader.classList.remove('active');
                loader.setAttribute('aria-hidden', 'true');
            }
        }

        function aplicarDadosCarregados(dados, { manterIndicadorCarregamento = false } = {}) {
            if (!dados) return;

            estado.salas = (dados.salas || []).map(sala => ({
                ...sala,
                statusNormalizado: normalizarStatus(sala.statusGeral || sala.status)
            }));

            estado.agendamentos = (dados.agendamentos || []).map(ag => ({
                ...ag,
                turnoNormalizado: normalizarTurno(ag.turno),
                statusNormalizado: normalizarStatus(ag.status)
            }));

            console.log('Estado atualizado - Salas:', estado.salas.length, 'Agendamentos:', estado.agendamentos.length);

            aplicarFiltros();
            atualizarPlanejamento();
            const opcoesFiltros = preencherRelatorioFiltros();
            preencherDashboardFiltros(opcoesFiltros);
            preencherSalaMesFiltros(opcoesFiltros);
            registrarEventosFiltrosEspecificos();
            recalcularAcompanhamentoMedicos();

            if (manterIndicadorCarregamento) {
                const monitor = document.getElementById('monitor-content');
                if (monitor) {
                    monitor.style.display = 'flex';
                }
            } else {
                esconderLoading();
            }
        }

        function carregarDados(opcoes = {}) {
            const dataIsoAtual = estado.dataAtual.toISOString().split('T')[0];
            const infoCache = obterInfoCacheDia(dataIsoAtual);
            const deveForcarAtualizacao = opcoes.forcarAtualizacao === true;
            let usandoCacheExpirado = false;
            const tinhaDadosEmCache = Boolean(infoCache && infoCache.dados);

            if (infoCache && !deveForcarAtualizacao) {
                if (!infoCache.expirado) {
                    console.log(`Dados de ${dataIsoAtual} carregados a partir do cache local.`);
                    aplicarDadosCarregados(infoCache.dados);
                    return;
                }

                console.log(`Cache local para ${dataIsoAtual} expirado. Exibindo dados enquanto atualiza.`);
                aplicarDadosCarregados(infoCache.dados, { manterIndicadorCarregamento: true });
                togglePlanejamentoLoading(true);
                usandoCacheExpirado = true;
            } else {
                estado.planejamentoLinhas = [];
                try {
                    renderPlanejamento();
                } catch (err) {
                    console.warn('Não foi possível atualizar visual do planejamento imediatamente:', err);
                }
            }

            if (isLoading) {
                pendingReload = true;
                togglePlanejamentoLoading(true);
                return;
            }
            isLoading = true;
            pendingReload = false;
            if (usandoCacheExpirado) {
                // Mantém o conteúdo visível enquanto atualiza em segundo plano
                togglePlanejamentoLoading(true);
            } else {
                mostrarLoading();
            }

            const diaSolicitado = dataIsoAtual;

            executarGoogleScript({
                funcao: 'getDadosCompletos',
                parametros: [diaSolicitado],
                tentativas: 1,
                onSuccess(dados) {
                    console.log('Dados recebidos do server:', dados);
                    salvarCacheDia(diaSolicitado, dados);
                    // Libera o estado de carregamento antes de atualizar as views para garantir
                    // que componentes como o planejamento sejam renderizados com os dados recebidos.
                    isLoading = false;
                    aplicarDadosCarregados(dados);
                    console.log('Loading escondido - Verificando se monitor está visível');
                    prefetchDiasAdjacentes(diaSolicitado);
                    if (pendingReload) {
                        pendingReload = false;
                        carregarDados();
                    }
                },
                onFailure(error) {
                    console.error('Erro ao carregar dados:', error);
                    if (!tinhaDadosEmCache) {
                        alert('Erro ao carregar dados do sistema.');
                    }
                    esconderLoading();
                    const deveRecarregar = pendingReload;
                    pendingReload = false;
                    isLoading = false;
                    if (deveRecarregar) {
                        carregarDados();
                    }
                }
            });
        }

        function mostrarLoading() {
            document.getElementById('loading-monitor').style.display = 'block';
            document.getElementById('monitor-content').style.display = 'none';
            togglePlanejamentoLoading(true);
        }

        function esconderLoading() {
            document.getElementById('loading-monitor').style.display = 'none';
            document.getElementById('monitor-content').style.display = 'flex';
            togglePlanejamentoLoading(false);
        }

        function carregarDadosMestres() {
            executarGoogleScript({
                funcao: 'getDadosMestres',
                tentativas: 1,
                onSuccess(dados) {
                    estado.dadosMestres = dados;
                    preencherFiltros();
                    setupMultiselectListeners();
                    preencherFormularios();
                    const opcoes = preencherRelatorioFiltros();
                    preencherDashboardFiltros(opcoes);
                    preencherSalaMesFiltros(opcoes);
                    registrarEventosFiltrosEspecificos();
                },
                onFailure(error) {
                    console.error('Erro ao carregar dados mestres:', error);
                    alert('Erro ao carregar dados do sistema.');
                }
            });
        }

        function preencherFiltros() {
            // Especialidades
            const espOptions = document.getElementById('filter-especialidade-options');
            espOptions.innerHTML = '';
            estado.dadosMestres.especialidades.forEach(esp => {
                const label = document.createElement('label');
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = esp;
                label.appendChild(input);
                label.appendChild(document.createTextNode(esp));
                espOptions.appendChild(label);
            });

            // Categorias
            const catOptions = document.getElementById('filter-categoria-options');
            catOptions.innerHTML = '';
            estado.dadosMestres.categorias.forEach(cat => {
                const label = document.createElement('label');
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = cat;
                label.appendChild(input);
                label.appendChild(document.createTextNode(cat));
                catOptions.appendChild(label);
            });

            // Ilhas
            const ilhaOptions = document.getElementById('filter-ilha-options');
            ilhaOptions.innerHTML = '';
            estado.dadosMestres.ilhas.forEach(ilha => {
                const label = document.createElement('label');
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = ilha;
                label.appendChild(input);
                label.appendChild(document.createTextNode(`Ilha ${ilha}`));
                ilhaOptions.appendChild(label);
            });

            // Status (fixo)
            const statusOptions = document.getElementById('filter-status-options');
            statusOptions.innerHTML = `
                <label><input type="checkbox" value="livre"> Livre</label>
                <label><input type="checkbox" value="ocupado"> Ocupado</label>
                <label><input type="checkbox" value="bloqueado"> Bloqueado</label>
                <label><input type="checkbox" value="reservado"> Reservado</label>
            `;

            const statusPadrao = Array.isArray(estado.filtros.status) && estado.filtros.status.length > 0
                ? estado.filtros.status
                : ['ocupado'];
            statusPadrao.forEach(valor => {
                const input = statusOptions.querySelector(`input[value="${valor}"]`);
                if (input) input.checked = true;
            });
            estado.filtros.status = [...statusPadrao];
            const statusBtn = document.querySelector('#filter-status-multi .multiselect-btn');
            if (statusBtn) {
                if (statusPadrao.length === 0) {
                    statusBtn.textContent = 'Todos os status';
                } else if (statusPadrao.length === 1) {
                    statusBtn.textContent = formatarStatusLabel(statusPadrao[0]) || '1 selecionado';
                } else {
                    statusBtn.textContent = `${statusPadrao.length} selecionados`;
                }
            }
        }

        function corrigirOrtografiaProfissionais(texto) {
            if (typeof texto !== 'string') return texto;
            return texto.replace(/profissionals/gi, 'profissionais').replace(/professionals/gi, 'profissionais');
        }

        function atualizarReportMultiselect(selectId, opcoes) {
            const select = document.getElementById(selectId);
            const container = document.querySelector(`.report-multiselect[data-select-id="${selectId}"]`);
            if (!select || !container) {
                return;
            }

            const placeholder = corrigirOrtografiaProfissionais(container.dataset.placeholder || 'Selecionar');
            const button = container.querySelector('.report-multiselect-btn');
            const panel = container.querySelector('.report-multiselect-panel');
            const optionsWrapper = container.querySelector('.report-multiselect-options');

            const obterSelecionados = () => Array.from(select.options).filter(opt => opt.selected).map(opt => opt.value);

            const atualizarBotao = () => {
                const selecionados = obterSelecionados();
                if (selecionados.length === 0) {
                    button.textContent = placeholder;
                } else if (selecionados.length === 1) {
                    const item = Array.isArray(opcoes)
                        ? opcoes.find(opcao => opcao.value === selecionados[0])
                        : null;
                    button.textContent = corrigirOrtografiaProfissionais(item ? item.label : `${selecionados.length} selecionado`);
                } else {
                    button.textContent = corrigirOrtografiaProfissionais(`${selecionados.length} selecionados`);
                }
            };

            optionsWrapper.innerHTML = '';
            if (!opcoes || opcoes.length === 0) {
                const vazio = document.createElement('div');
                vazio.className = 'report-multiselect-empty';
                vazio.textContent = 'Nenhuma opção disponível.';
                optionsWrapper.appendChild(vazio);
            } else {
                opcoes.forEach(({ value, label }) => {
                    const checkboxId = `${selectId}-${value}`.replace(/[^a-zA-Z0-9_-]/g, '_');
                    const linha = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.value = value;
                    input.id = checkboxId;
                    input.checked = Array.from(select.options).some(opt => opt.value === value && opt.selected);
                    const texto = document.createElement('span');
                    texto.textContent = corrigirOrtografiaProfissionais(label);
                    linha.appendChild(input);
                    linha.appendChild(texto);
                    optionsWrapper.appendChild(linha);

                    input.addEventListener('change', () => {
                        const option = Array.from(select.options).find(opt => opt.value === value);
                        if (option) {
                            option.selected = input.checked;
                        }
                        atualizarBotao();
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });
            }

            if (!container.dataset.initialized) {
                button.addEventListener('click', e => {
                    e.stopPropagation();
                    const estavaAberto = panel.classList.contains('open');
                    document.querySelectorAll('.report-multiselect-panel').forEach(outroPainel => outroPainel.classList.remove('open'));
                    document.querySelectorAll('.report-multiselect-btn').forEach(outroBotao => outroBotao.classList.remove('open'));
                    if (!estavaAberto) {
                        panel.classList.add('open');
                        button.classList.add('open');
                    }
                });

                const botoesAcao = panel.querySelectorAll('.report-multiselect-actions button');
                botoesAcao.forEach(botao => {
                    botao.addEventListener('click', () => {
                        const acao = botao.dataset.action;
                        const checkboxes = panel.querySelectorAll('.report-multiselect-options input[type="checkbox"]');
                        if (acao === 'select-all') {
                            checkboxes.forEach(cb => {
                                cb.checked = true;
                                const option = Array.from(select.options).find(opt => opt.value === cb.value);
                                if (option) option.selected = true;
                            });
                        } else if (acao === 'clear') {
                            checkboxes.forEach(cb => {
                                cb.checked = false;
                                const option = Array.from(select.options).find(opt => opt.value === cb.value);
                                if (option) option.selected = false;
                            });
                        }
                        atualizarBotao();
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });

                container.dataset.initialized = 'true';
            }

            atualizarBotao();
        }

        function definirRelatorioOpcoes(selectId, valores) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const selecionados = new Set(Array.from(select.selectedOptions || []).map(opt => opt.value));
            select.innerHTML = '';
            (valores || []).forEach(({ value, label }) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = corrigirOrtografiaProfissionais(label);
                if (selecionados.has(value)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            atualizarReportMultiselect(selectId, valores);
        }

        function definirOpcaoStatusMapa(selectId, valores) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const valorAtual = select.value;
            select.innerHTML = '';
            const lista = Array.isArray(valores) && valores.length ? valores : [{ value: 'livre', label: 'Livre' }];
            lista.forEach(({ value, label }) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = corrigirOrtografiaProfissionais(label);
                select.appendChild(option);
            });
            if (valorAtual && lista.some(item => item.value === valorAtual)) {
                select.value = valorAtual;
            }
        }

        function obterOpcoesFiltroComuns() {
            const turnos = [
                { value: 'manha', label: 'Manhã' },
                { value: 'tarde', label: 'Tarde' },
                { value: 'noite', label: 'Noite' },
                { value: 'todos', label: 'Todos os turnos' }
            ];

            const statusSet = new Set(['ocupado', 'reservado', 'bloqueado', 'livre', 'manutencao', 'cancelado']);
            estado.agendamentos.forEach(ag => {
                if (ag.statusNormalizado) {
                    statusSet.add(ag.statusNormalizado);
                }
            });
            const statusValores = Array.from(statusSet)
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }))
                .map(status => ({ value: status, label: formatarStatusLabel(status) }));

            const ilhasSet = new Set();
            (estado.dadosMestres.ilhas || []).forEach(ilha => {
                if (ilha !== undefined && ilha !== null && `${ilha}`.trim()) {
                    ilhasSet.add(String(ilha).trim());
                }
            });
            estado.salas.forEach(sala => {
                if (sala.ilha !== undefined && sala.ilha !== null && `${sala.ilha}`.trim()) {
                    ilhasSet.add(String(sala.ilha).trim());
                }
            });
            const ilhasLista = Array.from(ilhasSet)
                .filter(Boolean)
                .sort(ordenarAlphaNumerico)
                .map(ilha => ({ value: ilha, label: `Ilha ${ilha}` }));

            const salasSet = new Set();
            estado.salas.forEach(sala => {
                if (sala.numero !== undefined && sala.numero !== null && `${sala.numero}`.trim()) {
                    salasSet.add(String(sala.numero).trim());
                }
            });
            estado.agendamentos.forEach(ag => {
                if (ag.sala !== undefined && ag.sala !== null && `${ag.sala}`.trim()) {
                    salasSet.add(String(ag.sala).trim());
                }
            });
            const salasLista = Array.from(salasSet)
                .filter(Boolean)
                .sort(ordenarAlphaNumerico)
                .map(numero => ({ value: numero, label: `Sala ${numero}` }));

            const especialidadeMap = new Map();
            (estado.dadosMestres.especialidades || []).forEach(esp => {
                const chave = normalizarTexto(esp);
                if (chave && !especialidadeMap.has(chave)) {
                    especialidadeMap.set(chave, esp);
                }
            });
            estado.agendamentos.forEach(ag => {
                const esp = ag.especialidade;
                const chave = normalizarTexto(esp);
                if (chave && !especialidadeMap.has(chave)) {
                    especialidadeMap.set(chave, esp);
                }
            });
            const especialidadesLista = Array.from(especialidadeMap.values())
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }))
                .map(esp => ({ value: esp, label: esp }));

            const categoriaMap = new Map();
            (estado.dadosMestres.categorias || []).forEach(cat => {
                const chave = normalizarTexto(cat);
                if (chave && !categoriaMap.has(chave)) {
                    categoriaMap.set(chave, cat);
                }
            });
            estado.agendamentos.forEach(ag => {
                const cat = ag.categoria;
                const chave = normalizarTexto(cat);
                if (chave && !categoriaMap.has(chave)) {
                    categoriaMap.set(chave, cat);
                }
            });
            const categoriasLista = Array.from(categoriaMap.values())
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }))
                .map(cat => ({ value: cat, label: cat }));

            const profissionaisSet = new Set();
            estado.agendamentos.forEach(ag => {
                const profissional = (ag.profissional || '').trim();
                if (profissional) {
                    profissionaisSet.add(profissional);
                }
            });
            const profissionaisLista = Array.from(profissionaisSet)
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }))
                .map(nome => ({ value: nome, label: nome }));

            return {
                turnos,
                status: statusValores,
                ilhas: ilhasLista,
                salas: salasLista,
                especialidades: especialidadesLista,
                categorias: categoriasLista,
                profissionais: profissionaisLista
            };
        }

        function aplicarOpcoesFiltros(prefixo, opcoes) {
            if (!opcoes) return;
            definirRelatorioOpcoes(`${prefixo}-filtro-turno`, opcoes.turnos);
            definirRelatorioOpcoes(`${prefixo}-filtro-status`, opcoes.status);
            definirRelatorioOpcoes(`${prefixo}-filtro-ilha`, opcoes.ilhas);
            definirRelatorioOpcoes(`${prefixo}-filtro-sala`, opcoes.salas);
            definirRelatorioOpcoes(`${prefixo}-filtro-especialidade`, opcoes.especialidades);
            definirRelatorioOpcoes(`${prefixo}-filtro-categoria`, opcoes.categorias);
            definirRelatorioOpcoes(`${prefixo}-filtro-profissional`, opcoes.profissionais);
        }

        function preencherRelatorioFiltros() {
            const opcoes = obterOpcoesFiltroComuns();
            aplicarOpcoesFiltros('relatorio', opcoes);
            return opcoes;
        }

        function preencherDashboardFiltros(opcoesExistentes) {
            const opcoes = opcoesExistentes || obterOpcoesFiltroComuns();
            aplicarOpcoesFiltros('dashboard', opcoes);
            atualizarDashboardPeriodoOpcoes();
        }

        function preencherSalaMesFiltros(opcoesExistentes) {
            const opcoes = opcoesExistentes || obterOpcoesFiltroComuns();
            definirRelatorioOpcoes('sala-mes-filtro-turno', opcoes.turnos);
            definirRelatorioOpcoes('sala-mes-filtro-status', opcoes.status);
            definirRelatorioOpcoes('sala-mes-filtro-especialidade', opcoes.especialidades);
            definirRelatorioOpcoes('sala-mes-filtro-categoria', opcoes.categorias);
            definirRelatorioOpcoes('sala-mes-filtro-profissional', opcoes.profissionais);
            definirOpcaoStatusMapa('sala-mes-status-visualizacao', opcoes.status);
        }

        const NOMES_MESES_PT = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        function formatarMesHumano(valor) {
            if (typeof valor !== 'string' || valor.length < 7) {
                return valor || '';
            }
            const [ano, mes] = valor.split('-');
            if (!ano || !mes) {
                return valor;
            }
            const indice = Math.max(Math.min(Number(mes) - 1, NOMES_MESES_PT.length - 1), 0);
            const nome = NOMES_MESES_PT[indice] || `Mês ${mes}`;
            return `${nome} ${ano}`;
        }

        function obterMesAtualValor() {
            const base = estado.dataAtual instanceof Date ? new Date(estado.dataAtual) : new Date();
            const ano = base.getFullYear();
            const mes = String(base.getMonth() + 1).padStart(2, '0');
            return `${ano}-${mes}`;
        }

        function gerarOpcoesMeses() {
            const mesesSet = new Set();
            (estado.agendamentos || []).forEach(ag => {
                obterDatasDoAgendamento(ag).forEach(dataIso => {
                    if (typeof dataIso !== 'string' || dataIso.length < 7) return;
                    const partes = dataIso.split('-');
                    if (partes.length < 2) return;
                    const ano = partes[0];
                    const mes = partes[1];
                    if (/^\d{4}$/.test(ano) && /^\d{2}$/.test(mes)) {
                        mesesSet.add(`${ano}-${mes}`);
                    }
                });
            });

            if (!mesesSet.size) {
                mesesSet.add(obterMesAtualValor());
            }

            return Array.from(mesesSet)
                .filter(Boolean)
                .sort()
                .map(valor => {
                    const [ano, mes] = valor.split('-');
                    const indiceMes = Math.max(Math.min(Number(mes) - 1, 11), 0);
                    const nomeMes = NOMES_MESES_PT[indiceMes] || `Mês ${mes}`;
                    return { value: valor, label: `${nomeMes} ${ano}` };
                });
        }

        function gerarOpcoesAnos() {
            const anosSet = new Set();
            (estado.agendamentos || []).forEach(ag => {
                obterDatasDoAgendamento(ag).forEach(dataIso => {
                    if (typeof dataIso !== 'string' || dataIso.length < 4) return;
                    const ano = dataIso.slice(0, 4);
                    if (/^\d{4}$/.test(ano)) {
                        anosSet.add(ano);
                    }
                });
            });

            if (!anosSet.size) {
                const anoAtual = (estado.dataAtual instanceof Date ? estado.dataAtual.getFullYear() : new Date().getFullYear());
                anosSet.add(String(anoAtual));
            }

            return Array.from(anosSet)
                .filter(Boolean)
                .sort()
                .map(ano => ({ value: String(ano), label: String(ano) }));
        }

        function gerarOpcoesSemanas() {
            return [1, 2, 3, 4, 5].map(numero => ({
                value: String(numero),
                label: `Semana ${numero}`
            }));
        }

        function aplicarSelecaoReportMultiselect(selectId, valoresSelecionados) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const conjunto = new Set((valoresSelecionados || []).map(valor => String(valor)));
            Array.from(select.options || []).forEach(option => {
                option.selected = conjunto.size ? conjunto.has(option.value) : false;
            });

            const opcoesAtuais = Array.from(select.options || []).map(option => ({
                value: option.value,
                label: option.textContent || option.value
            }));

            atualizarReportMultiselect(selectId, opcoesAtuais);
        }

        function sincronizarDashboardPeriodoValores() {
            aplicarSelecaoReportMultiselect('dashboard-periodo-meses', estado.dashboardMesesSelecionados);
            aplicarSelecaoReportMultiselect('dashboard-periodo-semana-meses', estado.dashboardSemanaMesesSelecionados);
            aplicarSelecaoReportMultiselect('dashboard-periodo-semanas', estado.dashboardSemanasSelecionadas);
            aplicarSelecaoReportMultiselect('dashboard-periodo-anos', estado.dashboardAnosSelecionados);
        }

        function atualizarDashboardPeriodoOpcoes() {
            const meses = gerarOpcoesMeses();
            const semanas = gerarOpcoesSemanas();
            const anos = gerarOpcoesAnos();

            definirRelatorioOpcoes('dashboard-periodo-meses', meses);
            definirRelatorioOpcoes('dashboard-periodo-semana-meses', meses);
            definirRelatorioOpcoes('dashboard-periodo-semanas', semanas);
            definirRelatorioOpcoes('dashboard-periodo-anos', anos);
            definirRelatorioOpcoes('dashboard-comparar-meses', meses);
            definirRelatorioOpcoes('dashboard-comparar-anos', anos);
            definirRelatorioOpcoes('relatorio-comparar-meses', meses);
            definirRelatorioOpcoes('relatorio-comparar-anos', anos);

            if (!Array.isArray(estado.dashboardMesesSelecionados) || !estado.dashboardMesesSelecionados.length) {
                if (meses.length) {
                    const valorPadrao = meses.find(opcao => opcao.value === obterMesAtualValor())
                        || meses[meses.length - 1];
                    estado.dashboardMesesSelecionados = valorPadrao ? [valorPadrao.value] : [];
                }
            }

            if (!Array.isArray(estado.dashboardSemanaMesesSelecionados) || !estado.dashboardSemanaMesesSelecionados.length) {
                if (meses.length) {
                    const valorPadrao = meses.find(opcao => opcao.value === obterMesAtualValor())
                        || meses[meses.length - 1];
                    estado.dashboardSemanaMesesSelecionados = valorPadrao ? [valorPadrao.value] : [];
                }
            }

            if (!Array.isArray(estado.dashboardSemanasSelecionadas) || !estado.dashboardSemanasSelecionadas.length) {
                const semanaAtual = Math.min(Math.max(Math.ceil(((estado.dataAtual instanceof Date ? estado.dataAtual.getDate() : new Date().getDate())) / 7), 1), 5);
                estado.dashboardSemanasSelecionadas = [String(semanaAtual)];
            }

            if (!Array.isArray(estado.dashboardAnosSelecionados) || !estado.dashboardAnosSelecionados.length) {
                if (anos.length) {
                    const anoAtual = String(estado.dataAtual instanceof Date ? estado.dataAtual.getFullYear() : new Date().getFullYear());
                    const valorPadrao = anos.find(opcao => opcao.value === anoAtual) || anos[anos.length - 1];
                    estado.dashboardAnosSelecionados = valorPadrao ? [valorPadrao.value] : [];
                }
            }

            sincronizarDashboardPeriodoValores();
        }

        function inicializarDashboardPeriodoDetalhes() {
            const periodoSelect = document.getElementById('dashboard-periodo');
            const container = document.getElementById('dashboard-periodo-detalhes');
            if (!periodoSelect || !container) return;

            const limparLista = lista => (lista || []).map(item => String(item || '').trim()).filter(Boolean);

            const atualizarVisibilidade = () => {
                const periodoAtual = periodoSelect.value || 'dia';
                const mostrar = ['mes', 'semana', 'ano'].includes(periodoAtual);
                container.classList.toggle('active', mostrar);
                container.querySelectorAll('.dashboard-periodo-field').forEach(field => {
                    const periodos = (field.dataset.periodo || '')
                        .split(',')
                        .map(parte => parte.trim())
                        .filter(Boolean);
                    field.classList.toggle('active', mostrar && periodos.includes(periodoAtual));
                });
            };

            const garantirPadroes = periodoAtual => {
                if (periodoAtual === 'mes' && (!Array.isArray(estado.dashboardMesesSelecionados) || !estado.dashboardMesesSelecionados.length)) {
                    const selectMes = document.getElementById('dashboard-periodo-meses');
                    const opcoes = Array.from(selectMes ? selectMes.options : []);
                    const mesAtual = obterMesAtualValor();
                    const padrao = opcoes.find(opt => opt.value === mesAtual) || opcoes[opcoes.length - 1];
                    if (padrao) {
                        estado.dashboardMesesSelecionados = [padrao.value];
                    }
                } else if (periodoAtual === 'semana') {
                    const selectMesSemana = document.getElementById('dashboard-periodo-semana-meses');
                    if (!Array.isArray(estado.dashboardSemanaMesesSelecionados) || !estado.dashboardSemanaMesesSelecionados.length) {
                        const opcoesMes = Array.from(selectMesSemana ? selectMesSemana.options : []);
                        const mesAtual = obterMesAtualValor();
                        const padraoMes = opcoesMes.find(opt => opt.value === mesAtual) || opcoesMes[opcoesMes.length - 1];
                        if (padraoMes) {
                            estado.dashboardSemanaMesesSelecionados = [padraoMes.value];
                        }
                    }
                    if (!Array.isArray(estado.dashboardSemanasSelecionadas) || !estado.dashboardSemanasSelecionadas.length) {
                        const dataBase = estado.dataAtual instanceof Date ? new Date(estado.dataAtual) : new Date();
                        const semanaPadrao = Math.min(Math.max(Math.ceil(dataBase.getDate() / 7), 1), 5);
                        estado.dashboardSemanasSelecionadas = [String(semanaPadrao)];
                    }
                } else if (periodoAtual === 'ano' && (!Array.isArray(estado.dashboardAnosSelecionados) || !estado.dashboardAnosSelecionados.length)) {
                    const selectAno = document.getElementById('dashboard-periodo-anos');
                    const opcoesAno = Array.from(selectAno ? selectAno.options : []);
                    const anoAtual = String(estado.dataAtual instanceof Date ? estado.dataAtual.getFullYear() : new Date().getFullYear());
                    const padraoAno = opcoesAno.find(opt => opt.value === anoAtual) || opcoesAno[opcoesAno.length - 1];
                    if (padraoAno) {
                        estado.dashboardAnosSelecionados = [padraoAno.value];
                    }
                }

                sincronizarDashboardPeriodoValores();
            };

            if (periodoSelect.dataset.periodoDetalhesListeners !== 'true') {
                periodoSelect.addEventListener('change', () => {
                    const periodoAtual = periodoSelect.value || 'dia';
                    garantirPadroes(periodoAtual);
                    atualizarVisibilidade();
                    carregarDashboard();
                });
                periodoSelect.dataset.periodoDetalhesListeners = 'true';
            }

            const registrarListener = (id, atualizadorEstado) => {
                const select = document.getElementById(id);
                if (!select || select.dataset.periodoDetalhesListeners === 'true') return;
                select.addEventListener('change', () => {
                    atualizadorEstado();
                });
                select.dataset.periodoDetalhesListeners = 'true';
            };

            registrarListener('dashboard-periodo-meses', () => {
                estado.dashboardMesesSelecionados = limparLista(obterValoresMultiplo('dashboard-periodo-meses'));
                if ((periodoSelect.value || 'dia') === 'mes' && estado.dashboardMesesSelecionados.length) {
                    carregarDashboard();
                }
            });

            registrarListener('dashboard-periodo-semana-meses', () => {
                estado.dashboardSemanaMesesSelecionados = limparLista(obterValoresMultiplo('dashboard-periodo-semana-meses'));
                if ((periodoSelect.value || 'dia') === 'semana') {
                    const semanasAtual = limparLista(obterValoresMultiplo('dashboard-periodo-semanas'));
                    estado.dashboardSemanasSelecionadas = semanasAtual;
                    if (estado.dashboardSemanaMesesSelecionados.length && semanasAtual.length) {
                        carregarDashboard();
                    }
                }
            });

            registrarListener('dashboard-periodo-semanas', () => {
                estado.dashboardSemanasSelecionadas = limparLista(obterValoresMultiplo('dashboard-periodo-semanas'));
                if ((periodoSelect.value || 'dia') === 'semana' && estado.dashboardSemanasSelecionadas.length) {
                    const mesesAtual = limparLista(obterValoresMultiplo('dashboard-periodo-semana-meses'));
                    estado.dashboardSemanaMesesSelecionados = mesesAtual;
                    if (mesesAtual.length) {
                        carregarDashboard();
                    }
                }
            });

            registrarListener('dashboard-periodo-anos', () => {
                estado.dashboardAnosSelecionados = limparLista(obterValoresMultiplo('dashboard-periodo-anos'));
                if ((periodoSelect.value || 'dia') === 'ano' && estado.dashboardAnosSelecionados.length) {
                    carregarDashboard();
                }
            });

            garantirPadroes(periodoSelect.value || 'dia');
            atualizarVisibilidade();
        }

        function atualizarCamposComparacaoPainel(painel, tipoSelecionado) {
            if (!painel) return;
            painel.querySelectorAll('[data-comparar]').forEach(campo => {
                const tipos = (campo.dataset.comparar || '')
                    .split(',')
                    .map(item => item.trim())
                    .filter(Boolean);
                const visivel = tipoSelecionado && tipos.includes(tipoSelecionado);
                campo.style.display = visivel ? 'flex' : 'none';
            });
        }

        function coletarConfiguracaoComparacaoDashboard() {
            const tipoSelect = document.getElementById('dashboard-comparar-tipo');
            if (!tipoSelect) return null;
            const tipo = tipoSelect.value;
            if (!tipo) {
                alert('Selecione o tipo de período para comparar.');
                return null;
            }

            if (tipo === 'dia') {
                const dia = document.getElementById('dashboard-comparar-dia')?.value;
                if (!dia) {
                    alert('Escolha o dia que deseja utilizar na comparação.');
                    return null;
                }
                return { tipo: 'dia', dia, descricao: `Dia ${formatarDataCompleta(dia)}` };
            }

            if (tipo === 'intervalo') {
                const inicio = document.getElementById('dashboard-comparar-inicio')?.value;
                const fim = document.getElementById('dashboard-comparar-fim')?.value;
                if (!inicio || !fim) {
                    alert('Informe as datas inicial e final para comparar.');
                    return null;
                }
                if (inicio > fim) {
                    alert('No comparativo do dashboard a data inicial não pode ser maior que a final.');
                    return null;
                }
                return {
                    tipo: 'intervalo',
                    inicio,
                    fim,
                    descricao: `De ${formatarDataCompleta(inicio)} até ${formatarDataCompleta(fim)}`
                };
            }

            if (tipo === 'mes') {
                const meses = obterValoresMultiplo('dashboard-comparar-meses');
                if (!meses.length) {
                    alert('Selecione ao menos um mês para comparar.');
                    return null;
                }
                const descricao = meses.map(formatarMesHumano).join(', ');
                return { tipo: 'mes', meses, descricao: `Meses: ${descricao}` };
            }

            if (tipo === 'ano') {
                const anos = obterValoresMultiplo('dashboard-comparar-anos');
                if (!anos.length) {
                    alert('Selecione ao menos um ano para comparar.');
                    return null;
                }
                return { tipo: 'ano', anos, descricao: `Ano(s): ${anos.join(', ')}` };
            }

            alert('Tipo de comparação do dashboard não reconhecido.');
            return null;
        }

        function obterDashboardComparativoPayload(filtrosBase) {
            if (!estado.dashboardComparacaoAtiva || !estado.dashboardComparativoConfig) {
                return null;
            }
            const config = estado.dashboardComparativoConfig;
            const filtros = JSON.parse(JSON.stringify(filtrosBase || {}));
            filtros.diasEspecificos = [];
            filtros.intervaloDias = null;
            filtros.meses = [];
            filtros.semanas = [];
            filtros.anos = [];

            let periodo = 'dia';
            if (config.tipo === 'dia') {
                filtros.diasEspecificos = [config.dia];
                periodo = 'dia';
            } else if (config.tipo === 'intervalo') {
                filtros.intervaloDias = { inicio: config.inicio, fim: config.fim };
                periodo = 'dia';
            } else if (config.tipo === 'mes') {
                filtros.meses = Array.isArray(config.meses) ? [...config.meses] : [];
                periodo = 'mes';
            } else if (config.tipo === 'ano') {
                filtros.anos = Array.isArray(config.anos) ? config.anos.map(ano => parseInt(ano, 10)).filter(Number.isFinite) : [];
                periodo = 'ano';
            }

            return {
                periodo,
                filtros,
                descricao: config.descricao || ''
            };
        }

        function removerDashboardComparacao({ recarregar = true } = {}) {
            estado.dashboardComparacaoAtiva = false;
            estado.dashboardComparativoConfig = null;
            estado.dashboardComparativoDados = null;
            estado.dashboardComparativoInfo = null;
            const banner = document.getElementById('dashboard-comparativo-resumo');
            if (banner) {
                banner.classList.remove('active');
            }
            if (recarregar) {
                carregarDashboard();
            } else {
                atualizarDashboardComparativoResumo(null, null);
            }
        }

        function inicializarDashboardComparacaoUI() {
            const painel = document.getElementById('dashboard-comparar-panel');
            const tipoSelect = document.getElementById('dashboard-comparar-tipo');
            const botaoToggle = document.getElementById('btn-dashboard-comparar');
            const botaoAplicar = document.getElementById('dashboard-comparar-aplicar');
            const botaoLimpar = document.getElementById('dashboard-comparar-limpar');
            const botaoRemover = document.getElementById('dashboard-comparativo-remover');
            if (!painel || !tipoSelect || !botaoToggle) {
                return;
            }

            const atualizarCampos = () => {
                atualizarCamposComparacaoPainel(painel, tipoSelect.value);
            };

            botaoToggle.addEventListener('click', () => {
                painel.classList.toggle('active');
            });

            tipoSelect.addEventListener('change', atualizarCampos);
            atualizarCampos();

            if (botaoAplicar) {
                botaoAplicar.addEventListener('click', () => {
                    const config = coletarConfiguracaoComparacaoDashboard();
                    if (!config) return;
                    estado.dashboardComparacaoAtiva = true;
                    estado.dashboardComparativoConfig = config;
                    estado.dashboardComparativoInfo = { descricao: config.descricao };
                    painel.classList.remove('active');
                    carregarDashboard();
                });
            }

            const limparInterface = () => {
                tipoSelect.value = '';
                painel.querySelectorAll('input[type="date"]').forEach(input => { input.value = ''; });
                painel.querySelectorAll('select[multiple]').forEach(select => {
                    Array.from(select.options).forEach(option => { option.selected = false; });
                    atualizarReportMultiselect(select.id, Array.from(select.options).map(option => ({ value: option.value, label: option.textContent })));
                });
                atualizarCampos();
            };

            if (botaoLimpar) {
                botaoLimpar.addEventListener('click', () => {
                    limparInterface();
                    removerDashboardComparacao({ recarregar: true });
                    painel.classList.remove('active');
                });
            }

            if (botaoRemover) {
                botaoRemover.addEventListener('click', () => {
                    limparInterface();
                    removerDashboardComparacao({ recarregar: true });
                });
            }
        }

        function registrarEventosFiltrosEspecificos() {
            const dashboardFiltros = document.getElementById('dashboard-filtros');
            if (dashboardFiltros && dashboardFiltros.dataset.listenersAttached !== 'true') {
                dashboardFiltros.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', () => {
                        carregarDashboard();
                    });
                });
                dashboardFiltros.dataset.listenersAttached = 'true';
            }

            const salaMesFiltros = document.getElementById('sala-mes-filtros');
            if (salaMesFiltros && salaMesFiltros.dataset.listenersAttached !== 'true') {
                salaMesFiltros.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', () => {
                        definirSalaMesPendencia(true);
                    });
                });
                salaMesFiltros.dataset.listenersAttached = 'true';
            }
        }

        function setupMultiselectListeners() {
            document.querySelectorAll('.multiselect-options input').forEach(cb => {
                cb.addEventListener('change', function() {
                    const multi = this.closest('.multiselect');
                    const id = multi.id;
                    let key;
                    let todosText;
                    if (id === 'filter-especialidade-multi') {
                        key = 'especialidade';
                        todosText = 'Todas as especialidades';
                    } else if (id === 'filter-categoria-multi') {
                        key = 'categoria';
                        todosText = 'Todas as categorias';
                    } else if (id === 'filter-status-multi') {
                        key = 'status';
                        todosText = 'Todos os status';
                    } else if (id === 'filter-ilha-multi') {
                        key = 'ilha';
                        todosText = 'Todas as ilhas';
                    }
                    const selected = Array.from(multi.querySelectorAll('input:checked')).map(c => c.value);
                    estado.filtros[key] = selected;
                    const btn = multi.querySelector('.multiselect-btn');
                    btn.textContent = selected.length === 0 ? todosText : `${selected.length} selecionados`;
                    aplicarFiltros();
                });
            });
        }

        function preencherFormularios() {
            const especialidadeSelect = document.getElementById('cadastro-especialidade');
            const categoriaSelect = document.getElementById('cadastro-categoria');
            const ilhaSelect = document.getElementById('cadastro-ilha');
            
            // Limpar opções existentes
            especialidadeSelect.innerHTML = '<option value="">Selecione uma especialidade</option>';
            categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            ilhaSelect.innerHTML = '<option value="">Selecione uma ilha</option>';
            
            // Preencher especialidades
            estado.dadosMestres.especialidades.forEach(esp => {
                const option = document.createElement('option');
                option.value = esp;
                option.textContent = esp;
                especialidadeSelect.appendChild(option);
            });
            
            // Preencher categorias
            estado.dadosMestres.categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoriaSelect.appendChild(option);
            });
            
            // Preencher ilhas
            estado.dadosMestres.ilhas.forEach(ilha => {
                const option = document.createElement('option');
                option.value = ilha;
                option.textContent = `Ilha ${ilha}`;
                ilhaSelect.appendChild(option);
            });

            const planejamentoEspecialidade = document.getElementById('planejamento-inserir-especialidade');
            if (planejamentoEspecialidade) {
                planejamentoEspecialidade.innerHTML = '<option value="">Selecione uma especialidade</option>';
                estado.dadosMestres.especialidades.forEach(esp => {
                    const option = document.createElement('option');
                    option.value = esp;
                    option.textContent = esp;
                    planejamentoEspecialidade.appendChild(option);
                });
            }

            const planejamentoCategoria = document.getElementById('planejamento-inserir-categoria');
            if (planejamentoCategoria) {
                planejamentoCategoria.innerHTML = '<option value="">Selecione uma categoria</option>';
                estado.dadosMestres.categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    planejamentoCategoria.appendChild(option);
                });
            }

            const planejamentoIlha = document.getElementById('planejamento-inserir-ilha');
            if (planejamentoIlha) {
                planejamentoIlha.innerHTML = '<option value="">Selecione uma ilha</option>';
                estado.dadosMestres.ilhas.forEach(ilha => {
                    const option = document.createElement('option');
                    option.value = ilha;
                    option.textContent = `Ilha ${ilha}`;
                    planejamentoIlha.appendChild(option);
                });
            }

            const editarEspecialidade = document.getElementById('editar-especialidade');
            const editarCategoria = document.getElementById('editar-categoria');
            if (editarEspecialidade) {
                editarEspecialidade.innerHTML = '<option value="">Selecione</option>';
                estado.dadosMestres.especialidades.forEach(esp => {
                    const option = document.createElement('option');
                    option.value = esp;
                    option.textContent = esp;
                    editarEspecialidade.appendChild(option);
                });
            }
            if (editarCategoria) {
                editarCategoria.innerHTML = '<option value="">Selecione</option>';
                estado.dadosMestres.categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    editarCategoria.appendChild(option);
                });
            }
        }

        function configurarEventListeners() {
            document.querySelectorAll('[data-filter-toggle]').forEach(botao => {
                const alvoId = botao.getAttribute('data-filter-toggle');
                const alvo = document.getElementById(alvoId);
                if (!alvo) return;

                const icone = botao.querySelector('i');
                const label = botao.querySelector('.filter-toggle-label');
                const textoExpandido = botao.dataset.expandedText || 'Ocultar filtros';
                const textoRecolhido = botao.dataset.collapsedText || 'Mostrar filtros';

                const atualizarVisual = recolhido => {
                    botao.setAttribute('aria-expanded', recolhido ? 'false' : 'true');
                    if (icone) {
                        icone.className = recolhido ? 'fas fa-eye' : 'fas fa-eye-slash';
                    }
                    if (label) {
                        label.textContent = recolhido ? textoRecolhido : textoExpandido;
                    }
                };

                atualizarVisual(false);

                botao.addEventListener('click', () => {
                    const recolhido = alvo.classList.toggle('is-collapsed');
                    if (recolhido) {
                        alvo.querySelectorAll('.report-multiselect-panel').forEach(panel => panel.classList.remove('open'));
                        alvo.querySelectorAll('.report-multiselect-btn').forEach(btn => btn.classList.remove('open'));
                    }
                    atualizarVisual(recolhido);
                });
            });

            // Seletor de turno
            document.querySelectorAll('.turno-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.turno-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    estado.turnoAtual = this.getAttribute('data-turno');
                    estado.planejamentoTurno = estado.turnoAtual === 'todos' ? 'todos' : estado.turnoAtual;
                    atualizarMonitor();
                    atualizarIndicadores();
                    atualizarPlanejamento();
                });
            });

            // Novo toggle para visualização simplificada
            document.getElementById('toggle-simplificada').addEventListener('click', function() {
                estado.visualizacaoSimplificada = !estado.visualizacaoSimplificada;
                this.classList.toggle('active');
                this.textContent = estado.visualizacaoSimplificada ? 'Ativado' : 'Desativado';
                atualizarMonitor();
            });

            // Configurar multiselect buttons
            document.querySelectorAll('.multiselect-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const options = this.nextElementSibling;
                    const isOpen = options.style.display === 'block';

                    document.querySelectorAll('.multiselect-options').forEach(opt => {
                        opt.style.display = 'none';
                        if (opt.previousElementSibling) {
                            opt.previousElementSibling.classList.remove('open');
                        }
                    });

                    if (!isOpen) {
                        options.style.display = 'block';
                        this.classList.add('open');
                    } else {
                        this.classList.remove('open');
                    }
                });
            });

            // Fechar multiselect ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.multiselect')) {
                    document.querySelectorAll('.multiselect-options').forEach(opt => {
                        opt.style.display = 'none';
                        if (opt.previousElementSibling) {
                            opt.previousElementSibling.classList.remove('open');
                        }
                    });
                }
                if (!e.target.closest('.report-multiselect')) {
                    document.querySelectorAll('.report-multiselect-panel').forEach(panel => panel.classList.remove('open'));
                    document.querySelectorAll('.report-multiselect-btn').forEach(btn => btn.classList.remove('open'));
                }
            });

            // Modal de detalhes da sala
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = btn.closest('.modal');
                    if (!modal) return;
                    if (modal.id === 'planejamento-frequencia-modal') {
                        fecharModalPlanejamentoFrequencia();
                    } else if (modal.id === 'planejamento-registro-rapido-modal') {
                        fecharPlanejamentoRegistroRapido();
                    } else if (modal.id === 'chart-modal') {
                        fecharChartModal();
                    } else if (modal.id === 'planejamento-inserir-modal') {
                        definirPlanejamentoInserirProcessando(false);
                        const salvarBtn = document.querySelector('#form-planejamento-inserir button[type="submit"]');
                        if (salvarBtn) salvarBtn.disabled = false;
                        modal.style.display = 'none';
                    } else if (modal.id === 'editar-modal') {
                        modal.style.display = 'none';
                        planejamentoEdicaoFila = null;
                        atualizarEditarModalContexto();
                    } else {
                        modal.style.display = 'none';
                    }
                });
            });

            // Botão de cadastro
            document.getElementById('btn-cadastro').addEventListener('click', function() {
                abrirModalCadastro();
            });

            // Botão de bloqueio
            document.getElementById('btn-bloquear').addEventListener('click', function() {
                abrirModalBloqueio();
            });

            const planejamentoAdicionarBtn = document.getElementById('planejamento-adicionar');
            if (planejamentoAdicionarBtn) {
                planejamentoAdicionarBtn.addEventListener('click', function() {
                    abrirModalPlanejamentoInserir();
                });
            }

            const planejamentoEditarSelecionadosBtn = document.getElementById('planejamento-editar-selecionados');
            if (planejamentoEditarSelecionadosBtn) {
                planejamentoEditarSelecionadosBtn.addEventListener('click', function() {
                    const selecionados = Array.from(obterPlanejamentoSelecionadosSet());
                    if (!selecionados.length) {
                        return;
                    }
                    iniciarPlanejamentoEdicao(selecionados);
                });
            }

            // Botões cancelar
            document.getElementById('btn-cancelar').addEventListener('click', function() {
                document.getElementById('cadastro-modal').style.display = 'none';
            });

            document.getElementById('btn-cancelar-bloqueio').addEventListener('click', function() {
                document.getElementById('bloqueio-modal').style.display = 'none';
            });

            const planejamentoCancelarBtn = document.getElementById('planejamento-inserir-cancelar');
            if (planejamentoCancelarBtn) {
                planejamentoCancelarBtn.addEventListener('click', function() {
                    mostrarPlanejamentoInserirAlerta('');
                    definirPlanejamentoInserirProcessando(false);
                    const salvarBtn = document.querySelector('#form-planejamento-inserir button[type="submit"]');
                    if (salvarBtn) salvarBtn.disabled = false;
                    document.getElementById('planejamento-inserir-modal').style.display = 'none';
                });
            }

            const planejamentoFrequenciaCancelar = document.getElementById('planejamento-frequencia-cancelar');
            if (planejamentoFrequenciaCancelar) {
                planejamentoFrequenciaCancelar.addEventListener('click', () => {
                    fecharModalPlanejamentoFrequencia();
                });
            }

            const planejamentoFrequenciaForm = document.getElementById('form-planejamento-frequencia');
            if (planejamentoFrequenciaForm) {
                planejamentoFrequenciaForm.addEventListener('submit', salvarPlanejamentoFrequencia);
            }

            const planejamentoFrequenciaFaltou = document.getElementById('planejamento-frequencia-faltou');
            if (planejamentoFrequenciaFaltou) {
                planejamentoFrequenciaFaltou.addEventListener('click', marcarPlanejamentoFrequenciaFaltou);
            }

            const planejamentoRegistroRapidoCancelar = document.getElementById('planejamento-registro-rapido-cancelar');
            if (planejamentoRegistroRapidoCancelar) {
                planejamentoRegistroRapidoCancelar.addEventListener('click', () => {
                    fecharPlanejamentoRegistroRapido();
                });
            }

            const planejamentoRegistroRapidoConfirmar = document.getElementById('planejamento-registro-rapido-confirmar');
            if (planejamentoRegistroRapidoConfirmar) {
                planejamentoRegistroRapidoConfirmar.addEventListener('click', confirmarPlanejamentoRegistroRapido);
            }

            // Formulário de cadastro
            document.getElementById('form-cadastro').addEventListener('submit', function(e) {
                e.preventDefault();
                salvarAgendamento();
            });

            const planejamentoForm = document.getElementById('form-planejamento-inserir');
            if (planejamentoForm) {
                planejamentoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    salvarPlanejamentoManual();
                });
            }

            // Formulário de bloqueio
            document.getElementById('form-bloqueio').addEventListener('submit', function(e) {
                e.preventDefault();
                salvarStatusSalas();
            });

            const planejamentoTurnoInserir = document.getElementById('planejamento-inserir-turno');
            if (planejamentoTurnoInserir) {
                planejamentoTurnoInserir.addEventListener('change', function() {
                    atualizarHorariosPlanejamentoInserir();
                });
            }

            const planejamentoSalaInserir = document.getElementById('planejamento-inserir-sala');
            if (planejamentoSalaInserir) {
                planejamentoSalaInserir.addEventListener('change', function() {
                    sincronizarIlhaPlanejamentoInserir();
                });
            }

            // Validação de conflito em tempo real
            document.getElementById('cadastro-sala').addEventListener('change', function() {
                const salaNum = this.value;
                const sala = estado.salas.find(s => String(s.numero) === String(salaNum));
                if (sala) {
                    document.getElementById('cadastro-ilha').value = sala.ilha;
                }
                verificarConflito();
            });
            document.getElementById('cadastro-turno').addEventListener('change', verificarConflito);
            document.getElementById('cadastro-data-inicio').addEventListener('change', verificarConflito);
            document.getElementById('cadastro-hora-inicio').addEventListener('change', verificarConflito);
            document.getElementById('cadastro-hora-fim').addEventListener('change', verificarConflito);

            // Fechar modal ao clicar fora
            window.addEventListener('click', function(e) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (e.target === modal) {
                        if (modal.id === 'planejamento-frequencia-modal') {
                            fecharModalPlanejamentoFrequencia();
                        } else if (modal.id === 'planejamento-registro-rapido-modal') {
                            fecharPlanejamentoRegistroRapido();
                        } else if (modal.id === 'chart-modal') {
                            fecharChartModal();
                        } else if (modal.id === 'planejamento-inserir-modal') {
                            definirPlanejamentoInserirProcessando(false);
                            const salvarBtn = document.querySelector('#form-planejamento-inserir button[type="submit"]');
                            if (salvarBtn) salvarBtn.disabled = false;
                            modal.style.display = 'none';
                        } else {
                            modal.style.display = 'none';
                        }
                    }
                });
            });

            // Novo: Checkbox para dias específicos
            document.getElementById('agendar-dias-especificos').addEventListener('change', function() {
                document.getElementById('dias-selecao').style.display = this.checked ? 'block' : 'none';
            });

            // Atualizar botão
            document.getElementById('btn-atualizar').addEventListener('click', carregarDados);

            const navToggle = document.getElementById('nav-toggle');
            const mainNav = document.getElementById('main-nav');
            const mobileNavMediaQuery = typeof window.matchMedia === 'function'
                ? window.matchMedia('(max-width: 960px)')
                : { matches: false };
            const navGroupToggles = document.querySelectorAll('.nav-group-toggle');
            const scheduleToggle = document.getElementById('schedule-toggle');
            const scheduleControls = document.getElementById('schedule-controls');
            const scheduleMediaQuery = typeof window.matchMedia === 'function'
                ? window.matchMedia('(max-width: 720px)')
                : {
                    matches: false,
                    addEventListener: () => {},
                    addListener: () => {}
                };
            let shouldFocusNavToggle = false;

            if (scheduleControls) {
                scheduleControls.setAttribute('aria-hidden', scheduleMediaQuery.matches ? 'true' : 'false');
            }

            if (scheduleToggle && scheduleControls) {
                drawerController.register('schedule', {
                    open: () => {
                        scheduleControls.classList.add('is-open');
                        scheduleControls.setAttribute('aria-hidden', 'false');
                        scheduleToggle.setAttribute('aria-expanded', 'true');
                    },
                    close: () => {
                        scheduleControls.classList.remove('is-open');
                        scheduleControls.setAttribute('aria-hidden', scheduleMediaQuery.matches ? 'true' : 'false');
                        scheduleToggle.setAttribute('aria-expanded', 'false');
                    },
                    isOpen: () => scheduleControls.classList.contains('is-open')
                });

                scheduleToggle.addEventListener('click', () => {
                    if (!scheduleMediaQuery.matches) {
                        return;
                    }
                    drawerController.toggle('schedule');
                });

                const closeScheduleDrawer = () => {
                    if (scheduleMediaQuery.matches) {
                        drawerController.close('schedule');
                    }
                };

                document.querySelectorAll('.turno-btn').forEach(btn => {
                    btn.addEventListener('click', closeScheduleDrawer);
                });

                const handleScheduleMediaChange = (event) => {
                    if (!scheduleControls) return;
                    scheduleControls.classList.remove('is-open');
                    scheduleToggle.setAttribute('aria-expanded', 'false');
                    if (event.matches) {
                        scheduleControls.setAttribute('aria-hidden', 'true');
                        drawerController.close('schedule');
                    } else {
                        scheduleControls.setAttribute('aria-hidden', 'false');
                        drawerController.close('schedule');
                    }
                };

                if (typeof scheduleMediaQuery.addEventListener === 'function') {
                    scheduleMediaQuery.addEventListener('change', handleScheduleMediaChange);
                } else if (typeof scheduleMediaQuery.addListener === 'function') {
                    scheduleMediaQuery.addListener(handleScheduleMediaChange);
                }

                handleScheduleMediaChange(scheduleMediaQuery);
            }

            const setGroupExpanded = (toggle, expanded) => {
                if (!toggle) return;
                const controlsId = toggle.getAttribute('aria-controls');
                const submenu = controlsId ? document.getElementById(controlsId) : toggle.nextElementSibling;
                const group = toggle.closest('.nav-group');
                toggle.setAttribute('aria-expanded', String(expanded));
                toggle.classList.toggle('is-open', expanded);
                if (submenu) {
                    submenu.classList.toggle('is-open', expanded);
                }
                if (group) {
                    group.classList.toggle('is-open', expanded);
                }
            };

            if (navToggle && mainNav) {
                drawerController.register('nav', {
                    open: () => {
                        shouldFocusNavToggle = false;
                        navToggle.setAttribute('aria-expanded', 'true');
                        navToggle.classList.add('is-open');
                        mainNav.classList.add('is-open');
                        const icon = navToggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-bars');
                            icon.classList.add('fa-xmark');
                        }
                    },
                    close: () => {
                        navToggle.setAttribute('aria-expanded', 'false');
                        navToggle.classList.remove('is-open');
                        mainNav.classList.remove('is-open');
                        const icon = navToggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-xmark');
                            icon.classList.add('fa-bars');
                        }
                        const focusRequested = shouldFocusNavToggle
                            || (mobileNavMediaQuery.matches && mainNav.contains(document.activeElement));
                        shouldFocusNavToggle = false;
                        if (focusRequested && typeof navToggle.focus === 'function') {
                            navToggle.focus();
                        }
                    },
                    isOpen: () => mainNav.classList.contains('is-open')
                });

                navToggle.addEventListener('click', () => {
                    if (!mobileNavMediaQuery.matches) {
                        return;
                    }
                    drawerController.toggle('nav');
                });
            }

            const closeMobileNav = ({ shouldFocus = false } = {}) => {
                if (!navToggle || !mainNav) return;
                shouldFocusNavToggle = shouldFocus;
                drawerController.close('nav');
            };

            if (navToggle && mainNav) {
                const handleMobileNavChange = (event) => {
                    if (!event.matches) {
                        closeMobileNav();
                        navGroupToggles.forEach(toggle => {
                            const shouldOpen = toggle.dataset.initialOpen === 'true';
                            setGroupExpanded(toggle, shouldOpen);
                        });
                        drawerController.syncBackdrop();
                        return;
                    }

                    navGroupToggles.forEach(toggle => {
                        setGroupExpanded(toggle, false);
                    });
                };

                if (typeof mobileNavMediaQuery.addEventListener === 'function') {
                    mobileNavMediaQuery.addEventListener('change', handleMobileNavChange);
                } else if (typeof mobileNavMediaQuery.addListener === 'function') {
                    mobileNavMediaQuery.addListener(handleMobileNavChange);
                }

                handleMobileNavChange(mobileNavMediaQuery);
            }

            navGroupToggles.forEach(toggle => {
                const shouldStartOpen = toggle.dataset.initialOpen === 'true';
                if (shouldStartOpen) {
                    setGroupExpanded(toggle, !mobileNavMediaQuery.matches);
                } else {
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    const nextState = mobileNavMediaQuery.matches ? false : expanded;
                    setGroupExpanded(toggle, nextState);
                }

                toggle.addEventListener('click', event => {
                    event.preventDefault();
                    event.stopPropagation();
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    const nextState = !expanded;

                    if (mobileNavMediaQuery.matches) {
                        navGroupToggles.forEach(other => {
                            if (other !== toggle) {
                                setGroupExpanded(other, false);
                                const otherGroup = other.closest('.nav-group');
                                if (otherGroup) {
                                    otherGroup.classList.remove('is-active');
                                }
                            }
                        });
                    }

                    setGroupExpanded(toggle, nextState);

                    const currentGroup = toggle.closest('.nav-group');
                    if (currentGroup) {
                        document.querySelectorAll('.nav-group').forEach(group => {
                            if (group !== currentGroup && !mobileNavMediaQuery.matches) {
                                const groupToggle = group.querySelector('.nav-group-toggle');
                                if (groupToggle) {
                                    setGroupExpanded(groupToggle, false);
                                }
                                group.classList.remove('is-active');
                            }
                        });
                        if (nextState) {
                            currentGroup.classList.add('is-active');
                        }
                    }
                });

                const navGroupElement = toggle.closest('.nav-group');
                if (navGroupElement) {
                    let hoverCloseTimer = null;

                    const clearHoverCloseTimer = () => {
                        if (hoverCloseTimer) {
                            clearTimeout(hoverCloseTimer);
                            hoverCloseTimer = null;
                        }
                    };

                    navGroupElement.addEventListener('mouseenter', () => {
                        if (mobileNavMediaQuery.matches) {
                            return;
                        }
                        clearHoverCloseTimer();
                    });

                    navGroupElement.addEventListener('mouseleave', event => {
                        if (mobileNavMediaQuery.matches) {
                            return;
                        }

                        const relatedTarget = event.relatedTarget;
                        if (relatedTarget && navGroupElement.contains(relatedTarget)) {
                            return;
                        }

                        clearHoverCloseTimer();
                        hoverCloseTimer = setTimeout(() => {
                            if (navGroupElement.matches(':hover')) {
                                return;
                            }
                            const activeElement = document.activeElement;
                            if (activeElement && navGroupElement.contains(activeElement)) {
                                return;
                            }
                            setGroupExpanded(toggle, false);
                        }, 220);
                    });

                    navGroupElement.addEventListener('focusout', event => {
                        if (mobileNavMediaQuery.matches) {
                            return;
                        }
                        clearHoverCloseTimer();
                        const nextFocused = event.relatedTarget;
                        if (nextFocused && navGroupElement.contains(nextFocused)) {
                            return;
                        }
                        setGroupExpanded(toggle, false);
                    });
                }
            });

            if (navGroupToggles.length > 0) {
                document.addEventListener('click', event => {
                    if (mobileNavMediaQuery.matches) {
                        return;
                    }
                    navGroupToggles.forEach(toggle => {
                        const group = toggle.closest('.nav-group');
                        if (!group) {
                            return;
                        }
                        if (!group.contains(event.target)) {
                            setGroupExpanded(toggle, false);
                        }
                    });
                });
            }

            const initialActiveButton = document.querySelector('.nav-btn.active');
            if (initialActiveButton) {
                const initialGroup = initialActiveButton.closest('.nav-group');
                if (initialGroup) {
                    initialGroup.classList.add('is-active');
                    const initialToggle = initialGroup.querySelector('.nav-group-toggle');
                    if (initialToggle) {
                        setGroupExpanded(initialToggle, !mobileNavMediaQuery.matches);
                    }
                }
            }

            // Configuração das abas
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('focus', () => {
                    const group = btn.closest('.nav-group');
                    if (!group) {
                        return;
                    }
                    const toggle = group.querySelector('.nav-group-toggle');
                    if (toggle) {
                        setGroupExpanded(toggle, true);
                    }
                });

                btn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const tab = this.getAttribute('data-tab');
                    document.querySelectorAll('.dashboard-section').forEach(sec => sec.classList.remove('active'));
                    document.getElementById(`${tab}-section`).classList.add('active');
                    const group = this.closest('.nav-group');
                    if (group) {
                        document.querySelectorAll('.nav-group').forEach(otherGroup => {
                            if (otherGroup !== group) {
                                otherGroup.classList.remove('is-active');
                                const otherToggle = otherGroup.querySelector('.nav-group-toggle');
                                if (otherToggle) {
                                    setGroupExpanded(otherToggle, false);
                                }
                            }
                        });
                        group.classList.add('is-active');
                        const toggle = group.querySelector('.nav-group-toggle');
                        if (toggle) {
                            if (mobileNavMediaQuery.matches) {
                                setGroupExpanded(toggle, true);
                            } else {
                                setGroupExpanded(toggle, false);
                            }
                        }
                    }
                    if (tab === 'dashboard') carregarDashboard();
                    if (tab === 'sala-mes') carregarSalaMesOptions();
                    if (tab === 'relatorios') inicializarRelatorios();
                    if (tab === 'planejamento') atualizarPlanejamento();
                    if (tab === 'medicos') renderAcompanhamentoMedicos();
                    if (tab === 'logs') inicializarLogsGestao();
                    if (tab === 'gestao-cadastros') inicializarGestaoCadastros();
                    if (mobileNavMediaQuery.matches) {
                        closeMobileNav({ shouldFocus: true });
                    }
                });
            });

            const medicosBusca = document.getElementById('medicos-busca');
            if (medicosBusca) {
                medicosBusca.addEventListener('input', () => {
                    estado.acompanhamentoMedicos.busca = medicosBusca.value || '';
                    renderAcompanhamentoMedicos();
                });
            }

            const medicosEspecialidade = document.getElementById('medicos-especialidade');
            if (medicosEspecialidade) {
                medicosEspecialidade.addEventListener('change', () => {
                    estado.acompanhamentoMedicos.especialidade = medicosEspecialidade.value || 'todas';
                    renderAcompanhamentoMedicos();
                });
            }

            const medicosFrequencia = document.getElementById('medicos-frequencia');
            if (medicosFrequencia) {
                medicosFrequencia.addEventListener('change', () => {
                    estado.acompanhamentoMedicos.frequencia = medicosFrequencia.value || 'todos';
                    renderAcompanhamentoMedicos();
                });
            }

            const medicosOrdenacao = document.getElementById('medicos-ordenacao');
            if (medicosOrdenacao) {
                medicosOrdenacao.addEventListener('change', () => {
                    estado.acompanhamentoMedicos.ordenacao = medicosOrdenacao.value || 'atrasos';
                    renderAcompanhamentoMedicos();
                });
            }

            const garantirPeriodoEstado = () => {
                if (!estado.acompanhamentoMedicos.periodo) {
                    estado.acompanhamentoMedicos.periodo = {
                        tipo: 'dia',
                        dia: (estado.dataAtual instanceof Date ? estado.dataAtual : new Date()).toISOString().split('T')[0],
                        semana: '',
                        mes: '',
                        ano: '',
                        inicio: '',
                        fim: ''
                    };
                }
                return estado.acompanhamentoMedicos.periodo;
            };

            const periodoSelect = document.getElementById('medicos-periodo');
            if (periodoSelect) {
                periodoSelect.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    periodo.tipo = periodoSelect.value || 'dia';
                    if (periodo.tipo === 'mes' && !periodo.mes) {
                        periodo.mes = (periodo.dia || new Date().toISOString().split('T')[0]).slice(0, 7);
                    }
                    if (periodo.tipo === 'ano' && !periodo.ano) {
                        periodo.ano = (periodo.dia || new Date().toISOString().split('T')[0]).slice(0, 4);
                    }
                    if (periodo.tipo === 'semana' && !periodo.semana) {
                        const base = estado.dataAtual instanceof Date ? estado.dataAtual : new Date();
                        periodo.semana = `${base.getFullYear()}-W${obterSemanaISO(base)}`;
                    }
                    if (periodo.tipo === 'intervalo') {
                        const hojeIso = new Date().toISOString().split('T')[0];
                        if (!periodo.inicio) periodo.inicio = hojeIso;
                        if (!periodo.fim) periodo.fim = periodo.inicio;
                    }
                    atualizarMedicosPeriodoUI();
                    recalcularAcompanhamentoMedicos();
                });
            }

            const periodoDia = document.getElementById('medicos-periodo-dia');
            if (periodoDia) {
                periodoDia.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    if (periodoDia.value) {
                        periodo.dia = periodoDia.value;
                    }
                    recalcularAcompanhamentoMedicos();
                });
            }

            const periodoSemana = document.getElementById('medicos-periodo-semana');
            if (periodoSemana) {
                periodoSemana.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    periodo.semana = periodoSemana.value;
                    recalcularAcompanhamentoMedicos();
                });
            }

            const periodoMes = document.getElementById('medicos-periodo-mes');
            if (periodoMes) {
                periodoMes.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    periodo.mes = periodoMes.value;
                    recalcularAcompanhamentoMedicos();
                });
            }

            const periodoAno = document.getElementById('medicos-periodo-ano');
            if (periodoAno) {
                periodoAno.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    periodo.ano = periodoAno.value;
                    recalcularAcompanhamentoMedicos();
                });
            }

            const periodoInicio = document.getElementById('medicos-periodo-inicio');
            if (periodoInicio) {
                periodoInicio.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    periodo.inicio = periodoInicio.value;
                    recalcularAcompanhamentoMedicos();
                });
            }

            const periodoFim = document.getElementById('medicos-periodo-fim');
            if (periodoFim) {
                periodoFim.addEventListener('change', () => {
                    const periodo = garantirPeriodoEstado();
                    periodo.fim = periodoFim.value;
                    recalcularAcompanhamentoMedicos();
                });
            }

            atualizarMedicosPeriodoUI();

            // Dashboard update
            document.getElementById('btn-atualizar-dashboard').addEventListener('click', carregarDashboard);
            const btnDashboardPdf = document.getElementById('btn-dashboard-pdf');
            if (btnDashboardPdf) {
                btnDashboardPdf.addEventListener('click', exportarDashboardPdf);
            }

            // Relatórios
            document.getElementById('btn-gerar-relatorio').addEventListener('click', gerarRelatorio);
            const btnRelatorioPdf = document.getElementById('btn-relatorio-pdf');
            if (btnRelatorioPdf) {
                btnRelatorioPdf.addEventListener('click', exportarRelatorioPdf);
            }

            // Sala/Mês
            const salaMesTipoSelect = document.getElementById('sala-mes-periodo-tipo');
            if (salaMesTipoSelect) {
                const prepararSalaMes = () => {
                    const tipoAtual = salaMesTipoSelect.value
                        || (estado.salaMesPeriodo && estado.salaMesPeriodo.tipo)
                        || 'mes';
                    atualizarSalaMesPeriodoOpcoes();
                    garantirPadroesSalaMes(tipoAtual);
                    sincronizarSalaMesPeriodoValores();
                    inicializarSalaMesPeriodoDetalhes();
                };

                const salaMesSection = document.getElementById('sala-mes-section');
                if (salaMesSection && salaMesSection.classList.contains('active')) {
                    carregarSalaMesOptions();
                } else {
                    prepararSalaMes();
                }
            }


            // Novo: Formulário de mover
            document.getElementById('form-mover').addEventListener('submit', function(e) {
                e.preventDefault();
                moverAgendamento();
            });

            const planejamentoTurnoSelect = document.getElementById('planejamento-turno');
            if (planejamentoTurnoSelect) {
                planejamentoTurnoSelect.addEventListener('change', function() {
                    estado.planejamentoTurno = this.value;
                    atualizarPlanejamento();
                });
            }

            const planejamentoFiltroNomeInput = document.getElementById('planejamento-filtro-nome');
            if (planejamentoFiltroNomeInput) {
                planejamentoFiltroNomeInput.addEventListener('input', function() {
                    estado.planejamentoFiltroNome = this.value || '';
                    renderPlanejamento();
                });
            }

            const planejamentoFiltroEspecialidadeSelect = document.getElementById('planejamento-filtro-especialidade');
            if (planejamentoFiltroEspecialidadeSelect) {
                planejamentoFiltroEspecialidadeSelect.addEventListener('change', function() {
                    estado.planejamentoFiltroEspecialidade = this.value || '';
                    renderPlanejamento();
                });
            }

            const planejamentoAplicarBtn = document.getElementById('planejamento-aplicar');
            if (planejamentoAplicarBtn) {
                planejamentoAplicarBtn.addEventListener('click', aplicarPlanejamentoTudo);
            }

            const formEditar = document.getElementById('form-editar');
            if (formEditar) {
                formEditar.addEventListener('submit', function(e) {
                    e.preventDefault();
                    salvarEdicaoAgendamento({ continuar: false });
                });
            }

            const salvarEditarProximoBtn = document.getElementById('editar-salvar-proximo');
            if (salvarEditarProximoBtn) {
                salvarEditarProximoBtn.addEventListener('click', function() {
                    salvarEdicaoAgendamento({ continuar: true });
                });
            }

            const cadastroResidenteSelect = document.getElementById('cadastro-residente');
            if (cadastroResidenteSelect) {
                cadastroResidenteSelect.addEventListener('change', atualizarCamposResidenteCadastro);
            }

            atualizarPlanejamentoSelecaoUI();

            inicializarDashboardDiasEspecificos();
            inicializarDashboardPeriodoDetalhes();
            inicializarDashboardComparacaoUI();
            inicializarRelatorioComparacaoUI();
            inicializarExpansaoGraficos();
        }

        function setupResponsiveShell() {
            const registeredDrawers = new Map();
            const backdrop = document.getElementById('drawer-backdrop');
            const filtersDrawer = document.querySelector('[data-drawer="filters"]');
            const openFiltersBtn = document.getElementById('open-filters');
            const closeButtons = document.querySelectorAll('[data-drawer-close]');

            const syncBackdropState = () => {
                const anyOpen = Array.from(registeredDrawers.values()).some(entry => entry.isOpen());
                if (anyOpen) {
                    if (backdrop) {
                        backdrop.classList.add('is-visible');
                        backdrop.setAttribute('aria-hidden', 'false');
                    }
                    document.body.classList.add('drawer-open');
                } else {
                    if (backdrop) {
                        backdrop.classList.remove('is-visible');
                        backdrop.setAttribute('aria-hidden', 'true');
                    }
                    document.body.classList.remove('drawer-open');
                }
            };

            const register = (name, entry) => {
                if (!name || !entry || typeof entry.open !== 'function' || typeof entry.close !== 'function' || typeof entry.isOpen !== 'function') {
                    return () => {};
                }
                registeredDrawers.set(name, entry);
                return () => unregister(name);
            };

            const unregister = (name) => {
                if (!registeredDrawers.has(name)) {
                    return;
                }
                const entry = registeredDrawers.get(name);
                if (entry && entry.isOpen()) {
                    entry.close();
                }
                registeredDrawers.delete(name);
                syncBackdropState();
            };

            const open = (name) => {
                const entry = registeredDrawers.get(name);
                if (!entry) return;
                registeredDrawers.forEach((otherEntry, otherName) => {
                    if (otherName !== name && otherEntry.isOpen()) {
                        otherEntry.close();
                    }
                });
                entry.open();
                syncBackdropState();
            };

            const close = (name) => {
                const entry = registeredDrawers.get(name);
                if (!entry) return;
                entry.close();
                syncBackdropState();
            };

            const toggle = (name) => {
                const entry = registeredDrawers.get(name);
                if (!entry) return;
                if (entry.isOpen()) {
                    close(name);
                } else {
                    open(name);
                }
            };

            const closeAll = (exceptName) => {
                registeredDrawers.forEach((entry, key) => {
                    if (exceptName && key === exceptName) {
                        return;
                    }
                    if (entry.isOpen()) {
                        entry.close();
                    }
                });
                syncBackdropState();
            };

            Object.assign(drawerController, {
                register,
                unregister,
                open,
                close,
                toggle,
                closeAll,
                isAnyOpen: () => Array.from(registeredDrawers.values()).some(entry => entry.isOpen()),
                syncBackdrop: syncBackdropState
            });

            if (openFiltersBtn) {
                openFiltersBtn.setAttribute('aria-expanded', 'false');
            }

            if (filtersDrawer) {
                register('filters', {
                    open: () => {
                        filtersDrawer.classList.add('drawer-open');
                        if (openFiltersBtn) {
                            openFiltersBtn.setAttribute('aria-expanded', 'true');
                        }
                    },
                    close: () => {
                        filtersDrawer.classList.remove('drawer-open');
                        if (openFiltersBtn) {
                            openFiltersBtn.setAttribute('aria-expanded', 'false');
                        }
                    },
                    isOpen: () => filtersDrawer.classList.contains('drawer-open')
                });

                if (openFiltersBtn) {
                    openFiltersBtn.addEventListener('click', () => toggle('filters'));
                }

                closeButtons.forEach(btn => {
                    const target = btn.getAttribute('data-drawer-close');
                    if (!target) return;
                    btn.addEventListener('click', () => close(target));
                });
            } else if (openFiltersBtn) {
                openFiltersBtn.addEventListener('click', () => toggle('filters'));
            }

            if (backdrop) {
                backdrop.addEventListener('click', () => closeAll());
            }

            window.addEventListener('keydown', event => {
                if (event.key === 'Escape') {
                    closeAll();
                }
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth > 1100) {
                    syncBackdropState();
                }
            });

            inicializarLogsGestao();
        }

        function aplicarFiltros() {
            atualizarMonitor();
            atualizarIndicadores();
        }

        function salaAtendeFiltros(sala) {
            const turnoFiltro = estado.turnoAtual === 'todos' ? 'todos' : normalizarTurno(estado.turnoAtual);
            const agendamentosSala = estado.agendamentos.filter(ag => {
                if (String(ag.sala) !== String(sala.numero)) return false;
                if (turnoFiltro === 'todos') return true;
                const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                return turnoAg === turnoFiltro || turnoAg === 'todos';
            });

            if (estado.filtros.status.length > 0) {
                const statusSala = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
                const salaBloqueada = statusBloqueiaAgendamento(statusSala);
                const statusEfetivo = salaBloqueada ? statusSala : (agendamentosSala.length > 0 ? 'ocupado' : 'livre');
                if (!estado.filtros.status.includes(statusEfetivo)) return false;
            }
            
            // Filtro por ilha
            if (estado.filtros.ilha.length > 0) {
                if (!estado.filtros.ilha.includes(sala.ilha.toString())) return false;
            }
            
            // Filtro por especialidade e categoria (apenas se a sala tem agendamentos)
            if (agendamentosSala.length > 0) {
                if (estado.filtros.especialidade.length > 0) {
                    const temAlguma = agendamentosSala.some(ag => estado.filtros.especialidade.includes(ag.especialidade));
                    if (!temAlguma) return false;
                }
                
                if (estado.filtros.categoria.length > 0) {
                    const temAlguma = agendamentosSala.some(ag => estado.filtros.categoria.includes(ag.categoria));
                    if (!temAlguma) return false;
                }
            } else {
                // Se a sala não tem agendamentos mas há filtros de especialidade/categoria
                if (estado.filtros.especialidade.length > 0 || estado.filtros.categoria.length > 0) return false;
            }
            
            return true;
        }

        function atualizarMonitor() {
            const monitorContent = document.getElementById('monitor-content');
            monitorContent.innerHTML = '';

            let horarios;
            switch (estado.turnoAtual) {
                case 'manha': horarios = horariosManha; break;
                case 'tarde': horarios = horariosTarde; break;
                case 'noite': horarios = horariosNoite; break;
                default: horarios = [];
            }

            const salasFiltradas = estado.salas.filter(salaAtendeFiltros);
            const ilhasUnicas = [...new Set(salasFiltradas.map(s => s.ilha))]
                .filter(valor => valor !== undefined && valor !== null)
                .sort((a, b) => parseFloat(a) - parseFloat(b));

            ilhasUnicas.forEach(ilha => {
                const groupSalas = salasFiltradas.filter(s => s.ilha === ilha);
                if (!groupSalas.length) return;

                const bloco = document.createElement('div');
                bloco.className = 'bloco';
                bloco.innerHTML = `<h3><i class="fas fa-umbrella-beach"></i> Ilha ${ilha}</h3><div class="salas-container" id="ilha${ilha}"></div>`;
                monitorContent.appendChild(bloco);

                groupSalas.sort((a, b) => {
                    const numA = parseFloat(a.numero);
                    const numB = parseFloat(b.numero);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    return a.numero.localeCompare(b.numero, undefined, { numeric: true });
                });

                const container = document.getElementById(`ilha${ilha}`);
                const fragment = document.createDocumentFragment();
                groupSalas.forEach(sala => {
                    const salaElement = criarElementoSala(sala, horarios);
                    fragment.appendChild(salaElement);
                });
                container.appendChild(fragment);
            });

            if (!ilhasUnicas.length) {
                monitorContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-door-closed"></i>
                        <p>Nenhuma sala encontrada com os filtros aplicados</p>
                    </div>
                `;
            }
        }

        function getStatusClass(sala) {
            const statusSala = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
            if (statusBloqueiaAgendamento(statusSala)) {
                return statusParaClasseVisual(statusSala);
            }

            const turnoFiltro = estado.turnoAtual === 'todos' ? 'todos' : normalizarTurno(estado.turnoAtual);
            const agendamentosSala = estado.agendamentos.filter(ag => {
                if (String(ag.sala) !== String(sala.numero)) return false;
                if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                if (turnoFiltro === 'todos') return true;
                const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                return turnoAg === turnoFiltro || turnoAg === 'todos';
            });

            return agendamentosSala.length > 0 ? 'ocupado' : 'livre';
        }

        function formatarJanelaHorario(inicio, fim) {
            if (inicio && fim) {
                return `${inicio} - ${fim}`;
            }
            if (inicio || fim) {
                return inicio || fim;
            }
            return 'Horário não definido';
        }

        function obterResumoSalaDetalhado(sala) {
            const numero = String(sala.numero || '').trim();
            const statusClasse = getStatusClass(sala);
            const agendamentosSala = estado.agendamentos
                .filter(ag => String(ag.sala) === numero)
                .filter(ag => statusBloqueiaAgendamento(ag.statusNormalizado || ag.status))
                .sort((a, b) => (a.horaInicio || '').localeCompare(b.horaInicio || ''));

            const agenda = agendamentosSala.slice(0, 3).map(ag => ({
                horario: formatarJanelaHorario(ag.horaInicio, ag.horaFim),
                profissional: ag.profissional || 'Profissional não informado',
                especialidade: ag.especialidade || '',
                status: ag.statusNormalizado || ag.status
            }));

            return {
                statusClasse,
                statusLabel: formatarStatusLabel(statusClasse),
                ilha: sala.ilha,
                agenda,
                total: agendamentosSala.length
            };
        }

        function atualizarIndicadores() {
            const totalSalasEl = document.getElementById('total-salas');
            if (!totalSalasEl) {
                return;
            }
            const salasFiltradas = estado.salas.filter(s => salaAtendeFiltros(s));
            const totalSalas = salasFiltradas.length;
            
            // Contar salas ocupadas (com pelo menos um agendamento no turno atual)
            let salasOcupadas = 0;
            let ocupacaoPorTurno = { manha: 0, tarde: 0, noite: 0 };
            let ilhasEspecialidades = {};
            
            salasFiltradas.forEach(sala => {
                const agendamentosSala = estado.agendamentos.filter(ag => {
                    if (String(ag.sala) !== String(sala.numero)) return false;
                    if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                    if (estado.turnoAtual === 'todos') return true;
                    const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                    const turnoFiltro = normalizarTurno(estado.turnoAtual);
                    return turnoAg === turnoFiltro || turnoAg === 'todos';
                });
                
                if (agendamentosSala.length > 0) {
                    salasOcupadas++;
                    
                    // Contar por ilha e especialidade
                    if (!ilhasEspecialidades[sala.ilha]) {
                        ilhasEspecialidades[sala.ilha] = new Set();
                    }
                    agendamentosSala.forEach(ag => {
                        ilhasEspecialidades[sala.ilha].add(ag.especialidade);
                    });
                }
                
                // Calcular ocupação por turno
                ['manha', 'tarde', 'noite'].forEach(turno => {
                    const agendamentosTurno = estado.agendamentos.filter(ag => {
                        if (String(ag.sala) !== String(sala.numero)) return false;
                        if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                        const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                        return turnoAg === turno;
                    });
                    if (agendamentosTurno.length > 0) {
                        ocupacaoPorTurno[turno]++;
                    }
                });
            });
            
            const salasLivres = totalSalas - salasOcupadas;
            const taxaOcupacao = totalSalas > 0 ? Math.round((salasOcupadas / totalSalas) * 100) : 0;
            
            // Atualizar indicadores
            totalSalasEl.textContent = totalSalas;
            document.getElementById('salas-ocupadas').textContent = salasOcupadas;
            document.getElementById('salas-livres').textContent = salasLivres;
            document.getElementById('taxa-ocupacao').textContent = taxaOcupacao + '%';
            
            // Atualizar ocupação por turno
            const totalSalasGeral = salasFiltradas.length;
            document.getElementById('ocupacao-manha').textContent = 
                totalSalasGeral > 0 ? Math.round((ocupacaoPorTurno.manha / totalSalasGeral) * 100) + '%' : '0%';
            document.getElementById('ocupacao-tarde').textContent = 
                totalSalasGeral > 0 ? Math.round((ocupacaoPorTurno.tarde / totalSalasGeral) * 100) + '%' : '0%';
            document.getElementById('ocupacao-noite').textContent = 
                totalSalasGeral > 0 ? Math.round((ocupacaoPorTurno.noite / totalSalasGeral) * 100) + '%' : '0%';
            
            // Atualizar ilhas e especialidades
            const ilhasList = document.getElementById('ilhas-especialidades-list');
            ilhasList.innerHTML = '';
            
            if (Object.keys(ilhasEspecialidades).length === 0) {
                ilhasList.innerHTML = '<p>Nenhuma especialidade com agendamentos</p>';
            } else {
                Object.entries(ilhasEspecialidades).sort(([ilhaA], [ilhaB]) => parseFloat(ilhaA) - parseFloat(ilhaB)).forEach(([ilha, esps]) => {
                    const ilhaItem = document.createElement('div');
                    ilhaItem.className = 'indicador-item';
                    ilhaItem.innerHTML = `
                        <span>Ilha ${ilha}:</span>
                        <span class="indicador-valor">${Array.from(esps).join(', ')}</span>
                    `;
                    ilhasList.appendChild(ilhaItem);
                });
            }
        }

        function obterPlanejamentoSelecionadosSet() {
            const selecionadosAtual = estado.planejamentoSelecionados;
            if (selecionadosAtual instanceof Set) {
                return selecionadosAtual;
            }
            if (Array.isArray(selecionadosAtual)) {
                const novoSet = new Set(selecionadosAtual.map(id => String(id)));
                estado.planejamentoSelecionados = novoSet;
                return novoSet;
            }
            const novoSet = new Set();
            estado.planejamentoSelecionados = novoSet;
            return novoSet;
        }

        function limparPlanejamentoSelecao() {
            const selecionados = obterPlanejamentoSelecionadosSet();
            if (selecionados && typeof selecionados.clear === 'function') {
                selecionados.clear();
            }
        }

        function atualizarPlanejamentoSelecaoUI() {
            const selecionados = obterPlanejamentoSelecionadosSet();
            const quantidade = selecionados ? selecionados.size : 0;
            const btnEditarSelecionados = document.getElementById('planejamento-editar-selecionados');
            const textoBtn = document.getElementById('planejamento-editar-selecionados-texto');
            if (btnEditarSelecionados) {
                btnEditarSelecionados.disabled = quantidade === 0;
                btnEditarSelecionados.setAttribute('aria-disabled', quantidade === 0 ? 'true' : 'false');
            }
            if (textoBtn) {
                textoBtn.textContent = quantidade > 0
                    ? `Editar selecionados (${quantidade})`
                    : 'Editar selecionados';
            }
        }

        function togglePlanejamentoSelecao(id, selecionado) {
            const selecionados = obterPlanejamentoSelecionadosSet();
            const chave = String(id);
            if (selecionado) {
                selecionados.add(chave);
            } else {
                selecionados.delete(chave);
            }
            atualizarPlanejamentoSelecaoUI();
        }

        function iniciarPlanejamentoEdicao(ids) {
            const lista = Array.isArray(ids) ? ids : [];
            const vistos = new Set();
            const fila = [];
            lista.forEach(id => {
                const chave = String(id);
                if (!chave) return;
                if (vistos.has(chave)) return;
                vistos.add(chave);
                fila.push(chave);
            });
            if (!fila.length) {
                return;
            }
            planejamentoEdicaoFila = {
                ids: fila,
                index: 0
            };
            abrirModalEditar(fila[0], { origem: 'planejamento', indiceFila: 0 });
        }

        function atualizarEditarModalContexto() {
            const info = document.getElementById('editar-contexto-info');
            const btnProximo = document.getElementById('editar-salvar-proximo');
            if (!info && !btnProximo) {
                return;
            }
            const ativo = planejamentoEdicaoFila && Array.isArray(planejamentoEdicaoFila.ids)
                && planejamentoEdicaoFila.ids.length > 0;
            const total = ativo ? planejamentoEdicaoFila.ids.length : 0;
            const indiceAtual = ativo ? (planejamentoEdicaoFila.index || 0) : 0;
            if (info) {
                if (ativo) {
                    const texto = total > 1
                        ? `Editando planejamento ${indiceAtual + 1} de ${total}`
                        : 'Editando planejamento';
                    info.textContent = texto;
                    info.style.display = 'block';
                } else {
                    info.textContent = '';
                    info.style.display = 'none';
                }
            }
            if (btnProximo) {
                if (ativo && total > 1) {
                    btnProximo.style.display = 'inline-flex';
                    btnProximo.disabled = indiceAtual >= total - 1;
                } else {
                    btnProximo.style.display = 'none';
                    btnProximo.disabled = true;
                }
            }
        }

        function atualizarPlanejamento() {
            const container = document.getElementById('planejamento-container');
            if (!container) return;

            const dataIso = estado.dataAtual.toISOString().split('T')[0];
            const turnoSelecionado = estado.planejamentoTurno || 'manha';
            const linhasAnteriores = Array.isArray(estado.planejamentoLinhas)
                ? estado.planejamentoLinhas.reduce((acc, item) => {
                    acc[item.id] = item;
                    return acc;
                }, {})
                : {};

            const agendamentosDia = estado.agendamentos.filter(ag => {
                if (!ag) return false;
                if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                if (!(ag.dataInicio <= dataIso && ag.dataFim >= dataIso)) return false;
                const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                if (turnoSelecionado === 'todos') {
                    return ['manha', 'tarde', 'noite', 'todos'].includes(turnoAg);
                }
                return turnoAg === turnoSelecionado || turnoAg === 'todos';
            }).sort((a, b) => {
                const espA = normalizarTexto(a.especialidade || '');
                const espB = normalizarTexto(b.especialidade || '');
                if (espA !== espB) {
                    return espA.localeCompare(espB, 'pt-BR', { sensitivity: 'base' });
                }
                const turnoA = a.turnoNormalizado || normalizarTurno(a.turno) || '';
                const turnoB = b.turnoNormalizado || normalizarTurno(b.turno) || '';
                if (turnoA !== turnoB) {
                    return turnoA.localeCompare(turnoB, 'pt-BR');
                }
                return (a.profissional || '').localeCompare(b.profissional || '', 'pt-BR');
            });

            estado.planejamentoLinhas = agendamentosDia.map(ag => {
                const id = String(ag.id);
                const anterior = linhasAnteriores[id] || {};
                return {
                    id,
                    profissional: ag.profissional || '—',
                    especialidade: ag.especialidade && ag.especialidade.trim() ? ag.especialidade : 'Sem especialidade',
                    turno: ag.turnoNormalizado || normalizarTurno(ag.turno) || 'manha',
                    dataInicio: ag.dataInicio || '',
                    dataFim: ag.dataFim || '',
                    horaInicio: ag.horaInicio || '',
                    horaFim: ag.horaFim || '',
                    salaAtual: ag.sala != null ? String(ag.sala) : '—',
                    salaPlanejada: anterior.salaPlanejada || '',
                    horaChegadaReal: ag.horaChegadaReal || '',
                    horaSaidaReal: ag.horaSaidaReal || '',
                    faltou: valorFrequenciaEhFaltou(ag.horaChegadaReal) || valorFrequenciaEhFaltou(ag.horaSaidaReal),
                    marcado: Boolean(anterior.marcado),
                    resultado: null,
                    mensagem: ''
                };
            });

            const selecionados = obterPlanejamentoSelecionadosSet();
            if (selecionados && selecionados.size) {
                const idsValidos = new Set(estado.planejamentoLinhas.map(item => item.id));
                Array.from(selecionados).forEach(id => {
                    if (!idsValidos.has(id)) {
                        selecionados.delete(id);
                    }
                });
            }

            renderPlanejamento();
        }

        function avaliarPlanejamentoLinha(linha) {
            if (!linha) {
                return { status: 'pendente', mensagem: '' };
            }

            const salaPlanejadaBruta = (linha.salaPlanejada || '').trim();
            const salaAtualBruta = (linha.salaAtual || '').trim();
            const salaAtualNormalizada = salaAtualBruta === '—' ? '' : salaAtualBruta;

            if (!salaPlanejadaBruta) {
                linha.resultado = 'pendente';
                linha.mensagem = '';
                return { status: linha.resultado, mensagem: linha.mensagem };
            }

            if (
                salaAtualNormalizada &&
                salaPlanejadaBruta.localeCompare(salaAtualNormalizada, undefined, { sensitivity: 'base' }) === 0
            ) {
                linha.resultado = 'ok';
                linha.mensagem = 'Sala atual já corresponde ao planejamento';
                return { status: linha.resultado, mensagem: linha.mensagem };
            }

            linha.resultado = 'erro';
            linha.mensagem = salaAtualNormalizada
                ? `Agendado na sala ${salaAtualNormalizada}`
                : 'Sem sala registrada';
            return { status: linha.resultado, mensagem: linha.mensagem };
        }

        function atualizarVisualPlanejamento(linha, tr, statusSpan, botaoAcao) {
            const { status, mensagem } = avaliarPlanejamentoLinha(linha);

            if (tr) {
                tr.classList.remove('planejamento-row-ok', 'planejamento-row-erro');
                if (status === 'ok') tr.classList.add('planejamento-row-ok');
                if (status === 'erro') tr.classList.add('planejamento-row-erro');
            }

            if (statusSpan) {
                statusSpan.className = 'planejamento-status-chip';
                statusSpan.classList.remove('planejamento-status-chip-vazia');
                statusSpan.removeAttribute('aria-hidden');
                if (status === 'ok') {
                    statusSpan.classList.add('ok');
                    statusSpan.textContent = mensagem || 'Sala conferida';
                } else if (status === 'erro') {
                    statusSpan.classList.add('alerta');
                    statusSpan.textContent = mensagem || 'Sala divergente';
                } else {
                    statusSpan.classList.add('pendente');
                    if (mensagem) {
                        statusSpan.textContent = mensagem;
                    } else {
                        statusSpan.textContent = '';
                        statusSpan.setAttribute('aria-hidden', 'true');
                        statusSpan.classList.add('planejamento-status-chip-vazia');
                    }
                }
            }

            if (botaoAcao) {
                botaoAcao.disabled = status !== 'erro';
            }
        }

        function renderPlanejamento() {
            const tbody = document.getElementById('planejamento-tbody');
            const feedback = document.getElementById('planejamento-feedback');
            const turnoSelect = document.getElementById('planejamento-turno');
            const filtroNomeInput = document.getElementById('planejamento-filtro-nome');
            const filtroEspecialidadeSelect = document.getElementById('planejamento-filtro-especialidade');
            if (!tbody) return;

            if (turnoSelect) {
                turnoSelect.value = estado.planejamentoTurno || 'manha';
            }

            if (filtroNomeInput) {
                filtroNomeInput.value = estado.planejamentoFiltroNome || '';
            }

            const linhas = Array.isArray(estado.planejamentoLinhas) ? estado.planejamentoLinhas : [];
            const selecionadosSet = obterPlanejamentoSelecionadosSet();
            const especialidadeMap = new Map();
            linhas.forEach(item => {
                const especialidadeBruta = item.especialidade || '';
                const label = especialidadeBruta && especialidadeBruta.trim() && especialidadeBruta.trim() !== '—'
                    ? especialidadeBruta
                    : 'Sem especialidade';
                const chave = normalizarTexto(label);
                if (chave && !especialidadeMap.has(chave)) {
                    especialidadeMap.set(chave, label);
                }
            });
            const especialidadesOrdenadas = Array.from(especialidadeMap.values())
                .sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));

            if (filtroEspecialidadeSelect) {
                let valorAtual = estado.planejamentoFiltroEspecialidade || '';
                if (valorAtual && valorAtual.trim() === '—') {
                    valorAtual = 'Sem especialidade';
                    estado.planejamentoFiltroEspecialidade = valorAtual;
                }
                const opcoes = ['<option value="">Todas</option>'];
                especialidadesOrdenadas.forEach(esp => {
                    opcoes.push(`<option value="${esp.replace(/"/g, '&quot;')}">${esp}</option>`);
                });
                filtroEspecialidadeSelect.innerHTML = opcoes.join('');
                if (valorAtual && !especialidadesOrdenadas.includes(valorAtual)) {
                    estado.planejamentoFiltroEspecialidade = '';
                    filtroEspecialidadeSelect.value = '';
                } else {
                    filtroEspecialidadeSelect.value = valorAtual;
                }
            }

            togglePlanejamentoLoading(isLoading);

            const filtroNome = normalizarTexto(estado.planejamentoFiltroNome || '');
            const filtroEspecialidade = normalizarTexto(estado.planejamentoFiltroEspecialidade || '');

            const linhasFiltradas = linhas.filter(item => {
                const nomeValido = !filtroNome || normalizarTexto(item.profissional).includes(filtroNome);
                const especialidadeLabel = item.especialidade && item.especialidade.trim() && item.especialidade.trim() !== '—'
                    ? item.especialidade
                    : 'Sem especialidade';
                const especialidadeValida = !filtroEspecialidade || normalizarTexto(especialidadeLabel).includes(filtroEspecialidade);
                return nomeValido && especialidadeValida;
            });

            tbody.innerHTML = '';

            if (isLoading) {
                if (feedback) {
                    feedback.textContent = 'Carregando planejamento atualizado...';
                    feedback.style.color = 'var(--text-muted)';
                }
                atualizarPlanejamentoSelecaoUI();
                return;
            }

            const criarLinhaMensagem = mensagem => {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.textContent = mensagem;
                tr.appendChild(td);
                tbody.appendChild(tr);
            };

            if (!linhas.length) {
                criarLinhaMensagem('Nenhum agendamento encontrado para o turno selecionado.');
                if (feedback) {
                    feedback.textContent = 'Informe as salas desejadas e utilize as ações para aplicar as alterações.';
                    feedback.style.color = 'var(--text-secondary)';
                }
                atualizarPlanejamentoSelecaoUI();
                return;
            }

            if (!linhasFiltradas.length) {
                criarLinhaMensagem('Nenhum profissional corresponde aos filtros aplicados.');
                if (feedback) {
                    feedback.textContent = 'Ajuste os filtros de busca para visualizar o planejamento.';
                    feedback.style.color = 'var(--warning)';
                }
                atualizarPlanejamentoSelecaoUI();
                return;
            }

            const grupos = new Map();
            linhasFiltradas.forEach(item => {
                const especialidadeBruta = item.especialidade || '';
                const labelOriginal = especialidadeBruta && especialidadeBruta.trim() && especialidadeBruta.trim() !== '—'
                    ? especialidadeBruta
                    : 'Sem especialidade';
                const chave = normalizarTexto(labelOriginal) || 'sem-especialidade';
                if (!grupos.has(chave)) {
                    grupos.set(chave, { label: labelOriginal, itens: [] });
                }
                grupos.get(chave).itens.push(item);
            });

            const fragment = document.createDocumentFragment();
            const gruposOrdenados = Array.from(grupos.values())
                .sort((a, b) => a.label.localeCompare(b.label, 'pt-BR', { sensitivity: 'base' }));

            gruposOrdenados.forEach(grupo => {
                const headerTr = document.createElement('tr');
                headerTr.className = 'planejamento-grupo';
                const headerTd = document.createElement('td');
                headerTd.colSpan = 7;
                const headerWrapper = document.createElement('div');
                headerWrapper.className = 'planejamento-grupo-header';
                const titulo = document.createElement('span');
                titulo.textContent = grupo.label;
                const total = document.createElement('span');
                total.className = 'planejamento-grupo-total';
                const quantidade = grupo.itens.length;
                total.textContent = `${quantidade} profissional${quantidade === 1 ? '' : 's'}`;
                headerWrapper.appendChild(titulo);
                headerWrapper.appendChild(total);
                headerTd.appendChild(headerWrapper);
                headerTr.appendChild(headerTd);
                fragment.appendChild(headerTr);

                grupo.itens.sort((a, b) => (a.profissional || '').localeCompare(b.profissional || '', 'pt-BR'));

                grupo.itens.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.dataset.planejamentoId = item.id;
                    let statusSpan;
                    let botaoAcao;

                    const tdCheck = document.createElement('td');
                    tdCheck.className = 'planejamento-col-check';
                    const selecaoWrapper = document.createElement('div');
                    selecaoWrapper.className = 'planejamento-selecao';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'planejamento-select-checkbox';
                    checkbox.dataset.planejamentoId = item.id;
                    checkbox.checked = selecionadosSet.has(item.id);
                    checkbox.setAttribute('aria-label', `Selecionar ${item.profissional || 'profissional'} para edição`);
                    checkbox.addEventListener('change', () => {
                        togglePlanejamentoSelecao(item.id, checkbox.checked);
                    });

                    const quickWrapper = document.createElement('div');
                    quickWrapper.className = 'planejamento-quickfreq';

                    const botaoEntradaRapida = document.createElement('button');
                    botaoEntradaRapida.type = 'button';
                    botaoEntradaRapida.className = 'planejamento-quickfreq-btn planejamento-quickfreq-btn-in';
                    botaoEntradaRapida.dataset.planejamentoRegistro = 'entrada';
                    botaoEntradaRapida.dataset.planejamentoRegistroId = item.id;
                    botaoEntradaRapida.textContent = 'IN';
                    botaoEntradaRapida.setAttribute('aria-label', `Registrar entrada rápida de ${item.profissional || 'profissional'}`);
                    botaoEntradaRapida.setAttribute('title', 'Registrar entrada');
                    botaoEntradaRapida.addEventListener('click', () => abrirPlanejamentoRegistroRapido(item.id, 'entrada'));

                    const botaoSaidaRapida = document.createElement('button');
                    botaoSaidaRapida.type = 'button';
                    botaoSaidaRapida.className = 'planejamento-quickfreq-btn planejamento-quickfreq-btn-out';
                    botaoSaidaRapida.dataset.planejamentoRegistro = 'saida';
                    botaoSaidaRapida.dataset.planejamentoRegistroId = item.id;
                    botaoSaidaRapida.textContent = 'OUT';
                    botaoSaidaRapida.setAttribute('aria-label', `Registrar saída rápida de ${item.profissional || 'profissional'}`);
                    botaoSaidaRapida.setAttribute('title', 'Registrar saída');
                    botaoSaidaRapida.addEventListener('click', () => abrirPlanejamentoRegistroRapido(item.id, 'saida'));

                    quickWrapper.appendChild(botaoEntradaRapida);
                    quickWrapper.appendChild(botaoSaidaRapida);
                    selecaoWrapper.appendChild(checkbox);
                    selecaoWrapper.appendChild(quickWrapper);
                    tdCheck.appendChild(selecaoWrapper);

                    const tdProfissional = document.createElement('td');
                    tdProfissional.textContent = item.profissional;

                    const tdEspecialidade = document.createElement('td');
                    tdEspecialidade.textContent = grupo.label || 'Sem especialidade';

                    const tdTurno = document.createElement('td');
                    tdTurno.textContent = formatarTurnoLabel(item.turno) || '-';

                    const tdSalaAtual = document.createElement('td');
                    tdSalaAtual.textContent = item.salaAtual || '-';

                    const tdPlanejada = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = 'Sala desejada';
                    input.value = item.salaPlanejada || '';
                    input.dataset.id = item.id;
                    input.addEventListener('input', () => {
                        item.salaPlanejada = input.value;
                        atualizarVisualPlanejamento(item, tr, statusSpan, botaoAcao);
                    });
                    input.addEventListener('keydown', event => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            const todosInputs = Array.from(document.querySelectorAll('#planejamento-tbody input[type="text"]'));
                            const indiceAtual = todosInputs.indexOf(event.currentTarget);
                            if (indiceAtual >= 0) {
                                const proximo = todosInputs[indiceAtual + 1];
                                if (proximo) {
                                    proximo.focus();
                                    proximo.select();
                                } else {
                                    event.currentTarget.blur();
                                }
                            }
                        }
                    });
                    const planejarWrapper = document.createElement('div');
                    planejarWrapper.className = 'planejamento-planejada-wrapper';
                    planejarWrapper.appendChild(input);
                    statusSpan = document.createElement('span');
                    statusSpan.className = 'planejamento-status-chip';
                    planejarWrapper.appendChild(statusSpan);
                    tdPlanejada.appendChild(planejarWrapper);

                    const tdAcao = document.createElement('td');
                    const containerAcoes = document.createElement('div');
                    containerAcoes.className = 'planejamento-acoes';
                    const containerBotoes = document.createElement('div');
                    containerBotoes.className = 'planejamento-acoes-botoes';

                    const botaoEditar = document.createElement('button');
                    botaoEditar.type = 'button';
                    botaoEditar.className = 'btn btn-secondary';
                    botaoEditar.dataset.planejamentoId = item.id;
                    botaoEditar.innerHTML = '<i class="fas fa-pen"></i> Editar';
                    botaoEditar.setAttribute('title', 'Editar agendamento');
                    botaoEditar.setAttribute('aria-label', 'Editar agendamento do planejamento');
                    botaoEditar.addEventListener('click', () => iniciarPlanejamentoEdicao([item.id]));

                    const botaoFrequencia = document.createElement('button');
                    botaoFrequencia.type = 'button';
                    botaoFrequencia.className = 'btn btn-secondary';
                    botaoFrequencia.dataset.planejamentoFrequenciaId = item.id;
                    botaoFrequencia.innerHTML = '<i class="fas fa-user-check"></i> Frequência';
                    botaoFrequencia.addEventListener('click', () => abrirPlanejamentoFrequencia(item.id));

                    botaoAcao = document.createElement('button');
                    botaoAcao.type = 'button';
                    botaoAcao.className = 'btn btn-primary btn-icon';
                    botaoAcao.dataset.planejamentoId = item.id;
                    botaoAcao.innerHTML = '<i class="fas fa-check"></i>';
                    botaoAcao.setAttribute('title', 'Substituir sala');
                    botaoAcao.setAttribute('aria-label', 'Substituir sala planejada');
                    botaoAcao.addEventListener('click', () => aplicarPlanejamentoLinha(item.id));

                    const botaoExcluir = document.createElement('button');
                    botaoExcluir.type = 'button';
                    botaoExcluir.className = 'btn btn-danger btn-icon';
                    botaoExcluir.dataset.planejamentoId = item.id;
                    botaoExcluir.innerHTML = '<i class="fas fa-trash"></i>';
                    botaoExcluir.setAttribute('title', 'Excluir planejamento');
                    botaoExcluir.setAttribute('aria-label', 'Excluir linha do planejamento');
                    botaoExcluir.addEventListener('click', () => excluirPlanejamentoLinha(item.id));

                    containerBotoes.appendChild(botaoEditar);
                    containerBotoes.appendChild(botaoFrequencia);
                    containerBotoes.appendChild(botaoAcao);
                    containerBotoes.appendChild(botaoExcluir);

                    const frequenciaInfo = document.createElement('span');
                    frequenciaInfo.className = 'planejamento-frequencia-info';
                    atualizarInfoFrequenciaElemento(frequenciaInfo, item);
                    atualizarEstadoBotoesRegistroRapido(botaoEntradaRapida, botaoSaidaRapida, item);

                    containerAcoes.appendChild(containerBotoes);
                    containerAcoes.appendChild(frequenciaInfo);
                    tdAcao.appendChild(containerAcoes);

                    tr.appendChild(tdCheck);
                    tr.appendChild(tdProfissional);
                    tr.appendChild(tdEspecialidade);
                    tr.appendChild(tdTurno);
                    tr.appendChild(tdSalaAtual);
                    tr.appendChild(tdPlanejada);
                    tr.appendChild(tdAcao);

                    fragment.appendChild(tr);

                    atualizarVisualPlanejamento(item, tr, statusSpan, botaoAcao);
                });
            });

            tbody.appendChild(fragment);

            atualizarPlanejamentoSelecaoUI();

            if (feedback) {
                const divergentes = linhasFiltradas.filter(item => item.resultado === 'erro');
                const pendentes = linhasFiltradas.filter(item => item.resultado === 'pendente');
                const resumoBase = `${gruposOrdenados.length} especialidade${gruposOrdenados.length === 1 ? '' : 's'} em exibição • ${linhasFiltradas.length} ${linhasFiltradas.length === 1 ? 'profissional' : 'profissionais'}.`;
                if (divergentes.length > 0) {
                    feedback.textContent = `${resumoBase} ${divergentes.length} divergência${divergentes.length === 1 ? '' : 's'} pronta${divergentes.length === 1 ? '' : 's'} para substituição.`;
                    feedback.style.color = 'var(--danger)';
                } else if (pendentes.length > 0) {
                    feedback.textContent = `${resumoBase} ${pendentes.length} registro${pendentes.length === 1 ? '' : 's'} aguardando definição de sala.`;
                    feedback.style.color = 'var(--warning)';
                } else {
                    feedback.textContent = `${resumoBase} Todas as salas planejadas conferem com o agendamento atual.`;
                    feedback.style.color = 'var(--success)';
                }
            }
        }

        function abrirModalPlanejamentoInserir() {
            const modal = document.getElementById('planejamento-inserir-modal');
            if (!modal) return;

            mostrarPlanejamentoInserirAlerta('');
            const loadingText = document.getElementById('planejamento-inserir-loading-text');
            if (loadingText) {
                loadingText.textContent = 'Processando solicitação...';
            }
            definirPlanejamentoInserirProcessando(false);

            const dataInput = document.getElementById('planejamento-inserir-data');
            const turnoSelect = document.getElementById('planejamento-inserir-turno');
            const horaInicioInput = document.getElementById('planejamento-inserir-hora-inicio');
            const horaFimInput = document.getElementById('planejamento-inserir-hora-fim');
            const salaSelect = document.getElementById('planejamento-inserir-sala');
            const ilhaSelect = document.getElementById('planejamento-inserir-ilha');
            const profissionalInput = document.getElementById('planejamento-inserir-profissional');
            const observacoesInput = document.getElementById('planejamento-inserir-observacoes');

            if (dataInput) {
                const dataAtual = estado.dataAtual ? estado.dataAtual.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
                dataInput.value = dataAtual;
            }

            if (turnoSelect) {
                let turnoPadraoEstado = estado.planejamentoTurno || estado.turnoAtual || 'manha';
                if (!turnoPadraoEstado) turnoPadraoEstado = 'manha';
                turnoSelect.value = turnoPadraoEstado;
            }

            if (salaSelect) {
                salaSelect.innerHTML = '<option value="">Selecione uma sala</option>';
                estado.salas.forEach(sala => {
                    const statusSala = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
                    if (!statusBloqueiaAgendamento(statusSala)) {
                        const option = document.createElement('option');
                        option.value = sala.numero;
                        option.textContent = `Sala ${sala.numero}`;
                        salaSelect.appendChild(option);
                    }
                });
                salaSelect.value = '';
            }

            if (ilhaSelect) {
                ilhaSelect.value = '';
            }

            if (profissionalInput) profissionalInput.value = '';
            if (observacoesInput) observacoesInput.value = '';

            atualizarHorariosPlanejamentoInserir();
            sincronizarIlhaPlanejamentoInserir();

            modal.style.display = 'flex';

            if (profissionalInput) {
                setTimeout(() => profissionalInput.focus(), 100);
            }
        }

        function mostrarPlanejamentoInserirAlerta(mensagem) {
            const alerta = document.getElementById('planejamento-inserir-alert');
            const texto = document.getElementById('planejamento-inserir-message');
            if (!alerta || !texto) return;

            if (mensagem) {
                texto.textContent = mensagem;
                alerta.style.display = 'block';
            } else {
                texto.textContent = '';
                alerta.style.display = 'none';
            }
        }

        function definirPlanejamentoInserirProcessando(ativo, mensagem) {
            const overlay = document.getElementById('planejamento-inserir-loading');
            const texto = document.getElementById('planejamento-inserir-loading-text');
            if (!overlay) return;

            if (typeof mensagem === 'string' && texto) {
                texto.textContent = mensagem;
            }

            if (ativo) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function atualizarHorariosPlanejamentoInserir() {
            const turnoSelect = document.getElementById('planejamento-inserir-turno');
            const horaInicioInput = document.getElementById('planejamento-inserir-hora-inicio');
            const horaFimInput = document.getElementById('planejamento-inserir-hora-fim');
            if (!turnoSelect || !horaInicioInput || !horaFimInput) return;

            const turno = turnoSelect.value || 'manha';
            const horariosPadrao = {
                manha: { inicio: '07:00', fim: '13:00' },
                tarde: { inicio: '13:00', fim: '19:00' },
                noite: { inicio: '19:00', fim: '07:00' },
                todos: { inicio: '07:00', fim: '19:00' }
            };

            const valores = horariosPadrao[turno] || horariosPadrao.manha;
            horaInicioInput.value = valores.inicio;
            horaFimInput.value = valores.fim;
        }

        function sincronizarIlhaPlanejamentoInserir() {
            const salaSelect = document.getElementById('planejamento-inserir-sala');
            const ilhaSelect = document.getElementById('planejamento-inserir-ilha');
            if (!salaSelect || !ilhaSelect) return;

            const salaSelecionada = salaSelect.value;
            if (!salaSelecionada) {
                return;
            }

            const salaInfo = estado.salas.find(s => String(s.numero) === String(salaSelecionada));
            if (salaInfo && salaInfo.ilha) {
                ilhaSelect.value = salaInfo.ilha;
            }
        }

        function salvarPlanejamentoManual() {
            mostrarPlanejamentoInserirAlerta('');

            const dataInputEl = document.getElementById('planejamento-inserir-data');
            const turnoSelectEl = document.getElementById('planejamento-inserir-turno');
            const horaInicioEl = document.getElementById('planejamento-inserir-hora-inicio');
            const horaFimEl = document.getElementById('planejamento-inserir-hora-fim');
            const salaSelectEl = document.getElementById('planejamento-inserir-sala');
            const ilhaSelectEl = document.getElementById('planejamento-inserir-ilha');
            const especialidadeSelectEl = document.getElementById('planejamento-inserir-especialidade');
            const categoriaSelectEl = document.getElementById('planejamento-inserir-categoria');
            const profissionalInputEl = document.getElementById('planejamento-inserir-profissional');
            const observacoesInputEl = document.getElementById('planejamento-inserir-observacoes');

            const data = dataInputEl ? dataInputEl.value : '';
            const turno = turnoSelectEl ? turnoSelectEl.value : '';
            const horaInicio = horaInicioEl ? horaInicioEl.value : '';
            const horaFim = horaFimEl ? horaFimEl.value : '';
            const sala = salaSelectEl ? salaSelectEl.value : '';
            const ilha = ilhaSelectEl ? ilhaSelectEl.value : '';
            const especialidade = especialidadeSelectEl ? especialidadeSelectEl.value : '';
            const categoria = categoriaSelectEl ? categoriaSelectEl.value : '';
            const profissional = profissionalInputEl ? profissionalInputEl.value.trim() : '';
            const observacoes = observacoesInputEl ? observacoesInputEl.value : '';

            if (!data || !turno || !horaInicio || !horaFim || !sala || !ilha || !especialidade || !categoria || !profissional) {
                mostrarPlanejamentoInserirAlerta('Preencha todos os campos obrigatórios.');
                return;
            }

            const salvarBtn = document.querySelector('#form-planejamento-inserir button[type="submit"]');

            const salaInfo = estado.salas.find(s => String(s.numero) === String(sala));
            if (!salaInfo) {
                mostrarPlanejamentoInserirAlerta('Sala selecionada não encontrada no cadastro.');
                return;
            }

            const statusSalaInfo = salaInfo.statusNormalizado || normalizarStatus(salaInfo.statusGeral || salaInfo.status);
            if (statusBloqueiaAgendamento(statusSalaInfo) && statusSalaInfo !== 'ocupado') {
                const statusLabel = formatarStatusLabel(statusSalaInfo);
                mostrarPlanejamentoInserirAlerta(`Não é possível utilizar a sala ${sala}. Ela está marcada como ${statusLabel.toLowerCase()}.`);
                return;
            }

            const payload = {
                sala,
                turno,
                horaInicio,
                horaFim,
                especialidade,
                profissional,
                categoria,
                ilha,
                observacoes,
                status: 'ocupado',
                datas: null,
                dataInicio: data,
                dataFim: data
            };

            const executarSalvarAgendamento = () => {
                definirPlanejamentoInserirProcessando(true, 'Salvando novo agendamento...');
                executarGoogleScript({
                    funcao: 'salvarAgendamento',
                    parametros: [payload],
                    tentativas: 1,
                    onSuccess(result) {
                        if (result && result.success) {
                            definirPlanejamentoInserirProcessando(true, 'Agendamento inserido com sucesso!');
                            setTimeout(() => {
                                definirPlanejamentoInserirProcessando(false);
                                if (salvarBtn) salvarBtn.disabled = false;
                                alert('Agendamento inserido com sucesso!');
                                mostrarPlanejamentoInserirAlerta('');
                                const modal = document.getElementById('planejamento-inserir-modal');
                                if (modal) modal.style.display = 'none';
                                const form = document.getElementById('form-planejamento-inserir');
                                if (form) form.reset();
                                carregarDados();
                            }, 400);
                        } else {
                            if (salvarBtn) salvarBtn.disabled = false;
                            definirPlanejamentoInserirProcessando(false);
                            mostrarPlanejamentoInserirAlerta(result?.message || 'Não foi possível salvar o agendamento.');
                        }
                    },
                    onFailure(error) {
                        if (salvarBtn) salvarBtn.disabled = false;
                        definirPlanejamentoInserirProcessando(false);
                        mostrarPlanejamentoInserirAlerta('Erro ao salvar agendamento: ' + (error?.message || error));
                    }
                });
            };

            const conflito = verificarConflitoHorario(sala, data, horaInicio, horaFim, turno);
            if (conflito) {
                const salasLivres = obterSalasLivresParaHorario(data, horaInicio, horaFim, turno, conflito.id);
                if (!salasLivres.length) {
                    mostrarPlanejamentoInserirAlerta('A sala informada está ocupada e não há outras salas livres para movimentar o profissional atual.');
                    return;
                }

                const listaTexto = salasLivres.map(salaLivre => `Sala ${salaLivre.numero}`).join(', ');
                const confirmarMover = confirm(`A sala ${sala} já está ocupada por ${conflito.profissional} (${conflito.horaInicio} - ${conflito.horaFim}).\nSalas livres disponíveis: ${listaTexto}.\nDeseja mover ${conflito.profissional} para uma sala livre e continuar?`);
                if (!confirmarMover) {
                    mostrarPlanejamentoInserirAlerta('Operação cancelada. Escolha outra sala ou confirme o movimento.');
                    return;
                }

                let salaDestinoProfissional = salasLivres[0];
                if (salasLivres.length > 1) {
                    const escolha = prompt('Informe o número da sala para onde deseja mover o profissional atual:', salasLivres[0].numero);
                    if (!escolha) {
                        mostrarPlanejamentoInserirAlerta('Movimentação cancelada. Escolha uma sala válida para continuar.');
                        return;
                    }
                    const encontrada = salasLivres.find(salaLivre => String(salaLivre.numero) === String(escolha).trim());
                    if (!encontrada) {
                        mostrarPlanejamentoInserirAlerta('Sala escolhida não está na lista de disponíveis. Operação cancelada.');
                        return;
                    }
                    salaDestinoProfissional = encontrada;
                }

                if (salvarBtn) salvarBtn.disabled = true;
                definirPlanejamentoInserirProcessando(true, `Movendo ${conflito.profissional} para a sala ${salaDestinoProfissional.numero}...`);
                mostrarPlanejamentoInserirAlerta(`Movendo ${conflito.profissional} para a sala ${salaDestinoProfissional.numero}...`);

                const payloadMovimento = { sala: salaDestinoProfissional.numero };
                if (salaDestinoProfissional.ilha) {
                    payloadMovimento.ilha = salaDestinoProfissional.ilha;
                }

                executarGoogleScript({
                    funcao: 'atualizarAgendamento',
                    parametros: [conflito.id, payloadMovimento],
                    tentativas: 1,
                    onSuccess(result) {
                        if (!result || !result.success) {
                            if (salvarBtn) salvarBtn.disabled = false;
                            definirPlanejamentoInserirProcessando(false);
                            mostrarPlanejamentoInserirAlerta(result?.message || 'Não foi possível mover o agendamento existente.');
                            return;
                        }

                        mostrarPlanejamentoInserirAlerta('Profissional movido com sucesso. Salvando novo agendamento...');
                        executarSalvarAgendamento();
                    },
                    onFailure(error) {
                        if (salvarBtn) salvarBtn.disabled = false;
                        definirPlanejamentoInserirProcessando(false);
                        mostrarPlanejamentoInserirAlerta('Erro ao mover agendamento existente: ' + (error?.message || error));
                    }
                });

                return;
            }

            if (salvarBtn) salvarBtn.disabled = true;
            definirPlanejamentoInserirProcessando(true, 'Salvando novo agendamento...');
            executarSalvarAgendamento();
        }

        function mostrarPlanejamentoMensagem(texto, sucesso = false, alerta = false) {
            const feedback = document.getElementById('planejamento-feedback');
            if (!feedback) return;
            feedback.textContent = texto;
            feedback.style.color = alerta
                ? 'var(--danger)'
                : sucesso
                    ? 'var(--success)'
                    : 'var(--text-secondary)';
        }

        function valorFrequenciaEhFaltou(valor) {
            return normalizarTexto(valor) === 'faltou';
        }

        function sanitizarValorFrequencia(valor) {
            const texto = (valor || '').trim();
            if (!texto || texto === '—' || valorFrequenciaEhFaltou(texto)) {
                return '';
            }
            return texto;
        }

        function obterDescricaoFrequencia(linha) {
            if (!linha) {
                return { texto: 'Frequência não registrada', classe: 'pendente' };
            }

            const chegadaBruta = (linha.horaChegadaReal || '').trim();
            const saidaBruta = (linha.horaSaidaReal || '').trim();

            if (valorFrequenciaEhFaltou(chegadaBruta) || valorFrequenciaEhFaltou(saidaBruta)) {
                return { texto: 'Marcado como faltou', classe: 'faltou' };
            }

            const chegada = sanitizarValorFrequencia(chegadaBruta);
            const saida = sanitizarValorFrequencia(saidaBruta);

            if (!chegada && !saida) {
                return { texto: 'Frequência não registrada', classe: 'pendente' };
            }

            const partes = [];
            if (chegada) partes.push(`Cheg.: ${chegada}`);
            if (saida) partes.push(`Saída: ${saida}`);
            return { texto: partes.join(' · '), classe: 'registrado' };
        }

        function atualizarInfoFrequenciaElemento(elemento, linha) {
            if (!elemento) return;
            const info = obterDescricaoFrequencia(linha);
            elemento.textContent = info.texto;
            elemento.classList.remove('faltou', 'registrado', 'pendente');
            if (info.classe) {
                elemento.classList.add(info.classe);
            }
        }

        function atualizarEstadoBotoesRegistroRapido(botaoEntrada, botaoSaida, linha) {
            const chegadaValor = linha ? sanitizarValorFrequencia(linha.horaChegadaReal) : '';
            const saidaValor = linha ? sanitizarValorFrequencia(linha.horaSaidaReal) : '';
            const chegadaRegistrada = Boolean(chegadaValor);
            const saidaRegistrada = Boolean(saidaValor);

            if (botaoEntrada) {
                botaoEntrada.classList.toggle('is-active', chegadaRegistrada);
                botaoEntrada.setAttribute('aria-pressed', chegadaRegistrada ? 'true' : 'false');
                botaoEntrada.setAttribute('title', chegadaRegistrada
                    ? `Entrada registrada às ${chegadaValor}`
                    : 'Registrar entrada');
            }

            if (botaoSaida) {
                botaoSaida.classList.toggle('is-active', saidaRegistrada);
                botaoSaida.setAttribute('aria-pressed', saidaRegistrada ? 'true' : 'false');
                botaoSaida.setAttribute('title', saidaRegistrada
                    ? `Saída registrada às ${saidaValor}`
                    : 'Registrar saída');
            }
        }

        function mostrarPlanejamentoFrequenciaAlerta(mensagem) {
            const alerta = document.getElementById('planejamento-frequencia-alert');
            const texto = document.getElementById('planejamento-frequencia-message');
            if (!alerta || !texto) return;

            if (mensagem) {
                texto.textContent = mensagem;
                alerta.style.display = 'block';
                alerta.classList.add('show');
            } else {
                texto.textContent = '';
                alerta.style.display = 'none';
                alerta.classList.remove('show');
            }
        }

        function atualizarPlanejamentoFrequenciaStatus(linha) {
            const status = document.getElementById('planejamento-frequencia-status');
            const texto = document.getElementById('planejamento-frequencia-status-texto');
            if (!status || !texto) return;

            status.classList.remove('alert-success', 'alert-warning', 'alert-error', 'show');
            status.style.display = 'none';
            texto.textContent = '';

            if (!linha) {
                return;
            }

            if (valorFrequenciaEhFaltou(linha.horaChegadaReal) || valorFrequenciaEhFaltou(linha.horaSaidaReal)) {
                texto.textContent = 'Profissional marcado como faltou.';
                status.classList.add('alert-warning', 'show');
                status.style.display = 'block';
            } else if (linha.horaChegadaReal || linha.horaSaidaReal) {
                const descricao = obterDescricaoFrequencia(linha);
                texto.textContent = `Último registro: ${descricao.texto}`;
                status.classList.add('alert-success', 'show');
                status.style.display = 'block';
            }
        }

        function atualizarPlanejamentoFrequenciaEstado(id, horaChegada, horaSaida) {
            const idStr = String(id);
            const linha = estado.planejamentoLinhas.find(item => item.id === idStr);
            const agendamento = estado.agendamentos.find(item => String(item.id) === idStr);

            const chegadaNormalizada = horaChegada || '';
            const saidaNormalizada = horaSaida || '';

            if (linha) {
                linha.horaChegadaReal = chegadaNormalizada;
                linha.horaSaidaReal = saidaNormalizada;
                linha.faltou = valorFrequenciaEhFaltou(chegadaNormalizada) || valorFrequenciaEhFaltou(saidaNormalizada);
            }

            if (agendamento) {
                agendamento.horaChegadaReal = chegadaNormalizada;
                agendamento.horaSaidaReal = saidaNormalizada;
            }
        }

        function atualizarPlanejamentoFrequenciaVisual(id) {
            const linha = estado.planejamentoLinhas.find(item => item.id === String(id));
            const botao = document.querySelector(`button[data-planejamento-frequencia-id="${id}"]`);
            if (botao) {
                const container = botao.closest('.planejamento-acoes');
                if (container) {
                    const info = container.querySelector('.planejamento-frequencia-info');
                    if (info) {
                        atualizarInfoFrequenciaElemento(info, linha);
                    }
                }
            }

            const trLinha = document.querySelector(`#planejamento-tbody tr[data-planejamento-id="${id}"]`);
            if (trLinha) {
                const botaoEntrada = trLinha.querySelector('button[data-planejamento-registro="entrada"]');
                const botaoSaida = trLinha.querySelector('button[data-planejamento-registro="saida"]');
                atualizarEstadoBotoesRegistroRapido(botaoEntrada, botaoSaida, linha);
            }
        }

        function abrirPlanejamentoFrequencia(id) {
            const modal = document.getElementById('planejamento-frequencia-modal');
            if (!modal) return;

            const linha = estado.planejamentoLinhas.find(item => item.id === String(id));
            if (!linha) {
                mostrarPlanejamentoMensagem('Não foi possível localizar o agendamento selecionado para frequência.', false, true);
                return;
            }

            mostrarPlanejamentoFrequenciaAlerta('');

            const resumo = document.getElementById('planejamento-frequencia-resumo');
            if (resumo) {
                const partes = [];
                if (linha.profissional && linha.profissional !== '—') partes.push(linha.profissional);
                if (linha.especialidade && linha.especialidade !== '—') partes.push(linha.especialidade);
                const turnoLabel = formatarTurnoLabel(linha.turno);
                if (turnoLabel) partes.push(turnoLabel);
                const dataLabel = linha.dataInicio ? linha.dataInicio.split('-').reverse().join('/') : '';
                if (dataLabel) partes.push(`Dia ${dataLabel}`);
                const salaLabel = linha.salaAtual && linha.salaAtual !== '—' ? `Sala atual ${linha.salaAtual}` : 'Sem sala definida';
                partes.push(salaLabel);
                resumo.textContent = partes.join(' • ');
            }

            const idInput = document.getElementById('planejamento-frequencia-id');
            if (idInput) idInput.value = linha.id;

            const chegadaInput = document.getElementById('planejamento-frequencia-chegada');
            const saidaInput = document.getElementById('planejamento-frequencia-saida');

            const chegadaValor = valorFrequenciaEhFaltou(linha.horaChegadaReal) ? '' : (linha.horaChegadaReal || '');
            const saidaValor = valorFrequenciaEhFaltou(linha.horaSaidaReal) ? '' : (linha.horaSaidaReal || '');

            if (chegadaInput) chegadaInput.value = chegadaValor;
            if (saidaInput) saidaInput.value = saidaValor;

            atualizarPlanejamentoFrequenciaStatus(linha);
            setPlanejamentoFrequenciaBusy(false);

            modal.style.display = 'flex';
            if (chegadaInput) {
                setTimeout(() => chegadaInput.focus(), 100);
            }
        }

        function fecharModalPlanejamentoFrequencia() {
            const modal = document.getElementById('planejamento-frequencia-modal');
            if (!modal) return;
            modal.style.display = 'none';
            const form = document.getElementById('form-planejamento-frequencia');
            if (form) {
                form.reset();
            }
            const idInput = document.getElementById('planejamento-frequencia-id');
            if (idInput) idInput.value = '';
            mostrarPlanejamentoFrequenciaAlerta('');
            atualizarPlanejamentoFrequenciaStatus(null);
            setPlanejamentoFrequenciaBusy(false);
        }

        function setPlanejamentoFrequenciaBusy(isBusy) {
            ['planejamento-frequencia-salvar', 'planejamento-frequencia-cancelar', 'planejamento-frequencia-faltou'].forEach(btnId => {
                const botao = document.getElementById(btnId);
                if (!botao) return;
                botao.disabled = !!isBusy;
                const requerProcessamento = btnId !== 'planejamento-frequencia-cancelar';
                if (requerProcessamento) {
                    if (isBusy) {
                        botao.dataset.keepBusy = 'true';
                        botao.classList.add('is-processing');
                    } else {
                        delete botao.dataset.keepBusy;
                        botao.classList.remove('is-processing');
                    }
                } else if (!isBusy) {
                    delete botao.dataset.keepBusy;
                    botao.classList.remove('is-processing');
                }
            });
        }

        function salvarPlanejamentoFrequencia(event) {
            event.preventDefault();

            const id = document.getElementById('planejamento-frequencia-id').value;
            const chegada = document.getElementById('planejamento-frequencia-chegada').value;
            const saida = document.getElementById('planejamento-frequencia-saida').value;

            if (!id) {
                mostrarPlanejamentoFrequenciaAlerta('Não foi possível identificar o agendamento selecionado.');
                return;
            }

            if (chegada && saida && chegada > saida) {
                mostrarPlanejamentoFrequenciaAlerta('A hora de saída deve ser maior que a hora de chegada.');
                return;
            }

            mostrarPlanejamentoFrequenciaAlerta('');
            setPlanejamentoFrequenciaBusy(true);
            mostrarPlanejamentoMensagem('Registrando frequência...', false);

            executarGoogleScript({
                funcao: 'registrarFrequenciaAgendamento',
                parametros: [id, { horaChegadaReal: chegada || '', horaSaidaReal: saida || '' }],
                tentativas: 1,
                onSuccess(result) {
                    setPlanejamentoFrequenciaBusy(false);
                    if (result && result.success) {
                        mostrarPlanejamentoMensagem(result.message || 'Frequência registrada com sucesso.', true);
                        fecharModalPlanejamentoFrequencia();
                        atualizarPlanejamentoFrequenciaEstado(result.id || id, result.horaChegadaReal, result.horaSaidaReal);
                        atualizarPlanejamentoFrequenciaVisual(result.id || id);
                    } else {
                        const mensagem = (result && result.message) || 'Não foi possível registrar a frequência.';
                        mostrarPlanejamentoFrequenciaAlerta(mensagem);
                        mostrarPlanejamentoMensagem(mensagem, false, true);
                    }
                },
                onFailure(error) {
                    setPlanejamentoFrequenciaBusy(false);
                    const mensagem = 'Erro ao registrar frequência: ' + (error?.message || error);
                    mostrarPlanejamentoFrequenciaAlerta(mensagem);
                    mostrarPlanejamentoMensagem(mensagem, false, true);
                }
            });
        }

        function marcarPlanejamentoFrequenciaFaltou() {
            const id = document.getElementById('planejamento-frequencia-id').value;
            if (!id) {
                mostrarPlanejamentoFrequenciaAlerta('Não foi possível identificar o agendamento selecionado.');
                return;
            }

            const confirmar = confirm('Deseja marcar este profissional como faltou?');
            if (!confirmar) {
                return;
            }

            mostrarPlanejamentoFrequenciaAlerta('');
            setPlanejamentoFrequenciaBusy(true);
            mostrarPlanejamentoMensagem('Marcando frequência como falta...', false);

            executarGoogleScript({
                funcao: 'registrarFrequenciaAgendamento',
                parametros: [id, { faltou: true }],
                tentativas: 1,
                onSuccess(result) {
                    setPlanejamentoFrequenciaBusy(false);
                    if (result && result.success) {
                        mostrarPlanejamentoMensagem(result.message || 'Profissional marcado como faltou.', true);
                        fecharModalPlanejamentoFrequencia();
                        atualizarPlanejamentoFrequenciaEstado(result.id || id, result.horaChegadaReal, result.horaSaidaReal);
                        atualizarPlanejamentoFrequenciaVisual(result.id || id);
                    } else {
                        const mensagem = (result && result.message) || 'Não foi possível marcar o profissional como faltou.';
                        mostrarPlanejamentoFrequenciaAlerta(mensagem);
                        mostrarPlanejamentoMensagem(mensagem, false, true);
                    }
                },
                onFailure(error) {
                    setPlanejamentoFrequenciaBusy(false);
                    const mensagem = 'Erro ao marcar falta: ' + (error?.message || error);
                    mostrarPlanejamentoFrequenciaAlerta(mensagem);
                    mostrarPlanejamentoMensagem(mensagem, false, true);
                }
            });
        }

        function obterHorarioAtualFormatado() {
            return new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        function mostrarPlanejamentoRegistroRapidoAlerta(mensagem) {
            const alerta = document.getElementById('planejamento-registro-rapido-alert');
            const texto = document.getElementById('planejamento-registro-rapido-message');
            if (!alerta || !texto) return;

            if (mensagem) {
                texto.textContent = mensagem;
                alerta.style.display = 'block';
                alerta.classList.add('show');
            } else {
                texto.textContent = '';
                alerta.style.display = 'none';
                alerta.classList.remove('show');
            }
        }

        function setPlanejamentoRegistroRapidoBusy(isBusy) {
            const confirmarBtn = document.getElementById('planejamento-registro-rapido-confirmar');
            const cancelarBtn = document.getElementById('planejamento-registro-rapido-cancelar');

            [confirmarBtn, cancelarBtn].forEach(btn => {
                if (!btn) return;
                btn.disabled = !!isBusy;
            });

            if (confirmarBtn) {
                if (isBusy) {
                    confirmarBtn.dataset.keepBusy = 'true';
                    confirmarBtn.classList.add('is-processing');
                } else {
                    delete confirmarBtn.dataset.keepBusy;
                    confirmarBtn.classList.remove('is-processing');
                    const spinner = confirmarBtn.querySelector('.button-spinner');
                    if (spinner) spinner.remove();
                }
            }
        }

        function fecharPlanejamentoRegistroRapido() {
            const modal = document.getElementById('planejamento-registro-rapido-modal');
            if (!modal) return;
            modal.style.display = 'none';
            contextoRegistroRapido = null;
            mostrarPlanejamentoRegistroRapidoAlerta('');
            setPlanejamentoRegistroRapidoBusy(false);
        }

        function abrirPlanejamentoRegistroRapido(id, tipo) {
            const modal = document.getElementById('planejamento-registro-rapido-modal');
            if (!modal) return;

            const linha = estado.planejamentoLinhas.find(item => item.id === String(id));
            if (!linha) {
                mostrarPlanejamentoMensagem('Não foi possível localizar o agendamento selecionado para frequência.', false, true);
                return;
            }

            const tipoNormalizado = tipo === 'saida' ? 'saida' : 'entrada';
            const horario = obterHorarioAtualFormatado();
            const labelTipo = tipoNormalizado === 'entrada' ? 'entrada' : 'saída';

            contextoRegistroRapido = {
                id: linha.id,
                tipo: tipoNormalizado,
                horario
            };

            const profissionalEl = document.getElementById('planejamento-registro-rapido-profissional');
            if (profissionalEl) {
                profissionalEl.textContent = linha.profissional || 'Profissional não identificado';
            }

            const resumoEl = document.getElementById('planejamento-registro-rapido-resumo');
            if (resumoEl) {
                const partes = [];
                if (linha.especialidade && linha.especialidade !== '—') partes.push(linha.especialidade);
                const turnoLabel = formatarTurnoLabel(linha.turno);
                if (turnoLabel) partes.push(turnoLabel);
                const salaLabel = linha.salaAtual && linha.salaAtual !== '—' ? `Sala ${linha.salaAtual}` : 'Sala não definida';
                partes.push(salaLabel);
                resumoEl.textContent = partes.join(' • ');
            }

            const statusEl = document.getElementById('planejamento-registro-rapido-status');
            if (statusEl) {
                const info = obterDescricaoFrequencia(linha);
                statusEl.textContent = info.texto;
                statusEl.className = `planejamento-registro-rapido-status ${info.classe || ''}`;
            }

            const horarioEl = document.getElementById('planejamento-registro-rapido-horario');
            if (horarioEl) {
                horarioEl.textContent = `Confirmar ${labelTipo} às ${horario}?`;
            }

            mostrarPlanejamentoRegistroRapidoAlerta('');
            setPlanejamentoRegistroRapidoBusy(false);

            modal.style.display = 'flex';
            const confirmarBtn = document.getElementById('planejamento-registro-rapido-confirmar');
            if (confirmarBtn) {
                setTimeout(() => confirmarBtn.focus(), 100);
            }
        }

        function confirmarPlanejamentoRegistroRapido() {
            if (!contextoRegistroRapido) {
                mostrarPlanejamentoRegistroRapidoAlerta('Não foi possível identificar o agendamento selecionado.');
                return;
            }

            const { id, tipo, horario } = contextoRegistroRapido;
            const linha = estado.planejamentoLinhas.find(item => item.id === String(id));

            if (!linha) {
                mostrarPlanejamentoRegistroRapidoAlerta('Não foi possível localizar o agendamento selecionado.');
                return;
            }

            const chegadaAtual = sanitizarValorFrequencia(linha.horaChegadaReal);
            const saidaAtual = sanitizarValorFrequencia(linha.horaSaidaReal);

            const payload = { faltou: false };
            if (tipo === 'entrada') {
                payload.horaChegadaReal = horario;
                payload.horaSaidaReal = saidaAtual;
            } else {
                payload.horaSaidaReal = horario;
                payload.horaChegadaReal = chegadaAtual;
            }

            mostrarPlanejamentoRegistroRapidoAlerta('');
            setPlanejamentoRegistroRapidoBusy(true);
            const labelTipo = tipo === 'entrada' ? 'entrada' : 'saída';
            mostrarPlanejamentoMensagem(`Registrando ${labelTipo} às ${horario}...`, false);

            executarGoogleScript({
                funcao: 'registrarFrequenciaAgendamento',
                parametros: [id, payload],
                tentativas: 1,
                onSuccess(result) {
                    setPlanejamentoRegistroRapidoBusy(false);
                    if (result && result.success) {
                        mostrarPlanejamentoMensagem(result.message || `Registro de ${labelTipo} salvo com sucesso.`, true);
                        fecharPlanejamentoRegistroRapido();
                        atualizarPlanejamentoFrequenciaEstado(result.id || id, result.horaChegadaReal, result.horaSaidaReal);
                        atualizarPlanejamentoFrequenciaVisual(result.id || id);
                    } else {
                        const mensagem = (result && result.message) || 'Não foi possível registrar a frequência.';
                        mostrarPlanejamentoRegistroRapidoAlerta(mensagem);
                        mostrarPlanejamentoMensagem(mensagem, false, true);
                    }
                },
                onFailure(error) {
                    setPlanejamentoRegistroRapidoBusy(false);
                    const mensagem = 'Erro ao registrar frequência: ' + (error?.message || error);
                    mostrarPlanejamentoRegistroRapidoAlerta(mensagem);
                    mostrarPlanejamentoMensagem(mensagem, false, true);
                }
            });
        }

        function obterSalasLivresParaHorario(dataIso, horaInicio, horaFim, turno, ignorarId = null) {
            if (!dataIso || !horaInicio || !horaFim) {
                return [];
            }

            const turnoNormalizado = normalizarTurno(turno) || 'todos';
            const salasLivres = estado.salas.filter(sala => {
                const statusSala = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
                if (statusBloqueiaAgendamento(statusSala)) {
                    return false;
                }

                const conflito = verificarConflitoHorario(
                    sala.numero,
                    dataIso,
                    horaInicio,
                    horaFim,
                    turnoNormalizado,
                    ignorarId
                );

                return !conflito;
            });

            return salasLivres.sort((a, b) => ordenarAlphaNumerico(a.numero, b.numero));
        }

        function aplicarPlanejamentoLinha(id) {
            const linha = estado.planejamentoLinhas.find(item => item.id === String(id));
            if (!linha) {
                mostrarPlanejamentoMensagem('Não foi possível localizar o agendamento selecionado.', false, true);
                return;
            }

            const btnLinha = document.querySelector(`button[data-planejamento-id="${linha.id}"]`);
            const trLinha = btnLinha ? btnLinha.closest('tr') : null;
            const statusSpan = trLinha ? trLinha.querySelector('.planejamento-status') : null;

            const avaliacao = avaliarPlanejamentoLinha(linha);
            atualizarVisualPlanejamento(linha, trLinha, statusSpan, btnLinha);

            if (avaliacao.status === 'pendente') {
                mostrarPlanejamentoMensagem('Defina a sala planejada para continuar.', false, true);
                return;
            }

            if (avaliacao.status === 'ok') {
                mostrarPlanejamentoMensagem('A sala informada já está correta para este profissional.', true);
                return;
            }

            const salaDestino = (linha.salaPlanejada || '').trim();
            if (!salaDestino) {
                mostrarPlanejamentoMensagem('Defina a sala planejada para continuar.', false, true);
                return;
            }

            if (btnLinha) btnLinha.disabled = true;

            const salaInfo = estado.salas.find(s => String(s.numero).toLowerCase() === salaDestino.toLowerCase());
            if (!salaInfo) {
                if (btnLinha) btnLinha.disabled = false;
                mostrarPlanejamentoMensagem('Sala destino não encontrada no cadastro. Verifique a numeração informada.', false, true);
                return;
            }

            const statusSalaDestino = salaInfo.statusNormalizado || normalizarStatus(salaInfo.statusGeral || salaInfo.status);
            if (statusBloqueiaAgendamento(statusSalaDestino) && statusSalaDestino !== 'ocupado') {
                if (btnLinha) btnLinha.disabled = false;
                const statusLabel = formatarStatusLabel(statusSalaDestino);
                mostrarPlanejamentoMensagem(`A sala ${salaDestino} está marcada como ${statusLabel.toLowerCase()} e não pode ser utilizada.`, false, true);
                return;
            }

            const agendamentoOriginal = estado.agendamentos.find(ag => String(ag.id) === linha.id);
            const dataIso = estado.dataAtual.toISOString().split('T')[0];
            const horaInicioRef = linha.horaInicio || (agendamentoOriginal ? agendamentoOriginal.horaInicio : '');
            const horaFimRef = linha.horaFim || (agendamentoOriginal ? agendamentoOriginal.horaFim : '');
            const turnoRef = (agendamentoOriginal && (agendamentoOriginal.turnoNormalizado || normalizarTurno(agendamentoOriginal.turno)))
                || linha.turno
                || 'todos';

            if (agendamentoOriginal && horaInicioRef && horaFimRef) {
                const conflito = verificarConflitoHorario(
                    salaDestino,
                    dataIso,
                    horaInicioRef,
                    horaFimRef,
                    turnoRef,
                    linha.id
                );

                if (conflito) {
                    mostrarPlanejamentoMensagem(`Conflito identificado com ${conflito.profissional || 'outro agendamento'} na sala ${salaDestino}. Realizando troca automática...`, false);

                    executarGoogleScript({
                        funcao: 'trocarAgendamentos',
                        parametros: [linha.id, conflito.id],
                        tentativas: 1,
                        onSuccess(result) {
                            if (result && result.success) {
                                mostrarPlanejamentoMensagem('Troca realizada com sucesso. Atualizando dados...', true);
                                carregarDados();
                            } else {
                                if (btnLinha) btnLinha.disabled = false;
                                mostrarPlanejamentoMensagem(result?.message || 'Não foi possível trocar os agendamentos.', false, true);
                            }
                        },
                        onFailure(error) {
                            if (btnLinha) btnLinha.disabled = false;
                            mostrarPlanejamentoMensagem('Erro ao realizar troca: ' + (error?.message || error), false, true);
                        }
                    });

                    return;
                }
            }

            const payload = { sala: salaInfo.numero };
            if (salaInfo.ilha) {
                payload.ilha = salaInfo.ilha;
            }

            mostrarPlanejamentoMensagem('Aplicando substituição...', false);

            executarGoogleScript({
                funcao: 'atualizarAgendamento',
                parametros: [linha.id, payload],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        mostrarPlanejamentoMensagem('Substituição realizada com sucesso. Atualizando dados...', true);
                        carregarDados();
                    } else {
                        if (btnLinha) btnLinha.disabled = false;
                        mostrarPlanejamentoMensagem(result?.message || 'Não foi possível atualizar o agendamento.', false, true);
                    }
                },
                onFailure(error) {
                    if (btnLinha) btnLinha.disabled = false;
                    mostrarPlanejamentoMensagem('Erro ao substituir: ' + (error?.message || error), false, true);
                }
            });
        }

        function excluirPlanejamentoLinha(id) {
            const linha = estado.planejamentoLinhas.find(item => item.id === String(id));
            if (!linha) {
                mostrarPlanejamentoMensagem('Agendamento não encontrado para exclusão.', false, true);
                return;
            }

            const confirmar = confirm(`Deseja excluir o agendamento de ${linha.profissional} e liberar a sala ${linha.salaAtual || linha.salaPlanejada || ''}?`);
            if (!confirmar) {
                return;
            }

            const botaoExcluir = document.querySelector(`button.btn-danger[data-planejamento-id="${linha.id}"]`);
            if (botaoExcluir) {
                botaoExcluir.dataset.keepBusy = 'true';
                botaoExcluir.disabled = true;
            }

            mostrarPlanejamentoMensagem('Removendo agendamento e liberando sala...', false);

            executarGoogleScript({
                funcao: 'removerAgendamento',
                parametros: [linha.id],
                tentativas: 1,
                onSuccess(result) {
                    if (botaoExcluir) {
                        botaoExcluir.disabled = false;
                        delete botaoExcluir.dataset.keepBusy;
                        botaoExcluir.classList.remove('is-processing');
                    }

                    if (result && result.success) {
                        mostrarPlanejamentoMensagem('Agendamento removido com sucesso. Atualizando dados...', true);
                        carregarDados();
                    } else {
                        mostrarPlanejamentoMensagem(result?.message || 'Não foi possível remover o agendamento.', false, true);
                    }
                },
                onFailure(error) {
                    if (botaoExcluir) {
                        botaoExcluir.disabled = false;
                        delete botaoExcluir.dataset.keepBusy;
                        botaoExcluir.classList.remove('is-processing');
                    }
                    mostrarPlanejamentoMensagem('Erro ao excluir agendamento: ' + (error?.message || error), false, true);
                }
            });
        }

        function aplicarPlanejamentoTudo() {
            estado.planejamentoLinhas.forEach(item => avaliarPlanejamentoLinha(item));
            renderPlanejamento();

            const divergentes = estado.planejamentoLinhas.filter(item => item.resultado === 'erro');
            if (divergentes.length === 0) {
                mostrarPlanejamentoMensagem('Nenhuma divergência para substituir. Ajuste as salas desejadas.', false, true);
                return;
            }

            const aplicarBtn = document.getElementById('planejamento-aplicar');
            if (aplicarBtn) aplicarBtn.disabled = true;

            mostrarPlanejamentoMensagem(`Substituindo ${divergentes.length} registro${divergentes.length === 1 ? '' : 's'}...`, false);

            const dataIso = estado.dataAtual.toISOString().split('T')[0];

            const processar = (index) => {
                if (index >= divergentes.length) {
                    if (aplicarBtn) aplicarBtn.disabled = false;
                    mostrarPlanejamentoMensagem('Substituições concluídas. Atualizando dados...', true);
                    carregarDados();
                    return;
                }

                const item = divergentes[index];
                const salaDestino = (item.salaPlanejada || '').trim();
                const salaInfo = estado.salas.find(s => String(s.numero).toLowerCase() === salaDestino.toLowerCase());
                if (!salaInfo) {
                    if (aplicarBtn) aplicarBtn.disabled = false;
                    mostrarPlanejamentoMensagem(`Sala ${salaDestino} não encontrada no cadastro. Operação interrompida.`, false, true);
                    return;
                }

                const agendamentoOriginal = estado.agendamentos.find(ag => String(ag.id) === item.id);
                if (!agendamentoOriginal) {
                    if (aplicarBtn) aplicarBtn.disabled = false;
                    mostrarPlanejamentoMensagem('Não foi possível localizar um dos agendamentos originais. Operação interrompida.', false, true);
                    return;
                }

                const horaInicioRef = item.horaInicio || agendamentoOriginal.horaInicio || '';
                const horaFimRef = item.horaFim || agendamentoOriginal.horaFim || '';
                const turnoRef = (agendamentoOriginal.turnoNormalizado || normalizarTurno(agendamentoOriginal.turno))
                    || item.turno
                    || 'todos';

                if (horaInicioRef && horaFimRef) {
                    const conflito = verificarConflitoHorario(
                        salaDestino,
                        dataIso,
                        horaInicioRef,
                        horaFimRef,
                        turnoRef,
                        item.id
                    );

                    if (conflito) {
                        mostrarPlanejamentoMensagem(`Conflito identificado na sala ${salaDestino}. Trocando com ${conflito.profissional || 'outro agendamento'}...`, false);

                        executarGoogleScript({
                            funcao: 'trocarAgendamentos',
                            parametros: [item.id, conflito.id],
                            tentativas: 1,
                            onSuccess(result) {
                                if (result && result.success) {
                                    processar(index + 1);
                                } else {
                                    if (aplicarBtn) aplicarBtn.disabled = false;
                                    mostrarPlanejamentoMensagem(result?.message || 'Não foi possível trocar os agendamentos.', false, true);
                                }
                            },
                            onFailure(error) {
                                if (aplicarBtn) aplicarBtn.disabled = false;
                                mostrarPlanejamentoMensagem('Erro ao realizar troca: ' + (error?.message || error), false, true);
                            }
                        });

                        return;
                    }
                }

                const payload = { sala: salaInfo.numero };
                if (salaInfo.ilha) {
                    payload.ilha = salaInfo.ilha;
                }

                executarGoogleScript({
                    funcao: 'atualizarAgendamento',
                    parametros: [item.id, payload],
                    tentativas: 1,
                    onSuccess(result) {
                        if (result && result.success) {
                            processar(index + 1);
                        } else {
                            if (aplicarBtn) aplicarBtn.disabled = false;
                            mostrarPlanejamentoMensagem(result?.message || 'Falha ao substituir um dos agendamentos.', false, true);
                        }
                    },
                    onFailure(error) {
                        if (aplicarBtn) aplicarBtn.disabled = false;
                        mostrarPlanejamentoMensagem('Erro ao substituir: ' + (error?.message || error), false, true);
                    }
                });
            };

            processar(0);
        }

        function criarElementoSala(sala, horarios) {
            const salaDiv = document.createElement('div');
            salaDiv.className = 'sala';
            salaDiv.setAttribute('data-sala', sala.numero);

            // Determinar status geral da sala
            const statusNormalizado = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
            const statusClass = statusParaClasseVisual(statusNormalizado);
            const statusTextMap = {
                bloqueado: 'Bloqueada',
                reservado: 'Reservada',
                manutencao: 'Em manutenção'
            };
            const statusText = statusTextMap[statusNormalizado] || 'Livre';
            
            // Header da sala
            const headerDiv = document.createElement('div');
            headerDiv.className = 'sala-header';
            headerDiv.innerHTML = `
                <div class="sala-numero">
                    <i class="fas fa-door-open"></i> SALA ${sala.numero}
                </div>
                <div class="ilha-pin">
                    <i class="fas fa-umbrella-beach" aria-hidden="true"></i>
                    <span>${sala.ilha ? `Ilha ${sala.ilha}` : 'Sem ilha'}</span>
                </div>
            `;
            salaDiv.appendChild(headerDiv);
            
            // Horários da sala
            const horariosDiv = document.createElement('div');
            horariosDiv.className = 'sala-horarios';
            
            // Se a sala tem status statusGeral, aplicar a todos os horários
            if (['bloqueado', 'reservado', 'manutencao'].includes(statusNormalizado)) {
                salaDiv.classList.add('sala-simplificada');
                const bloqueioDiv = document.createElement('div');
                bloqueioDiv.className = `horario-slot horario-${statusClass} single-block`;
                bloqueioDiv.innerHTML = `
                    <span>${statusText}</span>
                    <div class="horario-status-container">
                        <span class="horario-status">Motivo: ${sala.motivo || 'Não especificado'}</span>
                    </div>
                `;
                horariosDiv.appendChild(bloqueioDiv);
            } else {
                // Caso contrário, verificar agendamentos
                if (estado.visualizacaoSimplificada) {
                    // Visualização simplificada
                    const agendamentosSala = estado.agendamentos.filter(ag => {
                        if (String(ag.sala) !== String(sala.numero)) return false;
                        if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                        if (estado.turnoAtual === 'todos') return true;
                        const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                        const turnoFiltro = normalizarTurno(estado.turnoAtual);
                        return turnoAg === turnoFiltro || turnoAg === 'todos';
                    });

                    if (agendamentosSala.length === 0) {
                        // Sala livre no turno
                        salaDiv.classList.add('sala-simplificada');
                        const livreDiv = document.createElement('div');
                        livreDiv.className = 'horario-slot horario-livre single-block';
                        livreDiv.innerHTML = `
                            <span>${formatarTurnoLabel(estado.turnoAtual)}</span>
                            <div class="horario-status-container">
                                <span class="horario-status">Livre</span>
                            </div>
                        `;
                        horariosDiv.appendChild(livreDiv);
                    } else if (agendamentosSala.length === 1 && isTurnoInteiro(agendamentosSala[0])) {
                        // Um agendamento cobrindo o turno inteiro
                        salaDiv.classList.add('sala-simplificada');
                        const ag = agendamentosSala[0];
                        const especialidadeLabel = (ag.especialidade || '').trim() || 'Especialidade não informada';
                        const profissionalLabel = (ag.profissional || '').trim() || 'Profissional não informado';
                        const ocupadoDiv = document.createElement('div');
                        ocupadoDiv.className = 'horario-slot horario-ocupado single-block';
                        ocupadoDiv.innerHTML = `
                            <span>${formatarTurnoLabel(ag.turno)}</span>
                            <div class="horario-status-container">
                                <span class="horario-status horario-status-especialidade">${especialidadeLabel}</span>
                                <span class="horario-status horario-status-profissional">${profissionalLabel}</span>
                            </div>
                        `;
                        horariosDiv.appendChild(ocupadoDiv);
                    } else {
                        // Múltiplos agendamentos ou não cobrindo inteiro - fallback para detalhado
                        renderHorariosDetalhados(horariosDiv, sala, horarios);
                    }
                } else {
                    // Visualização detalhada
                    renderHorariosDetalhados(horariosDiv, sala, horarios);
                }
            }
            
            salaDiv.appendChild(horariosDiv);
            
            // Adicionar evento de clique para abrir modal de detalhes
            salaDiv.addEventListener('click', function() {
                abrirModalSala(sala.numero);
            });
            
            return salaDiv;
        }

        // Função auxiliar para verificar se agendamento cobre turno inteiro
        function isTurnoInteiro(ag) {
            const turnoRanges = {
                manha: {start: '07:00', end: '13:00'},
                tarde: {start: '13:00', end: '19:00'},
                noite: {start: '19:00', end: '07:00'}
            };
            const turno = ag.turnoNormalizado || normalizarTurno(ag.turno);
            const range = turnoRanges[turno];
            if (!range) return false;
            return ag.horaInicio === range.start && ag.horaFim === range.end;
        }

        // Função auxiliar para renderizar horários detalhados
        function renderHorariosDetalhados(horariosDiv, sala, horarios) {
            if (estado.turnoAtual !== 'todos') {
                horarios.forEach(horario => {
                    const horaInicioStr = horario.split('-')[0];
                    const horaInicio = Number(horaInicioStr.split(':')[0]);
                    
                    const agendamento = estado.agendamentos.find(ag => {
                        if (String(ag.sala) !== String(sala.numero)) return false;
                        if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                        const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                        return turnoAg === estado.turnoAtual && estaNoHorario(ag, horaInicio);
                    });
                    
                    let horarioClass = agendamento ? 'horario-ocupado' : 'horario-livre';
                    
                    const horarioDiv = document.createElement('div');
                    horarioDiv.className = `horario-slot ${horarioClass}`;
                    if (agendamento) {
                        const especialidadeLabel = (agendamento.especialidade || '').trim() || 'Especialidade não informada';
                        const profissionalLabel = (agendamento.profissional || '').trim() || 'Profissional não informado';
                        horarioDiv.innerHTML = `
                            <span>${horario}</span>
                            <div class="horario-status-container">
                                <span class="horario-status horario-status-especialidade">${especialidadeLabel}</span>
                                <span class="horario-status horario-status-profissional">${profissionalLabel}</span>
                            </div>
                        `;
                    } else {
                        horarioDiv.innerHTML = `
                            <span>${horario}</span>
                            <div class="horario-status-container">
                                <span class="horario-status">Livre</span>
                            </div>
                        `;
                    }
                    horariosDiv.appendChild(horarioDiv);
                });
            } else {
                // Modo 'todos' - agrupar por turno
                const turnos = [
                    {nome: 'Manhã', horarios: horariosManha, turno: 'manha'},
                    {nome: 'Tarde', horarios: horariosTarde, turno: 'tarde'},
                    {nome: 'Noite', horarios: horariosNoite, turno: 'noite'}
                ];
                turnos.forEach(turnoInfo => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'turno-section';
                    const header = document.createElement('div');
                    header.className = 'turno-header';
                    header.textContent = turnoInfo.nome;
                    sectionDiv.appendChild(header);
                    turnoInfo.horarios.forEach(horario => {
                        const horaInicioStr = horario.split('-')[0];
                        const horaInicio = Number(horaInicioStr.split(':')[0]);
                    const agendamento = estado.agendamentos.find(ag => {
                        if (String(ag.sala) !== String(sala.numero)) return false;
                        if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) return false;
                        const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                        return turnoAg === turnoInfo.turno && estaNoHorario(ag, horaInicio);
                    });
                        let horarioClass = agendamento ? 'horario-ocupado' : 'horario-livre';
                        const horarioDiv = document.createElement('div');
                        horarioDiv.className = `horario-slot ${horarioClass}`;
                        if (agendamento) {
                            const especialidadeLabel = (agendamento.especialidade || '').trim() || 'Especialidade não informada';
                            const profissionalLabel = (agendamento.profissional || '').trim() || 'Profissional não informado';
                            horarioDiv.innerHTML = `
                                <span>${horario}</span>
                                <div class="horario-status-container">
                                    <span class="horario-status horario-status-especialidade">${especialidadeLabel}</span>
                                    <span class="horario-status horario-status-profissional">${profissionalLabel}</span>
                                </div>
                            `;
                        } else {
                            horarioDiv.innerHTML = `
                                <span>${horario}</span>
                                <div class="horario-status-container">
                                    <span class="horario-status">Livre</span>
                                </div>
                            `;
                        }
                        sectionDiv.appendChild(horarioDiv);
                    });
                    horariosDiv.appendChild(sectionDiv);
                });
            }
        }

        function estaNoHorario(ag, hora) {
            const agHoraInicio = Number(ag.horaInicio.split(':')[0]);
            const agHoraFim = Number(ag.horaFim.split(':')[0]);
            if (agHoraFim <= agHoraInicio) {
                // Overnight
                return hora >= agHoraInicio || hora < agHoraFim;
            } else {
                return hora >= agHoraInicio && hora < agHoraFim;
            }
        }

        function verificarConflito() {
            const sala = document.getElementById('cadastro-sala').value;
            const turno = document.getElementById('cadastro-turno').value;
            const data = document.getElementById('cadastro-data-inicio').value;
            const horaInicio = document.getElementById('cadastro-hora-inicio').value;
            const horaFim = document.getElementById('cadastro-hora-fim').value;
            
            if (!sala || !turno || !data || !horaInicio || !horaFim) {
                esconderAlerta();
                return;
            }
            
            const conflito = verificarConflitoHorario(sala, data, horaInicio, horaFim, turno);
            
            if (conflito) {
                mostrarAlerta(`Conflito de horário: ${conflito.profissional} das ${conflito.horaInicio} às ${conflito.horaFim}`);
            } else {
                esconderAlerta();
            }
        }

        function verificarConflitoHorario(sala, data, horaInicio, horaFim, turno, ignorarId = null) {
            if (!sala || !data || !horaInicio || !horaFim || !turno) {
                return null;
            }

            const dataStr = typeof data === 'string' ? data : new Date(data).toISOString().split('T')[0];
            const turnoNormalizado = normalizarTurno(turno);
            const salaNormalizada = String(sala);
            const ignorarNormalizado = ignorarId != null ? String(ignorarId) : null;

            const agendamentosSala = estado.agendamentos.filter(ag => {
                if (String(ag.sala) !== salaNormalizada) return false;
                if (ignorarNormalizado && String(ag.id) === ignorarNormalizado) return false;

                const agTurno = ag.turnoNormalizado || normalizarTurno(ag.turno);
                if (turnoNormalizado !== 'todos' && agTurno !== turnoNormalizado && agTurno !== 'todos') {
                    return false;
                }

                if (!statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)) {
                    return false;
                }

                return ag.dataInicio <= dataStr && ag.dataFim >= dataStr;
            });

            if (!agendamentosSala.length) {
                return null;
            }

            const toMinutes = hora => {
                const [h, m] = hora.split(':').map(Number);
                return (h * 60) + m;
            };

            const criarIntervalos = (inicio, fim) => {
                if (fim <= inicio) {
                    return [
                        [inicio, 24 * 60],
                        [0, fim]
                    ];
                }
                return [[inicio, fim]];
            };

            const novoInicio = toMinutes(horaInicio);
            const novoFim = toMinutes(horaFim);
            const intervalosNovos = criarIntervalos(novoInicio, novoFim);

            for (const ag of agendamentosSala) {
                const agInicio = toMinutes(ag.horaInicio);
                const agFim = toMinutes(ag.horaFim);
                const intervalosAg = criarIntervalos(agInicio, agFim);

                for (const [iniNovo, fimNovo] of intervalosNovos) {
                    for (const [iniAg, fimAg] of intervalosAg) {
                        if (iniNovo < fimAg && fimNovo > iniAg) {
                            return ag;
                        }
                    }
                }
            }

            return null;
        }

        function obterDatasDoAgendamento(agendamento) {
            if (!agendamento) return [];

            if (Array.isArray(agendamento.datas) && agendamento.datas.length) {
                return agendamento.datas.map(data => {
                    if (typeof data === 'string') return data;
                    const parsed = new Date(data);
                    return isNaN(parsed.getTime()) ? null : parsed.toISOString().split('T')[0];
                }).filter(Boolean);
            }

            const datas = [];
            const inicio = agendamento.dataInicio ? new Date(`${agendamento.dataInicio}T00:00:00`) : null;
            const fim = agendamento.dataFim ? new Date(`${agendamento.dataFim}T00:00:00`) : inicio;

            if (inicio && !isNaN(inicio.getTime()) && fim && !isNaN(fim.getTime())) {
                const cursor = new Date(inicio);
                while (cursor.getTime() <= fim.getTime()) {
                    datas.push(cursor.toISOString().split('T')[0]);
                    cursor.setDate(cursor.getDate() + 1);
                }
            }

            if (!datas.length && agendamento.dataInicio) {
                datas.push(agendamento.dataInicio);
            }

            if (!datas.length && estado.dataAtual instanceof Date) {
                datas.push(estado.dataAtual.toISOString().split('T')[0]);
            }

            return datas;
        }

        function obterSalasLivresParaPeriodo(datas, horaInicio, horaFim, turno, ignorarId = null, salaAtual = null) {
            if (!Array.isArray(datas) || !datas.length) return [];

            const salasOrdenadas = (Array.isArray(estado.salas) ? [...estado.salas] : [])
                .sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
            const salaAtualStr = salaAtual != null ? String(salaAtual) : null;
            const disponiveis = [];

            salasOrdenadas.forEach(sala => {
                const salaNumero = String(sala.numero);
                if (salaAtualStr && salaNumero === salaAtualStr) {
                    return;
                }

                const statusSala = normalizarStatus(sala.statusNormalizado || sala.statusGeral || sala.status);
                if (statusBloqueiaAgendamento(statusSala)) {
                    return;
                }

                let salaDisponivel = true;
                for (const data of datas) {
                    const conflito = verificarConflitoHorario(
                        salaNumero,
                        data,
                        horaInicio,
                        horaFim,
                        turno,
                        ignorarId
                    );
                    if (conflito) {
                        salaDisponivel = false;
                        break;
                    }
                }

                if (salaDisponivel) {
                    disponiveis.push(salaNumero);
                }
            });

            return disponiveis;
        }

        function mostrarAlerta(mensagem) {
            const alerta = document.getElementById('alert-conflito');
            const mensagemSpan = document.getElementById('alert-message');
            mensagemSpan.textContent = mensagem;
            alerta.style.display = 'block';
        }

        function esconderAlerta() {
            document.getElementById('alert-conflito').style.display = 'none';
        }

        function abrirModalSala(numeroSala) {
            const sala = estado.salas.find(s => String(s.numero) === String(numeroSala));
            const agendamentosSala = estado.agendamentos.filter(ag =>
                String(ag.sala) === String(numeroSala) &&
                ag.dataInicio <= estado.dataAtual.toISOString().split('T')[0] &&
                ag.dataFim >= estado.dataAtual.toISOString().split('T')[0] &&
                statusBloqueiaAgendamento(ag.statusNormalizado || ag.status)
            );

            // Atualizar informações no modal
            document.getElementById('modal-sala-numero').textContent = numeroSala;
            const statusSala = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
            const statusLabelMap = {
                bloqueado: 'Bloqueada',
                reservado: 'Reservada',
                manutencao: 'Em manutenção',
                ocupado: 'Ocupado',
                livre: 'Livre'
            };
            document.getElementById('info-status').textContent = statusLabelMap[statusSala] || 'Livre';
            document.getElementById('info-motivo').textContent = ['bloqueado', 'reservado', 'manutencao'].includes(statusSala) ? (sala.motivo || '-') : '-';
            document.getElementById('info-ilha').textContent = sala.ilha;
            document.getElementById('info-turno').textContent =
                estado.turnoAtual === 'todos' ? 'Todos os Turnos' : formatarTurnoLabel(estado.turnoAtual);
            
            // Calcular estatísticas
            let horarios = estado.turnoAtual === 'manha' ? horariosManha : 
                           estado.turnoAtual === 'tarde' ? horariosTarde : 
                           estado.turnoAtual === 'noite' ? horariosNoite : 
                           [...horariosManha, ...horariosTarde, ...horariosNoite];
            let ocupados = 0;
            let proximaDisponibilidade = null;
            
            if (!['bloqueado', 'reservado', 'manutencao'].includes(statusSala)) {
                for (let i = 0; i < horarios.length; i++) {
                    const horaInicioStr = horarios[i].split('-')[0];
                    const horaInicio = Number(horaInicioStr.split(':')[0]);

                    let turnoHorario = estado.turnoAtual;
                    if (estado.turnoAtual === 'todos') {
                        turnoHorario = (horaInicio >= 7 && horaInicio < 13) ? 'manha' :
                                       (horaInicio >= 13 && horaInicio < 19) ? 'tarde' : 'noite';
                    }

                    const agendamento = agendamentosSala.find(ag => {
                        const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                        return turnoAg === turnoHorario && estaNoHorario(ag, horaInicio);
                    });
                    
                    if (agendamento) {
                        ocupados++;
                    } else if (!proximaDisponibilidade) {
                        proximaDisponibilidade = horarios[i].split('-')[0];
                    }
                }
            } else {
                ocupados = horarios.length;
            }
            
            document.getElementById('info-ocupados').textContent = ocupados;
            document.getElementById('info-livres').textContent = horarios.length - ocupados;
            document.getElementById('info-proxima').textContent = 
                proximaDisponibilidade ? `${proximaDisponibilidade}` : 'Não disponível hoje';
            
            // Listar agendamentos
            const agendamentosList = document.getElementById('agendamentos-list');
            agendamentosList.innerHTML = '';
            
            const agendamentosFiltrados = estado.turnoAtual === 'todos' ? agendamentosSala :
                    agendamentosSala.filter(ag => {
                        const turnoAg = ag.turnoNormalizado || normalizarTurno(ag.turno);
                        return turnoAg === estado.turnoAtual;
                    });

            if (agendamentosFiltrados.length === 0) {
                agendamentosList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>Nenhum agendamento para esta sala no dia selecionado.</p>
                    </div>
                `;
            } else {
                agendamentosFiltrados.forEach(ag => {
                    const statusAg = ag.statusNormalizado || normalizarStatus(ag.status);
                    const statusClasse = statusParaClasseVisual(statusAg);
                    const statusLabel = statusLabelMap[statusAg] || 'Ocupado';
                    const chegadaReal = ag.horaChegadaReal || '--';
                    const saidaReal = ag.horaSaidaReal || '--';
                    const frequenciaRegistrada = Boolean(ag.horaChegadaReal || ag.horaSaidaReal);
                    const frequenciaFaltou = valorFrequenciaEhFaltou(ag.horaChegadaReal)
                        || valorFrequenciaEhFaltou(ag.horaSaidaReal)
                        || normalizarTexto(ag.frequenciaStatus) === 'faltou';
                    const frequenciaClasse = frequenciaFaltou ? 'faltou' : frequenciaRegistrada ? 'registrado' : 'pendente';
                    const frequenciaTexto = frequenciaFaltou
                        ? 'Frequência marcada como falta'
                        : frequenciaRegistrada
                            ? 'Frequência registrada'
                            : 'Frequência pendente';
                    const agendamentoItem = document.createElement('div');
                    agendamentoItem.className = 'agendamento-item';
                    agendamentoItem.setAttribute('data-agendamento-id', ag.id);
                    agendamentoItem.innerHTML = `
                        <div class="agendamento-header">
                            <div class="agendamento-horario">${ag.horaInicio} - ${ag.horaFim}</div>
                            <div class="agendamento-status status-${statusClasse}">${statusLabel}</div>
                        </div>
                        <div class="agendamento-details">
                            <div class="detail-item">
                                <strong>Especialidade:</strong>
                                <span>${ag.especialidade}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Profissional:</strong>
                                <span>${ag.profissional}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Categoria:</strong>
                                <span>${ag.categoria}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Ilha:</strong>
                                <span>${ag.ilha}</span>
                            </div>
                        </div>
                        <div class="agendamento-frequencia ${frequenciaClasse}">
                            <span class="agendamento-frequencia-titulo"><i class="fas fa-user-check"></i> Frequência (Planejamento)</span>
                            <span><i class="fas fa-info-circle"></i> ${frequenciaTexto}</span>
                            <span><i class="fas fa-right-to-bracket"></i> Chegada: ${chegadaReal}</span>
                            <span><i class="fas fa-right-from-bracket"></i> Saída: ${saidaReal}</span>
                        </div>
                        <div class="agendamento-actions admin-only">
                            <button class="btn-editar" data-agendamento-id="${ag.id}">
                                <i class="fas fa-user-edit"></i> Editar
                            </button>
                            <button class="btn-mover" data-agendamento-id="${ag.id}">
                                <i class="fas fa-exchange-alt"></i> Mover Sala
                            </button>
                            <button class="btn-excluir" data-agendamento-id="${ag.id}">
                                <i class="fas fa-trash-alt"></i> Excluir
                            </button>
                        </div>
                    `;
                    agendamentosList.appendChild(agendamentoItem);
                });
            }
            
            // Exibir modal
            document.getElementById('sala-modal').style.display = 'flex';

            // Configurar eventos para botões de mover (apenas para admin)
            if (estado.userRole === 'admin') {
                document.querySelectorAll('.btn-mover').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const agId = this.getAttribute('data-agendamento-id');
                        abrirModalMover(agId, numeroSala);
                    });
                });
                document.querySelectorAll('.btn-editar').forEach(btn => {
                    btn.addEventListener('click', function(event) {
                        event.stopPropagation();
                        const agId = this.getAttribute('data-agendamento-id');
                        abrirModalEditar(agId);
                    });
                });
                document.querySelectorAll('.btn-excluir').forEach(btn => {
                    btn.addEventListener('click', function(event) {
                        event.stopPropagation();
                        const agId = this.getAttribute('data-agendamento-id');
                        solicitarExclusaoAgendamento(agId);
                    });
                });
            }
        }

        function abrirModalMover(agendamentoId, salaOrigem) {
            const ag = estado.agendamentos.find(ag => String(ag.id) === String(agendamentoId));
            if (!ag) {
                alert('Agendamento não encontrado.');
                return;
            }

            // Preencher select de salas destino (excluindo origem)
            const selectDestino = document.getElementById('mover-sala-destino');
            selectDestino.innerHTML = '<option value="">Selecione uma sala</option>';
            let possuiSalasDisponiveis = false;
            const salaOrigemNormalizada = String(salaOrigem);
            estado.salas.forEach(sala => {
                const statusSala = sala.statusNormalizado || normalizarStatus(sala.statusGeral || sala.status);
                if (String(sala.numero) !== salaOrigemNormalizada && !statusBloqueiaAgendamento(statusSala)) {
                    const option = document.createElement('option');
                    option.value = sala.numero;
                    option.textContent = `Sala ${sala.numero}`;
                    selectDestino.appendChild(option);
                    possuiSalasDisponiveis = true;
                }
            });

            const moverSubmitBtn = document.querySelector('#form-mover button[type="submit"]');
            const moverAlert = document.getElementById('mover-alert');
            if (!possuiSalasDisponiveis) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma sala livre disponível';
                option.disabled = true;
                option.selected = true;
                selectDestino.appendChild(option);
                document.getElementById('mover-message').textContent = 'Nenhuma sala livre disponível para o horário selecionado.';
                moverAlert.style.display = 'block';
            } else {
                moverAlert.style.display = 'none';
            }
            moverSubmitBtn.disabled = !possuiSalasDisponiveis;

            // Armazenar agendamento ID atual no estado ou attr
            estado.agendamentoMoverId = String(agendamentoId);

            // Exibir modal
            document.getElementById('mover-modal').style.display = 'flex';
        }

        function moverAgendamento() {
    const salaDestino = document.getElementById('mover-sala-destino').value;
    if (!salaDestino) {
        mostrarMoverAlerta('Selecione uma sala destino.');
        return;
    }

    const agOrigem = estado.agendamentos.find(ag => String(ag.id) === String(estado.agendamentoMoverId));
    if (!agOrigem) {
        alert('Agendamento origem não encontrado.');
        return;
    }

    console.log('Movendo agendamento ID:', estado.agendamentoMoverId, 'de sala', agOrigem.sala, 'para', salaDestino);

    // Verificar conflito na destino
    const conflito = verificarConflitoHorario(
        salaDestino,
        agOrigem.dataInicio,
        agOrigem.horaInicio,
        agOrigem.horaFim,
        agOrigem.turno,
        estado.agendamentoMoverId
    );

    if (conflito) {
        console.log('Conflito detectado! ID conflito:', conflito.id, 'Profissional:', conflito.profissional);
        // Troca automática
        executarGoogleScript({
            funcao: 'trocarAgendamentos',
            parametros: [estado.agendamentoMoverId, conflito.id],
            tentativas: 1,
            onSuccess(result) {
                console.log('Resultado da troca:', result);
                if (result && result.success) {
                    alert('Conflito detectado! Troca realizada com sucesso entre as salas.');
                    fecharModalsAndReload();
                } else {
                    mostrarMoverAlerta(result?.message || 'Não foi possível realizar a troca automaticamente.');
                }
            },
            onFailure(error) {
                console.error('Erro ao trocar:', error);
                mostrarMoverAlerta('Erro ao realizar troca: ' + (error?.message || error));
            }
        });
    } else {
        console.log('Sem conflito - Movendo simples');
        // Mover simples
        const salaInfo = estado.salas.find(s => String(s.numero) === String(salaDestino));
        if (!salaInfo) {
            mostrarMoverAlerta('Sala destino não encontrada.');
            return;
        }
        const ilhaDestino = salaInfo.ilha;
        executarGoogleScript({
            funcao: 'atualizarAgendamento',
            parametros: [estado.agendamentoMoverId, { sala: salaDestino, ilha: ilhaDestino }],
            tentativas: 1,
            onSuccess(result) {
                console.log('Resultado do mover:', result);
                if (result && result.success) {
                    alert('Agendamento movido com sucesso!');
                    fecharModalsAndReload();
                } else {
                    mostrarMoverAlerta(result?.message || 'Não foi possível mover o agendamento.');
                }
            },
            onFailure(error) {
                console.error('Erro ao mover:', error);
                mostrarMoverAlerta('Erro ao mover agendamento: ' + (error?.message || error));
            }
        });
    }
}

        function solicitarExclusaoAgendamento(agendamentoId) {
            if (!agendamentoId) return;

            const primeiraConfirmacao = confirm('Tem certeza que deseja excluir este agendamento?');
            if (!primeiraConfirmacao) {
                return;
            }

            const segundaConfirmacao = prompt('Para confirmar a exclusão definitiva, digite EXCLUIR');
            if (!segundaConfirmacao || segundaConfirmacao.trim().toUpperCase() !== 'EXCLUIR') {
                alert('Exclusão cancelada. Digite EXCLUIR para confirmar.');
                return;
            }

            const btn = document.querySelector(`.btn-excluir[data-agendamento-id="${agendamentoId}"]`);
            if (btn) {
                btn.disabled = true;
            }

            excluirAgendamento(agendamentoId, btn);
        }

        function excluirAgendamento(agendamentoId, botaoReferencia = null) {
            executarGoogleScript({
                funcao: 'removerAgendamento',
                parametros: [agendamentoId],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        alert('Agendamento removido com sucesso!');
                        fecharModalsAndReload();
                    } else {
                        if (botaoReferencia) botaoReferencia.disabled = false;
                        alert(result?.message || 'Não foi possível remover o agendamento.');
                    }
                },
                onFailure(error) {
                    if (botaoReferencia) botaoReferencia.disabled = false;
                    alert('Erro ao remover agendamento: ' + (error?.message || error));
                }
            });
        }

        function preencherOpcoesEditar(agendamento = null) {
            const editarEspecialidade = document.getElementById('editar-especialidade');
            if (editarEspecialidade) {
                editarEspecialidade.innerHTML = '<option value="">Selecione</option>';
                (estado.dadosMestres.especialidades || []).forEach(esp => {
                    const option = document.createElement('option');
                    option.value = esp;
                    option.textContent = esp;
                    editarEspecialidade.appendChild(option);
                });
            }

            const editarCategoria = document.getElementById('editar-categoria');
            if (editarCategoria) {
                editarCategoria.innerHTML = '<option value="">Selecione</option>';
                (estado.dadosMestres.categorias || []).forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    editarCategoria.appendChild(option);
                });
            }

            const editarSala = document.getElementById('editar-sala');
            if (editarSala) {
                const statusLabelMap = {
                    livre: 'Livre',
                    ocupado: 'Ocupada',
                    reservado: 'Reservada',
                    bloqueado: 'Bloqueada',
                    manutencao: 'Em manutenção'
                };

                editarSala.innerHTML = '<option value="">Selecione</option>';
                const salasOrdenadas = (Array.isArray(estado.salas) ? [...estado.salas] : [])
                    .sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
                salasOrdenadas.forEach(sala => {
                    const option = document.createElement('option');
                    option.value = sala.numero;

                    const statusSala = normalizarStatus(sala.statusNormalizado || sala.statusGeral || sala.status);
                    const statusDescricao = statusLabelMap[statusSala] || statusSala;
                    const descricaoStatus = statusSala && statusSala !== 'livre' ? ` (${statusDescricao})` : '';
                    option.textContent = `Sala ${sala.numero} - Ilha ${sala.ilha}${descricaoStatus}`;

                    if (
                        statusBloqueiaAgendamento(statusSala) &&
                        (!agendamento || String(agendamento.sala) !== String(sala.numero))
                    ) {
                        option.disabled = true;
                    }

                    editarSala.appendChild(option);
                });
            }
        }

        function abrirModalEditar(agendamentoId, opcoes = {}) {
            const ag = estado.agendamentos.find(ag => String(ag.id) === String(agendamentoId));
            if (!ag) {
                alert('Agendamento não encontrado.');
                return;
            }

            const origemPlanejamento = opcoes && opcoes.origem === 'planejamento';
            if (!origemPlanejamento) {
                planejamentoEdicaoFila = null;
            } else {
                if (!planejamentoEdicaoFila || !Array.isArray(planejamentoEdicaoFila.ids)) {
                    planejamentoEdicaoFila = {
                        ids: [String(agendamentoId)],
                        index: 0
                    };
                }
                if (typeof opcoes.indiceFila === 'number') {
                    planejamentoEdicaoFila.index = opcoes.indiceFila;
                } else if (!Number.isFinite(planejamentoEdicaoFila.index)) {
                    planejamentoEdicaoFila.index = 0;
                }
            }

            preencherOpcoesEditar(ag);

            estado.agendamentoEditarId = String(agendamentoId);

            document.getElementById('editar-profissional').value = ag.profissional || '';
            const editarEspecialidade = document.getElementById('editar-especialidade');
            const editarCategoria = document.getElementById('editar-categoria');
            const editarSala = document.getElementById('editar-sala');
            if (ag.especialidade && editarEspecialidade && !Array.from(editarEspecialidade.options).some(opt => opt.value === ag.especialidade)) {
                const option = document.createElement('option');
                option.value = ag.especialidade;
                option.textContent = ag.especialidade;
                editarEspecialidade.appendChild(option);
            }
            if (ag.categoria && editarCategoria && !Array.from(editarCategoria.options).some(opt => opt.value === ag.categoria)) {
                const option = document.createElement('option');
                option.value = ag.categoria;
                option.textContent = ag.categoria;
                editarCategoria.appendChild(option);
            }
            if (ag.sala && editarSala && !Array.from(editarSala.options).some(opt => opt.value === String(ag.sala))) {
                const option = document.createElement('option');
                option.value = ag.sala;
                option.textContent = `Sala ${ag.sala}`;
                editarSala.appendChild(option);
            }
            document.getElementById('editar-especialidade').value = ag.especialidade || '';
            document.getElementById('editar-categoria').value = ag.categoria || '';
            if (editarSala) {
                editarSala.value = ag.sala || '';
            }
            document.getElementById('editar-status').value = normalizarStatus(ag.status);
            document.getElementById('editar-turno').value = ag.turnoNormalizado || normalizarTurno(ag.turno) || 'manha';
            document.getElementById('editar-hora-inicio').value = ag.horaInicio || '';
            document.getElementById('editar-hora-fim').value = ag.horaFim || '';
            document.getElementById('editar-observacoes').value = ag.observacoes || '';

            const alerta = document.getElementById('editar-alert');
            if (alerta) alerta.style.display = 'none';

            document.getElementById('editar-modal').style.display = 'flex';
            atualizarEditarModalContexto();
        }

        function salvarEdicaoAgendamento(opcoes = {}) {
            if (!estado.agendamentoEditarId) {
                mostrarEditarAlerta('Nenhum agendamento selecionado para edição.');
                return;
            }

            const continuar = opcoes.continuar === true;

            const sala = document.getElementById('editar-sala').value;
            const profissional = document.getElementById('editar-profissional').value.trim();
            const especialidade = document.getElementById('editar-especialidade').value;
            const categoria = document.getElementById('editar-categoria').value;
            const status = document.getElementById('editar-status').value;
            const turno = document.getElementById('editar-turno').value;
            const horaInicio = document.getElementById('editar-hora-inicio').value;
            const horaFim = document.getElementById('editar-hora-fim').value;
            const observacoes = document.getElementById('editar-observacoes').value;

            if (!sala || !profissional || !especialidade || !categoria || !status || !turno || !horaInicio || !horaFim) {
                mostrarEditarAlerta('Preencha todos os campos obrigatórios.');
                return;
            }

            const agOriginal = estado.agendamentos.find(ag => String(ag.id) === String(estado.agendamentoEditarId));
            if (!agOriginal) {
                mostrarEditarAlerta('Não foi possível localizar o agendamento original para validação. Atualize a página e tente novamente.');
                return;
            }

            const salaInfo = estado.salas.find(salaItem => String(salaItem.numero) === String(sala));
            if (!salaInfo) {
                mostrarEditarAlerta('Sala selecionada não encontrada. Atualize os dados e tente novamente.');
                return;
            }

            if (statusBloqueiaAgendamento(status)) {
                const datasVerificacao = obterDatasDoAgendamento(agOriginal);
                let conflitoEncontrado = null;

                for (const dataVerificar of datasVerificacao) {
                    const conflito = verificarConflitoHorario(
                        sala,
                        dataVerificar,
                        horaInicio,
                        horaFim,
                        turno,
                        estado.agendamentoEditarId
                    );
                    if (conflito) {
                        conflitoEncontrado = { data: dataVerificar, detalhes: conflito };
                        break;
                    }
                }

                if (conflitoEncontrado) {
                    const salasDisponiveis = obterSalasLivresParaPeriodo(
                        datasVerificacao,
                        horaInicio,
                        horaFim,
                        turno,
                        estado.agendamentoEditarId,
                        sala
                    );

                    const salasTexto = salasDisponiveis.length
                        ? salasDisponiveis.map(numero => `Sala ${numero}`).join(', ')
                        : 'Nenhuma sala disponível para este período.';

                    const mensagemConflito = salasDisponiveis.length
                        ? `Conflito de horário na sala ${sala}. Já existe agendamento de ${conflitoEncontrado.detalhes.profissional} das ${conflitoEncontrado.detalhes.horaInicio} às ${conflitoEncontrado.detalhes.horaFim}. Salas livres neste período: ${salasTexto}. Selecione uma delas no campo de sala.`
                        : `Conflito de horário na sala ${sala}. Já existe agendamento de ${conflitoEncontrado.detalhes.profissional} das ${conflitoEncontrado.detalhes.horaInicio} às ${conflitoEncontrado.detalhes.horaFim}. Nenhuma sala livre foi encontrada para este período. Ajuste o horário ou o turno.`;

                    mostrarEditarAlerta(mensagemConflito);
                    return;
                }
            }

            const payload = {
                sala,
                ilha: salaInfo.ilha,
                profissional,
                especialidade,
                categoria,
                status,
                turno,
                horaInicio,
                horaFim,
                observacoes
            };

            executarGoogleScript({
                funcao: 'atualizarAgendamento',
                parametros: [estado.agendamentoEditarId, payload],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        const planejamentoAtivo = Boolean(
                            planejamentoEdicaoFila && Array.isArray(planejamentoEdicaoFila.ids) && planejamentoEdicaoFila.ids.length
                        );

                        if (planejamentoAtivo) {
                            mostrarPlanejamentoMensagem(result.message || 'Agendamento atualizado com sucesso!', true);
                        } else {
                            alert(result.message || 'Agendamento atualizado com sucesso!');
                        }

                        const proximoDisponivel = planejamentoAtivo
                            && planejamentoEdicaoFila.index < planejamentoEdicaoFila.ids.length - 1;

                        if (planejamentoAtivo && continuar && proximoDisponivel) {
                            planejamentoEdicaoFila.index += 1;
                            const proximoId = planejamentoEdicaoFila.ids[planejamentoEdicaoFila.index];
                            estado.agendamentoEditarId = null;
                            const alerta = document.getElementById('editar-alert');
                            if (alerta) alerta.style.display = 'none';
                            abrirModalEditar(proximoId, { origem: 'planejamento', indiceFila: planejamentoEdicaoFila.index });
                            carregarDados({ forcarAtualizacao: true });
                            return;
                        }

                        estado.agendamentoEditarId = null;
                        document.getElementById('editar-modal').style.display = 'none';
                        planejamentoEdicaoFila = null;
                        atualizarEditarModalContexto();
                        carregarDados();
                        if (planejamentoAtivo) {
                            limparPlanejamentoSelecao();
                            atualizarPlanejamentoSelecaoUI();
                        }
                    } else {
                        mostrarEditarAlerta(result?.message || 'Não foi possível atualizar o agendamento.');
                    }
                },
                onFailure(error) {
                    mostrarEditarAlerta('Erro ao atualizar agendamento: ' + (error?.message || error));
                }
            });
        }

        function mostrarEditarAlerta(mensagem) {
            const alerta = document.getElementById('editar-alert');
            if (!alerta) return;
            document.getElementById('editar-message').textContent = mensagem;
            alerta.style.display = 'block';
            setTimeout(() => {
                alerta.style.display = 'none';
            }, 5000);
        }

        function fecharModalsAndReload() {
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            carregarDados();
        }

        function mostrarMoverAlerta(mensagem) {
            const alerta = document.getElementById('mover-alert');
            document.getElementById('mover-message').textContent = mensagem;
            alerta.style.display = 'block';
            setTimeout(() => alerta.style.display = 'none', 5000);
        }

        function preencherSalasResidenteCadastro() {
            const select = document.getElementById('cadastro-residente-salas');
            if (!select) return;

            select.innerHTML = '';

            const salasDisponiveis = (Array.isArray(estado.salas) ? [...estado.salas] : [])
                .filter(sala => !statusBloqueiaAgendamento(sala.statusNormalizado || sala.statusGeral || sala.status))
                .sort((a, b) => ordenarAlphaNumerico(a.numero, b.numero));

            salasDisponiveis.forEach(sala => {
                const option = document.createElement('option');
                option.value = sala.numero;
                const ilhaLabel = sala.ilha ? ` - Ilha ${sala.ilha}` : '';
                option.textContent = `Sala ${sala.numero}${ilhaLabel}`;
                select.appendChild(option);
            });
        }

        function atualizarCamposResidenteCadastro() {
            const selectModo = document.getElementById('cadastro-residente');
            const grupoSalas = document.getElementById('cadastro-residente-salas-group');
            if (!selectModo || !grupoSalas) return;

            const ativo = (selectModo.value || 'nao') === 'sim';
            grupoSalas.style.display = ativo ? 'flex' : 'none';

            if (!ativo) {
                const selectSalas = document.getElementById('cadastro-residente-salas');
                if (selectSalas) {
                    Array.from(selectSalas.options).forEach(opt => opt.selected = false);
                }
            }
        }

        function abrirModalCadastro() {
            // Preencher opções de sala
            const selectSala = document.getElementById('cadastro-sala');
            selectSala.innerHTML = '<option value="">Selecione uma sala</option>';
            
            estado.salas.forEach(sala => {
                if (!statusBloqueiaAgendamento(sala.statusNormalizado || sala.statusGeral || sala.status)) {
                    const option = document.createElement('option');
                    option.value = sala.numero;
                    option.textContent = `Sala ${sala.numero}`;
                    selectSala.appendChild(option);
                }
            });

            preencherSalasResidenteCadastro();

            const cadastroResidenteSelect = document.getElementById('cadastro-residente');
            if (cadastroResidenteSelect) {
                cadastroResidenteSelect.value = 'nao';
            }
            const cadastroResidenteSalas = document.getElementById('cadastro-residente-salas');
            if (cadastroResidenteSalas) {
                Array.from(cadastroResidenteSalas.options).forEach(opt => opt.selected = false);
            }
            atualizarCamposResidenteCadastro();
            
            // Definir data atual como padrão
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('cadastro-data-inicio').value = hoje;
            document.getElementById('cadastro-data-fim').value = hoje;
            
            // Definir hora padrão baseada no turno atual
            if (estado.turnoAtual === 'manha') {
                document.getElementById('cadastro-hora-inicio').value = '07:00';
                document.getElementById('cadastro-hora-fim').value = '13:00';
            } else if (estado.turnoAtual === 'tarde') {
                document.getElementById('cadastro-hora-inicio').value = '13:00';
                document.getElementById('cadastro-hora-fim').value = '19:00';
            } else if (estado.turnoAtual === 'noite') {
                document.getElementById('cadastro-hora-inicio').value = '19:00';
                document.getElementById('cadastro-hora-fim').value = '07:00';
            } else {
                // Para 'todos', default para manhã
                document.getElementById('cadastro-hora-inicio').value = '07:00';
                document.getElementById('cadastro-hora-fim').value = '13:00';
            }
            
            // Definir turno atual como padrão (se não for 'todos')
            document.getElementById('cadastro-turno').value = estado.turnoAtual === 'todos' ? 'manha' : estado.turnoAtual;
            
            // Resetar checkbox de dias específicos
            document.getElementById('agendar-dias-especificos').checked = false;
            document.getElementById('dias-selecao').style.display = 'none';
            document.querySelectorAll('.dia-semana').forEach(cb => cb.checked = false);
            
            // Esconder alerta
            esconderAlerta();

            // Exibir modal
            document.getElementById('cadastro-modal').style.display = 'flex';
        }

        function abrirModalBloqueio() {
            // Preencher seleção múltipla de salas
            const salasSelecao = document.getElementById('salas-selecao');
            salasSelecao.innerHTML = '';
            
            estado.salas.sort((a, b) => parseInt(a.numero) - parseInt(b.numero)).forEach(sala => {
                const salaDiv = document.createElement('div');
                salaDiv.className = 'sala-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `sala-${sala.numero}`;
                checkbox.value = sala.numero;
                checkbox.className = 'sala-checkbox-input';
                
                const label = document.createElement('label');
                label.htmlFor = `sala-${sala.numero}`;
                label.textContent = `Sala ${sala.numero}`;
                
                salaDiv.appendChild(checkbox);
                salaDiv.appendChild(label);
                salasSelecao.appendChild(salaDiv);
            });
            
            // Exibir modal
            document.getElementById('bloqueio-modal').style.display = 'flex';
        }

        function salvarAgendamento() {
            // Obter dados do formulário
            const formDataBase = {
                sala: document.getElementById('cadastro-sala').value,
                turno: document.getElementById('cadastro-turno').value,
                horaInicio: document.getElementById('cadastro-hora-inicio').value,
                horaFim: document.getElementById('cadastro-hora-fim').value,
                especialidade: document.getElementById('cadastro-especialidade').value,
                profissional: document.getElementById('cadastro-profissional').value,
                categoria: document.getElementById('cadastro-categoria').value,
                ilha: document.getElementById('cadastro-ilha').value,
                observacoes: document.getElementById('cadastro-observacoes').value,
                status: 'ocupado'
            };

            // Validar dados base
            if (!formDataBase.sala || !formDataBase.turno || !formDataBase.horaInicio || !formDataBase.horaFim ||
                !formDataBase.especialidade || !formDataBase.profissional || !formDataBase.categoria || !formDataBase.ilha) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const dataInicioStr = document.getElementById('cadastro-data-inicio').value;
            const dataFimStr = document.getElementById('cadastro-data-fim').value;
            const usarDiasEspecificos = document.getElementById('agendar-dias-especificos').checked;

            let datas = [];
            if (usarDiasEspecificos) {
                const diasSelecionados = Array.from(document.querySelectorAll('.dia-semana:checked')).map(cb => parseInt(cb.value));
                if (diasSelecionados.length === 0) {
                    alert('Selecione pelo menos um dia da semana.');
                    return;
                }

                let currentDate = new Date(dataInicioStr);
                const endDate = new Date(dataFimStr);
                while (currentDate <= endDate) {
                    if (diasSelecionados.includes(currentDate.getDay())) {
                        datas.push(currentDate.toISOString().split('T')[0]);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else {
                datas = null; // Para modo contínuo
            }

            if (usarDiasEspecificos && datas.length === 0) {
                alert('Nenhuma data válida para agendamento.');
                return;
            }

            const datasParaVerificar = usarDiasEspecificos ? [...datas] : [dataInicioStr];
            if (!usarDiasEspecificos && dataFimStr && dataFimStr !== dataInicioStr) {
                datasParaVerificar.push(dataFimStr);
            }
            const datasValidas = datasParaVerificar.filter(Boolean);

            const formatarDataResumo = dataIso => {
                try {
                    if (!dataIso) return '';
                    const data = new Date(`${dataIso}T12:00:00`);
                    if (isNaN(data.getTime())) return dataIso;
                    return data.toLocaleDateString('pt-BR');
                } catch (erro) {
                    return dataIso;
                }
            };

            const residenteSelect = document.getElementById('cadastro-residente');
            const desejaResidente = residenteSelect && residenteSelect.value === 'sim';
            let residentes = [];

            if (desejaResidente) {
                const selectResidenteSalas = document.getElementById('cadastro-residente-salas');
                const selecionadas = selectResidenteSalas
                    ? Array.from(selectResidenteSalas.selectedOptions).map(opt => String(opt.value).trim()).filter(Boolean)
                    : [];

                const salasUnicas = [];
                const setSalas = new Set();
                selecionadas.forEach(salaNumero => {
                    if (!setSalas.has(salaNumero)) {
                        setSalas.add(salaNumero);
                        salasUnicas.push(salaNumero);
                    }
                });

                if (!salasUnicas.length) {
                    alert('Selecione ao menos uma sala para os residentes ou escolha "Não" na opção Residente.');
                    return;
                }

                if (salasUnicas.includes(formDataBase.sala)) {
                    alert('A sala principal não pode ser reutilizada para residentes. Escolha salas diferentes.');
                    return;
                }

                const salasInfo = Array.isArray(estado.salas) ? estado.salas : [];
                residentes = salasUnicas.map((salaNumero, index) => {
                    const info = salasInfo.find(s => String(s.numero) === salaNumero) || {};
                    return {
                        sala: salaNumero,
                        ilha: info.ilha || formDataBase.ilha,
                        indice: index + 1
                    };
                });
            }

            // Verificar conflitos para a data inicial ou todas se específico
            for (const dataVerificar of datasValidas) {
                const conflitoBase = verificarConflitoHorario(formDataBase.sala, dataVerificar, formDataBase.horaInicio, formDataBase.horaFim, formDataBase.turno);
                if (conflitoBase) {
                    mostrarAlerta(`Conflito na sala ${formDataBase.sala} em ${formatarDataResumo(dataVerificar)}: ${conflitoBase.profissional} das ${conflitoBase.horaInicio} às ${conflitoBase.horaFim}`);
                    return;
                }
            }

            for (const residente of residentes) {
                for (const dataVerificar of datasValidas) {
                    const conflitoResidente = verificarConflitoHorario(residente.sala, dataVerificar, formDataBase.horaInicio, formDataBase.horaFim, formDataBase.turno);
                    if (conflitoResidente) {
                        mostrarAlerta(`Conflito para Residente ${residente.indice} na sala ${residente.sala} em ${formatarDataResumo(dataVerificar)}: ${conflitoResidente.profissional} das ${conflitoResidente.horaInicio} às ${conflitoResidente.horaFim}`);
                        return;
                    }
                }
            }

            // Salvar no Google Sheets - enviar array de datas se específico
            const payload = {
                ...formDataBase,
                datas: usarDiasEspecificos ? datas : null,
                dataInicio: usarDiasEspecificos ? null : dataInicioStr,
                dataFim: usarDiasEspecificos ? null : dataFimStr,
                residentes: residentes.length ? residentes.map(res => ({ sala: res.sala, ilha: res.ilha })) : null
            };

            executarGoogleScript({
                funcao: 'salvarAgendamento',
                parametros: [payload],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        alert('Agendamento salvo com sucesso!');
                        document.getElementById('cadastro-modal').style.display = 'none';
                        document.getElementById('form-cadastro').reset();
                        carregarDados();
                    } else {
                        alert('Erro: ' + (result?.message || 'Não foi possível salvar o agendamento.'));
                    }
                },
                onFailure(error) {
                    alert('Erro ao salvar agendamento: ' + (error?.message || error));
                }
            });
        }

        function salvarStatusSalas() {
            const status = document.getElementById('bloqueio-status').value;
            const motivo = document.getElementById('bloqueio-motivo').value;
            
            // Obter salas selecionadas
            const salasSelecionadas = Array.from(document.querySelectorAll('.sala-checkbox-input:checked')).map(cb => cb.value);
            
            if (salasSelecionadas.length === 0) {
                alert('Por favor, selecione pelo menos uma sala.');
                return;
            }
            
            // Salvar status no Google Sheets
            executarGoogleScript({
                funcao: 'atualizarStatusMultiplasSalas',
                parametros: [salasSelecionadas, status, motivo],
                tentativas: 1,
                onSuccess(result) {
                    if (result && result.success) {
                        alert(`Status de ${salasSelecionadas.length} salas atualizado para ${status}!`);
                        document.getElementById('bloqueio-modal').style.display = 'none';
                        document.getElementById('form-bloqueio').reset();
                        carregarDados();
                    } else {
                        alert('Erro: ' + (result?.message || 'Não foi possível atualizar o status das salas.'));
                    }
                },
                onFailure(error) {
                    alert('Erro ao salvar status das salas: ' + (error?.message || error));
                }
            });
        }

        // Funções para as novas abas

        function atualizarResumoIndicadores(prefixo, resumo) {
            const dados = resumo || {};
            const definirTexto = (campo, valor, sufixo) => {
                const elemento = document.getElementById(`${prefixo}-${campo}`);
                if (!elemento) return;

                if (campo === 'periodo') {
                    elemento.textContent = valor && String(valor).trim() ? valor : '-';
                    return;
                }

                if (sufixo === '%') {
                    const numero = Number(valor);
                    elemento.textContent = Number.isFinite(numero) ? `${numero}%` : '0%';
                    return;
                }

                const numero = Number(valor);
                if (Number.isFinite(numero)) {
                    elemento.textContent = numero.toLocaleString('pt-BR');
                } else {
                    elemento.textContent = valor && String(valor).trim() ? valor : '0';
                }
            };

            definirTexto('periodo', dados.periodoTexto || '-');
            definirTexto('total', dados.totalAgendamentos ?? 0);
            definirTexto('dias', dados.diasAnalisados ?? 0);
            definirTexto('ocupacao-media', dados.ocupacaoMedia ?? 0, '%');
            definirTexto('ocupacao-pico', dados.ocupacaoPico ?? 0, '%');
            definirTexto('aproveitamento', dados.taxaAproveitamento ?? 0, '%');
            definirTexto('salas', dados.salasAtivas ?? 0);
            definirTexto('salas-consideradas', dados.totalSalasConsideradas ?? 0);
            definirTexto('especialidades', dados.especialidadesAtivas ?? 0);
            definirTexto('turnos', dados.turnosAtivos ?? 0);
        }

        function atualizarDashboardComparativoResumo(resumoPrincipal, resumoComparativo) {
            const banner = document.getElementById('dashboard-comparativo-resumo');
            if (!banner) return;
            const ativo = Boolean(estado.dashboardComparacaoAtiva && resumoComparativo && estado.dashboardComparativoInfo);
            banner.classList.toggle('active', ativo);
            if (!ativo) {
                ['dashboard-comparativo-total', 'dashboard-comparativo-ocupacao', 'dashboard-comparativo-aproveitamento'].forEach(id => {
                    const valorEl = document.getElementById(id);
                    const diffEl = document.getElementById(`${id}-diff`);
                    if (valorEl) valorEl.textContent = '--';
                    if (diffEl) {
                        diffEl.textContent = 'Sem dados de comparação';
                        diffEl.className = 'comparison-diff neutral';
                    }
                });
                return;
            }

            const descricao = estado.dashboardComparativoInfo?.descricao || resumoComparativo.periodoTexto || '-';
            const descricaoEl = document.getElementById('dashboard-comparativo-periodo');
            if (descricaoEl) descricaoEl.textContent = descricao;

            const resumoAtual = resumoPrincipal || {};
            atualizarMetricasComparacao('dashboard-comparativo-total', resumoAtual.totalAgendamentos, resumoComparativo.totalAgendamentos);
            atualizarMetricasComparacao('dashboard-comparativo-ocupacao', resumoAtual.ocupacaoMedia, resumoComparativo.ocupacaoMedia, { percentual: true });
            atualizarMetricasComparacao('dashboard-comparativo-aproveitamento', resumoAtual.taxaAproveitamento, resumoComparativo.taxaAproveitamento, { percentual: true });
        }

        function atualizarRelatorioComparativoResumo(resumoPrincipal, resumoComparativo) {
            const banner = document.getElementById('relatorio-comparativo-resumo');
            if (!banner) return;
            const ativo = Boolean(estado.relatorioComparacaoAtiva && resumoComparativo && estado.relatorioComparativoInfo);
            banner.classList.toggle('active', ativo);
            if (!ativo) {
                ['relatorio-comparativo-total', 'relatorio-comparativo-ocupacao', 'relatorio-comparativo-aproveitamento'].forEach(id => {
                    const valorEl = document.getElementById(id);
                    const diffEl = document.getElementById(`${id}-diff`);
                    if (valorEl) valorEl.textContent = '--';
                    if (diffEl) {
                        diffEl.textContent = 'Sem dados de comparação';
                        diffEl.className = 'comparison-diff neutral';
                    }
                });
                return;
            }

            const descricao = estado.relatorioComparativoInfo?.descricao || resumoComparativo.periodoTexto || '-';
            const descricaoEl = document.getElementById('relatorio-comparativo-periodo');
            if (descricaoEl) descricaoEl.textContent = descricao;

            const resumoAtual = resumoPrincipal || {};
            atualizarMetricasComparacao('relatorio-comparativo-total', resumoAtual.totalAgendamentos, resumoComparativo.totalAgendamentos);
            atualizarMetricasComparacao('relatorio-comparativo-ocupacao', resumoAtual.ocupacaoMedia, resumoComparativo.ocupacaoMedia, { percentual: true });
            atualizarMetricasComparacao('relatorio-comparativo-aproveitamento', resumoAtual.taxaAproveitamento, resumoComparativo.taxaAproveitamento, { percentual: true });
        }

        function formatarDataCurtaGrafico(isoDate) {
            if (!isoDate) return '';
            const partes = isoDate.split('-');
            if (partes.length !== 3) return isoDate;
            const [ano, mes, dia] = partes;
            if (!ano || !mes || !dia) return isoDate;
            return `${dia}/${mes}`;
        }

        function clonarConfigChart(chart) {
            if (!chart || !chart.config) return null;
            const { type, data, options } = chart.config;
            return {
                type,
                data: JSON.parse(JSON.stringify(data || {})),
                options: JSON.parse(JSON.stringify(options || {}))
            };
        }

        function gerarDetalhesGrafico(chart) {
            if (!chart || !chart.config) return [];
            const labels = Array.isArray(chart.config.data?.labels) ? chart.config.data.labels : [];
            const datasets = Array.isArray(chart.config.data?.datasets) ? chart.config.data.datasets : [];
            return labels.map((label, index) => ({
                label,
                valores: datasets.map(dataset => ({
                    legenda: dataset.label || '',
                    valor: Array.isArray(dataset.data) ? dataset.data[index] : dataset.data
                }))
            }));
        }

        function atualizarDetalhesGraficoModal(chart) {
            const lista = document.getElementById('chart-modal-detalhes');
            if (!lista) return;
            lista.innerHTML = '';
            const detalhes = gerarDetalhesGrafico(chart);
            if (!detalhes.length) {
                const li = document.createElement('li');
                li.textContent = 'Nenhum dado disponível para detalhamento.';
                lista.appendChild(li);
                return;
            }

            detalhes.forEach(item => {
                const li = document.createElement('li');
                const titulo = document.createElement('span');
                titulo.textContent = item.label || '-';
                titulo.className = 'chart-modal-detalhe-label';
                li.appendChild(titulo);

                item.valores.forEach(valorItem => {
                    const span = document.createElement('span');
                    const valorNumero = Number(valorItem.valor);
                    const textoValor = Number.isFinite(valorNumero)
                        ? valorNumero.toLocaleString('pt-BR')
                        : (valorItem.valor ?? '0');
                    span.textContent = valorItem.legenda
                        ? `${valorItem.legenda}: ${textoValor}`
                        : textoValor;
                    li.appendChild(span);
                });

                lista.appendChild(li);
            });
        }

        function abrirGraficoDetalhe(alvo) {
            const canvasOrigem = document.getElementById(`chart-${alvo}`);
            if (!canvasOrigem || !canvasOrigem.chart) {
                console.warn('Gráfico não encontrado para expandir:', alvo);
                return;
            }

            const modal = document.getElementById('chart-modal');
            const modalCanvas = document.getElementById('chart-modal-canvas');
            const modalTitulo = document.getElementById('chart-modal-title');
            if (!modal || !modalCanvas) return;

            const chartOrigem = canvasOrigem.chart;
            const configClonada = clonarConfigChart(chartOrigem);
            if (!configClonada) return;

            if (configClonada?.options?.plugins?.percentagePlugin) {
                configClonada.options.plugins.percentagePlugin.enabled = true;
            }

            const tituloOrigem = canvasOrigem.closest('.chart-container')?.querySelector('.chart-header h3');
            if (modalTitulo && tituloOrigem) {
                modalTitulo.innerHTML = `<i class="fas fa-chart-bar"></i> ${tituloOrigem.textContent.trim()}`;
            }

            const contexto = modalCanvas.getContext('2d');
            if (modalCanvas.chart) {
                modalCanvas.chart.destroy();
            }
            modalCanvas.chart = new Chart(contexto, configClonada);
            atualizarDetalhesGraficoModal(chartOrigem);

            modal.style.display = 'flex';
        }

        function fecharChartModal() {
            const modal = document.getElementById('chart-modal');
            const modalCanvas = document.getElementById('chart-modal-canvas');
            const detalhes = document.getElementById('chart-modal-detalhes');
            if (modal) {
                modal.style.display = 'none';
            }
            if (modalCanvas && modalCanvas.chart) {
                modalCanvas.chart.destroy();
                modalCanvas.chart = null;
            }
            if (detalhes) {
                detalhes.innerHTML = '';
            }
        }

        function inicializarExpansaoGraficos() {
            document.querySelectorAll('.chart-action').forEach(botao => {
                botao.addEventListener('click', () => {
                    const alvo = botao.dataset.chartTarget;
                    if (alvo) {
                        abrirGraficoDetalhe(alvo);
                    }
                });
            });
        }

        
        function inicializarDashboardDiasEspecificos() {
            const periodoSelect = document.getElementById('dashboard-periodo');
            const container = document.getElementById('dashboard-dia-especifico-container');
            const intervaloWrapper = document.getElementById('dashboard-dia-range');
            const inputInicio = document.getElementById('dashboard-dia-inicio');
            const inputFim = document.getElementById('dashboard-dia-fim');
            const radios = document.querySelectorAll('input[name="dashboard-dia-modo"]');

            if (!periodoSelect || !container || !intervaloWrapper || !inputInicio || !inputFim) {
                return;
            }

            if (!estado.dashboardIntervaloDias || typeof estado.dashboardIntervaloDias !== 'object') {
                estado.dashboardIntervaloDias = { inicio: '', fim: '' };
            }
            if (!estado.dashboardIntervaloDias.inicio && !estado.dashboardIntervaloDias.fim) {
                const hojeIso = new Date().toISOString().split('T')[0];
                estado.dashboardIntervaloDias = { inicio: hojeIso, fim: hojeIso };
            } else {
                if (!estado.dashboardIntervaloDias.inicio) {
                    estado.dashboardIntervaloDias.inicio = estado.dashboardIntervaloDias.fim || '';
                }
                if (!estado.dashboardIntervaloDias.fim) {
                    estado.dashboardIntervaloDias.fim = estado.dashboardIntervaloDias.inicio || '';
                }
            }

            const atualizarVisibilidade = () => {
                const isDia = periodoSelect.value === 'dia';
                container.classList.toggle('active', isDia);
                const modoSelecionado = document.querySelector('input[name="dashboard-dia-modo"]:checked');
                const modoIntervalo = isDia && modoSelecionado && modoSelecionado.value === 'intervalo';
                intervaloWrapper.classList.toggle('active', modoIntervalo);
            };

            const sincronizarInputs = () => {
                const dados = estado.dashboardIntervaloDias || {};
                if (dados.inicio && inputInicio.value !== dados.inicio) {
                    inputInicio.value = dados.inicio;
                }
                if (dados.fim && inputFim.value !== dados.fim) {
                    inputFim.value = dados.fim;
                }
            };

            const normalizarIntervalo = campoAlterado => {
                const dados = estado.dashboardIntervaloDias || {};
                const { inicio = '', fim = '' } = dados;
                if (!inicio || !fim) {
                    return;
                }
                if (inicio > fim) {
                    if (campoAlterado === 'inicio') {
                        estado.dashboardIntervaloDias.fim = inicio;
                        inputFim.value = inicio;
                    } else {
                        estado.dashboardIntervaloDias.inicio = fim;
                        inputInicio.value = fim;
                    }
                }
            };

            const atualizarEstado = (campo, valor) => {
                if (!estado.dashboardIntervaloDias || typeof estado.dashboardIntervaloDias !== 'object') {
                    estado.dashboardIntervaloDias = { inicio: '', fim: '' };
                }
                estado.dashboardIntervaloDias[campo] = valor || '';
                normalizarIntervalo(campo);
            };

            if (periodoSelect.dataset.dashboardDiasListeners !== 'true') {
                periodoSelect.addEventListener('change', atualizarVisibilidade);
                periodoSelect.dataset.dashboardDiasListeners = 'true';
            }

            radios.forEach(radio => {
                if (radio.dataset.dashboardDiasListeners !== 'true') {
                    radio.addEventListener('change', atualizarVisibilidade);
                    radio.dataset.dashboardDiasListeners = 'true';
                }
            });

            if (inputInicio.dataset.dashboardDiasListeners !== 'true') {
                inputInicio.addEventListener('change', () => {
                    atualizarEstado('inicio', inputInicio.value);
                });
                inputInicio.dataset.dashboardDiasListeners = 'true';
            }

            if (inputFim.dataset.dashboardDiasListeners !== 'true') {
                inputFim.addEventListener('change', () => {
                    atualizarEstado('fim', inputFim.value);
                });
                inputFim.dataset.dashboardDiasListeners = 'true';
            }

            sincronizarInputs();
            atualizarVisibilidade();
        }

        function prepararStatusDistribuicao(dadosStatus, ocupacaoGeral) {
            const resultado = {};
            if (dadosStatus && typeof dadosStatus === 'object') {
                Object.entries(dadosStatus).forEach(([chave, valor]) => {
                    const numero = Number(valor);
                    if (!Number.isNaN(numero)) {
                        resultado[chave] = numero;
                    }
                });
            }

            const uso = Number(ocupacaoGeral && (ocupacaoGeral.ocupadas ?? ocupacaoGeral.uso));
            const livres = Number(ocupacaoGeral && ocupacaoGeral.livres);
            const indisponiveis = Number(ocupacaoGeral && ocupacaoGeral.indisponiveis);
            if (uso > 0) {
                resultado.ocupado = Math.max(resultado.ocupado || 0, uso);
            }
            if (livres > 0) {
                resultado.livre = Math.max(resultado.livre || 0, livres);
            }
            if (indisponiveis > 0) {
                const manutencaoAtual = Number(resultado.manutencao || 0);
                const bloqueadoAtual = Number(resultado.bloqueado || 0);
                const restante = Math.max(indisponiveis - manutencaoAtual, 0);
                if (restante > bloqueadoAtual) {
                    resultado.bloqueado = restante;
                } else if (!resultado.bloqueado && restante > 0) {
                    resultado.bloqueado = restante;
                }
            }

            const statusConhecidos = ['ocupado', 'livre', 'bloqueado', 'reservado', 'manutencao'];
            if (Array.isArray(estado.salas) && estado.salas.length) {
                statusConhecidos.forEach(statusChave => {
                    const totalEstado = estado.salas.filter(sala => {
                        const statusSala = normalizarStatus(sala.statusNormalizado || sala.statusGeral || sala.status);
                        return statusSala === statusChave;
                    }).length;
                    if (totalEstado > 0) {
                        const atual = Number(resultado[statusChave] || 0);
                        resultado[statusChave] = Math.max(atual, totalEstado);
                    } else if (!(statusChave in resultado)) {
                        resultado[statusChave] = 0;
                    }
                });
            }

            if (Object.keys(resultado).length === 0) {
                return {
                    ocupado: uso || 0,
                    livre: livres || 0,
                    bloqueado: indisponiveis || 0
                };
            }
            return resultado;
        }

        function horaParaMinutos(valor) {
            if (!valor || typeof valor !== 'string') return null;
            const texto = valor.trim();
            if (!texto) return null;
            const partes = texto.split(':');
            if (partes.length < 2) return null;
            const horas = Number(partes[0]);
            const minutos = Number(partes[1]);
            if (!Number.isFinite(horas) || !Number.isFinite(minutos)) return null;
            return horas * 60 + minutos;
        }

        function formatarDuracaoMinutos(valor) {
            const minutos = Number(valor);
            if (!Number.isFinite(minutos) || minutos <= 0) {
                return '0 min';
            }
            const total = Math.round(minutos);
            const horas = Math.floor(total / 60);
            const restante = Math.abs(total % 60);
            const partes = [];
            if (horas > 0) partes.push(`${horas}h`);
            if (restante > 0) partes.push(`${restante} min`);
            return partes.join(' ') || '0 min';
        }

        function formatarPercentual(valor, casas = 0) {
            const numero = Number(valor);
            if (!Number.isFinite(numero)) {
                return '0%';
            }
            if (casas <= 0) {
                return `${Math.round(numero)}%`;
            }
            return `${numero.toFixed(casas)}%`;
        }

        function executarServidor(nomeFuncao, ...args) {
            return new Promise((resolve, reject) => {
                executarGoogleScript({
                    funcao: nomeFuncao,
                    parametros: args,
                    tentativas: 1,
                    onSuccess: resolve,
                    onFailure: erro => {
                        if (!(erro instanceof Error)) {
                            reject(new Error(String(erro)));
                        } else {
                            reject(erro);
                        }
                    }
                });
            });
        }

        function baixarArquivoBase64(retorno) {
            if (!retorno || !retorno.base64) {
                alert('Não foi possível gerar o arquivo solicitado.');
                return;
            }
            const mimeType = retorno.mimeType || 'application/pdf';
            const nome = retorno.filename || `relatorio-${Date.now()}.pdf`;
            const link = document.createElement('a');
            link.href = `data:${mimeType};base64,${retorno.base64}`;
            link.download = nome;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatarDiferencaNumero(valor) {
            const absoluto = Math.abs(valor);
            return absoluto.toLocaleString('pt-BR');
        }

        function formatarDiferencaPercentual(valor) {
            const absoluto = Math.abs(valor);
            const inteiro = Math.round(absoluto * 10) / 10;
            const texto = Number.isInteger(inteiro) ? inteiro.toFixed(0) : inteiro.toFixed(1);
            return `${texto.replace('.', ',')} p.p.`;
        }

        function atualizarMetricasComparacao(prefixo, valorPrincipal, valorComparativo, { percentual = false } = {}) {
            const valorEl = document.getElementById(`${prefixo}`);
            const diffEl = document.getElementById(`${prefixo}-diff`);
            if (!valorEl || !diffEl) {
                return;
            }

            if (valorComparativo === undefined || valorComparativo === null || Number.isNaN(Number(valorComparativo))) {
                valorEl.textContent = '--';
                diffEl.textContent = 'Sem dados de comparação';
                diffEl.className = 'comparison-diff neutral';
                return;
            }

            if (percentual) {
                valorEl.textContent = formatarPercentual(valorComparativo, 0);
            } else {
                valorEl.textContent = Number(valorComparativo).toLocaleString('pt-BR');
            }

            const principalNumero = Number(valorPrincipal) || 0;
            const comparativoNumero = Number(valorComparativo) || 0;
            const diferenca = principalNumero - comparativoNumero;

            if (Math.abs(diferenca) < 0.0001) {
                diffEl.textContent = '• Sem variação';
                diffEl.className = 'comparison-diff neutral';
                return;
            }

            const simbolo = diferenca > 0 ? '▲' : '▼';
            const classe = diferenca > 0 ? 'comparison-diff up' : 'comparison-diff down';
            const textoDiff = percentual
                ? formatarDiferencaPercentual(diferenca)
                : formatarDiferencaNumero(diferenca);
            diffEl.textContent = `${simbolo} ${textoDiff}`;
            diffEl.className = classe;
        }

        function formatarDataCompleta(isoDate) {
            if (!isoDate) return '';
            const data = new Date(`${isoDate}T00:00:00`);
            if (Number.isNaN(data.getTime())) {
                return isoDate;
            }
            return data.toLocaleDateString('pt-BR');
        }

        function calcularResumoMedicos(agendamentos) {
            const mapa = new Map();
            (agendamentos || []).forEach(ag => {
                const nomeBruto = (ag.profissional || '').trim();
                if (!nomeBruto) return;
                const chave = normalizarTexto(nomeBruto) || nomeBruto;
                if (!mapa.has(chave)) {
                    mapa.set(chave, {
                        nome: nomeBruto,
                        especialidades: new Set(),
                        turnos: new Set(),
                        horarios: new Map(),
                        totalAgendamentos: 0,
                        frequencias: { registrada: 0, pendente: 0, faltou: 0 },
                        registrosManuais: 0,
                        faltas: 0,
                        atrasos: 0,
                        atrasoTotal: 0,
                        maiorAtraso: 0,
                        diasAtuacao: new Set()
                    });
                }

                const registro = mapa.get(chave);
                registro.nome = nomeBruto;

                const especialidade = (ag.especialidade || '').trim() || 'Sem especialidade';
                registro.especialidades.add(especialidade);

                const turnoLabel = formatarTurnoLabel(ag.turnoNormalizado || normalizarTurno(ag.turno));
                if (turnoLabel) {
                    registro.turnos.add(turnoLabel);
                }

                if (ag.horaInicio || ag.horaFim) {
                    const inicio = (ag.horaInicio || '--').trim();
                    const fim = (ag.horaFim || '--').trim();
                    const intervalo = `${inicio} - ${fim}`.trim();
                    if (intervalo && intervalo !== '- -') {
                        registro.horarios.set(intervalo, (registro.horarios.get(intervalo) || 0) + 1);
                    }
                }

                const dataInicio = (ag.dataInicio || ag.data || '').trim();
                if (dataInicio) {
                    registro.diasAtuacao.add(dataInicio);
                }

                registro.totalAgendamentos += 1;

                const faltou = valorFrequenciaEhFaltou(ag.horaChegadaReal)
                    || valorFrequenciaEhFaltou(ag.horaSaidaReal)
                    || normalizarTexto(ag.frequenciaStatus) === 'faltou';
                const chegadaMinutos = horaParaMinutos(ag.horaChegadaReal);
                const saidaMinutos = horaParaMinutos(ag.horaSaidaReal);
                const registroManual = (Number.isFinite(chegadaMinutos) || Number.isFinite(saidaMinutos)) && !faltou;

                if (faltou) {
                    registro.frequencias.faltou += 1;
                    registro.faltas += 1;
                } else if (registroManual) {
                    registro.frequencias.registrada += 1;
                    registro.registrosManuais += 1;
                } else {
                    registro.frequencias.pendente += 1;
                }

                const inicioMinutos = horaParaMinutos(ag.horaInicio);
                if (Number.isFinite(inicioMinutos) && Number.isFinite(chegadaMinutos)) {
                    const atraso = chegadaMinutos - inicioMinutos;
                    if (atraso > 0) {
                        registro.atrasos += 1;
                        registro.atrasoTotal += atraso;
                        if (atraso > registro.maiorAtraso) {
                            registro.maiorAtraso = atraso;
                        }
                    }
                }
            });

            return Array.from(mapa.values()).map(item => {
                const totalFrequencias = item.frequencias.registrada + item.frequencias.pendente + item.frequencias.faltou;
                const mediaAtraso = item.atrasos > 0 ? item.atrasoTotal / item.atrasos : 0;
                return {
                    nome: item.nome,
                    especialidades: Array.from(item.especialidades).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' })),
                    turnos: Array.from(item.turnos).sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' })),
                    horarios: Array.from(item.horarios.entries())
                        .sort((a, b) => b[1] - a[1])
                        .map(([intervalo, quantidade]) => ({ intervalo, quantidade })),
                    totalAgendamentos: item.totalAgendamentos,
                    frequencias: { ...item.frequencias },
                    registrosManuais: item.registrosManuais,
                    faltas: item.faltas,
                    atrasos: item.atrasos,
                    totalAtrasoMinutos: item.atrasoTotal,
                    maiorAtraso: item.maiorAtraso,
                    mediaAtraso,
                    percentualFrequencia: totalFrequencias > 0 ? (item.frequencias.registrada / totalFrequencias) * 100 : 0,
                    percentualFaltas: totalFrequencias > 0 ? (item.frequencias.faltou / totalFrequencias) * 100 : 0,
                    totalFrequencias,
                    diasAtuacao: item.diasAtuacao.size,
                    manualPercentual: totalFrequencias > 0 ? (item.registrosManuais / totalFrequencias) * 100 : 0
                };
            });
        }

        function atualizarAcompanhamentoMedicosFiltros() {
            const select = document.getElementById('medicos-especialidade');
            if (!select) return;
            const especialidades = new Set();
            (estado.medicosResumo || []).forEach(medico => {
                (medico.especialidades || []).forEach(esp => {
                    if (esp && esp !== 'Sem especialidade') {
                        especialidades.add(esp);
                    }
                });
            });

            const opcoes = ['<option value="todas">Todas</option>'];
            Array.from(especialidades)
                .sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }))
                .forEach(esp => {
                    opcoes.push(`<option value="${esp.replace(/"/g, '&quot;')}">${esp}</option>`);
                });

            select.innerHTML = opcoes.join('');
            const atual = estado.acompanhamentoMedicos?.especialidade || 'todas';
            if (atual !== 'todas' && !especialidades.has(atual)) {
                estado.acompanhamentoMedicos.especialidade = 'todas';
            }
            select.disabled = opcoes.length <= 1;
            select.value = estado.acompanhamentoMedicos.especialidade || 'todas';
        }

        function sincronizarFiltrosMedicos() {
            const filtros = estado.acompanhamentoMedicos || {};
            const buscaInput = document.getElementById('medicos-busca');
            if (buscaInput && buscaInput.value !== (filtros.busca || '')) {
                buscaInput.value = filtros.busca || '';
            }
            const especialidadeSelect = document.getElementById('medicos-especialidade');
            if (especialidadeSelect && especialidadeSelect.value !== (filtros.especialidade || 'todas')) {
                especialidadeSelect.value = filtros.especialidade || 'todas';
            }
            const frequenciaSelect = document.getElementById('medicos-frequencia');
            if (frequenciaSelect && frequenciaSelect.value !== (filtros.frequencia || 'todos')) {
                frequenciaSelect.value = filtros.frequencia || 'todos';
            }
            const ordenacaoSelect = document.getElementById('medicos-ordenacao');
            if (ordenacaoSelect && ordenacaoSelect.value !== (filtros.ordenacao || 'atrasos')) {
                ordenacaoSelect.value = filtros.ordenacao || 'atrasos';
            }

            const periodo = filtros.periodo || {};
            const periodoSelect = document.getElementById('medicos-periodo');
            const tipoPeriodo = periodo.tipo || 'dia';
            if (periodoSelect && periodoSelect.value !== tipoPeriodo) {
                periodoSelect.value = tipoPeriodo;
            }

            const atualizarCampo = (id, valor) => {
                const elemento = document.getElementById(id);
                if (elemento && elemento.value !== (valor || '')) {
                    elemento.value = valor || '';
                }
            };

            atualizarCampo('medicos-periodo-dia', periodo.dia);
            atualizarCampo('medicos-periodo-semana', periodo.semana);
            atualizarCampo('medicos-periodo-mes', periodo.mes);
            atualizarCampo('medicos-periodo-ano', periodo.ano);
            atualizarCampo('medicos-periodo-inicio', periodo.inicio);
            atualizarCampo('medicos-periodo-fim', periodo.fim);

            atualizarMedicosPeriodoUI();
        }

        function atualizarResumoMedicosCards(medicosFiltrados) {
            const totalElemento = document.getElementById('medicos-total');
            const frequenciaElemento = document.getElementById('medicos-frequencia-registrada');
            const atrasoElemento = document.getElementById('medicos-atraso-medio');
            if (!totalElemento || !frequenciaElemento || !atrasoElemento) return;

            const lista = Array.isArray(medicosFiltrados) ? medicosFiltrados : [];
            const total = lista.length;
            const totalFrequencias = lista.reduce((soma, medico) => soma + (medico.totalFrequencias || 0), 0);
            const totalRegistradas = lista.reduce((soma, medico) => soma + (medico.frequencias?.registrada || 0), 0);
            const totalAtrasos = lista.reduce((soma, medico) => soma + (medico.atrasos || 0), 0);
            const totalAtrasoMinutos = lista.reduce((soma, medico) => soma + (medico.totalAtrasoMinutos || 0), 0);

            const frequenciaPercentual = totalFrequencias > 0 ? (totalRegistradas / totalFrequencias) * 100 : 0;
            const atrasoMedio = totalAtrasos > 0 ? (totalAtrasoMinutos / totalAtrasos) : 0;

            totalElemento.textContent = total;
            frequenciaElemento.textContent = formatarPercentual(frequenciaPercentual, 0);
            atrasoElemento.textContent = formatarDuracaoMinutos(atrasoMedio);
        }

        function atualizarDestaqueMedicos(lista = estado.medicosResumo) {
            const destaqueWrapper = document.getElementById('medicos-highlight');
            const nomeElemento = document.getElementById('medicos-highlight-nome');
            const valorElemento = document.getElementById('medicos-highlight-valor');
            if (!destaqueWrapper || !nomeElemento || !valorElemento) return;

            const dados = Array.isArray(lista) ? lista.filter(Boolean) : [];
            if (dados.length === 0) {
                nomeElemento.textContent = 'Nenhum registro';
                valorElemento.textContent = '0 min';
                destaqueWrapper.dataset.status = 'vazio';
                return;
            }

            const destaque = dados.reduce((anterior, atual) => {
                if (!anterior) return atual;
                const atrasoAnterior = Number(anterior.maiorAtraso || 0);
                const atrasoAtual = Number(atual.maiorAtraso || 0);
                if (atrasoAtual > atrasoAnterior) return atual;
                if (atrasoAtual === atrasoAnterior && atrasoAtual > 0) {
                    return (atual.totalAgendamentos || 0) > (anterior.totalAgendamentos || 0) ? atual : anterior;
                }
                return anterior;
            }, null);

            if (!destaque || !destaque.maiorAtraso) {
                nomeElemento.textContent = 'Sem atrasos registrados';
                valorElemento.textContent = '0 min';
                destaqueWrapper.dataset.status = 'ok';
                return;
            }

            nomeElemento.textContent = destaque.nome;
            valorElemento.textContent = formatarDuracaoMinutos(destaque.maiorAtraso);
            destaqueWrapper.dataset.status = 'alerta';
        }

        function aplicarFiltrosMedicos() {
            const base = Array.isArray(estado.medicosResumo) ? [...estado.medicosResumo] : [];
            if (!base.length) return [];

            const filtros = estado.acompanhamentoMedicos || {};
            const busca = normalizarTexto(filtros.busca || '');
            let resultado = base;

            if (busca) {
                resultado = resultado.filter(medico => normalizarTexto(medico.nome).includes(busca));
            }

            const especialidadeFiltro = filtros.especialidade || 'todas';
            if (especialidadeFiltro !== 'todas') {
                resultado = resultado.filter(medico => (medico.especialidades || []).some(esp => esp === especialidadeFiltro));
            }

            switch (filtros.frequencia) {
                case 'pontual':
                    resultado = resultado.filter(medico => (medico.atrasos || 0) === 0 && (medico.faltas || 0) === 0 && (medico.frequencias?.pendente || 0) === 0);
                    break;
                case 'pendente':
                    resultado = resultado.filter(medico => (medico.frequencias?.pendente || 0) > 0);
                    break;
                case 'manual':
                    resultado = resultado.filter(medico => (medico.registrosManuais || 0) > 0);
                    break;
                case 'faltou':
                    resultado = resultado.filter(medico => (medico.faltas || 0) > 0);
                    break;
                case 'atraso':
                    resultado = resultado.filter(medico => (medico.atrasos || 0) > 0 || (medico.maiorAtraso || 0) > 0);
                    break;
                default:
                    break;
            }

            const ordenacao = filtros.ordenacao || 'atrasos';
            resultado.sort((a, b) => {
                if (ordenacao === 'faltas') {
                    const diff = (b.faltas || 0) - (a.faltas || 0);
                    if (diff !== 0) return diff;
                    return (b.atrasos || 0) - (a.atrasos || 0);
                }
                if (ordenacao === 'frequencia') {
                    const diff = (b.percentualFrequencia || 0) - (a.percentualFrequencia || 0);
                    if (Math.abs(diff) > 0.1) return diff;
                    return (a.frequencias?.pendente || 0) - (b.frequencias?.pendente || 0);
                }
                if (ordenacao === 'nome') {
                    return a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' });
                }
                const diffMedia = (b.mediaAtraso || 0) - (a.mediaAtraso || 0);
                if (Math.abs(diffMedia) > 0.1) return diffMedia;
                const diffMaior = (b.maiorAtraso || 0) - (a.maiorAtraso || 0);
                if (diffMaior !== 0) return diffMaior;
                return (b.totalAgendamentos || 0) - (a.totalAgendamentos || 0);
            });

            return resultado;
        }

        function renderAcompanhamentoMedicos() {
            const listaContainer = document.getElementById('medicos-lista');
            if (!listaContainer) return;

            const medicosFiltrados = aplicarFiltrosMedicos();
            atualizarResumoMedicosCards(medicosFiltrados);
            atualizarDestaqueMedicos(medicosFiltrados);

            if (!medicosFiltrados.length) {
                const mensagem = (estado.medicosResumo || []).length
                    ? 'Nenhum profissional encontrado para os filtros selecionados.'
                    : 'Nenhum agendamento médico foi carregado para o período selecionado.';
                listaContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-md"></i>
                        <p>${mensagem}</p>
                    </div>
                `;
                return;
            }

            const fragment = document.createDocumentFragment();
            medicosFiltrados.forEach(medico => {
                const card = document.createElement('article');
                card.className = 'medico-card';

                const especialidadesHtml = (medico.especialidades && medico.especialidades.length)
                    ? medico.especialidades.map(esp => `<span class="medico-tag"><i class="fas fa-stethoscope"></i> ${esp}</span>`).join('')
                    : '<span class="medico-tag"><i class="fas fa-stethoscope"></i> Sem especialidade</span>';
                const turnosHtml = (medico.turnos && medico.turnos.length)
                    ? `<span class="medico-tag secundario"><i class="fas fa-clock"></i> ${medico.turnos.join(', ')}</span>`
                    : '';
                const horariosHtml = (medico.horarios && medico.horarios.length)
                    ? medico.horarios.slice(0, 3).map(({ intervalo, quantidade }) => `<li><span class="horario-label">${intervalo}</span><span class="horario-ocorrencia">${quantidade}x</span></li>`).join('')
                    : '<li class="medico-horarios-vazio">Sem padrões identificados</li>';
                const frequenciaHtml = `
                    <li><i class="fas fa-user-check"></i> Registros: <strong>${medico.frequencias.registrada}</strong></li>
                    <li><i class="fas fa-hourglass-half"></i> Pendentes: <strong>${medico.frequencias.pendente}</strong></li>
                    <li><i class="fas fa-user-times"></i> Faltas: <strong>${medico.frequencias.faltou}</strong></li>
                    <li><i class="fas fa-clock"></i> Maior atraso: <strong>${formatarDuracaoMinutos(medico.maiorAtraso)}</strong></li>
                `;
                const mediaAtrasoTexto = medico.atrasos > 0 ? formatarDuracaoMinutos(medico.mediaAtraso) : '0 min';
                const registrosTexto = medico.registrosManuais > 0
                    ? `${medico.registrosManuais} registro${medico.registrosManuais === 1 ? '' : 's'} manual${medico.registrosManuais === 1 ? '' : 'is'}`
                    : 'Sem registros manuais';
                const diasTexto = medico.diasAtuacao > 0
                    ? `${medico.diasAtuacao} dia${medico.diasAtuacao === 1 ? '' : 's'} acompanhados`
                    : 'Sem datas registradas';
                const alertaClasse = (medico.atrasos || medico.faltas) ? 'medico-metrica alerta' : 'medico-metrica';

                card.innerHTML = `
                    <div class="medico-card-header">
                        <div class="medico-identificacao">
                            <h3>${medico.nome}</h3>
                            <div class="medico-tags">
                                ${especialidadesHtml}
                                ${turnosHtml}
                            </div>
                        </div>
                        <div class="medico-metricas">
                            <div class="medico-metrica">
                                <span class="medico-metrica-label">Agendamentos</span>
                                <span class="medico-metrica-valor">${medico.totalAgendamentos}</span>
                            </div>
                            <div class="medico-metrica">
                                <span class="medico-metrica-label">Frequência registrada</span>
                                <span class="medico-metrica-valor">${formatarPercentual(medico.percentualFrequencia, 0)}</span>
                            </div>
                            <div class="${alertaClasse}">
                                <span class="medico-metrica-label">Média de atraso</span>
                                <span class="medico-metrica-valor">${mediaAtrasoTexto}</span>
                            </div>
                        </div>
                    </div>
                    <div class="medico-card-detalhes">
                        <div>
                            <h4>Horários padrão</h4>
                            <ul class="medico-horarios">
                                ${horariosHtml}
                            </ul>
                        </div>
                        <div>
                            <h4>Frequência</h4>
                            <ul class="medico-frequencia">
                                ${frequenciaHtml}
                            </ul>
                        </div>
                    </div>
                    <div class="medico-insights">
                        <i class="fas fa-clipboard-check"></i>
                        <span>${formatarPercentual(medico.percentualFrequencia, 0)} de presença • ${registrosTexto} • ${diasTexto}.</span>
                    </div>
                `;

                fragment.appendChild(card);
            });

            listaContainer.innerHTML = '';
            listaContainer.appendChild(fragment);
        }

        function recalcularAcompanhamentoMedicos() {
            const agendamentosFiltrados = filtrarAgendamentosPorPeriodoMedicos(estado.agendamentos || []);
            estado.medicosResumo = calcularResumoMedicos(agendamentosFiltrados);
            atualizarMedicosPeriodoAnos();
            atualizarAcompanhamentoMedicosFiltros();
            sincronizarFiltrosMedicos();
            renderAcompanhamentoMedicos();
        }

        function clonarProfundo(valor) {
            if (valor === null || valor === undefined) {
                return valor;
            }
            if (typeof valor !== 'object') {
                return valor;
            }
            try {
                return JSON.parse(JSON.stringify(valor));
            } catch (erro) {
                console.warn('Falha ao clonar valor para logs.', erro, valor);
                if (Array.isArray(valor)) {
                    return valor.map(item => clonarProfundo(item));
                }
                return { ...valor };
            }
        }

        function obterLogsDemonstracaoClonados() {
            return clonarProfundo(LOGS_DEMONSTRACAO);
        }

        function obterAlertasLogsDemonstracaoClonados() {
            return clonarProfundo(ALERTAS_LOGS_DEMONSTRACAO);
        }

        function tentarParseJsonLog(valor) {
            if (valor === null || valor === undefined || valor === '') {
                return {};
            }
            if (typeof valor === 'object') {
                return valor;
            }
            if (typeof valor !== 'string') {
                return { valor };
            }
            const texto = valor.trim();
            if (!texto) {
                return {};
            }
            try {
                return JSON.parse(texto);
            } catch (erro) {
                console.warn('Falha ao interpretar JSON de log.', erro, texto);
                return { descricao: texto };
            }
        }

        function obterValorPorCaminho(obj, caminho) {
            if (!obj || typeof obj !== 'object') {
                return undefined;
            }
            const partes = Array.isArray(caminho) ? caminho : String(caminho).split('.');
            let atual = obj;
            for (const parte of partes) {
                if (atual && typeof atual === 'object' && parte in atual) {
                    atual = atual[parte];
                } else {
                    return undefined;
                }
            }
            return atual;
        }

        function extrairPrimeiroValor(obj, caminhos, padrao = '') {
            if (!Array.isArray(caminhos)) {
                return padrao;
            }
            for (const caminho of caminhos) {
                const valor = obterValorPorCaminho(obj, caminho);
                if (valor !== undefined && valor !== null && valor !== '') {
                    return valor;
                }
            }
            return padrao;
        }

        function interpretarBooleanoFlex(valor) {
            if (typeof valor === 'boolean') {
                return valor;
            }
            if (typeof valor === 'number') {
                return valor !== 0;
            }
            if (typeof valor === 'string') {
                const texto = normalizarTexto(valor);
                if (!texto) {
                    return null;
                }
                if (['sim', 'true', '1', 'ativo', 'alerta', 'critico', 'crítico', 'positivo', 'sucesso'].includes(texto)) {
                    return true;
                }
                if (['nao', 'não', 'false', '0', 'negativo', 'inativo', 'erro', 'fail'].includes(texto)) {
                    return false;
                }
            }
            return null;
        }

        function inferirTipoAcao(acao, tipoOriginal) {
            const base = normalizarTexto(tipoOriginal || acao || '');
            if (!base) {
                return 'operacao';
            }
            if (base.includes('cancel')) return 'cancelamento';
            if (base.includes('login') || base.includes('acesso') || base.includes('autentic')) return 'login';
            if (base.includes('export') || base.includes('download')) return 'exportacao';
            if (base.includes('rotin') || base.includes('cron') || base.includes('auto')) return 'rotina';
            if (base.includes('bloq') || base.includes('admin') || base.includes('status') || base.includes('ajust')) return 'administrativo';
            if (base.includes('cad') || base.includes('cria') || base.includes('inclu') || base.includes('novo')) return 'criacao';
            if (base.includes('atualiz') || base.includes('edit') || base.includes('alter') || base.includes('ajus')) return 'atualizacao';
            return base.split(' ')[0] || 'operacao';
        }

        function inferirResultado(valor, alertaAtivo) {
            if (typeof valor === 'string') {
                const base = normalizarTexto(valor);
                if (!base) {
                    return alertaAtivo ? 'alerta' : 'sucesso';
                }
                if (base.includes('erro') || base.includes('falh') || base.includes('inval')) {
                    return 'erro';
                }
                if (base.includes('alert') || base.includes('aten') || base.includes('crit')) {
                    return 'alerta';
                }
                if (base.includes('pend')) {
                    return alertaAtivo ? 'alerta' : 'sucesso';
                }
                return 'sucesso';
            }
            if (typeof valor === 'boolean') {
                return valor ? 'sucesso' : 'erro';
            }
            if (typeof valor === 'number') {
                if (valor > 0) return 'sucesso';
                if (valor < 0) return 'erro';
            }
            return alertaAtivo ? 'alerta' : 'sucesso';
        }

        function inferirOrigem(valor) {
            const base = normalizarTexto(valor || '');
            if (!base) {
                return 'sistema';
            }
            if (base.includes('web') || base.includes('portal')) return 'web';
            if (base.includes('mobil') || base.includes('app')) return 'mobile';
            if (base.includes('api') || base.includes('integra')) return 'api';
            if (base.includes('rotina') || base.includes('cron') || base.includes('auto') || base.includes('script')) return 'rotina';
            return base || 'sistema';
        }

        function gerarIdLog(timestampIso, indice) {
            const base = (timestampIso || '').replace(/[^0-9]/g, '') || `${Date.now()}`;
            const sufixo = typeof indice === 'number' ? String(indice + 1).padStart(3, '0') : '000';
            return `LOG-${base}-${sufixo}`;
        }

        function converterLogPlanilhaParaRegistro(item, indice) {
            if (!item) {
                return null;
            }

            const dadosExtras = tentarParseJsonLog(item.dados);
            const timestampValor = item.timestamp instanceof Date ? item.timestamp : new Date(item.timestamp || Date.now());
            const timestampIso = Number.isNaN(timestampValor.getTime())
                ? new Date().toISOString()
                : timestampValor.toISOString();

            const id = String(
                extrairPrimeiroValor(dadosExtras, [
                    ['id'],
                    ['identificador'],
                    ['meta', 'id'],
                    ['agendamento', 'id'],
                    ['payload', 'id']
                ], gerarIdLog(timestampIso, indice))
            );

            const usuario = item.usuario
                || extrairPrimeiroValor(dadosExtras, [['usuario', 'nome'], ['usuario'], ['responsavel'], ['operador']], 'Desconhecido');
            const perfil = extrairPrimeiroValor(dadosExtras, [['usuario', 'perfil'], ['perfil'], ['role'], ['usuario', 'role']], '—');
            const matricula = extrairPrimeiroValor(dadosExtras, [['usuario', 'matricula'], ['matricula'], ['responsavel', 'matricula']], '');
            const acao = item.acao || extrairPrimeiroValor(dadosExtras, [['acao'], ['evento'], ['tipo']], 'Registro');
            const tipoAcao = inferirTipoAcao(acao, extrairPrimeiroValor(dadosExtras, [['tipoAcao'], ['tipo'], ['categoria']], ''));
            const alertaFlag = interpretarBooleanoFlex(extrairPrimeiroValor(dadosExtras, [['alerta'], ['isAlert'], ['critico'], ['critico']], null)) || false;
            const resultado = inferirResultado(extrairPrimeiroValor(dadosExtras, [['resultado'], ['status'], ['sucesso']], null), alertaFlag);
            const origem = inferirOrigem(extrairPrimeiroValor(dadosExtras, [['origem'], ['canal'], ['fonte']], ''));
            const detalhes = item.detalhes || extrairPrimeiroValor(dadosExtras, [['detalhes'], ['descricao'], ['mensagem']], '');
            const observacoes = extrairPrimeiroValor(dadosExtras, [['observacoes'], ['observacao'], ['obs']], '');
            const ip = extrairPrimeiroValor(dadosExtras, [['ip'], ['enderecoIp'], ['origemIp']], '');
            const alertaMotivo = extrairPrimeiroValor(dadosExtras, [['alertaMotivo'], ['motivoAlerta'], ['alertReason']], '');

            const revisadoValor = interpretarBooleanoFlex(extrairPrimeiroValor(dadosExtras, [['revisado'], ['foiRevisado'], ['reviewed']], null));
            const revisado = revisadoValor === null ? false : revisadoValor;
            const revisadoPor = extrairPrimeiroValor(dadosExtras, [['revisadoPor'], ['revisor'], ['reviewedBy']], '');
            const revisadoEmValor = extrairPrimeiroValor(dadosExtras, [['revisadoEm'], ['dataRevisao'], ['reviewedAt']], '');
            let revisadoEm = '';
            if (revisadoEmValor) {
                const dataRevisao = new Date(revisadoEmValor);
                if (!Number.isNaN(dataRevisao.getTime())) {
                    revisadoEm = dataRevisao.toISOString();
                }
            }

            let payload = extrairPrimeiroValor(dadosExtras, [['payload'], ['dados'], ['contexto'], ['log'], ['registro']], null);
            if (!payload && dadosExtras && typeof dadosExtras === 'object') {
                const copia = { ...dadosExtras };
                delete copia.id;
                delete copia.identificador;
                delete copia.meta;
                delete copia.agendamento;
                delete copia.payload;
                delete copia.dados;
                delete copia.contexto;
                delete copia.log;
                delete copia.registro;
                delete copia.usuario;
                delete copia.responsavel;
                delete copia.operador;
                delete copia.perfil;
                delete copia.role;
                delete copia.matricula;
                delete copia.tipoAcao;
                delete copia.tipo;
                delete copia.categoria;
                delete copia.resultado;
                delete copia.status;
                delete copia.sucesso;
                delete copia.alerta;
                delete copia.isAlert;
                delete copia.critico;
                delete copia.alertaMotivo;
                delete copia.motivoAlerta;
                delete copia.revisado;
                delete copia.foiRevisado;
                delete copia.reviewed;
                delete copia.revisadoPor;
                delete copia.revisor;
                delete copia.reviewedBy;
                delete copia.revisadoEm;
                delete copia.dataRevisao;
                delete copia.reviewedAt;
                delete copia.detalhes;
                delete copia.descricao;
                delete copia.mensagem;
                delete copia.observacoes;
                delete copia.observacao;
                delete copia.obs;
                delete copia.origem;
                delete copia.canal;
                delete copia.fonte;
                delete copia.ip;
                delete copia.enderecoIp;
                delete copia.origemIp;
                if (Object.keys(copia).length) {
                    payload = copia;
                }
            }

            if (payload && typeof payload === 'object') {
                payload = clonarProfundo(payload);
            }

            return {
                id,
                timestamp: timestampIso,
                usuario,
                perfil,
                matricula,
                acao,
                tipoAcao,
                resultado,
                origem,
                detalhes,
                observacoes,
                alerta: alertaFlag,
                alertaMotivo,
                revisado,
                revisadoPor,
                revisadoEm,
                ip,
                payload: payload || null
            };
        }

        function carregarLogsDaPlanilha(opcoes = {}) {
            const { forcar = false } = opcoes;
            const logsState = stores.logs;
            if (logsState.carregando) {
                return;
            }
            if (!forcar && logsState.carregado) {
                return;
            }

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                if (!logsState.carregado) {
                    logsState.registros = obterLogsDemonstracaoClonados();
                    logsState.alertasConfigurados = obterAlertasLogsDemonstracaoClonados();
                    logsState.ultimaSincronizacao = new Date().toISOString();
                    logsState.carregado = true;
                    renderLogsSection();
                    mostrarLogsFeedback('Exibindo dados demonstrativos.');
                }
                return;
            }

            logsState.carregando = true;
            mostrarLogsFeedback('Carregando registros de auditoria...');

            executarGoogleScript({
                funcao: 'getLogs',
                parametros: [300, ''],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        logsState.carregando = false;
                    }
                },
                onSuccess(resposta) {
                    const registros = Array.isArray(resposta)
                        ? resposta.map((item, indice) => converterLogPlanilhaParaRegistro(item, indice)).filter(Boolean)
                        : [];

                    if (!registros.length) {
                        console.warn('Nenhum registro de log encontrado na planilha.');
                        logsState.registros = [];
                        mostrarLogsFeedback('Nenhum registro encontrado na planilha de logs.');
                    } else {
                        logsState.registros = registros;
                        mostrarLogsFeedback('');
                    }
                    logsState.alertasConfigurados = [];

                    logsState.ultimaSincronizacao = new Date().toISOString();
                    logsState.carregado = true;
                    renderLogsSection();
                },
                onFailure(erro) {
                    console.error('Erro ao carregar logs da planilha:', erro);
                    if (!logsState.carregado) {
                        logsState.registros = obterLogsDemonstracaoClonados();
                        logsState.alertasConfigurados = obterAlertasLogsDemonstracaoClonados();
                        logsState.ultimaSincronizacao = new Date().toISOString();
                        renderLogsSection();
                        mostrarLogsFeedback('Não foi possível carregar os logs reais. Exibindo dados demonstrativos.');
                    } else {
                        mostrarLogsFeedback('Não foi possível atualizar os logs no momento.');
                    }
                    logsState.carregado = false;
                },
                mensagemErroPadrao: 'Erro ao carregar logs.'
            });
        }

        // ===== Gestão de Cadastros =====
        function obterDomGestaoCadastros() {
            const cache = domCache.gestaoCadastros;
            if (cache.inicializado) return cache;
            cache.container = document.getElementById('gestao-cadastros');
            cache.stats = document.getElementById('gestao-cadastros-stats');
            cache.feedback = document.getElementById('gestao-cadastros-feedback');
            cache.atualizado = document.getElementById('gestao-cadastros-atualizado');
            cache.refresh = document.getElementById('gestao-cadastros-refresh');
            cache.tabs = document.getElementById('gestao-cadastros-tabs');
            cache.tabButtons = cache.tabs ? Array.from(cache.tabs.querySelectorAll('.gestao-cadastros-tab')) : [];
            cache.panels = Array.from(document.querySelectorAll('.gestao-cadastros-panel'));

            cache.especialidadeForm = document.getElementById('gestao-especialidade-form');
            cache.especialidadeNome = document.getElementById('gestao-especialidade-nome');
            cache.especialidadeAjuda = document.getElementById('gestao-especialidade-ajuda');
            cache.especialidadeCancelar = document.getElementById('gestao-especialidade-cancelar');
            cache.especialidadeSalvar = document.getElementById('gestao-especialidade-salvar');
            cache.especialidadeLista = document.getElementById('gestao-especialidade-lista');

            cache.categoriaForm = document.getElementById('gestao-categoria-form');
            cache.categoriaNome = document.getElementById('gestao-categoria-nome');
            cache.categoriaAjuda = document.getElementById('gestao-categoria-ajuda');
            cache.categoriaCancelar = document.getElementById('gestao-categoria-cancelar');
            cache.categoriaSalvar = document.getElementById('gestao-categoria-salvar');
            cache.categoriaLista = document.getElementById('gestao-categoria-lista');

            cache.ilhaForm = document.getElementById('gestao-ilha-form');
            cache.ilhaNome = document.getElementById('gestao-ilha-nome');
            cache.ilhaAjuda = document.getElementById('gestao-ilha-ajuda');
            cache.ilhaCancelar = document.getElementById('gestao-ilha-cancelar');
            cache.ilhaSalvar = document.getElementById('gestao-ilha-salvar');
            cache.ilhaLista = document.getElementById('gestao-ilha-lista');
            cache.ilhaResumo = document.getElementById('gestao-ilha-resumo');

            cache.salaForm = document.getElementById('gestao-sala-form');
            cache.salaNumero = document.getElementById('gestao-sala-numero');
            cache.salaAjuda = document.getElementById('gestao-sala-ajuda');
            cache.salaIlha = document.getElementById('gestao-sala-ilha');
            cache.salaCancelar = document.getElementById('gestao-sala-cancelar');
            cache.salaSalvar = document.getElementById('gestao-sala-salvar');
            cache.salaLista = document.getElementById('gestao-sala-lista');
            cache.salaSelectTodos = document.getElementById('gestao-sala-select-todos');

            cache.salaLoteForm = document.getElementById('gestao-sala-lote-form');
            cache.salaLoteIlha = document.getElementById('gestao-sala-lote-ilha');
            cache.salaLoteAplicar = document.getElementById('gestao-sala-lote-aplicar');
            cache.salaLoteLimpar = document.getElementById('gestao-sala-lote-limpar');
            cache.salaLoteStatus = document.getElementById('gestao-sala-lote-status');

            cache.historicoForm = document.getElementById('gestao-historico-form');
            cache.historicoBusca = document.getElementById('gestao-historico-busca');
            cache.historicoEntidade = document.getElementById('gestao-historico-entidade');
            cache.historicoAcao = document.getElementById('gestao-historico-acao');
            cache.historicoUsuario = document.getElementById('gestao-historico-usuario');
            cache.historicoInicio = document.getElementById('gestao-historico-inicio');
            cache.historicoFim = document.getElementById('gestao-historico-fim');
            cache.historicoReset = document.getElementById('gestao-historico-reset');
            cache.historicoRecarregar = document.getElementById('gestao-historico-recarregar');
            cache.historicoTabela = document.getElementById('gestao-historico-tabela');
            cache.historicoResumo = document.getElementById('gestao-historico-resumo');

            cache.confirmModal = document.getElementById('gestao-confirm-modal');
            cache.confirmTitle = document.getElementById('gestao-confirm-title');
            cache.confirmMessage = document.getElementById('gestao-confirm-message');
            cache.confirmDetails = document.getElementById('gestao-confirm-details');
            cache.confirmWarning = document.getElementById('gestao-confirm-warning');
            cache.confirmAccept = document.getElementById('gestao-confirm-accept');
            cache.confirmDefaultTitleHtml = cache.confirmTitle ? cache.confirmTitle.innerHTML : '';
            cache.confirmDefaultTitle = cache.confirmTitle ? cache.confirmTitle.textContent.trim() : '';
            cache.confirmDefaultAcceptHtml = cache.confirmAccept ? cache.confirmAccept.innerHTML : '';
            cache.confirmDefaultLabel = cache.confirmAccept ? cache.confirmAccept.textContent.trim() : '';
            cache.confirmOnConfirm = null;
            cache.confirmOnCancel = null;

            cache.inicializado = true;
            return cache;
        }

        function limparFeedbackGestaoCadastros() {
            const dom = obterDomGestaoCadastros();
            if (!dom.feedback) return;
            dom.feedback.classList.remove('is-visible', 'success', 'error');
            dom.feedback.textContent = '';
        }

        function mostrarFeedbackGestaoCadastros(tipo, mensagem) {
            const dom = obterDomGestaoCadastros();
            if (!dom.feedback || !mensagem) return;
            dom.feedback.textContent = mensagem;
            dom.feedback.classList.remove('success', 'error');
            dom.feedback.classList.add('is-visible');
            dom.feedback.classList.add(tipo === 'error' ? 'error' : 'success');
        }

        function definirEstadoBotaoAcao(botao, processando, textoProcessando) {
            if (!botao) return;
            const span = botao.querySelector('span');
            if (processando) {
                if (!botao.dataset.labelOriginal) {
                    botao.dataset.labelOriginal = span ? span.textContent : botao.textContent;
                }
                if (textoProcessando) {
                    if (span) {
                        span.textContent = textoProcessando;
                    } else {
                        botao.textContent = textoProcessando;
                    }
                }
                botao.disabled = true;
                botao.setAttribute('aria-busy', 'true');
            } else {
                botao.disabled = false;
                botao.removeAttribute('aria-busy');
                const original = botao.dataset.labelOriginal;
                if (original) {
                    if (span) {
                        span.textContent = original;
                    } else {
                        botao.textContent = original;
                    }
                    delete botao.dataset.labelOriginal;
                }
            }
        }

        function encontrarIlhaPorId(id) {
            if (!Number.isInteger(Number(id))) return null;
            const dados = stores.gestaoCadastros.dados || {};
            const ilhas = Array.isArray(dados.ilhas) ? dados.ilhas : [];
            return ilhas.find(item => Number(item.id) === Number(id)) || null;
        }

        function encontrarIlhaPorNome(nome) {
            if (!nome) return null;
            const chaveBusca = normalizarChaveCadastroLocal(nome);
            if (!chaveBusca) return null;
            const dados = stores.gestaoCadastros.dados || {};
            const ilhas = Array.isArray(dados.ilhas) ? dados.ilhas : [];
            return ilhas.find(item => normalizarChaveCadastroLocal(item.nome) === chaveBusca) || null;
        }

        function obterSelecaoSalasSet() {
            const selecao = stores.gestaoCadastros.selecao || {};
            if (!(selecao.salasSelecionadas instanceof Set)) {
                selecao.salasSelecionadas = new Set(Array.isArray(selecao.salasSelecionadas) ? selecao.salasSelecionadas : []);
            }
            stores.gestaoCadastros.selecao = selecao;
            return selecao.salasSelecionadas;
        }

        function atualizarResumoSelecaoSalas() {
            const dom = obterDomGestaoCadastros();
            const selecionadas = obterSelecaoSalasSet();
            if (dom.salaLoteStatus) {
                const total = selecionadas.size;
                dom.salaLoteStatus.textContent = total
                    ? `${total} sala${total > 1 ? 's' : ''} selecionada${total > 1 ? 's' : ''}.`
                    : 'Nenhuma sala selecionada.';
            }
            if (dom.salaSelectTodos && dom.salaLista) {
                const checkboxes = Array.from(dom.salaLista.querySelectorAll('.gestao-sala-checkbox'));
                if (!checkboxes.length) {
                    dom.salaSelectTodos.checked = false;
                    dom.salaSelectTodos.indeterminate = false;
                    return;
                }
                const todosMarcados = checkboxes.every(cb => cb.checked);
                dom.salaSelectTodos.checked = todosMarcados;
                dom.salaSelectTodos.indeterminate = !todosMarcados && selecionadas.size > 0;
            }
        }

        function limparSelecaoSalas() {
            const dom = obterDomGestaoCadastros();
            const selecao = obterSelecaoSalasSet();
            selecao.clear();
            if (dom.salaLista) {
                dom.salaLista.querySelectorAll('.gestao-sala-checkbox').forEach(cb => {
                    cb.checked = false;
                });
            }
            if (dom.salaSelectTodos) {
                dom.salaSelectTodos.checked = false;
                dom.salaSelectTodos.indeterminate = false;
            }
            atualizarResumoSelecaoSalas();
        }

        function limparSelecaoSalasInexistentes() {
            const selecao = obterSelecaoSalasSet();
            if (!selecao.size) return;
            const dados = stores.gestaoCadastros.dados || {};
            const salas = Array.isArray(dados.salas) ? dados.salas : [];
            const idsValidos = new Set(salas.map(item => Number(item.id)));
            Array.from(selecao).forEach(valor => {
                const id = Number(valor);
                if (!idsValidos.has(id)) {
                    selecao.delete(valor);
                    selecao.delete(id);
                }
            });
        }

        function atualizarSeletoresGestaoIlha(ilhas) {
            const dom = obterDomGestaoCadastros();
            const lista = Array.isArray(ilhas) ? ilhas : [];
            const opcoes = ['<option value="">Sem ilha</option>'];
            lista.forEach(item => opcoes.push(`<option value="${item.id}">${escapeHtml(item.nome || '')}</option>`));
            if (dom.salaIlha) {
                const valorAtual = dom.salaIlha.value;
                dom.salaIlha.innerHTML = opcoes.join('');
                if (valorAtual) dom.salaIlha.value = valorAtual;
            }
            if (dom.salaLoteIlha) {
                const valorAtual = dom.salaLoteIlha.value;
                dom.salaLoteIlha.innerHTML = opcoes.join('');
                if (valorAtual) dom.salaLoteIlha.value = valorAtual;
            }
        }

        function renderGestaoCadastrosStats(est) {
            const dom = obterDomGestaoCadastros();
            if (!dom.stats) return;
            const estatisticas = est || {};
            const itens = [
                { chave: 'totalEspecialidades', rotulo: 'Especialidades ativas', icone: 'fa-stethoscope' },
                { chave: 'totalCategorias', rotulo: 'Categorias cadastradas', icone: 'fa-user-tag' },
                { chave: 'totalIlhas', rotulo: 'Ilhas disponíveis', icone: 'fa-island-tropical' },
                { chave: 'totalSalas', rotulo: 'Salas cadastradas', icone: 'fa-door-open' },
                { chave: 'salasSemIlha', rotulo: 'Salas sem ilha', icone: 'fa-location-pin-slash' },
                { chave: 'ilhasSemSala', rotulo: 'Ilhas sem salas', icone: 'fa-circle-exclamation' }
            ];
            dom.stats.innerHTML = itens.map(item => {
                const valor = estatisticas[item.chave] !== undefined ? estatisticas[item.chave] : '--';
                return `
                    <article class="gestao-stat-card" tabindex="0">
                        <div class="gestao-stat-icon"><i class="fas ${item.icone}"></i></div>
                        <div>
                            <strong>${valor}</strong>
                            <span>${item.rotulo}</span>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function renderGestaoEspecialidades(lista) {
            const dom = obterDomGestaoCadastros();
            if (!dom.especialidadeLista) return;
            const registros = Array.isArray(lista) && lista.length ? lista : [];
            if (!registros.length) {
                dom.especialidadeLista.innerHTML = '<tr><td colspan="2">Nenhuma especialidade cadastrada.</td></tr>';
                return;
            }
            dom.especialidadeLista.innerHTML = registros.map(item => `
                <tr data-id="${item.id}">
                    <td>${escapeHtml(item.nome || '')}</td>
                    <td class="col-acoes">
                        <button type="button" class="acao-btn" data-action="edit" data-id="${item.id}" data-nome="${escapeHtml(item.nome || '')}">
                            <i class="fas fa-pen"></i> Editar
                        </button>
                        <button type="button" class="acao-btn" data-action="delete" data-id="${item.id}" data-nome="${escapeHtml(item.nome || '')}">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderGestaoCategorias(lista) {
            const dom = obterDomGestaoCadastros();
            if (!dom.categoriaLista) return;
            const registros = Array.isArray(lista) && lista.length ? lista : [];
            if (!registros.length) {
                dom.categoriaLista.innerHTML = '<tr><td colspan="2">Nenhuma categoria cadastrada.</td></tr>';
                return;
            }
            dom.categoriaLista.innerHTML = registros.map(item => `
                <tr data-id="${item.id}">
                    <td>${escapeHtml(item.nome || '')}</td>
                    <td class="col-acoes">
                        <button type="button" class="acao-btn" data-action="edit" data-id="${item.id}" data-nome="${escapeHtml(item.nome || '')}">
                            <i class="fas fa-pen"></i> Editar
                        </button>
                        <button type="button" class="acao-btn" data-action="delete" data-id="${item.id}" data-nome="${escapeHtml(item.nome || '')}">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderGestaoIlhas(lista) {
            const dom = obterDomGestaoCadastros();
            if (!dom.ilhaLista) return;
            const registros = Array.isArray(lista) && lista.length ? lista : [];
            if (!registros.length) {
                dom.ilhaLista.innerHTML = '<tr><td colspan="3">Nenhuma ilha cadastrada.</td></tr>';
                if (dom.ilhaResumo) dom.ilhaResumo.textContent = '';
                return;
            }
            if (dom.ilhaResumo) {
                const semSala = registros.filter(item => (item.totalSalas || 0) === 0).length;
                dom.ilhaResumo.textContent = `${registros.length} ilha${registros.length > 1 ? 's' : ''} cadastrada${registros.length > 1 ? 's' : ''}. ${semSala} sem salas vinculadas.`;
            }
            dom.ilhaLista.innerHTML = registros.map(item => {
                const salas = Array.isArray(item.salas) ? item.salas : [];
                const resumoSalas = salas.length ? `${salas.slice(0, 5).join(', ')}${salas.length > 5 ? '…' : ''}` : 'Nenhuma';
                const alertaDuplicada = item.duplicada ? '<span class="badge badge-warning">Duplicada</span>' : '';
                return `
                    <tr data-id="${item.id}">
                        <td><strong>${escapeHtml(item.nome || '')}</strong> ${alertaDuplicada}</td>
                        <td>
                            <span>${item.totalSalas || 0} sala${item.totalSalas === 1 ? '' : 's'}</span>
                            <div class="texto-secundario">${escapeHtml(resumoSalas)}</div>
                        </td>
                        <td class="col-acoes">
                            <button type="button" class="acao-btn" data-action="edit" data-id="${item.id}" data-nome="${escapeHtml(item.nome || '')}">
                                <i class="fas fa-pen"></i> Renomear
                            </button>
                            <button type="button" class="acao-btn" data-action="delete" data-id="${item.id}" data-nome="${escapeHtml(item.nome || '')}" data-total-salas="${item.totalSalas || 0}" data-salas="${salas.map(escapeHtml).join('|')}">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderGestaoSalas(lista) {
            const dom = obterDomGestaoCadastros();
            if (!dom.salaLista) return;
            const registros = Array.isArray(lista) && lista.length ? lista : [];
            const selecao = obterSelecaoSalasSet();
            const dados = stores.gestaoCadastros.dados || {};
            const ilhas = Array.isArray(dados.ilhas) ? dados.ilhas : [];
            const mapaIlhasPorNome = new Map();
            ilhas.forEach(ilha => {
                if (!ilha || !ilha.nome) return;
                mapaIlhasPorNome.set(normalizarChaveCadastroLocal(ilha.nome), ilha);
            });
            if (!registros.length) {
                dom.salaLista.innerHTML = '<tr><td colspan="4">Nenhuma sala cadastrada.</td></tr>';
                selecao.clear();
                atualizarResumoSelecaoSalas();
                return;
            }
            dom.salaLista.innerHTML = registros.map(item => {
                const id = item.id;
                const marcado = selecao.has(id) || selecao.has(String(id));
                const ilhaTexto = item.ilha ? escapeHtml(item.ilha) : '<span class="texto-secundario">Sem ilha</span>';
                const chaveIlha = normalizarChaveCadastroLocal(item.ilha || '');
                const ilhaInfo = chaveIlha ? mapaIlhasPorNome.get(chaveIlha) : null;
                const ilhaId = ilhaInfo ? ilhaInfo.id : '';
                return `
                    <tr data-id="${id}">
                        <td class="col-check"><input type="checkbox" class="gestao-sala-checkbox" data-id="${id}" ${marcado ? 'checked' : ''}></td>
                        <td>${escapeHtml(item.numero || '')}</td>
                        <td>${ilhaTexto}</td>
                        <td class="col-acoes">
                            <button type="button" class="acao-btn" data-action="edit" data-id="${id}" data-numero="${escapeHtml(item.numero || '')}" data-ilha-id="${ilhaId}" data-ilha-nome="${escapeHtml(item.ilha || '')}">
                                <i class="fas fa-pen"></i> Editar
                            </button>
                            <button type="button" class="acao-btn" data-action="delete" data-id="${id}" data-numero="${escapeHtml(item.numero || '')}">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            atualizarResumoSelecaoSalas();
        }

        function renderGestaoHistorico() {
            const dom = obterDomGestaoCadastros();
            if (!dom.historicoTabela) return;
            const historico = stores.gestaoCadastros.historico;
            if (historico.carregando) {
                dom.historicoTabela.innerHTML = '<tr><td colspan="5">Carregando histórico...</td></tr>';
                return;
            }
            if (historico.erro) {
                dom.historicoTabela.innerHTML = `<tr><td colspan="5">${escapeHtml(historico.erro)}</td></tr>`;
                return;
            }
            const registros = Array.isArray(historico.registros) ? historico.registros : [];
            if (!registros.length) {
                dom.historicoTabela.innerHTML = '<tr><td colspan="5">Nenhum registro encontrado para os filtros selecionados.</td></tr>';
            } else {
                dom.historicoTabela.innerHTML = registros.map(item => {
                    const campos = Array.isArray(item.campos) ? item.campos.map(campo => `<li><strong>${escapeHtml(campo.campo || '')}:</strong> ${escapeHtml(String(campo.antes ?? ''))} → ${escapeHtml(String(campo.depois ?? ''))}</li>`).join('') : '<li>Sem detalhes adicionais.</li>';
                    return `
                        <tr>
                            <td>${formatarDataHoraLocal(item.timestamp)}</td>
                            <td>${escapeHtml(item.usuario || '--')}</td>
                            <td>${escapeHtml(item.entidade || '--')} - ${escapeHtml(item.operacao || '--')}</td>
                            <td>${escapeHtml(item.detalhes || item.acao || '--')}</td>
                            <td><ul>${campos}</ul></td>
                        </tr>
                    `;
                }).join('');
            }
            if (dom.historicoResumo) {
                const filtros = historico.filtros || {};
                const periodo = filtros.inicio || filtros.fim
                    ? `Período: ${filtros.inicio ? formatarDataLocal(filtros.inicio) : '--'} até ${filtros.fim ? formatarDataLocal(filtros.fim) : '--'}`
                    : 'Sem filtro de período';
                dom.historicoResumo.textContent = `${registros.length} registro${registros.length === 1 ? '' : 's'} exibido${registros.length === 1 ? '' : 's'}. ${periodo}.`;
            }
        }

        function resetarFormularioGestao(tipo) {
            const dom = obterDomGestaoCadastros();
            switch (tipo) {
                case 'especialidade':
                    if (dom.especialidadeForm) delete dom.especialidadeForm.dataset.id;
                    if (dom.especialidadeNome) {
                        dom.especialidadeNome.value = '';
                        dom.especialidadeNome.classList.remove('is-invalid');
                        dom.especialidadeNome.removeAttribute('aria-invalid');
                    }
                    if (dom.especialidadeAjuda) dom.especialidadeAjuda.textContent = '';
                    if (dom.especialidadeSalvar) {
                        const span = dom.especialidadeSalvar.querySelector('span');
                        if (span) span.textContent = 'Salvar';
                    }
                    stores.gestaoCadastros.selecao.especialidadeId = null;
                    break;
                case 'categoria':
                    if (dom.categoriaForm) delete dom.categoriaForm.dataset.id;
                    if (dom.categoriaNome) {
                        dom.categoriaNome.value = '';
                        dom.categoriaNome.classList.remove('is-invalid');
                        dom.categoriaNome.removeAttribute('aria-invalid');
                    }
                    if (dom.categoriaAjuda) dom.categoriaAjuda.textContent = '';
                    if (dom.categoriaSalvar) {
                        const span = dom.categoriaSalvar.querySelector('span');
                        if (span) span.textContent = 'Salvar';
                    }
                    stores.gestaoCadastros.selecao.categoriaId = null;
                    break;
                case 'ilha':
                    if (dom.ilhaForm) delete dom.ilhaForm.dataset.id;
                    if (dom.ilhaNome) {
                        dom.ilhaNome.value = '';
                        dom.ilhaNome.classList.remove('is-invalid');
                        dom.ilhaNome.removeAttribute('aria-invalid');
                    }
                    if (dom.ilhaAjuda) dom.ilhaAjuda.textContent = '';
                    if (dom.ilhaSalvar) {
                        const span = dom.ilhaSalvar.querySelector('span');
                        if (span) span.textContent = 'Salvar';
                    }
                    stores.gestaoCadastros.selecao.ilhaId = null;
                    break;
                case 'sala':
                    if (dom.salaForm) delete dom.salaForm.dataset.id;
                    if (dom.salaNumero) {
                        dom.salaNumero.value = '';
                        dom.salaNumero.classList.remove('is-invalid');
                        dom.salaNumero.removeAttribute('aria-invalid');
                    }
                    if (dom.salaAjuda) dom.salaAjuda.textContent = '';
                    if (dom.salaIlha) dom.salaIlha.value = '';
                    if (dom.salaSalvar) {
                        const span = dom.salaSalvar.querySelector('span');
                        if (span) span.textContent = 'Salvar';
                    }
                    stores.gestaoCadastros.selecao.salaId = null;
                    break;
                default:
                    break;
            }
        }

        function preencherFormularioGestao(tipo, dados) {
            const dom = obterDomGestaoCadastros();
            switch (tipo) {
                case 'especialidade':
                    if (!dom.especialidadeForm || !dom.especialidadeNome) return;
                    dom.especialidadeForm.dataset.id = dados.id;
                    dom.especialidadeNome.value = dados.nome || '';
                    dom.especialidadeNome.focus();
                    dom.especialidadeNome.classList.remove('is-invalid');
                    dom.especialidadeNome.removeAttribute('aria-invalid');
                    if (dom.especialidadeAjuda) dom.especialidadeAjuda.textContent = '';
                    if (dom.especialidadeSalvar) {
                        const span = dom.especialidadeSalvar.querySelector('span');
                        if (span) span.textContent = 'Atualizar';
                    }
                    stores.gestaoCadastros.selecao.especialidadeId = dados.id;
                    break;
                case 'categoria':
                    if (!dom.categoriaForm || !dom.categoriaNome) return;
                    dom.categoriaForm.dataset.id = dados.id;
                    dom.categoriaNome.value = dados.nome || '';
                    dom.categoriaNome.focus();
                    dom.categoriaNome.classList.remove('is-invalid');
                    dom.categoriaNome.removeAttribute('aria-invalid');
                    if (dom.categoriaAjuda) dom.categoriaAjuda.textContent = '';
                    if (dom.categoriaSalvar) {
                        const span = dom.categoriaSalvar.querySelector('span');
                        if (span) span.textContent = 'Atualizar';
                    }
                    stores.gestaoCadastros.selecao.categoriaId = dados.id;
                    break;
                case 'ilha':
                    if (!dom.ilhaForm || !dom.ilhaNome) return;
                    dom.ilhaForm.dataset.id = dados.id;
                    dom.ilhaNome.value = dados.nome || '';
                    dom.ilhaNome.focus();
                    dom.ilhaNome.classList.remove('is-invalid');
                    dom.ilhaNome.removeAttribute('aria-invalid');
                    if (dom.ilhaAjuda) dom.ilhaAjuda.textContent = '';
                    if (dom.ilhaSalvar) {
                        const span = dom.ilhaSalvar.querySelector('span');
                        if (span) span.textContent = 'Atualizar';
                    }
                    stores.gestaoCadastros.selecao.ilhaId = dados.id;
                    break;
                case 'sala':
                    if (!dom.salaForm || !dom.salaNumero) return;
                    dom.salaForm.dataset.id = dados.id;
                    dom.salaNumero.value = dados.numero || '';
                    dom.salaNumero.focus();
                    dom.salaNumero.classList.remove('is-invalid');
                    dom.salaNumero.removeAttribute('aria-invalid');
                    if (dom.salaAjuda) dom.salaAjuda.textContent = '';
                    if (dom.salaIlha) {
                        let valorIlha = '';
                        if (dados.ilhaId) {
                            valorIlha = String(dados.ilhaId);
                        } else if (dados.ilhaNome) {
                            const info = encontrarIlhaPorNome(dados.ilhaNome);
                            if (info) {
                                valorIlha = String(info.id);
                            }
                        }
                        dom.salaIlha.value = valorIlha;
                    }
                    if (dom.salaSalvar) {
                        const span = dom.salaSalvar.querySelector('span');
                        if (span) span.textContent = 'Atualizar';
                    }
                    stores.gestaoCadastros.selecao.salaId = dados.id;
                    break;
                default:
                    break;
            }
        }

        function atualizarPainelGestaoCadastros() {
            const dom = obterDomGestaoCadastros();
            if (!dom.container) return;
            dom.container.classList.toggle('is-loading', !!stores.gestaoCadastros.carregando);
            const dados = stores.gestaoCadastros.dados || {};
            if (dom.atualizado) {
                dom.atualizado.textContent = dados.timestamp ? `Atualizado em ${formatarDataHoraLocal(dados.timestamp)}` : '';
            }
            renderGestaoCadastrosStats(dados.estatisticas || {});
            renderGestaoEspecialidades(dados.especialidades || []);
            renderGestaoCategorias(dados.categorias || []);
            renderGestaoIlhas(dados.ilhas || []);
            renderGestaoSalas(dados.salas || []);
            atualizarSeletoresGestaoIlha(dados.ilhas || []);
            if (stores.gestaoCadastros.tabAtiva === 'historico') {
                renderGestaoHistorico();
            }
        }

        function definirTabGestaoCadastros(tab) {
            const dom = obterDomGestaoCadastros();
            if (!dom.container) return;
            const alvo = tab || stores.gestaoCadastros.tabAtiva || 'especialidades';
            stores.gestaoCadastros.tabAtiva = alvo;
            dom.tabButtons.forEach(botao => {
                const painel = botao.dataset.panel;
                const ativo = painel === alvo;
                botao.classList.toggle('active', ativo);
                botao.setAttribute('aria-selected', ativo ? 'true' : 'false');
                const painelElemento = document.getElementById(`gestao-cadastros-${painel}`);
                if (painelElemento) {
                    if (ativo) {
                        painelElemento.removeAttribute('hidden');
                        painelElemento.classList.add('active');
                    } else {
                        painelElemento.setAttribute('hidden', '');
                        painelElemento.classList.remove('active');
                    }
                }
            });
            if (alvo === 'historico') {
                carregarHistoricoGestaoCadastros();
            }
        }

        function inicializarGestaoCadastros() {
            const dom = obterDomGestaoCadastros();
            if (!dom.container) return;
            if (!stores.gestaoCadastros.eventosRegistrados) {
                registrarEventosGestaoCadastros();
                stores.gestaoCadastros.eventosRegistrados = true;
            }
            atualizarPainelGestaoCadastros();
            definirTabGestaoCadastros(stores.gestaoCadastros.tabAtiva);
            if (!stores.gestaoCadastros.carregado) {
                carregarGestaoCadastros();
            }
        }

        function registrarEventosGestaoCadastros() {
            const dom = obterDomGestaoCadastros();
            if (!dom.container) return;
            if (dom.tabButtons.length) {
                dom.tabButtons.forEach(botao => botao.addEventListener('click', () => definirTabGestaoCadastros(botao.dataset.panel)));
            }
            if (dom.refresh) {
                dom.refresh.addEventListener('click', () => {
                    limparFeedbackGestaoCadastros();
                    carregarGestaoCadastros({ mostrarMensagem: true });
                });
            }
            if (dom.especialidadeForm) {
                dom.especialidadeForm.addEventListener('submit', evento => {
                    evento.preventDefault();
                    limparFeedbackGestaoCadastros();
                    const nome = (dom.especialidadeNome?.value || '').trim();
                    if (nome.length < 2) {
                        if (dom.especialidadeNome) {
                            dom.especialidadeNome.classList.add('is-invalid');
                            dom.especialidadeNome.setAttribute('aria-invalid', 'true');
                        }
                        if (dom.especialidadeAjuda) dom.especialidadeAjuda.textContent = 'Informe ao menos 2 caracteres.';
                        return;
                    }
                    if (dom.especialidadeNome) {
                        dom.especialidadeNome.classList.remove('is-invalid');
                        dom.especialidadeNome.removeAttribute('aria-invalid');
                    }
                    if (dom.especialidadeAjuda) dom.especialidadeAjuda.textContent = '';
                    const id = dom.especialidadeForm.dataset.id ? Number(dom.especialidadeForm.dataset.id) : null;
                    salvarGestaoEspecialidade({ id, nome });
                });
            }
            if (dom.especialidadeCancelar) {
                dom.especialidadeCancelar.addEventListener('click', () => resetarFormularioGestao('especialidade'));
            }
            if (dom.especialidadeLista) {
                dom.especialidadeLista.addEventListener('click', evento => {
                    const botao = evento.target.closest('button[data-action]');
                    if (!botao) return;
                    const id = Number(botao.dataset.id);
                    const nome = botao.dataset.nome || '';
                    if (botao.dataset.action === 'edit') {
                        preencherFormularioGestao('especialidade', { id, nome });
                    } else if (botao.dataset.action === 'delete') {
                        abrirConfirmacaoGestao({
                            titulo: 'Remover especialidade',
                            mensagem: `Confirma a exclusão da especialidade “${nome}”?`,
                            onConfirm: () => excluirGestaoEspecialidade(id, nome)
                        });
                    }
                });
            }
            if (dom.categoriaForm) {
                dom.categoriaForm.addEventListener('submit', evento => {
                    evento.preventDefault();
                    limparFeedbackGestaoCadastros();
                    const nome = (dom.categoriaNome?.value || '').trim();
                    if (nome.length < 2) {
                        if (dom.categoriaNome) {
                            dom.categoriaNome.classList.add('is-invalid');
                            dom.categoriaNome.setAttribute('aria-invalid', 'true');
                        }
                        if (dom.categoriaAjuda) dom.categoriaAjuda.textContent = 'Informe ao menos 2 caracteres.';
                        return;
                    }
                    if (dom.categoriaNome) {
                        dom.categoriaNome.classList.remove('is-invalid');
                        dom.categoriaNome.removeAttribute('aria-invalid');
                    }
                    if (dom.categoriaAjuda) dom.categoriaAjuda.textContent = '';
                    const id = dom.categoriaForm.dataset.id ? Number(dom.categoriaForm.dataset.id) : null;
                    salvarGestaoCategoria({ id, nome });
                });
            }
            if (dom.categoriaCancelar) {
                dom.categoriaCancelar.addEventListener('click', () => resetarFormularioGestao('categoria'));
            }
            if (dom.categoriaLista) {
                dom.categoriaLista.addEventListener('click', evento => {
                    const botao = evento.target.closest('button[data-action]');
                    if (!botao) return;
                    const id = Number(botao.dataset.id);
                    const nome = botao.dataset.nome || '';
                    if (botao.dataset.action === 'edit') {
                        preencherFormularioGestao('categoria', { id, nome });
                    } else if (botao.dataset.action === 'delete') {
                        abrirConfirmacaoGestao({
                            titulo: 'Remover categoria',
                            mensagem: `Confirma a exclusão da categoria “${nome}”?`,
                            onConfirm: () => excluirGestaoCategoria(id, nome)
                        });
                    }
                });
            }
            if (dom.ilhaForm) {
                dom.ilhaForm.addEventListener('submit', evento => {
                    evento.preventDefault();
                    limparFeedbackGestaoCadastros();
                    const nome = (dom.ilhaNome?.value || '').trim();
                    if (nome.length < 2) {
                        if (dom.ilhaNome) {
                            dom.ilhaNome.classList.add('is-invalid');
                            dom.ilhaNome.setAttribute('aria-invalid', 'true');
                        }
                        if (dom.ilhaAjuda) dom.ilhaAjuda.textContent = 'Informe ao menos 2 caracteres.';
                        return;
                    }
                    if (dom.ilhaNome) {
                        dom.ilhaNome.classList.remove('is-invalid');
                        dom.ilhaNome.removeAttribute('aria-invalid');
                    }
                    if (dom.ilhaAjuda) dom.ilhaAjuda.textContent = '';
                    const id = dom.ilhaForm.dataset.id ? Number(dom.ilhaForm.dataset.id) : null;
                    salvarGestaoIlha({ id, nome });
                });
            }
            if (dom.ilhaCancelar) {
                dom.ilhaCancelar.addEventListener('click', () => resetarFormularioGestao('ilha'));
            }
            if (dom.ilhaLista) {
                dom.ilhaLista.addEventListener('click', evento => {
                    const botao = evento.target.closest('button[data-action]');
                    if (!botao) return;
                    const id = Number(botao.dataset.id);
                    const nome = botao.dataset.nome || '';
                    if (botao.dataset.action === 'edit') {
                        preencherFormularioGestao('ilha', { id, nome });
                    } else if (botao.dataset.action === 'delete') {
                        const totalSalas = Number(botao.dataset.totalSalas || '0');
                        const salas = botao.dataset.salas ? botao.dataset.salas.split('|').filter(Boolean) : [];
                        confirmarExclusaoIlha({ id, nome, totalSalas, salas });
                    }
                });
            }
            if (dom.salaForm) {
                dom.salaForm.addEventListener('submit', evento => {
                    evento.preventDefault();
                    limparFeedbackGestaoCadastros();
                    const numero = (dom.salaNumero?.value || '').trim();
                    if (!numero) {
                        if (dom.salaNumero) {
                            dom.salaNumero.classList.add('is-invalid');
                            dom.salaNumero.setAttribute('aria-invalid', 'true');
                        }
                        if (dom.salaAjuda) dom.salaAjuda.textContent = 'Informe um identificador para a sala.';
                        return;
                    }
                    if (dom.salaNumero) {
                        dom.salaNumero.classList.remove('is-invalid');
                        dom.salaNumero.removeAttribute('aria-invalid');
                    }
                    if (dom.salaAjuda) dom.salaAjuda.textContent = '';
                    const id = dom.salaForm.dataset.id ? Number(dom.salaForm.dataset.id) : null;
                    const ilhaValor = dom.salaIlha ? dom.salaIlha.value : '';
                    const ilhaId = ilhaValor ? Number(ilhaValor) : null;
                    let ilhaNome = '';
                    if (ilhaId) {
                        const info = encontrarIlhaPorId(ilhaId);
                        ilhaNome = info ? info.nome : '';
                    }
                    if (!ilhaId && dom.salaIlha && dom.salaIlha.selectedOptions && dom.salaIlha.selectedOptions.length) {
                        const option = dom.salaIlha.selectedOptions[0];
                        const texto = option ? option.textContent.trim() : '';
                        ilhaNome = option && option.value ? texto : '';
                    }
                    salvarGestaoSala({ id, numero, ilhaId, ilhaNome });
                });
            }
            if (dom.salaCancelar) {
                dom.salaCancelar.addEventListener('click', () => resetarFormularioGestao('sala'));
            }
            if (dom.salaLista) {
                dom.salaLista.addEventListener('click', evento => {
                    const botao = evento.target.closest('button[data-action]');
                    if (!botao) return;
                    const id = Number(botao.dataset.id);
                    if (botao.dataset.action === 'edit') {
                        const numero = botao.dataset.numero || '';
                        const ilhaId = botao.dataset.ilhaId ? Number(botao.dataset.ilhaId) : null;
                        const ilhaNome = botao.dataset.ilhaNome || '';
                        preencherFormularioGestao('sala', { id, numero, ilhaId, ilhaNome });
                    } else if (botao.dataset.action === 'delete') {
                        const numero = botao.dataset.numero || '';
                        abrirConfirmacaoGestao({
                            titulo: 'Remover sala',
                            mensagem: `Confirma a exclusão da sala “${numero}”?`,
                            onConfirm: () => excluirGestaoSala(id, numero)
                        });
                    }
                });
                dom.salaLista.addEventListener('change', evento => {
                    const checkbox = evento.target.closest('.gestao-sala-checkbox');
                    if (!checkbox) return;
                    const id = Number(checkbox.dataset.id);
                    const selecao = obterSelecaoSalasSet();
                    if (checkbox.checked) {
                        selecao.add(id);
                    } else {
                        selecao.delete(id);
                        selecao.delete(String(id));
                    }
                    atualizarResumoSelecaoSalas();
                });
            }
            if (dom.salaSelectTodos) {
                dom.salaSelectTodos.addEventListener('change', () => {
                    const selecao = obterSelecaoSalasSet();
                    const checkboxes = dom.salaLista ? Array.from(dom.salaLista.querySelectorAll('.gestao-sala-checkbox')) : [];
                    const marcar = !!dom.salaSelectTodos.checked;
                    checkboxes.forEach(cb => {
                        cb.checked = marcar;
                        const id = Number(cb.dataset.id);
                        if (Number.isInteger(id)) {
                            if (marcar) {
                                selecao.add(id);
                            } else {
                                selecao.delete(id);
                                selecao.delete(String(id));
                            }
                        }
                    });
                    atualizarResumoSelecaoSalas();
                });
            }
            if (dom.salaLoteForm) {
                dom.salaLoteForm.addEventListener('submit', evento => {
                    evento.preventDefault();
                    limparFeedbackGestaoCadastros();
                    aplicarGestaoSalaLote();
                });
            }
            if (dom.salaLoteLimpar) {
                dom.salaLoteLimpar.addEventListener('click', evento => {
                    evento.preventDefault();
                    limparSelecaoSalas();
                });
            }
            if (dom.historicoForm) {
                dom.historicoForm.addEventListener('submit', evento => {
                    evento.preventDefault();
                    atualizarFiltrosHistoricoGestao();
                    carregarHistoricoGestaoCadastros({ mostrarMensagem: true });
                });
            }
            if (dom.historicoReset) {
                dom.historicoReset.addEventListener('click', evento => {
                    evento.preventDefault();
                    if (dom.historicoForm) dom.historicoForm.reset();
                    if (dom.historicoBusca) dom.historicoBusca.value = '';
                    if (dom.historicoEntidade) dom.historicoEntidade.value = '';
                    if (dom.historicoAcao) dom.historicoAcao.value = '';
                    if (dom.historicoUsuario) dom.historicoUsuario.value = '';
                    if (dom.historicoInicio) dom.historicoInicio.value = '';
                    if (dom.historicoFim) dom.historicoFim.value = '';
                    atualizarFiltrosHistoricoGestao(true);
                    carregarHistoricoGestaoCadastros({ mostrarMensagem: true });
                });
            }
            if (dom.historicoRecarregar) {
                dom.historicoRecarregar.addEventListener('click', evento => {
                    evento.preventDefault();
                    carregarHistoricoGestaoCadastros({ mostrarMensagem: true, forcar: true });
                });
            }
            if (dom.confirmModal) {
                dom.confirmModal.addEventListener('click', evento => {
                    if (evento.target === dom.confirmModal) {
                        fecharConfirmacaoGestao();
                    }
                });
                dom.confirmModal.querySelectorAll('.close-modal').forEach(botao => {
                    botao.addEventListener('click', evento => {
                        evento.preventDefault();
                        fecharConfirmacaoGestao();
                    });
                });
            }
        }

        function coletarFiltrosHistoricoDoDom() {
            const dom = obterDomGestaoCadastros();
            return {
                busca: dom.historicoBusca ? dom.historicoBusca.value.trim() : '',
                entidade: dom.historicoEntidade ? dom.historicoEntidade.value : '',
                acao: dom.historicoAcao ? dom.historicoAcao.value : '',
                usuario: dom.historicoUsuario ? dom.historicoUsuario.value.trim() : '',
                inicio: dom.historicoInicio ? dom.historicoInicio.value : '',
                fim: dom.historicoFim ? dom.historicoFim.value : ''
            };
        }

        function atualizarFiltrosHistoricoGestao(reset = false) {
            const historico = stores.gestaoCadastros.historico;
            if (!historico) return;
            historico.filtros = reset
                ? { busca: '', entidade: '', acao: '', usuario: '', inicio: '', fim: '' }
                : coletarFiltrosHistoricoDoDom();
        }

        function confirmarExclusaoIlha({ id, nome, totalSalas, salas }) {
            const listaIlhas = (stores.gestaoCadastros.dados?.ilhas || []).filter(ilha => Number(ilha.id) !== Number(id));
            const possuiReassociacao = totalSalas > 0 && listaIlhas.length > 0;
            const detalhes = [];
            if (totalSalas > 0) {
                detalhes.push(`<p>Esta ilha possui ${totalSalas} sala${totalSalas === 1 ? '' : 's'} associada${totalSalas === 1 ? '' : 's'}.</p>`);
                if (Array.isArray(salas) && salas.length) {
                    const itens = salas.slice(0, 8).map(sala => `<li>${escapeHtml(sala)}</li>`);
                    if (salas.length > 8) {
                        itens.push('<li>…</li>');
                    }
                    detalhes.push(`<ul>${itens.join('')}</ul>`);
                }
                if (possuiReassociacao) {
                    const opcoes = listaIlhas.map(item => `<option value="${item.id}" data-nome="${escapeHtml(item.nome || '')}">${escapeHtml(item.nome || '')}</option>`).join('');
                    detalhes.push(`
                        <label for="gestao-confirm-ilha-destino">Reatribuir salas para:</label>
                        <select id="gestao-confirm-ilha-destino">
                            <option value="">Manter sem ilha</option>
                            ${opcoes}
                        </select>
                    `);
                }
            } else {
                detalhes.push('<p>Esta ilha não possui salas associadas.</p>');
            }

            const aviso = totalSalas > 0
                ? (possuiReassociacao
                    ? 'As salas selecionadas serão movidas para a ilha escolhida.'
                    : 'As salas permanecerão cadastradas sem associação de ilha.')
                : '';

            abrirConfirmacaoGestao({
                titulo: 'Remover ilha',
                mensagem: `Confirma a exclusão da ilha “${nome}”?`,
                detalhes: detalhes.join(''),
                aviso,
                confirmarTexto: 'Excluir',
                onConfirm: () => {
                    let reassociarId = null;
                    let reassociarNome = '';
                    if (possuiReassociacao) {
                        const select = document.getElementById('gestao-confirm-ilha-destino');
                        if (select) {
                            const valor = select.value;
                            if (valor) {
                                reassociarId = Number(valor);
                                const option = select.selectedOptions && select.selectedOptions.length ? select.selectedOptions[0] : null;
                                reassociarNome = option ? (option.dataset.nome || option.textContent.trim()) : '';
                            }
                        }
                    }
                    excluirGestaoIlha(id, nome, reassociarId, reassociarNome);
                }
            });
        }

        function abrirConfirmacaoGestao(opcoes = {}) {
            const dom = obterDomGestaoCadastros();
            if (!dom.confirmModal) return;
            const { titulo, mensagem, detalhes = '', aviso = '', confirmarTexto, onConfirm, onCancel } = opcoes;

            if (dom.confirmTitle) {
                dom.confirmTitle.innerHTML = dom.confirmDefaultTitleHtml || dom.confirmTitle.innerHTML;
                if (titulo) {
                    const icon = dom.confirmTitle.querySelector('i');
                    if (icon) {
                        const iconClone = icon.cloneNode(true);
                        dom.confirmTitle.innerHTML = '';
                        dom.confirmTitle.appendChild(iconClone);
                        dom.confirmTitle.appendChild(document.createTextNode(` ${titulo}`));
                    } else {
                        dom.confirmTitle.textContent = titulo;
                    }
                }
            }

            if (dom.confirmMessage) {
                dom.confirmMessage.textContent = mensagem || '';
            }

            if (dom.confirmDetails) {
                dom.confirmDetails.innerHTML = detalhes || '';
                dom.confirmDetails.classList.toggle('is-visible', !!detalhes);
            }

            if (dom.confirmWarning) {
                dom.confirmWarning.textContent = aviso || '';
                dom.confirmWarning.classList.toggle('is-visible', !!aviso);
            }

            if (dom.confirmAccept) {
                dom.confirmAccept.innerHTML = dom.confirmDefaultAcceptHtml || dom.confirmAccept.innerHTML;
                const label = confirmarTexto || dom.confirmDefaultLabel || 'Confirmar';
                const icon = dom.confirmAccept.querySelector('i');
                if (icon) {
                    const iconClone = icon.cloneNode(true);
                    dom.confirmAccept.innerHTML = '';
                    dom.confirmAccept.appendChild(iconClone);
                    dom.confirmAccept.appendChild(document.createTextNode(` ${label}`));
                } else {
                    dom.confirmAccept.textContent = label;
                }
                dom.confirmAccept.disabled = false;
                dom.confirmAccept.removeAttribute('aria-busy');
                dom.confirmAccept.onclick = evento => {
                    evento.preventDefault();
                    dom.confirmAccept.disabled = true;
                    dom.confirmAccept.setAttribute('aria-busy', 'true');
                    let resultado;
                    try {
                        resultado = typeof onConfirm === 'function' ? onConfirm({ event: evento, close: fecharConfirmacaoGestao }) : undefined;
                    } catch (erro) {
                        console.error('Erro ao confirmar ação:', erro);
                        dom.confirmAccept.disabled = false;
                        dom.confirmAccept.removeAttribute('aria-busy');
                        return;
                    }
                    if (resultado === false) {
                        dom.confirmAccept.disabled = false;
                        dom.confirmAccept.removeAttribute('aria-busy');
                        return;
                    }
                    fecharConfirmacaoGestao(true);
                };
            }

            domCache.gestaoCadastros.confirmOnCancel = typeof onCancel === 'function' ? onCancel : null;

            dom.confirmModal.style.display = 'block';
            dom.confirmModal.classList.add('is-visible');
            if (dom.confirmAccept) {
                dom.confirmAccept.focus({ preventScroll: true });
            }
        }

        function fecharConfirmacaoGestao(foiConfirmado = false) {
            const dom = obterDomGestaoCadastros();
            if (!dom.confirmModal) return;
            dom.confirmModal.style.display = 'none';
            dom.confirmModal.classList.remove('is-visible');
            if (dom.confirmMessage) dom.confirmMessage.textContent = '';
            if (dom.confirmDetails) {
                dom.confirmDetails.innerHTML = '';
                dom.confirmDetails.classList.remove('is-visible');
            }
            if (dom.confirmWarning) {
                dom.confirmWarning.textContent = '';
                dom.confirmWarning.classList.remove('is-visible');
            }
            if (dom.confirmTitle && dom.confirmDefaultTitleHtml !== undefined) {
                dom.confirmTitle.innerHTML = dom.confirmDefaultTitleHtml;
            }
            if (dom.confirmAccept) {
                dom.confirmAccept.innerHTML = dom.confirmDefaultAcceptHtml || dom.confirmAccept.innerHTML;
                dom.confirmAccept.disabled = false;
                dom.confirmAccept.removeAttribute('aria-busy');
                dom.confirmAccept.onclick = null;
            }
            if (!foiConfirmado && typeof domCache.gestaoCadastros.confirmOnCancel === 'function') {
                try {
                    domCache.gestaoCadastros.confirmOnCancel();
                } catch (erro) {
                    console.error('Erro ao executar callback de cancelamento:', erro);
                }
            }
            domCache.gestaoCadastros.confirmOnCancel = null;
        }

        function carregarGestaoCadastros(opcoes = {}) {
            const { mostrarMensagem = false } = opcoes;
            const estado = stores.gestaoCadastros;
            if (estado.carregando) {
                return;
            }

            estado.carregando = true;
            estado.erro = null;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                const dadosDemo = obterGestaoCadastrosDemonstracao();
                estado.dados = dadosDemo;
                estado.carregando = false;
                estado.carregado = true;
                estado.ultimaAtualizacao = dadosDemo.timestamp;
                atualizarPainelGestaoCadastros();
                if (mostrarMensagem) {
                    mostrarFeedbackGestaoCadastros('success', 'Exibindo dados demonstrativos dos cadastros.');
                }
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoListarCadastros',
                parametros: [],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    const sucesso = processarRespostaGestao(resposta, {
                        mostrarMensagem,
                        mensagemPadrao: 'Cadastros atualizados com sucesso.'
                    });
                    if (!sucesso && mostrarMensagem) {
                        mostrarFeedbackGestaoCadastros('error', resposta?.message || resposta?.mensagem || 'Não foi possível atualizar os cadastros.');
                    }
                },
                onFailure(erro) {
                    estado.carregado = false;
                    estado.erro = erro?.message || 'Erro ao carregar cadastros.';
                    if (mostrarMensagem) {
                        mostrarFeedbackGestaoCadastros('error', estado.erro);
                    }
                },
                mensagemErroPadrao: 'Erro ao carregar cadastros.'
            });
        }

        function normalizarDadosGestao(dados) {
            const timestamp = dados?.timestamp || new Date().toISOString();
            const especialidades = Array.isArray(dados?.especialidades)
                ? dados.especialidades.map(item => ({
                    id: Number(item.id),
                    nome: item.nome || ''
                })).filter(item => item.id)
                : [];
            const categorias = Array.isArray(dados?.categorias)
                ? dados.categorias.map(item => ({
                    id: Number(item.id),
                    nome: item.nome || ''
                })).filter(item => item.id)
                : [];
            const ilhas = Array.isArray(dados?.ilhas)
                ? dados.ilhas.map(item => ({
                    id: Number(item.id),
                    nome: item.nome || '',
                    totalSalas: Number(item.totalSalas) || 0,
                    salas: Array.isArray(item.salas) ? item.salas.slice() : [],
                    linhas: Array.isArray(item.linhas) ? item.linhas.slice() : [],
                    duplicada: !!item.duplicada
                })).filter(item => item.id)
                : [];
            const salas = Array.isArray(dados?.salas)
                ? dados.salas.map(item => ({
                    id: Number(item.id),
                    numero: item.numero || '',
                    ilha: item.ilha || '',
                    ilhaChave: item.ilhaChave || normalizarChaveCadastroLocal(item.ilha || '')
                })).filter(item => item.id)
                : [];

            const estatisticasOrigem = dados?.estatisticas || {};
            const estatisticas = {
                totalEspecialidades: Number(estatisticasOrigem.totalEspecialidades ?? especialidades.length) || especialidades.length,
                totalCategorias: Number(estatisticasOrigem.totalCategorias ?? categorias.length) || categorias.length,
                totalIlhas: Number(estatisticasOrigem.totalIlhas ?? ilhas.length) || ilhas.length,
                totalSalas: Number(estatisticasOrigem.totalSalas ?? salas.length) || salas.length,
                ilhasSemSala: Number(estatisticasOrigem.ilhasSemSala ?? ilhas.filter(ilha => (ilha.totalSalas || 0) === 0).length) || ilhas.filter(ilha => (ilha.totalSalas || 0) === 0).length,
                salasSemIlha: Number(estatisticasOrigem.salasSemIlha ?? salas.filter(sala => !sala.ilha).length) || salas.filter(sala => !sala.ilha).length
            };

            return {
                timestamp,
                especialidades,
                categorias,
                ilhas,
                salas,
                estatisticas
            };
        }

        function processarRespostaGestao(resposta, opcoes = {}) {
            const estado = stores.gestaoCadastros;
            if (!resposta || resposta.success !== true || !resposta.dados) {
                const mensagem = resposta?.message || resposta?.mensagem || 'Não foi possível processar a operação.';
                estado.erro = mensagem;
                estado.carregado = false;
                if (opcoes.mostrarMensagem) {
                    mostrarFeedbackGestaoCadastros('error', mensagem);
                }
                return false;
            }

            estado.dados = normalizarDadosGestao(resposta.dados);
            estado.carregado = true;
            estado.erro = null;
            estado.ultimaAtualizacao = estado.dados.timestamp || resposta.timestamp || new Date().toISOString();
            limparSelecaoSalasInexistentes();
            atualizarPainelGestaoCadastros();

            if (opcoes.mostrarMensagem !== false) {
                const mensagem = resposta.mensagem || resposta.message || opcoes.mensagemPadrao || '';
                if (mensagem) {
                    mostrarFeedbackGestaoCadastros('success', mensagem);
                }
            }

            return true;
        }

        function obterGestaoCadastrosDemonstracao() {
            const timestamp = new Date().toISOString();
            const especialidades = [
                { id: 2, nome: 'Clínica Geral' },
                { id: 3, nome: 'Ortopedia' },
                { id: 4, nome: 'Pediatria' }
            ];
            const categorias = [
                { id: 5, nome: 'Médico' },
                { id: 6, nome: 'Enfermeiro' }
            ];
            const ilhas = [
                { id: 10, nome: 'Ilha Azul', totalSalas: 2, salas: ['201', '202'], linhas: [10], duplicada: false },
                { id: 11, nome: 'Ilha Central', totalSalas: 1, salas: ['301'], linhas: [11], duplicada: false },
                { id: 12, nome: 'Ilha Norte', totalSalas: 0, salas: [], linhas: [12], duplicada: false }
            ];
            const salas = [
                { id: 20, numero: '201', ilha: 'Ilha Azul', ilhaChave: normalizarChaveCadastroLocal('Ilha Azul') },
                { id: 21, numero: '202', ilha: 'Ilha Azul', ilhaChave: normalizarChaveCadastroLocal('Ilha Azul') },
                { id: 22, numero: '301', ilha: 'Ilha Central', ilhaChave: normalizarChaveCadastroLocal('Ilha Central') },
                { id: 23, numero: '401', ilha: '', ilhaChave: '' }
            ];
            return normalizarDadosGestao({ timestamp, especialidades, categorias, ilhas, salas });
        }

        function salvarGestaoEspecialidade({ id, nome }) {
            const dom = obterDomGestaoCadastros();
            definirEstadoBotaoAcao(dom.especialidadeSalvar, true, id ? 'Atualizando...' : 'Salvando...');
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                definirEstadoBotaoAcao(dom.especialidadeSalvar, false);
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoSalvarEspecialidade',
                parametros: [{ id, nome }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        definirEstadoBotaoAcao(dom.especialidadeSalvar, false);
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        resetarFormularioGestao('especialidade');
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || 'Não foi possível salvar a especialidade.');
                },
                mensagemErroPadrao: 'Erro ao salvar especialidade.'
            });
        }

        function excluirGestaoEspecialidade(id, nome) {
            limparFeedbackGestaoCadastros();
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoExcluirEspecialidade',
                parametros: [{ id }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        if (stores.gestaoCadastros.selecao.especialidadeId === id) {
                            resetarFormularioGestao('especialidade');
                        }
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || `Não foi possível excluir a especialidade ${nome}.`);
                },
                mensagemErroPadrao: 'Erro ao excluir especialidade.'
            });
        }

        function salvarGestaoCategoria({ id, nome }) {
            const dom = obterDomGestaoCadastros();
            definirEstadoBotaoAcao(dom.categoriaSalvar, true, id ? 'Atualizando...' : 'Salvando...');
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                definirEstadoBotaoAcao(dom.categoriaSalvar, false);
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoSalvarCategoria',
                parametros: [{ id, nome }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        definirEstadoBotaoAcao(dom.categoriaSalvar, false);
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        resetarFormularioGestao('categoria');
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || 'Não foi possível salvar a categoria.');
                },
                mensagemErroPadrao: 'Erro ao salvar categoria.'
            });
        }

        function excluirGestaoCategoria(id, nome) {
            limparFeedbackGestaoCadastros();
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoExcluirCategoria',
                parametros: [{ id }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        if (stores.gestaoCadastros.selecao.categoriaId === id) {
                            resetarFormularioGestao('categoria');
                        }
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || `Não foi possível excluir a categoria ${nome}.`);
                },
                mensagemErroPadrao: 'Erro ao excluir categoria.'
            });
        }

        function salvarGestaoIlha({ id, nome }) {
            const dom = obterDomGestaoCadastros();
            definirEstadoBotaoAcao(dom.ilhaSalvar, true, id ? 'Atualizando...' : 'Salvando...');
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                definirEstadoBotaoAcao(dom.ilhaSalvar, false);
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoSalvarIlha',
                parametros: [{ id, nome }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        definirEstadoBotaoAcao(dom.ilhaSalvar, false);
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        resetarFormularioGestao('ilha');
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || 'Não foi possível salvar a ilha.');
                },
                mensagemErroPadrao: 'Erro ao salvar ilha.'
            });
        }

        function excluirGestaoIlha(id, nome, reassociarId, reassociarNome) {
            limparFeedbackGestaoCadastros();
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoExcluirIlha',
                parametros: [{ id, reassociarId, reassociarNome }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        if (stores.gestaoCadastros.selecao.ilhaId === id) {
                            resetarFormularioGestao('ilha');
                        }
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || `Não foi possível excluir a ilha ${nome}.`);
                },
                mensagemErroPadrao: 'Erro ao excluir ilha.'
            });
        }

        function salvarGestaoSala({ id, numero, ilhaId, ilhaNome }) {
            const dom = obterDomGestaoCadastros();
            definirEstadoBotaoAcao(dom.salaSalvar, true, id ? 'Atualizando...' : 'Salvando...');
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                definirEstadoBotaoAcao(dom.salaSalvar, false);
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            const payload = { id, numero };
            if (Number.isInteger(ilhaId)) {
                payload.ilhaId = ilhaId;
            }
            if (ilhaNome !== undefined) {
                payload.ilhaNome = ilhaNome;
            }

            executarGoogleScript({
                funcao: 'gestaoSalvarSala',
                parametros: [payload],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        definirEstadoBotaoAcao(dom.salaSalvar, false);
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        resetarFormularioGestao('sala');
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || 'Não foi possível salvar a sala.');
                },
                mensagemErroPadrao: 'Erro ao salvar sala.'
            });
        }

        function excluirGestaoSala(id, numero) {
            limparFeedbackGestaoCadastros();
            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoExcluirSala',
                parametros: [{ id }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        if (stores.gestaoCadastros.selecao.salaId === id) {
                            resetarFormularioGestao('sala');
                        }
                        limparSelecaoSalasInexistentes();
                        atualizarResumoSelecaoSalas();
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || `Não foi possível excluir a sala ${numero}.`);
                },
                mensagemErroPadrao: 'Erro ao excluir sala.'
            });
        }

        function aplicarGestaoSalaLote() {
            const dom = obterDomGestaoCadastros();
            const selecao = Array.from(obterSelecaoSalasSet()).map(valor => Number(valor)).filter(Number.isInteger);
            if (!selecao.length) {
                mostrarFeedbackGestaoCadastros('error', 'Selecione ao menos uma sala para aplicar a alteração em lote.');
                return;
            }

            const ilhaValor = dom.salaLoteIlha ? dom.salaLoteIlha.value : '';
            const ilhaId = ilhaValor ? Number(ilhaValor) : null;
            let ilhaNome = '';
            if (ilhaId) {
                const info = encontrarIlhaPorId(ilhaId);
                ilhaNome = info ? info.nome : '';
            }

            const estado = stores.gestaoCadastros;
            estado.carregando = true;
            atualizarPainelGestaoCadastros();
            definirEstadoBotaoAcao(dom.salaLoteAplicar, true, 'Aplicando...');

            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                estado.carregando = false;
                definirEstadoBotaoAcao(dom.salaLoteAplicar, false);
                atualizarPainelGestaoCadastros();
                mostrarFeedbackGestaoCadastros('error', 'Integração com Apps Script indisponível neste ambiente.');
                return;
            }

            const payload = { salas: selecao };
            if (Number.isInteger(ilhaId)) {
                payload.ilhaId = ilhaId;
            }
            if (ilhaNome !== undefined) {
                payload.ilhaNome = ilhaNome;
            }

            executarGoogleScript({
                funcao: 'gestaoAtualizarSalasEmLote',
                parametros: [payload],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        estado.carregando = false;
                        definirEstadoBotaoAcao(dom.salaLoteAplicar, false);
                        atualizarPainelGestaoCadastros();
                    }
                },
                onSuccess(resposta) {
                    if (processarRespostaGestao(resposta, { mostrarMensagem: true })) {
                        limparSelecaoSalas();
                    }
                },
                onFailure(erro) {
                    mostrarFeedbackGestaoCadastros('error', erro?.message || 'Não foi possível aplicar a alteração em lote.');
                },
                mensagemErroPadrao: 'Erro ao atualizar salas em lote.'
            });
        }

        function carregarHistoricoGestaoCadastros(opcoes = {}) {
            const { mostrarMensagem = false } = opcoes;
            const historico = stores.gestaoCadastros.historico;
            if (historico.carregando) {
                return;
            }

            historico.carregando = true;
            historico.erro = null;
            renderGestaoHistorico();

            const filtros = historico.filtros || {};
            const runnerDisponivel = typeof google !== 'undefined' && google?.script?.run;
            if (!runnerDisponivel) {
                historico.registros = obterHistoricoGestaoDemonstracao(filtros).map(normalizarRegistroHistorico);
                historico.timestamp = new Date().toISOString();
                historico.carregando = false;
                renderGestaoHistorico();
                if (mostrarMensagem) {
                    mostrarFeedbackGestaoCadastros('success', 'Exibindo histórico demonstrativo.');
                }
                return;
            }

            executarGoogleScript({
                funcao: 'gestaoListarHistoricoLogs',
                parametros: [{
                    busca: filtros.busca || '',
                    entidade: filtros.entidade || '',
                    acao: filtros.acao || '',
                    usuario: filtros.usuario || '',
                    periodo: { inicio: filtros.inicio || '', fim: filtros.fim || '' },
                    limite: 200
                }],
                tentativas: 1,
                contexto: {
                    onFinally() {
                        historico.carregando = false;
                        renderGestaoHistorico();
                    }
                },
                onSuccess(resposta) {
                    if (resposta && resposta.success) {
                        const registros = Array.isArray(resposta.registros)
                            ? resposta.registros.map(normalizarRegistroHistorico).filter(Boolean)
                            : [];
                        historico.registros = registros;
                        historico.timestamp = resposta.timestamp || new Date().toISOString();
                        historico.erro = null;
                        if (mostrarMensagem) {
                            const mensagem = resposta.mensagem || resposta.message || `Histórico atualizado (${registros.length} registro${registros.length === 1 ? '' : 's'}).`;
                            mostrarFeedbackGestaoCadastros('success', mensagem);
                        }
                    } else {
                        const mensagem = resposta?.message || resposta?.mensagem || 'Não foi possível carregar o histórico.';
                        historico.erro = mensagem;
                        if (mostrarMensagem) {
                            mostrarFeedbackGestaoCadastros('error', mensagem);
                        }
                    }
                },
                onFailure(erro) {
                    const mensagem = erro?.message || 'Erro ao carregar histórico.';
                    historico.erro = mensagem;
                    if (mostrarMensagem) {
                        mostrarFeedbackGestaoCadastros('error', mensagem);
                    }
                },
                mensagemErroPadrao: 'Erro ao carregar histórico.'
            });
        }

        function normalizarRegistroHistorico(item) {
            if (!item) return null;
            const campos = Array.isArray(item.campos)
                ? item.campos.map(campo => ({
                    campo: campo.campo || '',
                    antes: campo.antes ?? '',
                    depois: campo.depois ?? ''
                }))
                : [];
            return {
                timestamp: item.timestamp || '',
                usuario: item.usuario || '',
                entidade: item.entidade || (item.dados && item.dados.entidade) || '',
                operacao: item.operacao || (item.dados && item.dados.operacao) || '',
                detalhes: item.detalhes || item.acao || '',
                acao: item.acao || '',
                campos
            };
        }

        function obterHistoricoGestaoDemonstracao(filtros = {}) {
            const agora = Date.now();
            const base = [
                {
                    timestamp: new Date(agora - 45 * 60000).toISOString(),
                    usuario: 'gestor@exemplo.com',
                    entidade: 'ilha',
                    operacao: 'update',
                    detalhes: 'Renomeou ilha Azul para ilha Central',
                    acao: 'Atualização de cadastro',
                    campos: [
                        { campo: 'nome', antes: 'Ilha Azul', depois: 'Ilha Central' }
                    ]
                },
                {
                    timestamp: new Date(agora - 2 * 3600000).toISOString(),
                    usuario: 'operador@exemplo.com',
                    entidade: 'sala',
                    operacao: 'create',
                    detalhes: 'Adicionou sala 405 sem ilha',
                    acao: 'Nova sala cadastrada',
                    campos: [
                        { campo: 'numero', antes: '', depois: '405' },
                        { campo: 'ilha', antes: '', depois: '' }
                    ]
                },
                {
                    timestamp: new Date(agora - 3 * 3600000).toISOString(),
                    usuario: 'auditoria@exemplo.com',
                    entidade: 'categoria',
                    operacao: 'delete',
                    detalhes: 'Removeu categoria Temporária',
                    acao: 'Limpeza de cadastro',
                    campos: [
                        { campo: 'nome', antes: 'Temporária', depois: '' }
                    ]
                }
            ];

            const chaveBusca = normalizarChaveCadastroLocal(filtros.busca || '');
            const entidadeFiltro = normalizarChaveCadastroLocal(filtros.entidade || '');
            const acaoFiltro = normalizarChaveCadastroLocal(filtros.acao || '');
            const usuarioFiltro = normalizarChaveCadastroLocal(filtros.usuario || '');
            const inicio = filtros.inicio ? new Date(`${filtros.inicio}T00:00:00`) : null;
            const fim = filtros.fim ? new Date(`${filtros.fim}T23:59:59`) : null;

            return base.filter(item => {
                const dataRegistro = item.timestamp ? new Date(item.timestamp) : null;
                if (inicio && dataRegistro && dataRegistro < inicio) return false;
                if (fim && dataRegistro && dataRegistro > fim) return false;
                if (entidadeFiltro && normalizarChaveCadastroLocal(item.entidade) !== entidadeFiltro) return false;
                if (acaoFiltro && normalizarChaveCadastroLocal(item.operacao) !== acaoFiltro) return false;
                if (usuarioFiltro && normalizarChaveCadastroLocal(item.usuario) !== usuarioFiltro) return false;
                if (chaveBusca) {
                    const alvo = [item.usuario, item.entidade, item.operacao, item.detalhes]
                        .filter(Boolean)
                        .map(valor => normalizarChaveCadastroLocal(valor))
                        .join(' ');
                    if (!alvo.includes(chaveBusca)) return false;
                }
                return true;
            });
        }

        function inicializarLogsGestao() {
            const container = document.getElementById('logs-section');
            if (!container) {
                return;
            }

            const logsState = stores.logs;
            if (!logsState.eventosConfigurados) {
                configurarEventosLogs();
                logsState.eventosConfigurados = true;
            }

            sincronizarUIFiltrosLogs();
            renderLogsSection();

            if (!logsState.carregado && !logsState.carregando) {
                carregarLogsDaPlanilha();
            }
        }

        function configurarEventosLogs() {
            const logsState = stores.logs;

            document.querySelectorAll('.logs-quick-filter').forEach(button => {
                button.addEventListener('click', () => {
                    const filtro = button.dataset.logsFilter || 'todos';
                    logsState.filtroRapido = filtro;
                    renderLogsSection();
                });
            });

            const buscaInput = document.getElementById('logs-busca');
            if (buscaInput) {
                buscaInput.addEventListener('input', () => {
                    logsState.filtros.busca = buscaInput.value.trim();
                    renderLogsSection();
                });
            }

            const usuarioInput = document.getElementById('logs-usuario');
            if (usuarioInput) {
                usuarioInput.addEventListener('input', () => {
                    logsState.filtros.usuario = usuarioInput.value.trim();
                    renderLogsSection();
                });
            }

            const dataInicioInput = document.getElementById('logs-data-inicio');
            if (dataInicioInput) {
                dataInicioInput.addEventListener('change', () => {
                    logsState.filtros.dataInicio = dataInicioInput.value || '';
                    renderLogsSection();
                });
            }

            const dataFimInput = document.getElementById('logs-data-fim');
            if (dataFimInput) {
                dataFimInput.addEventListener('change', () => {
                    logsState.filtros.dataFim = dataFimInput.value || '';
                    renderLogsSection();
                });
            }

            const aplicarValoresSelect = (id, chave) => {
                const select = document.getElementById(id);
                if (!select) return;
                select.addEventListener('change', () => {
                    logsState.filtros[chave] = Array.from(select.selectedOptions).map(option => option.value);
                    renderLogsSection();
                });
            };

            aplicarValoresSelect('logs-acao', 'acao');
            aplicarValoresSelect('logs-status', 'status');
            aplicarValoresSelect('logs-origem', 'origem');

            const apenasAlertas = document.getElementById('logs-apenas-alertas');
            if (apenasAlertas) {
                apenasAlertas.addEventListener('change', () => {
                    logsState.filtros.apenasAlertas = !!apenasAlertas.checked;
                    renderLogsSection();
                });
            }

            const salvarFiltroBtn = document.getElementById('logs-salvar-filtro');
            if (salvarFiltroBtn) {
                salvarFiltroBtn.addEventListener('click', salvarFiltroLogs);
            }

            const limparFiltrosBtn = document.getElementById('logs-limpar-filtros');
            if (limparFiltrosBtn) {
                limparFiltrosBtn.addEventListener('click', () => {
                    limparFiltrosLogs();
                });
            }

            const marcarRevisadoBtn = document.getElementById('logs-marcar-revisado');
            if (marcarRevisadoBtn) {
                marcarRevisadoBtn.addEventListener('click', marcarLogComoRevisado);
            }

            const fecharDetalheBtn = document.getElementById('logs-detail-close');
            if (fecharDetalheBtn) {
                fecharDetalheBtn.addEventListener('click', () => {
                    stores.logs.selecionadoId = null;
                    renderLogsSection();
                });
            }

            const exportarBtn = document.getElementById('logs-exportar');
            if (exportarBtn) {
                exportarBtn.addEventListener('click', () => {
                    const filtrados = filtrarRegistrosLogs();
                    exportarLogsParaCsv(filtrados);
                });
            }

            const exportarIndividualBtn = document.getElementById('logs-exportar-individual');
            if (exportarIndividualBtn) {
                exportarIndividualBtn.addEventListener('click', () => {
                    const selecionado = obterLogSelecionado();
                    exportarLogIndividual(selecionado);
                });
            }

            const gerenciarAlertasBtn = document.getElementById('logs-gerenciar-alertas');
            if (gerenciarAlertasBtn) {
                gerenciarAlertasBtn.addEventListener('click', () => {
                    mostrarLogsFeedback('Em breve: gerenciamento avançado de regras de alerta.');
                });
            }
        }

        function renderLogsSection() {
            const container = document.getElementById('logs-section');
            if (!container) {
                return;
            }

            const logsState = stores.logs;
            const registrosFiltrados = filtrarRegistrosLogs();

            atualizarVisaoGeralLogs(registrosFiltrados);
            atualizarTabelaLogs(registrosFiltrados);
            atualizarDetalheLog();
            atualizarAlertasLogs();
            atualizarFiltrosSalvosUI();

            document.querySelectorAll('.logs-quick-filter').forEach(button => {
                const filtro = button.dataset.logsFilter || 'todos';
                button.classList.toggle('active', filtro === logsState.filtroRapido);
            });

            const sincronizacaoEl = document.getElementById('logs-ultima-sincronizacao');
            if (sincronizacaoEl) {
                const ultima = logsState.ultimaSincronizacao ? formatarDataHoraLog(logsState.ultimaSincronizacao) : '—';
                sincronizacaoEl.innerHTML = `<i class="fas fa-clock" aria-hidden="true"></i><span>Sincronização: ${ultima}</span>`;
            }

            aplicarRestricoesLogs();
        }

        function filtrarRegistrosLogs() {
            const logsState = stores.logs;
            const filtros = logsState.filtros || {};
            let registros = Array.isArray(logsState.registros) ? [...logsState.registros] : [];
            const normalizar = texto => (typeof normalizarTexto === 'function' ? normalizarTexto(texto) : String(texto || '').toLowerCase());

            switch (logsState.filtroRapido) {
                case 'ultimas24h': {
                    const limite = Date.now() - (24 * 60 * 60 * 1000);
                    registros = registros.filter(log => new Date(log.timestamp).getTime() >= limite);
                    break;
                }
                case 'falhas':
                    registros = registros.filter(log => log.resultado === 'erro' || log.alerta);
                    break;
                case 'administradores':
                    registros = registros.filter(log => normalizar(log.perfil).includes('admin'));
                    break;
                case 'alertas':
                    registros = registros.filter(log => log.alerta);
                    break;
                default:
                    break;
            }

            if (filtros.busca) {
                const busca = normalizar(filtros.busca);
                registros = registros.filter(log => {
                    return [log.usuario, log.acao, log.detalhes, log.observacoes, log.matricula]
                        .some(campo => normalizar(campo).includes(busca));
                });
            }

            if (filtros.usuario) {
                const termo = normalizar(filtros.usuario);
                registros = registros.filter(log => normalizar(`${log.usuario} ${log.matricula}`).includes(termo));
            }

            if (filtros.dataInicio) {
                const inicio = new Date(`${filtros.dataInicio}T00:00:00`);
                registros = registros.filter(log => new Date(log.timestamp) >= inicio);
            }

            if (filtros.dataFim) {
                const fim = new Date(`${filtros.dataFim}T23:59:59`);
                registros = registros.filter(log => new Date(log.timestamp) <= fim);
            }

            if (Array.isArray(filtros.acao) && filtros.acao.length) {
                registros = registros.filter(log => filtros.acao.includes(log.tipoAcao));
            }

            if (Array.isArray(filtros.status) && filtros.status.length) {
                registros = registros.filter(log => filtros.status.includes(log.resultado));
            }

            if (Array.isArray(filtros.origem) && filtros.origem.length) {
                registros = registros.filter(log => filtros.origem.includes(log.origem));
            }

            if (filtros.apenasAlertas) {
                registros = registros.filter(log => log.alerta);
            }

            registros.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            return registros;
        }

        function atualizarVisaoGeralLogs(registrosFiltrados) {
            const logsState = stores.logs;
            const registrosTotais = Array.isArray(logsState.registros) ? logsState.registros : [];
            const total = registrosTotais.length;
            const alertas = registrosTotais.filter(log => log.alerta).length;
            const pendentes = registrosTotais.filter(log => !log.revisado).length;
            const ultimoCritico = registrosTotais
                .filter(log => log.resultado === 'erro' || log.alerta)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

            const definirTexto = (id, texto) => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.textContent = texto;
                }
            };

            definirTexto('logs-total-eventos', total.toLocaleString('pt-BR'));
            definirTexto('logs-total-alertas', alertas.toLocaleString('pt-BR'));
            definirTexto('logs-pendentes-revisao', pendentes.toLocaleString('pt-BR'));
            definirTexto('logs-ultimo-critico', ultimoCritico ? formatarDataHoraLog(ultimoCritico.timestamp) : '—');

            if (!registrosFiltrados.length) {
                mostrarLogsFeedback('Nenhum registro encontrado para os filtros atuais.');
            } else {
                mostrarLogsFeedback('');
            }
        }

        function atualizarTabelaLogs(registros) {
            const tbody = document.getElementById('logs-table-body');
            if (!tbody) {
                return;
            }

            if (!registros.length) {
                tbody.innerHTML = `
                    <tr class="logs-table-empty">
                        <td colspan="6">
                            <i class="fas fa-clipboard"></i>
                            <p>Nenhum registro encontrado para os filtros atuais.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const fragment = document.createDocumentFragment();
            const selecionadoId = stores.logs.selecionadoId;

            registros.forEach(log => {
                const linha = document.createElement('tr');
                linha.dataset.logId = log.id;
                if (log.alerta) {
                    linha.classList.add('is-alert');
                }
                if (log.resultado === 'erro') {
                    linha.classList.add('is-error');
                }
                if (log.id === selecionadoId) {
                    linha.classList.add('is-active');
                }

                const criarCelula = valor => {
                    const td = document.createElement('td');
                    td.innerHTML = valor;
                    return td;
                };

                linha.appendChild(criarCelula(formatarDataHoraLog(log.timestamp)));
                linha.appendChild(criarCelula(`<strong>${log.usuario}</strong><br><span class="logs-usuario-meta">${log.perfil}</span>`));
                linha.appendChild(criarCelula(log.acao));

                const statusHtml = `<span class="logs-status" data-status="${log.resultado}">${formatarTituloLog(log.resultado)}</span>`;
                linha.appendChild(criarCelula(statusHtml));

                linha.appendChild(criarCelula(formatarTituloLog(log.origem)));

                const detalhesTexto = log.detalhes && log.detalhes.length > 90
                    ? `${log.detalhes.slice(0, 90)}…`
                    : (log.detalhes || '—');
                linha.appendChild(criarCelula(detalhesTexto));

                linha.addEventListener('click', () => {
                    selecionarLogGestao(log.id);
                });

                fragment.appendChild(linha);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function selecionarLogGestao(logId) {
            stores.logs.selecionadoId = logId;
            atualizarDetalheLog();
            const registros = filtrarRegistrosLogs();
            atualizarTabelaLogs(registros);
            aplicarRestricoesLogs();
        }

        function obterLogSelecionado() {
            const logsState = stores.logs;
            if (!logsState.selecionadoId) {
                return null;
            }
            return logsState.registros.find(log => log.id === logsState.selecionadoId) || null;
        }

        function atualizarDetalheLog() {
            const detalhe = document.getElementById('logs-detail-content');
            const placeholder = document.getElementById('logs-detail-placeholder');
            const selecionado = obterLogSelecionado();
            const marcarRevisadoBtn = document.getElementById('logs-marcar-revisado');
            const exportarIndividualBtn = document.getElementById('logs-exportar-individual');

            if (!detalhe || !placeholder) {
                return;
            }

            if (!selecionado) {
                detalhe.classList.remove('is-visible');
                placeholder.style.display = 'block';
                if (marcarRevisadoBtn) marcarRevisadoBtn.disabled = true;
                if (exportarIndividualBtn) exportarIndividualBtn.disabled = true;
                return;
            }

            placeholder.style.display = 'none';
            detalhe.classList.add('is-visible');

            const definir = (id, texto) => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.textContent = texto;
                }
            };

            definir('logs-detalhe-data', formatarDataHoraLog(selecionado.timestamp));
            definir('logs-detalhe-usuario', `${selecionado.usuario} (${selecionado.matricula || '—'})`);
            definir('logs-detalhe-perfil', selecionado.perfil || '—');
            definir('logs-detalhe-acao', selecionado.acao || '—');
            definir('logs-detalhe-resultado', formatarTituloLog(selecionado.resultado));
            definir('logs-detalhe-origem', formatarTituloLog(selecionado.origem));
            definir('logs-detalhe-ip', selecionado.ip || '—');

            let revisaoTexto = 'Pendente de revisão';
            if (selecionado.revisado) {
                const quando = selecionado.revisadoEm ? formatarDataHoraLog(selecionado.revisadoEm) : '—';
                revisaoTexto = `Revisado por ${selecionado.revisadoPor || 'Equipe gestora'} em ${quando}`;
            }
            definir('logs-detalhe-revisao', revisaoTexto);

            definir('logs-detalhe-observacoes', selecionado.observacoes || '—');

            const payloadElement = document.getElementById('logs-detalhe-payload');
            if (payloadElement) {
                const payload = selecionado.payload ? JSON.stringify(selecionado.payload, null, 2) : '—';
                payloadElement.textContent = payload;
            }

            if (marcarRevisadoBtn) {
                marcarRevisadoBtn.disabled = !!selecionado.revisado;
            }
            if (exportarIndividualBtn) {
                exportarIndividualBtn.disabled = false;
            }
        }

        function atualizarAlertasLogs() {
            const lista = document.getElementById('logs-alertas-list');
            if (!lista) {
                return;
            }

            const alertas = Array.isArray(stores.logs.alertasConfigurados) ? stores.logs.alertasConfigurados : [];
            if (!alertas.length) {
                lista.innerHTML = '<li class="logs-alerts-empty">Nenhuma regra configurada até o momento.</li>';
                return;
            }

            const fragment = document.createDocumentFragment();
            alertas.forEach(alerta => {
                const item = document.createElement('li');
                item.className = 'logs-alert-item';

                const titulo = document.createElement('strong');
                titulo.innerHTML = `<i class="fas fa-bolt"></i> ${alerta.titulo}`;

                const descricao = document.createElement('span');
                descricao.textContent = alerta.descricao;

                item.appendChild(titulo);
                item.appendChild(descricao);

                if (alerta.ultimaVerificacao) {
                    const ultima = document.createElement('span');
                    ultima.innerHTML = `<i class="fas fa-clock"></i> Última verificação: ${formatarDataHoraLog(alerta.ultimaVerificacao)}`;
                    item.appendChild(ultima);
                }

                fragment.appendChild(item);
            });

            lista.innerHTML = '';
            lista.appendChild(fragment);
        }

        function atualizarFiltrosSalvosUI() {
            const container = document.getElementById('logs-filtros-salvos');
            if (!container) {
                return;
            }

            const filtrosSalvos = Array.isArray(stores.logs.filtrosSalvos) ? stores.logs.filtrosSalvos : [];
            if (!filtrosSalvos.length) {
                container.innerHTML = '<span class="logs-alerts-empty">Nenhum filtro salvo até o momento.</span>';
                return;
            }

            const fragment = document.createDocumentFragment();
            filtrosSalvos.forEach((item, indice) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'logs-saved-chip';

                const aplicarBtn = document.createElement('button');
                aplicarBtn.type = 'button';
                aplicarBtn.innerHTML = `<i class="fas fa-filter"></i> ${item.nome}`;
                aplicarBtn.addEventListener('click', () => {
                    aplicarFiltroSalvo(indice);
                });

                const removerBtn = document.createElement('button');
                removerBtn.type = 'button';
                removerBtn.setAttribute('aria-label', `Remover filtro ${item.nome}`);
                removerBtn.innerHTML = '<i class="fas fa-times"></i>';
                removerBtn.addEventListener('click', event => {
                    event.stopPropagation();
                    removerFiltroSalvoLogs(indice);
                });

                wrapper.appendChild(aplicarBtn);
                wrapper.appendChild(removerBtn);
                fragment.appendChild(wrapper);
            });

            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function salvarFiltroLogs() {
            const nomeInput = document.getElementById('logs-nome-filtro');
            if (!nomeInput) {
                return;
            }

            const nome = nomeInput.value.trim();
            if (!nome) {
                mostrarLogsFeedback('Informe um nome para salvar o filtro.');
                nomeInput.focus();
                return;
            }

            const filtroAtual = {
                nome,
                filtros: JSON.parse(JSON.stringify(stores.logs.filtros)),
                filtroRapido: stores.logs.filtroRapido
            };

            stores.logs.filtrosSalvos.push(filtroAtual);
            nomeInput.value = '';
            mostrarLogsFeedback(`Filtro "${nome}" salvo com sucesso.`);
            atualizarFiltrosSalvosUI();
        }

        function aplicarFiltroSalvo(indice) {
            const salvo = stores.logs.filtrosSalvos[indice];
            if (!salvo) {
                return;
            }

            stores.logs.filtros = JSON.parse(JSON.stringify(salvo.filtros));
            stores.logs.filtroRapido = salvo.filtroRapido || 'todos';
            sincronizarUIFiltrosLogs();
            renderLogsSection();
            mostrarLogsFeedback(`Filtro "${salvo.nome}" aplicado.`);
        }

        function removerFiltroSalvoLogs(indice) {
            if (!Array.isArray(stores.logs.filtrosSalvos)) {
                return;
            }
            stores.logs.filtrosSalvos.splice(indice, 1);
            atualizarFiltrosSalvosUI();
            mostrarLogsFeedback('Filtro removido.');
        }

        function sincronizarUIFiltrosLogs() {
            const filtros = stores.logs.filtros || {};

            const dataInicioInput = document.getElementById('logs-data-inicio');
            if (dataInicioInput) {
                dataInicioInput.value = filtros.dataInicio || '';
            }

            const dataFimInput = document.getElementById('logs-data-fim');
            if (dataFimInput) {
                dataFimInput.value = filtros.dataFim || '';
            }

            const usuarioInput = document.getElementById('logs-usuario');
            if (usuarioInput) {
                usuarioInput.value = filtros.usuario || '';
            }

            const buscaInput = document.getElementById('logs-busca');
            if (buscaInput) {
                buscaInput.value = filtros.busca || '';
            }

            const marcarSelecionados = (id, valores) => {
                const select = document.getElementById(id);
                if (!select) return;
                Array.from(select.options).forEach(option => {
                    option.selected = Array.isArray(valores) && valores.includes(option.value);
                });
            };

            marcarSelecionados('logs-acao', filtros.acao);
            marcarSelecionados('logs-status', filtros.status);
            marcarSelecionados('logs-origem', filtros.origem);

            const apenasAlertas = document.getElementById('logs-apenas-alertas');
            if (apenasAlertas) {
                apenasAlertas.checked = !!filtros.apenasAlertas;
            }
        }

        function limparFiltrosLogs() {
            stores.logs.filtros = {
                busca: '',
                dataInicio: '',
                dataFim: '',
                usuario: '',
                acao: [],
                status: [],
                origem: [],
                apenasAlertas: false
            };
            stores.logs.filtroRapido = 'todos';
            stores.logs.selecionadoId = null;
            sincronizarUIFiltrosLogs();
            renderLogsSection();
        }

        function marcarLogComoRevisado() {
            const selecionado = obterLogSelecionado();
            if (!selecionado) {
                mostrarLogsFeedback('Selecione um log antes de marcar como revisado.');
                return;
            }

            if (selecionado.revisado) {
                mostrarLogsFeedback('Este registro já está revisado.');
                return;
            }

            const role = (estado.userRole || '').toLowerCase();
            const revisor = role ? `Perfil ${role}` : 'Equipe gestora';
            selecionado.revisado = true;
            selecionado.revisadoPor = revisor;
            selecionado.revisadoEm = new Date().toISOString();
            renderLogsSection();
            mostrarLogsFeedback('Registro marcado como revisado.');
        }

        function exportarLogsParaCsv(registros) {
            if (!Array.isArray(registros) || !registros.length) {
                mostrarLogsFeedback('Nenhum registro disponível para exportação.');
                return;
            }

            const cabecalho = ['ID', 'Data/Hora', 'Usuário', 'Perfil', 'Matrícula', 'Ação', 'Resultado', 'Origem', 'Detalhes', 'Observações', 'Alerta', 'Revisado', 'Revisado por', 'Revisado em'];
            const linhas = registros.map(log => {
                const campos = [
                    log.id,
                    formatarDataHoraLog(log.timestamp),
                    log.usuario,
                    log.perfil,
                    log.matricula,
                    log.acao,
                    formatarTituloLog(log.resultado),
                    formatarTituloLog(log.origem),
                    log.detalhes,
                    log.observacoes,
                    log.alerta ? 'Sim' : 'Não',
                    log.revisado ? 'Sim' : 'Não',
                    log.revisadoPor,
                    log.revisadoEm ? formatarDataHoraLog(log.revisadoEm) : ''
                ];

                return campos.map(valor => {
                    const texto = String(valor ?? '').replace(/"/g, '""');
                    return `"${texto}"`;
                }).join(',');
            });

            const conteudo = [cabecalho.join(','), ...linhas].join('\n');
            const blob = new Blob([conteudo], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `logs-auditoria-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarLogsFeedback(`Exportação concluída (${registros.length} registros).`);
        }

        function exportarLogIndividual(log) {
            if (!log) {
                mostrarLogsFeedback('Selecione um registro antes de exportar o payload.');
                return;
            }

            const blob = new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${log.id}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarLogsFeedback('Payload exportado em JSON.');
        }

        function mostrarLogsFeedback(mensagem) {
            const feedback = document.getElementById('logs-feedback');
            if (!feedback) {
                return;
            }
            feedback.textContent = mensagem || '';
        }

        function formatarDataHoraLog(valor) {
            if (!valor) {
                return '—';
            }
            const data = new Date(valor);
            if (Number.isNaN(data.getTime())) {
                return valor;
            }
            return data.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        }

        function formatarTituloLog(texto) {
            if (!texto) {
                return '—';
            }
            const str = String(texto);
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function aplicarRestricoesLogs() {
            const container = document.getElementById('logs-section');
            if (!container) {
                return;
            }

            const role = (estado.userRole || '').toLowerCase();
            const permitido = role === 'admin' || role === 'gestor';
            const controles = container.querySelectorAll('[data-logs-control]');
            controles.forEach(controle => {
                if (permitido) {
                    controle.removeAttribute('disabled');
                } else {
                    controle.setAttribute('disabled', 'true');
                }
            });

            const aviso = document.getElementById('logs-access-warning');
            if (aviso) {
                aviso.style.display = permitido ? 'none' : 'flex';
            }
        }

        async function carregarDashboard() {
            const periodoSelect = document.getElementById('dashboard-periodo');
            const periodo = periodoSelect ? periodoSelect.value : 'dia';
            const limparLista = lista => (lista || []).map(item => String(item || '').trim()).filter(Boolean);
            const obterListaDashboard = id => limparLista(obterValoresMultiplo(id));
            const filtrosDashboard = {
                turnos: obterListaDashboard('dashboard-filtro-turno'),
                status: obterListaDashboard('dashboard-filtro-status'),
                ilhas: obterListaDashboard('dashboard-filtro-ilha'),
                salas: obterListaDashboard('dashboard-filtro-sala'),
                especialidades: obterListaDashboard('dashboard-filtro-especialidade'),
                categorias: obterListaDashboard('dashboard-filtro-categoria'),
                profissionais: obterListaDashboard('dashboard-filtro-profissional'),
                diasEspecificos: [],
                intervaloDias: null,
                meses: [],
                semanas: [],
                anos: []
            };

            const mesesSelecionados = limparLista(obterValoresMultiplo('dashboard-periodo-meses'));
            const mesesSemanasSelecionados = limparLista(obterValoresMultiplo('dashboard-periodo-semana-meses'));
            const semanasSelecionadas = limparLista(obterValoresMultiplo('dashboard-periodo-semanas'));
            const anosSelecionados = limparLista(obterValoresMultiplo('dashboard-periodo-anos'));

            estado.dashboardMesesSelecionados = mesesSelecionados;
            estado.dashboardSemanaMesesSelecionados = mesesSemanasSelecionados;
            estado.dashboardSemanasSelecionadas = semanasSelecionadas;
            estado.dashboardAnosSelecionados = anosSelecionados;

            if (periodo === 'dia') {
                const modoSelecionado = document.querySelector('input[name="dashboard-dia-modo"]:checked');
                if (modoSelecionado && modoSelecionado.value === 'intervalo') {
                    const intervaloAtual = estado.dashboardIntervaloDias || {};
                    const inicio = intervaloAtual.inicio || '';
                    const fim = intervaloAtual.fim || '';
                    if (!inicio || !fim) {
                        alert('Selecione a data inicial e final para gerar o dashboard.');
                        return;
                    }
                    if (inicio > fim) {
                        alert('A data inicial não pode ser maior que a data final.');
                        return;
                    }
                    filtrosDashboard.intervaloDias = { inicio, fim };
                } else {
                    const dataAtualIso = estado.dataAtual instanceof Date
                        ? estado.dataAtual.toISOString().split('T')[0]
                        : new Date().toISOString().split('T')[0];
                    filtrosDashboard.diasEspecificos = [dataAtualIso];
                }
            } else if (periodo === 'mes') {
                if (!mesesSelecionados.length) {
                    alert('Selecione ao menos um mês para visualizar os indicadores.');
                    return;
                }
                filtrosDashboard.meses = [...mesesSelecionados];
            } else if (periodo === 'semana') {
                if (!mesesSemanasSelecionados.length) {
                    alert('Selecione ao menos um mês para combinar com as semanas escolhidas.');
                    return;
                }
                if (!semanasSelecionadas.length) {
                    alert('Selecione ao menos uma semana do mês para visualizar os indicadores.');
                    return;
                }
                filtrosDashboard.meses = [...mesesSemanasSelecionados];
                filtrosDashboard.semanas = [...semanasSelecionadas];
            } else if (periodo === 'ano') {
                if (!anosSelecionados.length) {
                    alert('Selecione ao menos um ano para visualizar os indicadores.');
                    return;
                }
                filtrosDashboard.anos = [...anosSelecionados];
            }

            estado.filtrosDashboard = { ...filtrosDashboard };

            const comparativoPayload = obterDashboardComparativoPayload(filtrosDashboard);

            try {
                const principal = await executarServidor('getDadosAgregados', periodo, JSON.stringify(filtrosDashboard));
                let dadosComparativos = null;
                let infoComparativo = null;

                if (comparativoPayload) {
                    try {
                        const retornoComparativo = await executarServidor(
                            'getDadosAgregados',
                            comparativoPayload.periodo,
                            JSON.stringify(comparativoPayload.filtros)
                        );
                        if (retornoComparativo && !retornoComparativo.error) {
                            dadosComparativos = retornoComparativo;
                            infoComparativo = { descricao: comparativoPayload.descricao };
                        } else {
                            console.warn('Comparativo do dashboard retornou vazio ou com erro.');
                        }
                    } catch (erroComparativo) {
                        console.error('Erro ao carregar comparação do dashboard:', erroComparativo);
                    }
                } else if (!estado.dashboardComparacaoAtiva) {
                    estado.dashboardComparativoDados = null;
                    estado.dashboardComparativoInfo = null;
                }

                renderCharts(principal, dadosComparativos, infoComparativo);
            } catch (erro) {
                console.error('Erro no dashboard:', erro);
            }
        }

        function renderCharts(dados, dadosComparativos, infoComparativo) {
            if (!dados || dados.error) {
                console.error('Erro ao carregar dados do dashboard:', dados && dados.error ? dados.error : 'Dados indisponíveis');
            }

            const informacoes = dados && !dados.error ? dados : {
                resumo: {},
                ocupacaoTurno: {},
                ocupacaoIlha: {},
                evolucao: {},
                especialidades: {},
                ocupacaoGeral: {},
                statusDistribuicao: {}
            };

            estado.dashboardDados = informacoes;
            estado.dashboardResumoAtual = informacoes.resumo || null;

            const comparativoValido = dadosComparativos && !dadosComparativos.error;
            if (comparativoValido) {
                estado.dashboardComparativoDados = dadosComparativos;
                const descricaoComparativo = (infoComparativo && infoComparativo.descricao)
                    || (estado.dashboardComparativoConfig && estado.dashboardComparativoConfig.descricao)
                    || (dadosComparativos.resumo && dadosComparativos.resumo.periodoTexto)
                    || '';
                estado.dashboardComparativoInfo = { descricao: descricaoComparativo };
            } else if (!estado.dashboardComparacaoAtiva) {
                estado.dashboardComparativoDados = null;
                estado.dashboardComparativoInfo = null;
            }

            atualizarResumoIndicadores('dashboard-resumo', informacoes.resumo);
            atualizarDashboardComparativoResumo(informacoes.resumo, comparativoValido ? dadosComparativos.resumo : null);

            const ocupacaoTurno = informacoes.ocupacaoTurno || {};
            const ocupacaoIlha = informacoes.ocupacaoIlha || {};
            const evolucao = informacoes.evolucao || {};
            const especialidades = informacoes.especialidades || {};
            const ocupacaoGeral = informacoes.ocupacaoGeral || {};
            const statusDistribuicao = prepararStatusDistribuicao(informacoes.statusDistribuicao, ocupacaoGeral);

            registrarPluginPercentual();

            const styles = getComputedStyle(document.body);
            const isLightTheme = document.body.classList.contains('light-theme');
            const legendColor = (styles.getPropertyValue('--text-secondary') || '').trim()
                || (isLightTheme ? '#1e293b' : '#dbe8ff');
            const gridBase = (styles.getPropertyValue('--border-soft') || '').trim();
            const gridColor = gridBase || (isLightTheme ? 'rgba(148, 163, 184, 0.35)' : 'rgba(255, 255, 255, 0.1)');
            const tooltipConfig = {
                enabled: true,
                backgroundColor: isLightTheme ? 'rgba(248, 250, 252, 0.95)' : 'rgba(13, 23, 46, 0.92)',
                titleColor: isLightTheme ? '#0f172a' : '#f8fafc',
                bodyColor: isLightTheme ? '#0f172a' : '#f8fafc',
                borderColor: gridColor,
                borderWidth: 1
            };

            ['turno', 'ilha', 'evolucao', 'especialidade', 'heatmap', 'aproveitamento'].forEach(id => {
                const canvas = document.getElementById(`chart-${id}`);
                if (canvas && canvas.chart) canvas.chart.destroy();
            });

            const ctxTurno = document.getElementById('chart-turno').getContext('2d');
            const turnosOrdem = ['manha', 'tarde', 'noite'];
            const turnosRotulos = ['Manhã', 'Tarde', 'Noite'];
            const dadosTurno = turnosOrdem.map(key => Number(ocupacaoTurno[key] || 0));
            const totalTurno = dadosTurno.reduce((soma, valor) => soma + (Number(valor) || 0), 0);
            const tooltipTurno = {
                ...tooltipConfig,
                callbacks: {
                    label(context) {
                        const bruto = Number(context.raw) || 0;
                        const percentual = totalTurno ? (bruto / totalTurno) * 100 : 0;
                        return `${context.label}: ${bruto.toLocaleString('pt-BR')} (${formatarPercentual(percentual, 1)})`;
                    }
                }
            };
            document.getElementById('chart-turno').chart = new Chart(ctxTurno, {
                type: 'doughnut',
                data: {
                    labels: turnosRotulos,
                    datasets: [{
                        data: dadosTurno,
                        backgroundColor: ['#1e88e5', '#29a4d6', '#2ba58f'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: legendColor, usePointStyle: true } },
                        tooltip: tooltipTurno,
                        percentagePlugin: {
                            enabled: true,
                            color: legendColor,
                            fontSize: 12,
                            fontWeight: '600',
                            decimals: 1,
                            minPercentage: 5
                        }
                    }
                }
            });

            const ctxIlha = document.getElementById('chart-ilha').getContext('2d');
            const entradasIlhas = Object.entries(ocupacaoIlha).sort((a, b) => {
                const numA = parseFloat(a[0]);
                const numB = parseFloat(b[0]);
                if (Number.isFinite(numA) && Number.isFinite(numB)) {
                    return numA - numB;
                }
                return a[0].localeCompare(b[0], 'pt-BR', { numeric: true, sensitivity: 'base' });
            });
            const labelsIlhas = entradasIlhas.length
                ? entradasIlhas.map(([ilha]) => ilha ? `Ilha ${ilha}` : 'Sem ilha')
                : ['Sem dados'];
            const dadosIlhas = entradasIlhas.length
                ? entradasIlhas.map(([, valor]) => Number(valor) || 0)
                : [0];
            const totalIlhas = dadosIlhas.reduce((soma, valor) => soma + (Number(valor) || 0), 0);
            const tooltipIlha = {
                ...tooltipConfig,
                callbacks: {
                    label(context) {
                        const bruto = Number(context.raw) || 0;
                        const percentual = totalIlhas ? (bruto / totalIlhas) * 100 : 0;
                        return `${context.label}: ${bruto.toLocaleString('pt-BR')} (${formatarPercentual(percentual, 1)})`;
                    }
                }
            };
            document.getElementById('chart-ilha').chart = new Chart(ctxIlha, {
                type: 'bar',
                data: {
                    labels: labelsIlhas,
                    datasets: [{
                        label: 'Ocupação por Ilha',
                        data: dadosIlhas,
                        backgroundColor: '#1e88e5',
                        borderRadius: 6,
                        maxBarThickness: 36
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: tooltipIlha,
                        percentagePlugin: {
                            enabled: true,
                            color: legendColor,
                            fontSize: 11,
                            fontWeight: '600',
                            decimals: 1,
                            minPercentage: 4,
                            offsetY: 14
                        }
                    },
                    scales: {
                        x: { ticks: { color: legendColor }, grid: { color: gridColor } },
                        y: { beginAtZero: true, ticks: { color: legendColor }, grid: { color: gridColor } }
                    }
                }
            });

            const ctxEvolucao = document.getElementById('chart-evolucao').getContext('2d');
            const evolucaoOrdenada = Object.entries(evolucao).sort((a, b) => new Date(a[0]) - new Date(b[0]));
            const labelsEvolucao = evolucaoOrdenada.length
                ? evolucaoOrdenada.map(([dia]) => formatarDataCurtaGrafico(dia))
                : ['Sem dados'];
            const hojeIso = new Date().toISOString().split('T')[0];
            const dadosHistoricos = [];
            const dadosPrevisao = [];
            const pontosRaio = [];
            const pontosCor = [];
            const pontosBorda = [];
            const pontosBordaLargura = [];
            let possuiHoje = false;
            let possuiFuturo = false;
            const corHistorico = '#55b1d6';
            const corPrevisao = '#f0b429';
            const corHoje = (styles.getPropertyValue('--warning') || '#f0b429').trim() || '#f0b429';

            evolucaoOrdenada.forEach(([dia, valor]) => {
                const numero = Number(valor) || 0;
                if (dia > hojeIso) {
                    possuiFuturo = true;
                    dadosHistoricos.push(null);
                    dadosPrevisao.push(numero);
                    pontosRaio.push(4);
                    pontosCor.push(corHistorico);
                    pontosBorda.push(corHistorico);
                    pontosBordaLargura.push(0);
                } else {
                    dadosHistoricos.push(numero);
                    dadosPrevisao.push(null);
                    if (dia === hojeIso) {
                        possuiHoje = true;
                        pontosRaio.push(6);
                        pontosCor.push(corHoje);
                        pontosBorda.push(corHoje);
                        pontosBordaLargura.push(2);
                    } else {
                        pontosRaio.push(4);
                        pontosCor.push(corHistorico);
                        pontosBorda.push(corHistorico);
                        pontosBordaLargura.push(0);
                    }
                }
            });

            const datasetsEvolucao = [{
                label: 'Evolução de ocupação',
                data: dadosHistoricos.length ? dadosHistoricos : [0],
                borderColor: corHistorico,
                backgroundColor: 'rgba(85, 177, 214, 0.15)',
                fill: true,
                tension: 0.35,
                pointRadius: dadosHistoricos.length ? pontosRaio : 4,
                pointBackgroundColor: dadosHistoricos.length ? pontosCor : corHistorico,
                pointBorderWidth: dadosHistoricos.length ? pontosBordaLargura : 0,
                pointBorderColor: dadosHistoricos.length ? pontosBorda : corHistorico
            }];

            if (possuiFuturo) {
                datasetsEvolucao.push({
                    label: 'Previsão',
                    data: dadosPrevisao,
                    borderColor: corPrevisao,
                    backgroundColor: 'rgba(249, 115, 22, 0.08)',
                    fill: false,
                    tension: 0.35,
                    borderDash: [6, 6],
                    pointRadius: 4,
                    pointBackgroundColor: corPrevisao,
                    pointBorderWidth: 0
                });
            }

            const tooltipEvolucao = {
                ...tooltipConfig,
                callbacks: {
                    label(context) {
                        const valor = Number(context.raw) || 0;
                        const base = `${context.dataset?.label ? context.dataset.label + ': ' : ''}${valor.toLocaleString('pt-BR')}`;
                        if (context.dataset?.label === 'Previsão') {
                            return `${base} (previsão)`;
                        }
                        const original = evolucaoOrdenada[context.dataIndex];
                        if (original && original[0] === hojeIso) {
                            return `${base} (dados parciais do dia atual)`;
                        }
                        return base;
                    }
                }
            };

            const gerarLegendasPadrao = Chart?.defaults?.plugins?.legend?.labels?.generateLabels;
            const onClickLegendaPadrao = Chart?.defaults?.plugins?.legend?.onClick;
            const exibirLegendaEvolucao = possuiFuturo || possuiHoje;

            document.getElementById('chart-evolucao').chart = new Chart(ctxEvolucao, {
                type: 'line',
                data: {
                    labels: labelsEvolucao,
                    datasets: datasetsEvolucao
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: exibirLegendaEvolucao,
                            labels: {
                                color: legendColor,
                                usePointStyle: true,
                                generateLabels(chart) {
                                    const labels = gerarLegendasPadrao ? gerarLegendasPadrao(chart) : [];
                                    if (possuiHoje) {
                                        labels.push({
                                            text: 'Hoje',
                                            fillStyle: corHoje,
                                            strokeStyle: corHoje,
                                            lineWidth: 0,
                                            hidden: false,
                                            datasetIndex: -1,
                                            pointStyle: 'circle'
                                        });
                                    }
                                    return labels;
                                }
                            },
                            onClick(event, legendItem, legend) {
                                if (legendItem && legendItem.text === 'Hoje') {
                                    return;
                                }
                                if (typeof onClickLegendaPadrao === 'function') {
                                    onClickLegendaPadrao.call(this, event, legendItem, legend);
                                }
                            }
                        },
                        tooltip: tooltipEvolucao,
                        percentagePlugin: { enabled: false }
                    },
                    scales: {
                        x: { ticks: { color: legendColor }, grid: { color: gridColor } },
                        y: { beginAtZero: true, ticks: { color: legendColor }, grid: { color: gridColor } }
                    }
                }
            });

            const notaEvolucao = document.getElementById('chart-evolucao-nota');
            if (notaEvolucao) {
                const mensagens = [];
                if (possuiHoje) {
                    mensagens.push('Hoje');
                } else if (possuiFuturo) {
                    mensagens.push('A linha tracejada representa projeções para datas futuras.');
                }
                if (mensagens.length) {
                    notaEvolucao.textContent = mensagens.join(' ');
                    notaEvolucao.classList.add('active');
                } else {
                    notaEvolucao.textContent = '';
                    notaEvolucao.classList.remove('active');
                }
            }

            const ctxEspecialidade = document.getElementById('chart-especialidade').getContext('2d');
            const entradasEspecialidades = Object.entries(especialidades).sort((a, b) => b[1] - a[1]);
            const labelsEspecialidades = entradasEspecialidades.length
                ? entradasEspecialidades.map(([nome]) => nome)
                : ['Sem dados'];
            const dadosEspecialidades = entradasEspecialidades.length
                ? entradasEspecialidades.map(([, valor]) => Number(valor) || 0)
                : [0];
            const totalEspecialidades = dadosEspecialidades.reduce((soma, valor) => soma + (Number(valor) || 0), 0);
            const tooltipEspecialidade = {
                ...tooltipConfig,
                callbacks: {
                    label(context) {
                        const bruto = Number(context.raw) || 0;
                        const percentual = totalEspecialidades ? (bruto / totalEspecialidades) * 100 : 0;
                        return `${context.label}: ${bruto.toLocaleString('pt-BR')} (${formatarPercentual(percentual, 1)})`;
                    }
                }
            };
            document.getElementById('chart-especialidade').chart = new Chart(ctxEspecialidade, {
                type: 'bar',
                data: {
                    labels: labelsEspecialidades,
                    datasets: [{
                        label: 'Agendamentos',
                        data: dadosEspecialidades,
                        backgroundColor: '#f0b429',
                        borderRadius: 6,
                        maxBarThickness: 32
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: tooltipEspecialidade,
                        percentagePlugin: {
                            enabled: false,
                            color: legendColor,
                            fontSize: 11,
                            fontWeight: '600',
                            decimals: 1,
                            minPercentage: 3,
                            offsetX: 20
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: legendColor }, grid: { color: gridColor } },
                        y: { ticks: { color: legendColor }, grid: { color: 'rgba(0,0,0,0)' } }
                    }
                }
            });

            const ctxHeatmap = document.getElementById('chart-heatmap').getContext('2d');
            const labelsGeral = ['Uso médio', 'Salas livres', 'Indisponíveis'];
            const dadosGeral = [
                Number(ocupacaoGeral.uso || 0),
                Number(ocupacaoGeral.livres || 0),
                Number(ocupacaoGeral.indisponiveis || 0)
            ];
            const totalGeral = dadosGeral.reduce((soma, valor) => soma + (Number(valor) || 0), 0);
            const tooltipGeral = {
                ...tooltipConfig,
                callbacks: {
                    label(context) {
                        const bruto = Number(context.raw) || 0;
                        const percentual = totalGeral ? (bruto / totalGeral) * 100 : 0;
                        return `${context.label}: ${bruto.toLocaleString('pt-BR')} (${formatarPercentual(percentual, 1)})`;
                    }
                }
            };
            document.getElementById('chart-heatmap').chart = new Chart(ctxHeatmap, {
                type: 'doughnut',
                data: {
                    labels: labelsGeral,
                    datasets: [{
                        data: dadosGeral,
                        backgroundColor: ['#1e88e5', '#29a4d6', '#2ba58f'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: legendColor, usePointStyle: true } },
                        tooltip: tooltipGeral,
                        percentagePlugin: {
                            enabled: true,
                            color: legendColor,
                            fontSize: 12,
                            fontWeight: '600',
                            decimals: 1,
                            minPercentage: 5
                        }
                    }
                }
            });

            const ctxAproveitamento = document.getElementById('chart-aproveitamento').getContext('2d');
            const entradasStatus = Object.entries(statusDistribuicao)
                .filter(([status]) => status !== 'manutencao')
                .sort((a, b) => b[1] - a[1]);
            const statusLabels = entradasStatus.length
                ? entradasStatus.map(([status]) => formatarStatusLabel(status))
                : ['Sem dados'];
            const statusValores = entradasStatus.length
                ? entradasStatus.map(([, valor]) => Number(valor) || 0)
                : [0];
            const statusCores = ['#1e88e5', '#29a4d6', '#2ba58f', '#e57373', '#9aa7b5', '#f2c14e'];
            const totalStatus = statusValores.reduce((soma, valor) => soma + (Number(valor) || 0), 0);
            const tooltipStatus = {
                ...tooltipConfig,
                callbacks: {
                    label(context) {
                        const bruto = Number(context.raw) || 0;
                        const percentual = totalStatus ? (bruto / totalStatus) * 100 : 0;
                        return `${context.label}: ${bruto.toLocaleString('pt-BR')} (${formatarPercentual(percentual, 1)})`;
                    }
                }
            };
            document.getElementById('chart-aproveitamento').chart = new Chart(ctxAproveitamento, {
                type: 'polarArea',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusValores,
                        backgroundColor: statusValores.map((_, index) => statusCores[index % statusCores.length])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: legendColor, usePointStyle: true } },
                        tooltip: tooltipStatus,
                        percentagePlugin: {
                            enabled: true,
                            color: legendColor,
                            fontSize: 12,
                            fontWeight: '600',
                            decimals: 1,
                            minPercentage: 5,
                            offsetY: 8
                        }
                    },
                    scales: {
                        r: {
                            grid: { color: gridColor },
                            angleLines: { color: gridColor },
                            ticks: { display: false }
                        }
                    }
                }
            });
        }

        function inicializarRelatorios() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('relatorio-data-inicio').value = hoje;
            document.getElementById('relatorio-data-fim').value = hoje;
            const opcoesAtualizadas = preencherRelatorioFiltros();
            preencherDashboardFiltros(opcoesAtualizadas);
            preencherSalaMesFiltros(opcoesAtualizadas);
            registrarEventosFiltrosEspecificos();

            const filtrosContainer = document.getElementById('relatorio-filtros');
            if (filtrosContainer && !filtrosContainer.dataset.listenersAttached) {
                filtrosContainer.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', () => {
                        const inicio = document.getElementById('relatorio-data-inicio').value;
                        const fim = document.getElementById('relatorio-data-fim').value;
                        if (inicio && fim) {
                            gerarRelatorio();
                        }
                    });
                });
                const buscaInput = document.getElementById('relatorio-filtro-busca');
                if (buscaInput) {
                    buscaInput.addEventListener('keydown', event => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            gerarRelatorio();
                        }
                    });
                }
                filtrosContainer.dataset.listenersAttached = 'true';
            }
        }

        function coletarConfiguracaoComparacaoRelatorio() {
            const tipoSelect = document.getElementById('relatorio-comparar-tipo');
            if (!tipoSelect) return null;
            const tipo = tipoSelect.value;
            if (!tipo) {
                alert('Selecione o tipo de período para comparar nos relatórios.');
                return null;
            }

            if (tipo === 'dia') {
                const dia = document.getElementById('relatorio-comparar-dia')?.value;
                if (!dia) {
                    alert('Informe o dia que deseja comparar.');
                    return null;
                }
                return { tipo: 'dia', dia, descricao: `Dia ${formatarDataCompleta(dia)}` };
            }

            if (tipo === 'intervalo') {
                const inicio = document.getElementById('relatorio-comparar-inicio')?.value;
                const fim = document.getElementById('relatorio-comparar-fim')?.value;
                if (!inicio || !fim) {
                    alert('Informe as duas datas do intervalo para comparação.');
                    return null;
                }
                if (inicio > fim) {
                    alert('No comparativo do relatório a data inicial não pode ser maior que a final.');
                    return null;
                }
                return {
                    tipo: 'intervalo',
                    inicio,
                    fim,
                    descricao: `De ${formatarDataCompleta(inicio)} até ${formatarDataCompleta(fim)}`
                };
            }

            if (tipo === 'mes') {
                const meses = obterValoresMultiplo('relatorio-comparar-meses');
                if (!meses.length) {
                    alert('Selecione ao menos um mês para comparar.');
                    return null;
                }
                const descricao = meses.map(formatarMesHumano).join(', ');
                return { tipo: 'mes', meses, descricao: `Meses: ${descricao}` };
            }

            if (tipo === 'ano') {
                const anos = obterValoresMultiplo('relatorio-comparar-anos');
                if (!anos.length) {
                    alert('Selecione ao menos um ano para comparar.');
                    return null;
                }
                return { tipo: 'ano', anos, descricao: `Ano(s): ${anos.join(', ')}` };
            }

            alert('Tipo de comparação do relatório não reconhecido.');
            return null;
        }

        function obterIntervaloComparativoRelatorio(config) {
            if (!config) return null;
            if (config.tipo === 'dia') {
                return { inicio: config.dia, fim: config.dia, descricao: config.descricao };
            }
            if (config.tipo === 'intervalo') {
                return { inicio: config.inicio, fim: config.fim, descricao: config.descricao };
            }
            if (config.tipo === 'mes') {
                const meses = Array.isArray(config.meses) ? [...config.meses].sort() : [];
                if (!meses.length) return null;
                const primeiro = meses[0];
                const ultimo = meses[meses.length - 1];
                const [anoInicio, mesInicio] = primeiro.split('-').map(Number);
                const [anoFim, mesFim] = ultimo.split('-').map(Number);
                if (!Number.isFinite(anoInicio) || !Number.isFinite(mesInicio) || !Number.isFinite(anoFim) || !Number.isFinite(mesFim)) {
                    return null;
                }
                const inicio = `${anoInicio}-${String(mesInicio).padStart(2, '0')}-01`;
                const ultimoDia = new Date(anoFim, mesFim, 0);
                const fim = `${ultimoDia.getFullYear()}-${String(ultimoDia.getMonth() + 1).padStart(2, '0')}-${String(ultimoDia.getDate()).padStart(2, '0')}`;
                return { inicio, fim, descricao: config.descricao };
            }
            if (config.tipo === 'ano') {
                const anos = Array.isArray(config.anos) ? config.anos.map(ano => parseInt(ano, 10)).filter(Number.isFinite).sort((a, b) => a - b) : [];
                if (!anos.length) return null;
                const inicio = `${anos[0]}-01-01`;
                const fim = `${anos[anos.length - 1]}-12-31`;
                return { inicio, fim, descricao: config.descricao };
            }
            return null;
        }

        function removerRelatorioComparacao({ recarregar = true } = {}) {
            estado.relatorioComparacaoAtiva = false;
            estado.relatorioComparativoConfig = null;
            estado.relatorioComparativoDados = null;
            estado.relatorioComparativoInfo = null;
            const banner = document.getElementById('relatorio-comparativo-resumo');
            if (banner) {
                banner.classList.remove('active');
            }
            if (recarregar) {
                gerarRelatorio();
            } else {
                atualizarRelatorioComparativoResumo(null, null);
            }
        }

        function inicializarRelatorioComparacaoUI() {
            const painel = document.getElementById('relatorio-comparar-panel');
            const tipoSelect = document.getElementById('relatorio-comparar-tipo');
            const botaoToggle = document.getElementById('btn-relatorio-comparar');
            const botaoAplicar = document.getElementById('relatorio-comparar-aplicar');
            const botaoLimpar = document.getElementById('relatorio-comparar-limpar');
            const botaoRemover = document.getElementById('relatorio-comparativo-remover');
            if (!painel || !tipoSelect || !botaoToggle) {
                return;
            }

            const atualizarCampos = () => atualizarCamposComparacaoPainel(painel, tipoSelect.value);

            botaoToggle.addEventListener('click', () => {
                painel.classList.toggle('active');
            });

            tipoSelect.addEventListener('change', atualizarCampos);
            atualizarCampos();

            if (botaoAplicar) {
                botaoAplicar.addEventListener('click', () => {
                    const config = coletarConfiguracaoComparacaoRelatorio();
                    if (!config) return;
                    estado.relatorioComparacaoAtiva = true;
                    estado.relatorioComparativoConfig = config;
                    estado.relatorioComparativoInfo = { descricao: config.descricao };
                    painel.classList.remove('active');
                    gerarRelatorio();
                });
            }

            const limparInterface = () => {
                tipoSelect.value = '';
                painel.querySelectorAll('input[type="date"]').forEach(input => { input.value = ''; });
                painel.querySelectorAll('select[multiple]').forEach(select => {
                    Array.from(select.options).forEach(option => { option.selected = false; });
                    atualizarReportMultiselect(select.id, Array.from(select.options).map(option => ({ value: option.value, label: option.textContent })));
                });
                atualizarCampos();
            };

            if (botaoLimpar) {
                botaoLimpar.addEventListener('click', () => {
                    limparInterface();
                    removerRelatorioComparacao({ recarregar: true });
                    painel.classList.remove('active');
                });
            }

            if (botaoRemover) {
                botaoRemover.addEventListener('click', () => {
                    limparInterface();
                    removerRelatorioComparacao({ recarregar: true });
                });
            }
        }

        function obterValoresMultiplo(id) {
            const select = document.getElementById(id);
            if (!select) return [];
            return Array.from(select.selectedOptions || []).map(opt => opt.value);
        }

        async function exportarDashboardPdf() {
            if (!estado.dashboardDados) {
                alert('Gere o dashboard antes de exportar o PDF.');
                return;
            }
            const periodoSelect = document.getElementById('dashboard-periodo');
            const periodo = periodoSelect ? periodoSelect.value : 'dia';
            const filtros = estado.filtrosDashboard || {};
            const payload = {
                periodo,
                filtros,
                descricaoPrincipal: (estado.dashboardResumoAtual && estado.dashboardResumoAtual.periodoTexto) || '',
                comparacaoAtiva: Boolean(estado.dashboardComparacaoAtiva && estado.dashboardComparativoConfig),
                comparativo: null
            };
            if (payload.comparacaoAtiva) {
                const comparativo = obterDashboardComparativoPayload(filtros);
                if (comparativo) {
                    payload.comparativo = comparativo;
                } else {
                    payload.comparacaoAtiva = false;
                }
            }
            try {
                const resultado = await executarServidor('gerarDashboardPdf', JSON.stringify(payload));
                baixarArquivoBase64(resultado);
            } catch (erro) {
                console.error('Erro ao exportar PDF do dashboard:', erro);
                alert('Não foi possível gerar o PDF do dashboard.');
            }
        }

        async function exportarRelatorioPdf() {
            const inicio = document.getElementById('relatorio-data-inicio').value;
            const fim = document.getElementById('relatorio-data-fim').value;
            if (!inicio || !fim) {
                alert('Defina o período do relatório antes de exportar o PDF.');
                return;
            }

            const limparLista = lista => lista.map(item => String(item || '').trim()).filter(Boolean);
            const filtros = {
                turnos: limparLista(obterValoresMultiplo('relatorio-filtro-turno')),
                status: limparLista(obterValoresMultiplo('relatorio-filtro-status')),
                ilhas: limparLista(obterValoresMultiplo('relatorio-filtro-ilha')),
                salas: limparLista(obterValoresMultiplo('relatorio-filtro-sala')),
                especialidades: limparLista(obterValoresMultiplo('relatorio-filtro-especialidade')),
                categorias: limparLista(obterValoresMultiplo('relatorio-filtro-categoria')),
                profissionais: limparLista(obterValoresMultiplo('relatorio-filtro-profissional')),
                busca: (document.getElementById('relatorio-filtro-busca').value || '').trim()
            };

            const comparativoConfig = estado.relatorioComparacaoAtiva
                ? obterIntervaloComparativoRelatorio(estado.relatorioComparativoConfig)
                : null;

            const payload = {
                inicio,
                fim,
                filtros,
                descricaoPrincipal: (estado.relatorioResumoAtual && estado.relatorioResumoAtual.periodoTexto) || '',
                comparacaoAtiva: Boolean(comparativoConfig),
                comparativo: comparativoConfig || null
            };

            try {
                const resultado = await executarServidor('gerarRelatorioPdf', JSON.stringify(payload));
                baixarArquivoBase64(resultado);
            } catch (erro) {
                console.error('Erro ao exportar PDF do relatório:', erro);
                alert('Não foi possível gerar o PDF do relatório.');
            }
        }

        async function gerarRelatorio() {
            const inicio = document.getElementById('relatorio-data-inicio').value;
            const fim = document.getElementById('relatorio-data-fim').value;
            const limparLista = lista => lista.map(item => String(item || '').trim()).filter(Boolean);
            const filtros = {
                turnos: limparLista(obterValoresMultiplo('relatorio-filtro-turno')),
                status: limparLista(obterValoresMultiplo('relatorio-filtro-status')),
                ilhas: limparLista(obterValoresMultiplo('relatorio-filtro-ilha')),
                salas: limparLista(obterValoresMultiplo('relatorio-filtro-sala')),
                especialidades: limparLista(obterValoresMultiplo('relatorio-filtro-especialidade')),
                categorias: limparLista(obterValoresMultiplo('relatorio-filtro-categoria')),
                profissionais: limparLista(obterValoresMultiplo('relatorio-filtro-profissional')),
                busca: (document.getElementById('relatorio-filtro-busca').value || '').trim()
            };

            const comparativoConfig = estado.relatorioComparacaoAtiva
                ? obterIntervaloComparativoRelatorio(estado.relatorioComparativoConfig)
                : null;

            try {
                const filtrosJson = JSON.stringify(filtros);
                const principal = await executarServidor('getRelatorioPeriodo', inicio, fim, filtrosJson);
                let comparativoDados = null;
                let infoComparativo = null;

                if (comparativoConfig && comparativoConfig.inicio && comparativoConfig.fim) {
                    try {
                        const retornoComparativo = await executarServidor('getRelatorioPeriodo', comparativoConfig.inicio, comparativoConfig.fim, filtrosJson);
                        if (retornoComparativo && !retornoComparativo.error) {
                            comparativoDados = retornoComparativo;
                            infoComparativo = { descricao: comparativoConfig.descricao };
                            estado.relatorioComparativoInfo = infoComparativo;
                        } else {
                            console.warn('Comparativo do relatório retornou vazio ou com erro.');
                        }
                    } catch (erroComparativo) {
                        console.error('Erro ao carregar comparação do relatório:', erroComparativo);
                    }
                } else if (!estado.relatorioComparacaoAtiva) {
                    estado.relatorioComparativoDados = null;
                    estado.relatorioComparativoInfo = null;
                }

                renderRelatorioTable(principal, comparativoDados, infoComparativo);
            } catch (erro) {
                console.error('Erro no relatório:', erro);
            }
        }

        function renderRelatorioTable(resultadoPrincipal, resultadoComparativo, infoComparativo) {
            if (!resultadoPrincipal || resultadoPrincipal.error) {
                console.error('Erro ao gerar relatório:', resultadoPrincipal && resultadoPrincipal.error ? resultadoPrincipal.error : 'Dados indisponíveis');
            }

            const dados = resultadoPrincipal && !resultadoPrincipal.error ? resultadoPrincipal : { resumo: {}, diario: [], detalhado: [] };
            estado.relatorioResumoAtual = dados.resumo || null;
            if (resultadoComparativo && resultadoComparativo.error) {
                console.warn('Relatório comparativo retornou erro:', resultadoComparativo.error);
            }

            const comparativoValido = resultadoComparativo && !resultadoComparativo.error;
            if (comparativoValido) {
                estado.relatorioComparativoDados = resultadoComparativo;
                const descricao = (infoComparativo && infoComparativo.descricao)
                    || (estado.relatorioComparativoConfig && estado.relatorioComparativoConfig.descricao)
                    || (resultadoComparativo.resumo && resultadoComparativo.resumo.periodoTexto)
                    || '';
                estado.relatorioComparativoInfo = { descricao };
            } else if (!estado.relatorioComparacaoAtiva) {
                estado.relatorioComparativoDados = null;
                estado.relatorioComparativoInfo = null;
            }

            atualizarResumoIndicadores('relatorio-resumo', dados.resumo);
            atualizarRelatorioComparativoResumo(dados.resumo, comparativoValido ? resultadoComparativo.resumo : null);

            const tbodyResumo = document.querySelector('#relatorio-tabela tbody');
            tbodyResumo.innerHTML = '';

            const linhasDiario = Array.isArray(dados.diario) ? dados.diario : [];
            if (linhasDiario.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 5;
                td.textContent = 'Nenhum dado encontrado para o período selecionado.';
                tr.appendChild(td);
                tbodyResumo.appendChild(tr);
            } else {
                linhasDiario.forEach(item => {
                    const tr = document.createElement('tr');

                    const tdData = document.createElement('td');
                    tdData.textContent = item.data || '-';

                    const tdSalas = document.createElement('td');
                    tdSalas.textContent = Number.isFinite(Number(item.salasOcupadas))
                        ? Number(item.salasOcupadas).toLocaleString('pt-BR')
                        : item.salasOcupadas || '0';

                    const tdTaxa = document.createElement('td');
                    const taxaNumero = Number(item.taxaMedia);
                    tdTaxa.textContent = Number.isFinite(taxaNumero) ? `${taxaNumero}%` : '0%';

                    const tdAproveitamento = document.createElement('td');
                    const aproveitamentoNumero = Number(item.taxaAproveitamento);
                    tdAproveitamento.textContent = Number.isFinite(aproveitamentoNumero) ? `${aproveitamentoNumero}%` : '0%';

                    const tdEspecialidades = document.createElement('td');
                    tdEspecialidades.textContent = Array.isArray(item.especialidades) && item.especialidades.length
                        ? item.especialidades.join(', ')
                        : 'Não informado';

                    tr.appendChild(tdData);
                    tr.appendChild(tdSalas);
                    tr.appendChild(tdTaxa);
                    tr.appendChild(tdAproveitamento);
                    tr.appendChild(tdEspecialidades);
                    tbodyResumo.appendChild(tr);
                });
            }

            const tbodyDetalhado = document.querySelector('#relatorio-detalhado tbody');
            tbodyDetalhado.innerHTML = '';

            const linhasDetalhe = Array.isArray(dados.detalhado) ? dados.detalhado : [];
            if (linhasDetalhe.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 9;
                td.textContent = 'Nenhum agendamento encontrado para o período selecionado.';
                tr.appendChild(td);
                tbodyDetalhado.appendChild(tr);
            } else {
                linhasDetalhe.forEach(item => {
                    const tr = document.createElement('tr');

                    const tdData = document.createElement('td');
                    tdData.textContent = item.data || '-';

                    const tdSala = document.createElement('td');
                    tdSala.textContent = item.sala || '-';

                    const tdIlha = document.createElement('td');
                    tdIlha.textContent = item.ilha || '-';

                    const tdTurno = document.createElement('td');
                    const turnoLabel = formatarTurnoLabel(item.turno);
                    tdTurno.textContent = turnoLabel ? turnoLabel : '-';

                    const tdHorario = document.createElement('td');
                    const horaInicio = item.horaInicio || '';
                    const horaFim = item.horaFim || '';
                    let horarioTexto = '-';
                    if (horaInicio && horaFim) {
                        horarioTexto = `${horaInicio} - ${horaFim}`;
                    } else if (horaInicio || horaFim) {
                        horarioTexto = horaInicio || horaFim;
                    }
                    tdHorario.textContent = horarioTexto;

                    const tdEspecialidade = document.createElement('td');
                    tdEspecialidade.textContent = item.especialidade || 'Não informado';

                    const tdCategoria = document.createElement('td');
                    tdCategoria.textContent = item.categoria || 'Não informado';

                    const tdProfissional = document.createElement('td');
                    tdProfissional.textContent = item.profissional || '-';

                    const tdStatus = document.createElement('td');
                    tdStatus.textContent = formatarStatusLabel(item.status);

                    tr.appendChild(tdData);
                    tr.appendChild(tdSala);
                    tr.appendChild(tdIlha);
                    tr.appendChild(tdTurno);
                    tr.appendChild(tdHorario);
                    tr.appendChild(tdEspecialidade);
                    tr.appendChild(tdCategoria);
                    tr.appendChild(tdProfissional);
                    tr.appendChild(tdStatus);
                    tbodyDetalhado.appendChild(tr);
                });
            }
        }

        function agendarSalaMesAtualizacao() {
            if (salaMesAtualizacaoTimer) {
                clearTimeout(salaMesAtualizacaoTimer);
            }
            salaMesAtualizacaoTimer = setTimeout(() => {
                salaMesAtualizacaoTimer = null;
                sincronizarEstadoSalaMes();
                atualizarSalaMesStatus();
            }, 350);
            sincronizarEstadoSalaMes();
        }

        function atualizarEstadoBotaoSalaMes() {
            const botao = document.getElementById('sala-mes-aplicar');
            if (!botao) return;
            botao.disabled = !salaMesFiltrosPendentes;
            botao.classList.toggle('is-pending', salaMesFiltrosPendentes);
        }

        function definirSalaMesPendencia(pendente = true) {
            salaMesFiltrosPendentes = Boolean(pendente);
            atualizarEstadoBotaoSalaMes();
            sincronizarEstadoSalaMes();
        }

        function aplicarSalaMesFiltros(forcar = false) {
            if (!forcar && !salaMesFiltrosPendentes) {
                return;
            }
            definirSalaMesPendencia(false);
            agendarSalaMesAtualizacao();
        }

        function atualizarSalaMesDiaCampos() {
            const modoSelecionado = document.querySelector('input[name="sala-mes-dia-modo"]:checked');
            const modo = modoSelecionado ? modoSelecionado.value : 'hoje';
            const range = document.getElementById('sala-mes-dia-range');
            const inputDia = document.getElementById('sala-mes-dia-unico');
            if (range) {
                range.classList.toggle('active', modo === 'intervalo');
            }
            if (inputDia) {
                inputDia.disabled = modo !== 'data';
            }
        }

        function garantirPadroesSalaMes(tipoAtual) {
            const periodo = estado.salaMesPeriodo || (estado.salaMesPeriodo = {
                tipo: 'mes',
                meses: [],
                semanaMeses: [],
                semanas: [],
                diaModo: 'hoje',
                diaUnico: '',
                intervalo: { inicio: '', fim: '' }
            });

            if (tipoAtual) {
                periodo.tipo = tipoAtual;
            } else {
                periodo.tipo = periodo.tipo || 'mes';
            }

            const idsPendentes = [
                'sala-mes-periodo-meses',
                'sala-mes-periodo-semana-meses',
                'sala-mes-periodo-semanas'
            ];
            const pendentes = idsPendentes.filter(id => {
                const select = document.getElementById(id);
                return !select || !select.options || !select.options.length;
            });

            if (pendentes.length) {
                if (garantirPadroesSalaMes._retryTimer) {
                    clearTimeout(garantirPadroesSalaMes._retryTimer);
                }
                const tentativa = (garantirPadroesSalaMes._retryAttempts || 0) + 1;
                garantirPadroesSalaMes._retryAttempts = tentativa;
                if (tentativa <= 6) {
                    garantirPadroesSalaMes._retryTimer = setTimeout(() => {
                        garantirPadroesSalaMes._retryTimer = null;
                        garantirPadroesSalaMes(tipoAtual);
                    }, Math.min(200, 40 * tentativa));
                } else {
                    garantirPadroesSalaMes._retryAttempts = 0;
                    garantirPadroesSalaMes._retryTimer = null;
                }
                return periodo;
            }

            if (garantirPadroesSalaMes._retryTimer) {
                clearTimeout(garantirPadroesSalaMes._retryTimer);
                garantirPadroesSalaMes._retryTimer = null;
            }
            garantirPadroesSalaMes._retryAttempts = 0;

            const obterOpcoes = id => Array.from(document.getElementById(id)?.options || []).map(opt => opt.value);

            if (!Array.isArray(periodo.meses)) periodo.meses = [];
            if (!Array.isArray(periodo.semanaMeses)) periodo.semanaMeses = [];
            if (!Array.isArray(periodo.semanas)) periodo.semanas = [];

            const mesesOpcoes = obterOpcoes('sala-mes-periodo-meses');
            if (!periodo.meses.length && mesesOpcoes.length) {
                const mesAtual = obterMesAtualValor();
                const padrao = mesesOpcoes.includes(mesAtual) ? mesAtual : mesesOpcoes[mesesOpcoes.length - 1];
                if (padrao) periodo.meses = [padrao];
            }

            const mesesSemanas = obterOpcoes('sala-mes-periodo-semana-meses');
            if (!periodo.semanaMeses.length && mesesSemanas.length) {
                const mesAtual = obterMesAtualValor();
                const padrao = mesesSemanas.includes(mesAtual) ? mesAtual : mesesSemanas[mesesSemanas.length - 1];
                if (padrao) periodo.semanaMeses = [padrao];
            }

            const semanasOpcoes = obterOpcoes('sala-mes-periodo-semanas');
            if (!periodo.semanas.length && semanasOpcoes.length) {
                const base = estado.dataAtual instanceof Date ? estado.dataAtual : new Date();
                const semanaAtual = Math.min(Math.max(Math.ceil(base.getDate() / 7), 1), 5);
                const padrao = semanasOpcoes.includes(String(semanaAtual)) ? String(semanaAtual) : semanasOpcoes[0];
                periodo.semanas = padrao ? [padrao] : [];
            }

            if (!periodo.diaUnico) {
                const base = estado.dataAtual instanceof Date ? estado.dataAtual : new Date();
                periodo.diaUnico = base.toISOString().split('T')[0];
            }

            if (!periodo.intervalo || typeof periodo.intervalo !== 'object') {
                periodo.intervalo = { inicio: '', fim: '' };
            } else {
                periodo.intervalo.inicio = periodo.intervalo.inicio || '';
                periodo.intervalo.fim = periodo.intervalo.fim || '';
            }

            return periodo;
        }

        function sincronizarSalaMesPeriodoValores() {
            const periodo = estado.salaMesPeriodo || {};
            const tipoSelect = document.getElementById('sala-mes-periodo-tipo');
            if (tipoSelect) {
                tipoSelect.value = periodo.tipo || 'mes';
            }

            aplicarSelecaoReportMultiselect('sala-mes-periodo-meses', periodo.meses || []);
            aplicarSelecaoReportMultiselect('sala-mes-periodo-semana-meses', periodo.semanaMeses || []);
            aplicarSelecaoReportMultiselect('sala-mes-periodo-semanas', periodo.semanas || []);

            const modoAtual = periodo.diaModo || 'hoje';
            document.querySelectorAll('input[name="sala-mes-dia-modo"]').forEach(radio => {
                radio.checked = radio.value === modoAtual;
            });

            const inputDia = document.getElementById('sala-mes-dia-unico');
            if (inputDia) {
                inputDia.value = periodo.diaUnico || '';
            }

            const inputInicio = document.getElementById('sala-mes-dia-inicio');
            if (inputInicio) {
                inputInicio.value = (periodo.intervalo && periodo.intervalo.inicio) || '';
            }

            const inputFim = document.getElementById('sala-mes-dia-fim');
            if (inputFim) {
                inputFim.value = (periodo.intervalo && periodo.intervalo.fim) || '';
            }

            atualizarSalaMesDiaCampos();
        }

        function atualizarSalaMesPeriodoOpcoes() {
            const meses = gerarOpcoesMeses();
            const semanas = gerarOpcoesSemanas();
            definirRelatorioOpcoes('sala-mes-periodo-meses', meses);
            definirRelatorioOpcoes('sala-mes-periodo-semana-meses', meses);
            definirRelatorioOpcoes('sala-mes-periodo-semanas', semanas);
        }

        function inicializarSalaMesPeriodoDetalhes() {
            const tipoSelect = document.getElementById('sala-mes-periodo-tipo');
            const container = document.getElementById('sala-mes-periodo-detalhes');
            if (!tipoSelect || !container) {
                return;
            }

            const atualizarVisibilidade = () => {
                const periodoAtual = tipoSelect.value || 'mes';
                container.querySelectorAll('.status-map-periodo-field').forEach(field => {
                    const alvo = (field.dataset.periodo || '').split(',').map(item => item.trim()).filter(Boolean);
                    if (alvo.includes(periodoAtual)) {
                        field.classList.add('active');
                    } else {
                        field.classList.remove('active');
                    }
                });
                atualizarSalaMesDiaCampos();
            };

            if (tipoSelect.dataset.salaMesPeriodoListeners !== 'true') {
                tipoSelect.addEventListener('change', () => {
                    estado.salaMesPeriodo.tipo = tipoSelect.value || 'mes';
                    garantirPadroesSalaMes(estado.salaMesPeriodo.tipo);
                    sincronizarSalaMesPeriodoValores();
                    atualizarVisibilidade();
                    definirSalaMesPendencia(true);
                });
                tipoSelect.dataset.salaMesPeriodoListeners = 'true';
            }

            const registrar = (id, atualizador) => {
                const select = document.getElementById(id);
                if (!select || select.dataset.salaMesPeriodoListeners === 'true') {
                    return;
                }
                select.addEventListener('change', () => {
                    atualizador();
                });
                select.dataset.salaMesPeriodoListeners = 'true';
            };

            registrar('sala-mes-periodo-meses', () => {
                estado.salaMesPeriodo.meses = obterValoresMultiplo('sala-mes-periodo-meses');
                if ((estado.salaMesPeriodo.tipo || 'mes') === 'mes') {
                    definirSalaMesPendencia(true);
                }
            });

            registrar('sala-mes-periodo-semana-meses', () => {
                estado.salaMesPeriodo.semanaMeses = obterValoresMultiplo('sala-mes-periodo-semana-meses');
                if ((estado.salaMesPeriodo.tipo || 'mes') === 'semana') {
                    definirSalaMesPendencia(true);
                }
            });

            registrar('sala-mes-periodo-semanas', () => {
                estado.salaMesPeriodo.semanas = obterValoresMultiplo('sala-mes-periodo-semanas');
                if ((estado.salaMesPeriodo.tipo || 'mes') === 'semana') {
                    definirSalaMesPendencia(true);
                }
            });

            document.querySelectorAll('input[name="sala-mes-dia-modo"]').forEach(radio => {
                if (radio.dataset.salaMesPeriodoListeners === 'true') {
                    return;
                }
                radio.addEventListener('change', () => {
                    estado.salaMesPeriodo.diaModo = radio.value;
                    atualizarSalaMesDiaCampos();
                    definirSalaMesPendencia(true);
                });
                radio.dataset.salaMesPeriodoListeners = 'true';
            });

            const inputDia = document.getElementById('sala-mes-dia-unico');
            if (inputDia && inputDia.dataset.salaMesPeriodoListeners !== 'true') {
                inputDia.addEventListener('change', () => {
                    estado.salaMesPeriodo.diaUnico = inputDia.value || '';
                    const modoAtual = document.querySelector('input[name="sala-mes-dia-modo"]:checked');
                    if (modoAtual && modoAtual.value === 'data') {
                        definirSalaMesPendencia(true);
                    }
                });
                inputDia.dataset.salaMesPeriodoListeners = 'true';
            }

            const inputInicio = document.getElementById('sala-mes-dia-inicio');
            if (inputInicio && inputInicio.dataset.salaMesPeriodoListeners !== 'true') {
                inputInicio.addEventListener('change', () => {
                    estado.salaMesPeriodo.intervalo = estado.salaMesPeriodo.intervalo || { inicio: '', fim: '' };
                    estado.salaMesPeriodo.intervalo.inicio = inputInicio.value || '';
                    const modoAtual = document.querySelector('input[name="sala-mes-dia-modo"]:checked');
                    if (modoAtual && modoAtual.value === 'intervalo') {
                        definirSalaMesPendencia(true);
                    }
                });
                inputInicio.dataset.salaMesPeriodoListeners = 'true';
            }

            const inputFim = document.getElementById('sala-mes-dia-fim');
            if (inputFim && inputFim.dataset.salaMesPeriodoListeners !== 'true') {
                inputFim.addEventListener('change', () => {
                    estado.salaMesPeriodo.intervalo = estado.salaMesPeriodo.intervalo || { inicio: '', fim: '' };
                    estado.salaMesPeriodo.intervalo.fim = inputFim.value || '';
                    const modoAtual = document.querySelector('input[name="sala-mes-dia-modo"]:checked');
                    if (modoAtual && modoAtual.value === 'intervalo') {
                        definirSalaMesPendencia(true);
                    }
                });
                inputFim.dataset.salaMesPeriodoListeners = 'true';
            }

            atualizarVisibilidade();
        }

        function obterSalaMesPeriodoConfig() {
            const tipoSelect = document.getElementById('sala-mes-periodo-tipo');
            const tipo = (tipoSelect ? tipoSelect.value : estado.salaMesPeriodo.tipo) || 'mes';
            const limparLista = lista => (lista || []).map(item => String(item || '').trim()).filter(Boolean);
            const config = { tipo };
            estado.salaMesPeriodo.tipo = tipo;

            if (tipo === 'mes') {
                const meses = limparLista(obterValoresMultiplo('sala-mes-periodo-meses'));
                if (!meses.length) {
                    return null;
                }
                const unicos = Array.from(new Set(meses)).sort();
                estado.salaMesPeriodo.meses = [...unicos];
                config.meses = [...unicos];
            } else if (tipo === 'semana') {
                const meses = limparLista(obterValoresMultiplo('sala-mes-periodo-semana-meses'));
                const semanas = limparLista(obterValoresMultiplo('sala-mes-periodo-semanas'))
                    .map(valor => parseInt(valor, 10))
                    .filter(numero => Number.isInteger(numero));
                if (!meses.length || !semanas.length) {
                    return null;
                }
                const mesesOrdenados = Array.from(new Set(meses)).sort();
                const semanasOrdenadas = Array.from(new Set(semanas)).sort((a, b) => a - b);
                estado.salaMesPeriodo.semanaMeses = [...mesesOrdenados];
                estado.salaMesPeriodo.semanas = semanasOrdenadas.map(String);
                config.meses = [...mesesOrdenados];
                config.semanas = [...semanasOrdenadas];
            } else if (tipo === 'dia') {
                const modoSelecionado = document.querySelector('input[name="sala-mes-dia-modo"]:checked');
                const modo = modoSelecionado ? modoSelecionado.value : 'hoje';
                estado.salaMesPeriodo.diaModo = modo;
                config.diaModo = modo;

                if (modo === 'intervalo') {
                    const inicio = document.getElementById('sala-mes-dia-inicio')?.value || '';
                    const fim = document.getElementById('sala-mes-dia-fim')?.value || '';
                    estado.salaMesPeriodo.intervalo = {
                        inicio: inicio || '',
                        fim: fim || ''
                    };
                    if (!inicio || !fim) {
                        return null;
                    }
                    config.intervalo = { inicio, fim };
                } else if (modo === 'data') {
                    const diaUnico = document.getElementById('sala-mes-dia-unico')?.value || '';
                    estado.salaMesPeriodo.diaUnico = diaUnico;
                    if (!diaUnico) {
                        return null;
                    }
                    config.dias = [diaUnico];
                } else {
                    const base = estado.dataAtual instanceof Date ? estado.dataAtual : new Date();
                    const hojeIso = base.toISOString().split('T')[0];
                    estado.salaMesPeriodo.diaUnico = hojeIso;
                    config.dias = [hojeIso];
                }
            }

            return config;
        }

        function carregarSalaMesOptions() {
            registrarEventosFiltrosEspecificos();

            atualizarSalaMesPeriodoOpcoes();
            garantirPadroesSalaMes((estado.salaMesPeriodo && estado.salaMesPeriodo.tipo) || 'mes');
            sincronizarSalaMesPeriodoValores();
            inicializarSalaMesPeriodoDetalhes();

            const statusSelect = document.getElementById('sala-mes-status-visualizacao');
            if (statusSelect && statusSelect.dataset.listenersAttached !== 'true') {
                statusSelect.addEventListener('change', () => {
                    definirSalaMesPendencia(true);
                });
                statusSelect.dataset.listenersAttached = 'true';
            }

            const botaoAplicar = document.getElementById('sala-mes-aplicar');
            if (botaoAplicar && botaoAplicar.dataset.listenersAttached !== 'true') {
                botaoAplicar.addEventListener('click', () => {
                    aplicarSalaMesFiltros();
                });
                botaoAplicar.dataset.listenersAttached = 'true';
            }

            const container = document.getElementById('sala-mes-status-lista');
            if (container && !container.children.length) {
                container.innerHTML = '<div class="status-room-empty">Ajuste os filtros e escolha um período para visualizar as salas.</div>';
            }

            mostrarSalaMesStatusMapa('Preparando filtros de período...', 'info');
            atualizarEstadoBotaoSalaMes();
            aplicarSalaMesFiltros(true);
        }

        function setSalaMesLoading(ativo) {
            if (ativo) {
                salaMesLoadingPendencias++;
            } else if (salaMesLoadingPendencias > 0) {
                salaMesLoadingPendencias--;
            }
            sincronizarEstadoSalaMes();

            const card = document.querySelector('.status-map-card');
            if (!card) return;

            if (salaMesLoadingPendencias > 0) {
                card.classList.add('is-loading');
                card.setAttribute('aria-busy', 'true');
            } else {
                card.classList.remove('is-loading');
                card.removeAttribute('aria-busy');
            }
        }

        function mostrarSalaMesStatusMapa(mensagem, tipo = 'info') {
            const feedback = document.getElementById('sala-mes-status-feedback');
            if (!feedback) return;
            if (!mensagem) {
                feedback.textContent = '';
                feedback.style.display = 'none';
                feedback.removeAttribute('data-status');
                return;
            }
            feedback.textContent = mensagem;
            feedback.dataset.status = tipo;
            feedback.style.display = 'block';
        }

        function renderSalaMesStatus(resposta) {
            const container = document.getElementById('sala-mes-status-lista');
            if (!container) {
                setSalaMesLoading(false);
                return;
            }

            try {
                let dados = resposta;
                if (typeof dados === 'string') {
                    try {
                        dados = JSON.parse(dados);
                    } catch (error) {
                        console.error('Erro ao interpretar mapa de status:', error, dados);
                        container.innerHTML = '<div class="status-room-empty">Erro ao interpretar os dados retornados.</div>';
                        mostrarSalaMesStatusMapa('Não foi possível interpretar a resposta recebida.', 'erro');
                        setSalaMesLoading(false);
                        return;
                    }
                }

                if (dados && typeof dados === 'object' && !Array.isArray(dados) && Array.isArray(dados.dados)) {
                    dados = dados.dados;
                }

                if (!dados || dados.error) {
                    const mensagemErro = dados && dados.error ? String(dados.error) : 'Erro desconhecido.';
                    console.error('Erro ao carregar mapa de status:', mensagemErro);
                    container.innerHTML = '<div class="status-room-empty">Erro ao carregar a visão por status.</div>';
                    mostrarSalaMesStatusMapa('Erro ao carregar a visão por status. Tente novamente.', 'erro');
                    setSalaMesLoading(false);
                    return;
                }

                const ilhas = Array.isArray(dados.ilhas) ? dados.ilhas : [];
                container.innerHTML = '';

                if (!ilhas.length) {
                    container.innerHTML = '<div class="status-room-empty">Nenhuma sala encontrada com os filtros selecionados.</div>';
                    mostrarSalaMesStatusMapa('Nenhuma sala encontrada com os filtros aplicados.', 'info');
                    setSalaMesLoading(false);
                    return;
                }

                const statusTitulo = dados.statusLabel || formatarStatusLabel(dados.status || 'livre');
                const statusResumo = statusTitulo ? statusTitulo.toLowerCase() : 'com status selecionado';
                const labelResumo = statusResumo.includes('sala') ? statusResumo : `salas ${statusResumo}`;
                const contarTexto = quantidade => {
                    if (statusResumo.includes('sala')) {
                        return `${quantidade} ${statusResumo}`;
                    }
                    return `${quantidade} sala${quantidade === 1 ? '' : 's'} ${statusResumo}`;
                };

                const formatarNumero = valor => {
                    const numero = Number(valor);
                    return Number.isFinite(numero) ? numero.toLocaleString('pt-BR') : '0';
                };

                const gerarEventosHtml = (eventos, statusPadrao) => {
                    if (!Array.isArray(eventos) || !eventos.length) {
                        return '<div class="status-room-empty">Sem agendamentos no filtro aplicado.</div>';
                    }

                    const itens = eventos.map(evento => {
                        const horaInicio = (evento.horaInicio || '').trim();
                        const horaFim = (evento.horaFim || '').trim();
                        let horarioTexto = 'Horário não informado';
                        if (horaInicio && horaFim) {
                            horarioTexto = `${horaInicio} - ${horaFim}`;
                        } else if (horaInicio || horaFim) {
                            horarioTexto = horaInicio || horaFim;
                        }

                        const profissional = evento.profissional || 'Profissional não informado';
                        const especialidade = evento.especialidade || 'Especialidade não informada';
                        const categoria = evento.categoria || 'Categoria não informada';
                        const statusBruto = evento.status || statusPadrao || 'ocupado';
                        const statusEvento = formatarStatusLabel(statusBruto);
                        const varianteStatus = obterStatusVariant(statusBruto);

                        return `<li><span class="status-room-time">${escapeHtml(horarioTexto)}</span><div class="status-room-info"><span class="status-room-tag"><i class="fas fa-user-md"></i> ${escapeHtml(profissional)}</span><span class="status-room-tag"><i class="fas fa-stethoscope"></i> ${escapeHtml(especialidade)}</span><span class="status-room-tag"><i class="fas fa-layer-group"></i> ${escapeHtml(categoria)}</span><span class="status-room-badge" data-variant="${varianteStatus}">${escapeHtml(statusEvento)}</span></div></li>`;
                    }).join('');

                    return `<ul class="status-room-eventos">${itens}</ul>`;
                };

                const gerarSalasHtml = (salas, statusPadrao) => {
                    if (!salas.length) {
                        return '<div class="status-room-empty">Sem agendamentos no filtro aplicado.</div>';
                    }

                    const itens = salas.map(item => {
                        const numeroSala = item.sala === null || item.sala === undefined ? '-' : item.sala;
                        const statusBase = item.statusBase || statusPadrao || dados.status || 'livre';
                        const varianteStatus = obterStatusVariant(statusBase);
                        const eventos = Array.isArray(item.eventos) ? item.eventos : [];
                        const eventosHtml = eventos.length
                            ? gerarEventosHtml(eventos, statusBase)
                            : '<div class="status-room-empty">Sem agendamentos no filtro aplicado.</div>';

                        return `<li class="status-room-item"><div class="status-room-header"><div class="status-room-title"><i class="fas fa-door-open"></i><span>Sala ${escapeHtml(numeroSala)}</span></div><span class="status-room-badge" data-variant="${varianteStatus}">${escapeHtml(formatarStatusLabel(statusBase))}</span></div>${eventosHtml}</li>`;
                    }).join('');

                    return `<ul class="status-room-list">${itens}</ul>`;
                };

                const gerarDiasHtml = dias => {
                    if (!dias.length) {
                        return '<div class="status-room-empty">Nenhum dia disponível neste status.</div>';
                    }

                    return dias.map(dia => {
                        const tituloDia = dia.label || dia.data || 'Dia';
                        const totalDia = Number(dia.total) || 0;
                        const metaDiaTexto = totalDia > 0
                            ? contarTexto(totalDia)
                            : 'Nenhuma sala neste status.';
                        const salasOrdenadas = Array.isArray(dia.salas)
                            ? [...dia.salas].sort((a, b) => String(a.sala || '').localeCompare(String(b.sala || ''), undefined, { numeric: true }))
                            : [];
                        const conteudoDia = totalDia > 0
                            ? gerarSalasHtml(salasOrdenadas, dia.statusBase || dados.status)
                            : '<div class="status-room-empty">Nenhuma sala com este status neste dia.</div>';

                        return `<details class="status-tree-day"><summary class="status-day-summary"><div class="status-day-info"><span class="status-day-icon"><i class="fas fa-calendar-day"></i></span><div class="status-day-label"><span class="status-day-title">${escapeHtml(tituloDia)}</span><span class="status-day-meta">${escapeHtml(metaDiaTexto)}</span></div></div><span class="status-tree-count">${escapeHtml(formatarNumero(totalDia))}</span></summary><div class="status-day-content">${conteudoDia}</div></details>`;
                    }).join('');
                };

                const ilhasHtml = ilhas.map(ilha => {
                    const dias = Array.isArray(ilha.dias) ? ilha.dias : [];
                    const diasComSalas = dias.reduce((acc, dia) => acc + (Number(dia.total) > 0 ? 1 : 0), 0);
                    const totalSalas = formatarNumero(ilha.totalSalas);
                    const metaIlhaTexto = diasComSalas > 0
                        ? `${diasComSalas} dia${diasComSalas === 1 ? '' : 's'} com ${statusResumo.includes('sala') ? statusResumo : 'salas neste status'}`
                        : 'Nenhum dia com salas neste status.';
                    const diasHtml = gerarDiasHtml(dias);

                    return `<details class="status-tree-node"><summary class="status-island-summary"><div class="status-island-info"><span class="status-island-icon"><i class="fas fa-umbrella-beach"></i></span><div class="status-island-text"><span class="status-island-name">${escapeHtml(ilha.label || 'Sem ilha definida')}</span><span class="status-island-meta">${escapeHtml(metaIlhaTexto)}</span></div></div><div class="status-island-count"><span class="status-island-count-number">${escapeHtml(totalSalas)}</span><span class="status-island-count-label">${escapeHtml(labelResumo)}</span></div></summary><div class="status-tree-children">${diasHtml}</div></details>`;
                }).join('');

                container.innerHTML = ilhasHtml;

                const totalIlhas = Number(dados.totalIlhas) || ilhas.length;
                const totalSalas = Number(dados.totalSalas) || 0;
                const resumo = `${totalIlhas} ilha${totalIlhas === 1 ? '' : 's'} com ${contarTexto(totalSalas)} no período.`;
                mostrarSalaMesStatusMapa(resumo, totalSalas > 0 ? 'sucesso' : 'info');
                setSalaMesLoading(false);
            } catch (erroRender) {
                console.error('Erro ao renderizar o mapa de status das salas:', erroRender);
                container.innerHTML = '<div class="status-room-empty">Não foi possível exibir a visão solicitada.</div>';
                mostrarSalaMesStatusMapa('Ocorreu um erro ao montar a visão de salas.', 'erro');
                setSalaMesLoading(false);
            }
        }

        function atualizarSalaMesStatus() {
            const statusSelect = document.getElementById('sala-mes-status-visualizacao');
            const status = statusSelect ? statusSelect.value : '';
            const periodoConfig = obterSalaMesPeriodoConfig();

            if (!periodoConfig) {
                const containerVazio = document.getElementById('sala-mes-status-lista');
                if (containerVazio) {
                    containerVazio.innerHTML = '<div class="status-room-empty">Selecione um período válido para continuar.</div>';
                }
                mostrarSalaMesStatusMapa('Selecione um período válido para visualizar as salas.', 'info');
                setSalaMesLoading(false);
                return;
            }

            const filtros = coletarFiltrosSalaMes({ incluirStatus: false });
            const chaveCache = JSON.stringify({ status: status || 'livre', periodo: periodoConfig, filtros });
            const dadosCache = obterCacheSalaMes(chaveCache);
            if (dadosCache) {
                renderSalaMesStatus(dadosCache);
                mostrarSalaMesStatusMapa('Exibindo dados recentes armazenados.', 'info');
                return;
            }

            mostrarSalaMesStatusMapa('Carregando salas por status...', 'info');
            setSalaMesLoading(true);
            const requisicaoId = Symbol('salaMes');
            salaMesRequestAtual = requisicaoId;
            sincronizarEstadoSalaMes();

            executarGoogleScript({
                funcao: 'getMapaStatusSalasMes',
                parametros: [status || 'livre', JSON.stringify(periodoConfig), JSON.stringify(filtros)],
                tentativas: 1,
                onSuccess(dados) {
                    if (salaMesRequestAtual !== requisicaoId) {
                        setSalaMesLoading(false);
                        return;
                    }
                    salvarCacheSalaMes(chaveCache, dados);
                    renderSalaMesStatus(dados);
                },
                onFailure(error) {
                    if (salaMesRequestAtual !== requisicaoId) {
                        setSalaMesLoading(false);
                        return;
                    }
                    console.error('Erro ao carregar o mapa de status:', error);
                    setSalaMesLoading(false);
                    mostrarSalaMesStatusMapa('Erro ao carregar a visão por status. Tente novamente.', 'erro');
                    definirSalaMesPendencia(true);
                    const fallback = document.getElementById('sala-mes-status-lista');
                    if (fallback) {
                        fallback.innerHTML = '<div class="status-room-empty">Não foi possível carregar os dados.</div>';
                    }
                }
            });
        }

        function coletarFiltrosSalaMes(opcoes = {}) {
            const incluirStatus = opcoes.incluirStatus !== false;
            const limparLista = lista => (lista || []).map(item => String(item || '').trim()).filter(Boolean);

            const turnosSelecionados = limparLista(obterValoresMultiplo('sala-mes-filtro-turno'));
            const turnos = turnosSelecionados.includes('todos')
                ? (turnosSelecionados.length === 1
                    ? []
                    : turnosSelecionados.filter(turno => turno !== 'todos'))
                : turnosSelecionados;
            const statusLista = incluirStatus ? limparLista(obterValoresMultiplo('sala-mes-filtro-status')) : [];
            const especialidades = limparLista(obterValoresMultiplo('sala-mes-filtro-especialidade'));
            const categorias = limparLista(obterValoresMultiplo('sala-mes-filtro-categoria'));
            const profissionais = limparLista(obterValoresMultiplo('sala-mes-filtro-profissional'));

            return {
                turnos,
                turno: turnos.length ? turnos[0] : '',
                status: statusLista,
                statusLista: [...statusLista],
                especialidades,
                especialidade: especialidades.length ? especialidades[0] : '',
                categorias,
                categoria: categorias.length ? categorias[0] : '',
                profissionais,
                profissional: profissionais.length ? profissionais[0] : ''
            };
        }
</script>
